[{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\(funcionario)\\dashboard\\_components\\dashboard-client.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is assigned a value but never used.","line":39,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":41}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useSession } from \"next-auth/react\";\r\nimport {\r\n  SharedDashboard,\r\n  DashboardMetrics,\r\n  CaixaData,\r\n} from \"@/components/dashboard/shared-dashboard\";\r\n\r\ninterface DashboardData extends DashboardMetrics {\r\n  lastSales: {\r\n    id: string;\r\n    valorTotal: number;\r\n    createdAt: string;\r\n  }[];\r\n  avisos: {\r\n    id: string;\r\n    mensagem: string;\r\n    importante: boolean;\r\n    criadoEm: string;\r\n  }[];\r\n  // metrics properties are inherited\r\n}\r\n\r\nexport default function DashboardClient() {\r\n  const { data: session } = useSession();\r\n  const [data, setData] = useState<DashboardData | null>(null);\r\n  const [caixaData, setCaixaData] = useState<CaixaData | null | undefined>(\r\n    undefined\r\n  );\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    async function fetchData() {\r\n      try {\r\n        // ­ƒÜÇ Otimiza├º├úo: Buscar TODOS os dados em paralelo\r\n        // Isso inclui analytics, caixa e avisos\r\n        const [resAnalytics, resCaixa, _] = await Promise.all([\r\n          fetch(\"/api/employee/analytics\"),\r\n          fetch(\"/api/caixa\", { cache: \"no-store\" }),\r\n          fetch(\"/api/avisos\"),\r\n        ]);\r\n\r\n        if (resAnalytics.ok) {\r\n          const json = await resAnalytics.json();\r\n          setData(json);\r\n        }\r\n\r\n        // ­ƒÜÇ Armazenar dados do caixa para passar ao MeuCaixa\r\n        if (resCaixa.ok) {\r\n          const caixaJson = await resCaixa.json();\r\n          setCaixaData(caixaJson.caixaAberto || null);\r\n        } else {\r\n          setCaixaData(null);\r\n        }\r\n\r\n        // Os dados de avisos s├úo usados pelo MuralAvisos\r\n        // Ele tem seu pr├│prio estado interno, mas agora o servidor j├í tem os dados em cache\r\n      } catch (error) {\r\n        console.error(\"Failed to fetch dashboard data\", error);\r\n        setCaixaData(null); // Em caso de erro, seta como null\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    }\r\n    fetchData();\r\n  }, []);\r\n\r\n  const currentDate = new Date().toLocaleDateString(\"pt-BR\", {\r\n    weekday: \"long\",\r\n    year: \"numeric\",\r\n    month: \"long\",\r\n    day: \"numeric\",\r\n  });\r\n\r\n  // Capitalize first letter of date\r\n  const formattedDate =\r\n    currentDate.charAt(0).toUpperCase() + currentDate.slice(1);\r\n\r\n  return (\r\n    <SharedDashboard\r\n      title={`Ol├í, ${session?.user?.name?.split(\" \")[0]} ­ƒæï`}\r\n      subtitle={formattedDate}\r\n      metrics={data}\r\n      caixaData={caixaData}\r\n      loading={loading}\r\n    />\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\(funcionario)\\minha-conta\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowRight' is defined but never used.","line":5,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":27}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useSession } from \"next-auth/react\";\r\nimport { Clock, ArrowRight } from \"lucide-react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Skeleton } from \"@/components/ui/skeleton\";\r\nimport { MuralAvisos } from \"@/components/mural-avisos\";\r\nimport { formatCurrency } from \"@/lib/utils\";\r\nimport { RestartTourButton } from \"@/components/restart-tour-button\";\r\n\r\ninterface Sale {\r\n  id: string;\r\n  valorTotal: number;\r\n  createdAt: string;\r\n}\r\n\r\nexport default function MinhaContaPage() {\r\n  const { data: session } = useSession();\r\n  const [sales, setSales] = useState<Sale[]>([]);\r\n  const [salesMonth, setSalesMonth] = useState(0);\r\n  const [metaMensal, setMetaMensal] = useState(0);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    async function fetchSales() {\r\n      try {\r\n        const res = await fetch(\"/api/employee/analytics\");\r\n        if (res.ok) {\r\n          const json = await res.json();\r\n          setSales(json.lastSales || []);\r\n          setSalesMonth(json.salesMonth || 0);\r\n          setMetaMensal(json.metaMensal || 0);\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Failed to fetch sales\", error);\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    }\r\n    fetchSales();\r\n  }, []);\r\n\r\n  const calculateProgress = () => {\r\n    if (metaMensal === 0) return 0;\r\n    return Math.min((salesMonth / metaMensal) * 100, 100);\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"max-w-4xl mx-auto p-4 space-y-4\">\r\n        <Skeleton className=\"h-10 w-48\" />\r\n        <Skeleton className=\"h-64 rounded-xl\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-4xl mx-auto p-4 space-y-6\">\r\n      <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\r\n        <div className=\"flex flex-col gap-1\">\r\n          <h1 className=\"text-2xl font-bold text-gray-900 dark:text-white\">\r\n            Minhas Vendas\r\n          </h1>\r\n          <p className=\"text-gray-500 dark:text-gray-400\">\r\n            Acompanhe seu desempenho e hist├│rico de vendas.\r\n          </p>\r\n        </div>\r\n        <RestartTourButton />\r\n      </div>\r\n\r\n      {/* Meta e Progresso */}\r\n      {session?.user?.role !== \"admin\" && session?.user?.role !== \"master\" && (\r\n        <Card className=\"bg-gradient-to-br from-blue-600 to-blue-700 border-none shadow-lg rounded-xl text-white overflow-hidden relative\">\r\n          <div className=\"absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-16 -mt-16 blur-3xl\"></div>\r\n          <CardContent className=\"p-6 relative z-10\">\r\n            <div className=\"flex justify-between items-end mb-4\">\r\n              <div>\r\n                <p className=\"text-blue-100 text-sm font-medium mb-1\">\r\n                  Vendas no M├¬s\r\n                </p>\r\n                <h2 className=\"text-3xl font-bold\">\r\n                  {formatCurrency(salesMonth)}\r\n                </h2>\r\n              </div>\r\n              <div className=\"text-right\">\r\n                <p className=\"text-blue-100 text-sm font-medium mb-1\">\r\n                  Meta Mensal\r\n                </p>\r\n                <p className=\"text-xl font-semibold\">\r\n                  {formatCurrency(metaMensal)}\r\n                </p>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex justify-between text-xs font-medium text-blue-100\">\r\n                <span>Progresso</span>\r\n                <span>\r\n                  {((salesMonth / (metaMensal || 1)) * 100).toFixed(1)}%\r\n                </span>\r\n              </div>\r\n              <div className=\"h-3 bg-black/20 rounded-full overflow-hidden backdrop-blur-sm\">\r\n                <div\r\n                  className=\"h-full bg-white rounded-full transition-all duration-1000 ease-out\"\r\n                  style={{ width: `${calculateProgress()}%` }}\r\n                ></div>\r\n              </div>\r\n              <p className=\"text-xs text-blue-200 mt-2\">\r\n                {salesMonth >= metaMensal\r\n                  ? \"Parab├®ns! Voc├¬ atingiu sua meta mensal! ­ƒÜÇ\"\r\n                  : `Faltam ${formatCurrency(\r\n                      metaMensal - salesMonth\r\n                    )} para atingir sua meta.`}\r\n              </p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      <div className=\"mb-6\">\r\n        <MuralAvisos />\r\n      </div>\r\n\r\n      <Card className=\"bg-white dark:bg-zinc-900 border-none shadow-sm rounded-xl\">\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg font-semibold text-gray-900 dark:text-white\">\r\n            ├Ültimas Vendas\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {sales.length === 0 ? (\r\n            <div className=\"py-8 text-center text-gray-500\">\r\n              Nenhuma venda registrada recentemente.\r\n            </div>\r\n          ) : (\r\n            <>\r\n              {/* Mobile: Card Layout */}\r\n              <div className=\"md:hidden space-y-3\">\r\n                {sales.map((sale) => (\r\n                  <div\r\n                    key={sale.id}\r\n                    className=\"p-4 bg-gray-50 dark:bg-zinc-800 rounded-lg\"\r\n                  >\r\n                    <div className=\"flex justify-between items-start mb-2\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Clock className=\"h-4 w-4 text-gray-400\" />\r\n                        <div>\r\n                          <p className=\"font-medium text-gray-900 dark:text-white\">\r\n                            {new Date(sale.createdAt).toLocaleDateString(\r\n                              \"pt-BR\"\r\n                            )}\r\n                          </p>\r\n                          <p className=\"text-xs text-gray-500\">\r\n                            {new Date(sale.createdAt).toLocaleTimeString(\r\n                              \"pt-BR\",\r\n                              {\r\n                                hour: \"2-digit\",\r\n                                minute: \"2-digit\",\r\n                              }\r\n                            )}\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                      <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\">\r\n                        Conclu├¡da\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"flex justify-between items-center\">\r\n                      <p className=\"text-xs text-gray-500 font-mono\">\r\n                        ID: {sale.id.substring(0, 8)}...\r\n                      </p>\r\n                      <p className=\"font-bold text-lg text-gray-900 dark:text-white\">\r\n                        {formatCurrency(sale.valorTotal)}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n\r\n              {/* Desktop: Table Layout */}\r\n              <div className=\"hidden md:block overflow-x-auto\">\r\n                <table className=\"w-full text-sm text-left\">\r\n                  <thead className=\"text-xs text-gray-500 uppercase bg-gray-50 dark:bg-gray-800/50 rounded-lg\">\r\n                    <tr>\r\n                      <th className=\"px-4 py-3 rounded-l-lg\">Data/Hora</th>\r\n                      <th className=\"px-4 py-3\">ID da Venda</th>\r\n                      <th className=\"px-4 py-3\">Valor</th>\r\n                      <th className=\"px-4 py-3 rounded-r-lg text-right\">\r\n                        Status\r\n                      </th>\r\n                    </tr>\r\n                  </thead>\r\n                  <tbody>\r\n                    {sales.map((sale) => (\r\n                      <tr\r\n                        key={sale.id}\r\n                        className=\"border-b border-gray-100 dark:border-gray-800 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors\"\r\n                      >\r\n                        <td className=\"px-4 py-4 font-medium text-gray-900 dark:text-white flex items-center gap-2\">\r\n                          <Clock className=\"h-4 w-4 text-gray-400\" />\r\n                          <div className=\"flex flex-col\">\r\n                            <span>\r\n                              {new Date(sale.createdAt).toLocaleDateString(\r\n                                \"pt-BR\"\r\n                              )}\r\n                            </span>\r\n                            <span className=\"text-xs text-gray-500\">\r\n                              {new Date(sale.createdAt).toLocaleTimeString(\r\n                                \"pt-BR\",\r\n                                {\r\n                                  hour: \"2-digit\",\r\n                                  minute: \"2-digit\",\r\n                                }\r\n                              )}\r\n                            </span>\r\n                          </div>\r\n                        </td>\r\n                        <td className=\"px-4 py-4 text-gray-500 font-mono text-xs\">\r\n                          {sale.id.substring(0, 8)}...\r\n                        </td>\r\n                        <td className=\"px-4 py-4 font-bold text-gray-900 dark:text-white\">\r\n                          {formatCurrency(sale.valorTotal)}\r\n                        </td>\r\n                        <td className=\"px-4 py-4 text-right\">\r\n                          <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\">\r\n                            Conclu├¡da\r\n                          </span>\r\n                        </td>\r\n                      </tr>\r\n                    ))}\r\n                  </tbody>\r\n                </table>\r\n              </div>\r\n            </>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\(funcionario)\\vender\\_components\\parts\\ProductGrid.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_sortOption' is defined but never used.","line":23,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_onSortChange' is defined but never used.","line":24,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":30}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Input } from \"@/components/ui/input\";\r\nimport { Search, Package } from \"lucide-react\";\r\nimport { Product } from \"@/hooks/use-pos\";\r\nimport { useState, useCallback } from \"react\";\r\nimport { ProductCard } from \"./ProductCard\";\r\n\r\ninterface ProductGridProps {\r\n  products: Product[];\r\n  onAddToCart: (product: Product) => void;\r\n  searchTerm: string;\r\n  onSearchChange: (value: string) => void;\r\n  searchInputRef: React.RefObject<HTMLInputElement>;\r\n  sortOption?: string;\r\n  onSortChange?: (value: string) => void;\r\n}\r\n\r\nexport function ProductGrid({\r\n  products,\r\n  onAddToCart,\r\n  searchTerm,\r\n  onSearchChange,\r\n  searchInputRef,\r\n  sortOption: _sortOption,\r\n  onSortChange: _onSortChange,\r\n}: ProductGridProps) {\r\n  const [lastAddedId, setLastAddedId] = useState<string | null>(null);\r\n\r\n  const handleProductClick = useCallback(\r\n    (product: Product) => {\r\n      onAddToCart(product);\r\n      setLastAddedId(product.id);\r\n\r\n      // Clear visual feedback after animation\r\n      const timer = setTimeout(() => setLastAddedId(null), 300);\r\n      return () => clearTimeout(timer);\r\n    },\r\n    [onAddToCart]\r\n  );\r\n\r\n  const renderEmptyState = () => (\r\n    <div className=\"h-full flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 animate-in fade-in duration-500\">\r\n      <div className=\"bg-white dark:bg-[#182635] p-6 rounded-full shadow-sm mb-4\">\r\n        <Package className=\"h-10 w-10 text-gray-300 dark:text-gray-600\" />\r\n      </div>\r\n      <p className=\"text-lg font-medium\">Nenhum produto encontrado</p>\r\n      <p className=\"text-sm mt-1 opacity-70\">\r\n        {searchTerm\r\n          ? \"Tente buscar com outros termos\"\r\n          : \"Cadastre produtos no estoque para come├ºar\"}\r\n      </p>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <div className=\"flex flex-col h-full gap-6\">\r\n      {/* Search Header */}\r\n      <div className=\"relative flex-none\">\r\n        <Search className=\"absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5 z-10 pointer-events-none\" />\r\n        <Input\r\n          ref={searchInputRef}\r\n          placeholder=\"Buscar produtos... (F2)\"\r\n          value={searchTerm}\r\n          onChange={(e) => onSearchChange(e.target.value)}\r\n          className=\"h-14 pl-12 rounded-xl shadow-sm bg-white dark:bg-[#182635] border-2 border-gray-200 dark:border-gray-700 text-base focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:border-transparent transition-all\"\r\n        />\r\n      </div>\r\n\r\n      {/* Grid Content */}\r\n      <div className=\"flex-1 overflow-y-auto pr-2 scrollbar-hide\">\r\n        {products.length === 0 ? (\r\n          renderEmptyState()\r\n        ) : (\r\n          <div className=\"grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-4 pb-4\">\r\n            {products.map((product) => (\r\n              <ProductCard\r\n                key={product.id}\r\n                product={product}\r\n                onClick={handleProductClick}\r\n                isLastAdded={lastAddedId === product.id}\r\n              />\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\(funcionario)\\vender\\_components\\parts\\SaleSuccessScreen.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ShiningText' is assigned a value but never used.","line":96,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":96,"endColumn":18}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport * as React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { CheckCircle2, Package, CreditCard, Sparkles } from \"lucide-react\";\r\nimport { useEffect, useState } from \"react\";\r\n\r\ninterface ConfettiProps {\r\n  isActive?: boolean;\r\n  duration?: number;\r\n  autoPlay?: boolean;\r\n  zIndex?: number;\r\n  loop?: boolean;\r\n}\r\n\r\nconst Confetti = ({\r\n  isActive: externalIsActive,\r\n  duration = 6000,\r\n  autoPlay = false,\r\n  zIndex = 50,\r\n  loop = false,\r\n}: ConfettiProps) => {\r\n  const [isActive, setIsActive] = useState(autoPlay);\r\n\r\n  useEffect(() => {\r\n    if (externalIsActive !== undefined) {\r\n      setIsActive(externalIsActive);\r\n    }\r\n  }, [externalIsActive]);\r\n\r\n  useEffect(() => {\r\n    let timeoutId: number;\r\n\r\n    if (isActive && !loop && duration > 0) {\r\n      timeoutId = window.setTimeout(() => {\r\n        setIsActive(false);\r\n      }, duration);\r\n    }\r\n\r\n    return () => {\r\n      if (timeoutId) window.clearTimeout(timeoutId);\r\n    };\r\n  }, [isActive, duration, loop]);\r\n\r\n  if (!isActive) return null;\r\n\r\n  const colors = [\r\n    \"bg-blue-500\",\r\n    \"bg-green-500\",\r\n    \"bg-yellow-500\",\r\n    \"bg-red-500\",\r\n    \"bg-purple-500\",\r\n    \"bg-pink-500\",\r\n  ];\r\n\r\n  return (\r\n    <div\r\n      className=\"fixed inset-0 pointer-events-none overflow-hidden\"\r\n      style={{ zIndex }}\r\n    >\r\n      {[...Array(50)].map((_, i) => {\r\n        const randomColor = colors[Math.floor(Math.random() * colors.length)];\r\n        const randomX = Math.random() * 100;\r\n        const randomDelay = Math.random() * 0.5;\r\n        const randomDuration = 2 + Math.random() * 2;\r\n        const randomRotation = Math.random() * 360;\r\n\r\n        return (\r\n          <motion.div\r\n            key={i}\r\n            className={`absolute w-3 h-3 ${randomColor} rounded-sm`}\r\n            initial={{\r\n              top: \"-10%\",\r\n              left: `${randomX}%`,\r\n              opacity: 1,\r\n              rotate: 0,\r\n            }}\r\n            animate={{\r\n              top: \"110%\",\r\n              opacity: 0,\r\n              rotate: randomRotation,\r\n            }}\r\n            transition={{\r\n              duration: randomDuration,\r\n              delay: randomDelay,\r\n              ease: \"easeIn\",\r\n              repeat: loop ? Infinity : 0,\r\n            }}\r\n          />\r\n        );\r\n      })}\r\n    </div>\r\n  );\r\n};\r\n\r\nconst ShiningText = ({ text }: { text: string }) => {\r\n  return (\r\n    <motion.h1\r\n      className=\"bg-[linear-gradient(110deg,#404040,35%,#fff,50%,#404040,75%,#404040)] bg-[length:200%_100%] bg-clip-text text-base font-regular text-transparent\"\r\n      initial={{ backgroundPosition: \"200% 0\" }}\r\n      animate={{ backgroundPosition: \"-200% 0\" }}\r\n      transition={{\r\n        repeat: Infinity,\r\n        duration: 2,\r\n        ease: \"linear\",\r\n      }}\r\n    >\r\n      {text}\r\n    </motion.h1>\r\n  );\r\n};\r\n\r\ninterface SaleCompletedScreenProps {\r\n  total: number;\r\n  paymentMethod: string;\r\n  onNewSale: () => void;\r\n  valorRecebido?: number | null;\r\n  troco?: number | null;\r\n}\r\n\r\nconst SaleCompletedScreen = ({\r\n  total,\r\n  paymentMethod,\r\n  onNewSale,\r\n  valorRecebido,\r\n  troco,\r\n}: SaleCompletedScreenProps) => {\r\n  const [orderId] = useState(() => Math.floor(Math.random() * 10000));\r\n  const [showConfetti, setShowConfetti] = useState(false);\r\n  const [showContent, setShowContent] = useState(false);\r\n\r\n  useEffect(() => {\r\n    setShowConfetti(true);\r\n    setTimeout(() => setShowContent(true), 300);\r\n\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      if (e.key === \"Escape\") {\r\n        onNewSale();\r\n      }\r\n    };\r\n\r\n    window.addEventListener(\"keydown\", handleKeyDown);\r\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\r\n  }, [onNewSale]);\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 dark:from-green-950 dark:via-emerald-950 dark:to-teal-950 flex items-center justify-center p-4 overflow-y-auto\">\r\n      <Confetti\r\n        isActive={showConfetti}\r\n        duration={5000}\r\n        loop={false}\r\n        zIndex={100}\r\n      />\r\n\r\n      <motion.div\r\n        initial={{ scale: 0.8, opacity: 0 }}\r\n        animate={{ scale: 1, opacity: 1 }}\r\n        transition={{ duration: 0.5, ease: \"easeOut\" }}\r\n        className=\"max-w-lg w-full my-auto\"\r\n      >\r\n        <div className=\"bg-white dark:bg-zinc-900 rounded-3xl shadow-2xl overflow-hidden border border-green-100 dark:border-green-900/30\">\r\n          {/* Header Section */}\r\n          <div className=\"bg-gradient-to-r from-green-500 to-emerald-600 p-6 text-center relative overflow-hidden\">\r\n            <motion.div\r\n              initial={{ scale: 0 }}\r\n              animate={{ scale: 1 }}\r\n              transition={{ delay: 0.2, type: \"spring\", stiffness: 200 }}\r\n              className=\"inline-block\"\r\n            >\r\n              <div className=\"bg-white dark:bg-zinc-900 rounded-full p-3 mb-4 inline-block\">\r\n                <CheckCircle2 className=\"w-12 h-12 text-green-500\" />\r\n              </div>\r\n            </motion.div>\r\n\r\n            <motion.h1\r\n              initial={{ y: 20, opacity: 0 }}\r\n              animate={{ y: 0, opacity: 1 }}\r\n              transition={{ delay: 0.4 }}\r\n              className=\"text-2xl sm:text-3xl font-bold text-white mb-2\"\r\n            >\r\n              Venda Conclu├¡da!\r\n            </motion.h1>\r\n\r\n            <motion.p\r\n              initial={{ y: 20, opacity: 0 }}\r\n              animate={{ y: 0, opacity: 1 }}\r\n              transition={{ delay: 0.5 }}\r\n              className=\"text-green-100 text-base sm:text-lg\"\r\n            >\r\n              Parab├®ns pela sua venda!\r\n            </motion.p>\r\n\r\n            {/* Decorative elements */}\r\n            <motion.div\r\n              animate={{\r\n                rotate: 360,\r\n              }}\r\n              transition={{\r\n                duration: 20,\r\n                repeat: Infinity,\r\n                ease: \"linear\",\r\n              }}\r\n              className=\"absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full\"\r\n            />\r\n            <motion.div\r\n              animate={{\r\n                rotate: -360,\r\n              }}\r\n              transition={{\r\n                duration: 15,\r\n                repeat: Infinity,\r\n                ease: \"linear\",\r\n              }}\r\n              className=\"absolute -bottom-10 -left-10 w-32 h-32 bg-white/10 rounded-full\"\r\n            />\r\n          </div>\r\n\r\n          {/* Content Section */}\r\n          {showContent && (\r\n            <div className=\"p-5 sm:p-6\">\r\n              {/* Order Details */}\r\n              <motion.div\r\n                initial={{ y: 20, opacity: 0 }}\r\n                animate={{ y: 0, opacity: 1 }}\r\n                transition={{ delay: 0.6 }}\r\n                className=\"bg-gradient-to-br from-gray-50 to-gray-100 dark:from-zinc-800 dark:to-zinc-900 rounded-2xl p-4 mb-5\"\r\n              >\r\n                <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4 sm:gap-0 mb-4\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <div className=\"bg-green-100 dark:bg-green-900/30 p-2 rounded-full\">\r\n                      <Package className=\"w-5 h-5 text-green-600 dark:text-green-400\" />\r\n                    </div>\r\n                    <div>\r\n                      <p className=\"text-xs text-gray-500 dark:text-gray-400\">\r\n                        N├║mero do Pedido\r\n                      </p>\r\n                      <p className=\"text-base font-bold text-gray-800 dark:text-gray-100\">\r\n                        #VND-{orderId}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"text-left sm:text-right pl-10 sm:pl-0\">\r\n                    <p className=\"text-xs text-gray-500 dark:text-gray-400\">\r\n                      Total\r\n                    </p>\r\n                    <p className=\"text-xl font-bold text-green-600 dark:text-green-400\">\r\n                      R$ {total.toFixed(2)}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"border-t border-gray-200 dark:border-zinc-700 pt-4\">\r\n                  <div className=\"flex items-center gap-3 mb-3\">\r\n                    <CreditCard className=\"w-5 h-5 text-gray-400 dark:text-gray-500\" />\r\n                    <div className=\"flex-1\">\r\n                      <p className=\"text-xs text-gray-600 dark:text-gray-400\">\r\n                        M├®todo de Pagamento\r\n                      </p>\r\n                      <p className=\"font-semibold text-sm text-gray-800 dark:text-gray-100 capitalize\">\r\n                        {paymentMethod}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {paymentMethod === \"dinheiro\" &&\r\n                    valorRecebido !== null &&\r\n                    valorRecebido !== undefined && (\r\n                      <div className=\"grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-dashed border-gray-200 dark:border-zinc-700\">\r\n                        <div>\r\n                          <p className=\"text-xs text-gray-500 dark:text-gray-400\">\r\n                            Valor Recebido\r\n                          </p>\r\n                          <p className=\"text-sm font-semibold text-gray-700 dark:text-gray-300\">\r\n                            R$ {valorRecebido.toFixed(2)}\r\n                          </p>\r\n                        </div>\r\n                        {troco !== null && troco !== undefined && (\r\n                          <div className=\"text-right\">\r\n                            <p className=\"text-xs text-blue-500 font-medium\">\r\n                              Troco\r\n                            </p>\r\n                            <p className=\"text-lg font-bold text-blue-600 dark:text-blue-400\">\r\n                              R$ {troco.toFixed(2)}\r\n                            </p>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    )}\r\n                </div>\r\n              </motion.div>\r\n\r\n              {/* Success Messages */}\r\n              <motion.div\r\n                initial={{ y: 20, opacity: 0 }}\r\n                animate={{ y: 0, opacity: 1 }}\r\n                transition={{ delay: 0.7 }}\r\n                className=\"space-y-3 mb-6\"\r\n              >\r\n                <div className=\"flex items-start gap-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-100 dark:border-green-900/30\">\r\n                  <Sparkles className=\"w-5 h-5 text-green-600 dark:text-green-400 mt-0.5 flex-shrink-0\" />\r\n                  <div>\r\n                    <p className=\"font-semibold text-sm text-green-900 dark:text-green-100\">\r\n                      Sucesso Absoluto!\r\n                    </p>\r\n                    <p className=\"text-xs text-green-700 dark:text-green-300\">\r\n                      Venda registrada e estoque atualizado.\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </motion.div>\r\n\r\n              {/* Action Buttons */}\r\n              <motion.div\r\n                initial={{ y: 20, opacity: 0 }}\r\n                animate={{ y: 0, opacity: 1 }}\r\n                transition={{ delay: 0.9 }}\r\n                className=\"flex gap-3\"\r\n              >\r\n                <button\r\n                  onClick={onNewSale}\r\n                  className=\"w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold py-3 px-6 rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 text-sm sm:text-base\"\r\n                >\r\n                  Nova Venda (ESC)\r\n                </button>\r\n              </motion.div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </motion.div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default SaleCompletedScreen;\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\admin\\_components\\dashboard-client.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CardHeader' is defined but never used.","line":9,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CardTitle' is defined but never used.","line":9,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'session' is assigned a value but never used.","line":12,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":24}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { PageHeader } from \"@/components/ui/page-header\";\r\nimport { AnimatedLoadingSkeleton } from \"@/components/ui/loading\";\r\nimport { useAdminDashboard } from \"@/hooks/use-admin-dashboard\";\r\nimport { StatsCards, StockAlerts, QuickAccess } from \"./parts\";\r\nimport { useSession } from \"next-auth/react\";\r\nimport { AlertTriangle } from \"lucide-react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\n\r\nexport default function DashboardClient() {\r\n  const { data: session } = useSession();\r\n  const { produtosEstoqueBaixo, lotesVencimentoProximo, stats, loading } =\r\n    useAdminDashboard();\r\n\r\n  const getExpirationAlert = () => {\r\n    // Usar dados da API se dispon├¡veis (mais confi├ível) ou fallback para sess├úo\r\n    // Se stats for null (carregando ou erro), n├úo mostra nada por enquanto\r\n    if (\r\n      !stats ||\r\n      stats.diasParaVencimento === null ||\r\n      stats.diasParaVencimento === undefined\r\n    )\r\n      return null;\r\n\r\n    const diffDays = stats.diasParaVencimento;\r\n\r\n    // ALERTA AMARELO: Pr├│ximo do vencimento (1 a 7 dias)\r\n    if (diffDays <= 7 && diffDays > 0) {\r\n      return (\r\n        <Card className=\"mb-6 border-l-4 border-l-yellow-500 bg-yellow-50 dark:bg-yellow-900/10 border-y-yellow-200 border-r-yellow-200 dark:border-y-yellow-900/30 dark:border-r-yellow-900/30\">\r\n          <CardContent className=\"p-4 flex items-start gap-4\">\r\n            <div className=\"p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded-full\">\r\n              <AlertTriangle className=\"h-6 w-6 text-yellow-600 dark:text-yellow-500\" />\r\n            </div>\r\n            <div className=\"space-y-1\">\r\n              <h3 className=\"font-bold text-yellow-800 dark:text-yellow-500 text-lg\">\r\n                Aten├º├úo: Assinatura Expirando\r\n              </h3>\r\n              <p className=\"text-yellow-700 dark:text-yellow-400/90\">\r\n                Sua assinatura expira em{\" \"}\r\n                <span className=\"font-bold\">{diffDays} dias</span>. Renove para\r\n                evitar o bloqueio.\r\n              </p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      );\r\n    }\r\n\r\n    // ALERTA VERMELHO: Vencido (<= 0)\r\n    if (diffDays <= 0) {\r\n      return (\r\n        <Card className=\"mb-6 border-l-4 border-l-red-500 bg-red-50 dark:bg-red-900/10 border-y-red-200 border-r-red-200 dark:border-y-red-900/30 dark:border-r-red-900/30\">\r\n          <CardContent className=\"p-4 flex items-start gap-4\">\r\n            <div className=\"p-2 bg-red-100 dark:bg-red-900/30 rounded-full\">\r\n              <AlertTriangle className=\"h-6 w-6 text-red-600 dark:text-red-500\" />\r\n            </div>\r\n            <div className=\"space-y-1\">\r\n              <h3 className=\"font-bold text-red-800 dark:text-red-500 text-lg\">\r\n                Plano Vencido!\r\n              </h3>\r\n              <p className=\"text-red-700 dark:text-red-400/90\">\r\n                O pagamento da sua mensalidade n├úo foi identificado. Voc├¬\r\n                perder├í o acesso em{\" \"}\r\n                <span className=\"font-bold\">\r\n                  {Math.max(0, 10 + diffDays)} dias\r\n                </span>\r\n                . Entre em contato com o suporte.\r\n              </p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      );\r\n    }\r\n\r\n    return null;\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"container mx-auto py-10\">\r\n        <AnimatedLoadingSkeleton />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {getExpirationAlert()}\r\n      <PageHeader title=\"Dashboard\" description=\"Vis├úo geral do sistema\" />\r\n\r\n      {/* KPI Cards first as requested */}\r\n      <StatsCards stats={stats} />\r\n\r\n      <QuickAccess />\r\n\r\n      <StockAlerts\r\n        produtosEstoqueBaixo={produtosEstoqueBaixo}\r\n        lotesVencimentoProximo={lotesVencimentoProximo}\r\n        topLowStock={stats?.topLowStock}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\admin\\assinatura\\cancel\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[999,1002],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[999,1002],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":54,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1612,1615],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1612,1615],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2107,2110],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2107,2110],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { asaas } from \"@/lib/asaas\";\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session?.user?.email) {\r\n      return NextResponse.json({ error: \"N├úo autenticado\" }, { status: 401 });\r\n    }\r\n\r\n    // Buscar usu├írio e empresa\r\n    const user = await prisma.user.findUnique({\r\n      where: { email: session.user.email },\r\n      include: { empresa: true },\r\n    });\r\n\r\n    if (!user || user.role !== \"admin\") {\r\n      return NextResponse.json(\r\n        { error: \"Apenas administradores podem cancelar a assinatura\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    if (!user.empresa) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo encontrada\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    const { empresa } = user as any;\r\n\r\n    if (!empresa.asaasSubscriptionId) {\r\n      return NextResponse.json(\r\n        { error: \"Assinatura n├úo encontrada no Asaas\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json().catch(() => ({}));\r\n    const { motivo } = body;\r\n\r\n    // Cancelar assinatura no Asaas\r\n    console.log(\"­ƒùæ´©Å Cancelando assinatura:\", empresa.asaasSubscriptionId);\r\n    await asaas.cancelSubscription(empresa.asaasSubscriptionId);\r\n\r\n    // Registrar motivo do cancelamento\r\n    // Verifica se tabela Cancelamento existe no prisma client gerado\r\n    try {\r\n      const prismaAny = prisma as any;\r\n      await prismaAny.cancelamento.create({\r\n        data: {\r\n          empresaId: empresa.id,\r\n          motivo: motivo || \"Motivo n├úo informado\",\r\n        },\r\n      });\r\n    } catch (e) {\r\n      console.warn(\r\n        \"ÔÜá´©Å Erro ao salvar motivo de cancelamento (pode ser problema de sync do prisma):\",\r\n        e\r\n      );\r\n    }\r\n\r\n    // Atualizar status para CANCELADO\r\n    await prisma.empresa.update({\r\n      where: { id: empresa.id },\r\n      data: {\r\n        status: \"CANCELADO\" as any,\r\n      },\r\n    });\r\n\r\n    console.log(\"Ô£à Assinatura cancelada para empresa:\", empresa.nome);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message:\r\n        \"Assinatura cancelada com sucesso. O acesso continua at├® o fim do per├¡odo pago.\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"ÔØî Erro ao cancelar assinatura:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        error:\r\n          error instanceof Error\r\n            ? error.message\r\n            : \"Erro ao cancelar assinatura\",\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\admin\\assinatura\\info\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'req' is defined but never used.","line":7,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { asaas } from \"@/lib/asaas\";\r\n\r\nexport async function GET(req: NextRequest) {\r\n  const session = await getServerSession(authOptions);\r\n\r\n  if (\r\n    !session ||\r\n    (session.user.role !== \"admin\" && session.user.role !== \"master\")\r\n  ) {\r\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n  }\r\n\r\n  const empresaId = session.user.empresaId;\r\n  if (!empresaId) {\r\n    return NextResponse.json(\r\n      { error: \"Empresa n├úo encontrada\" },\r\n      { status: 404 }\r\n    );\r\n  }\r\n\r\n  try {\r\n    const empresa = await prisma.empresa.findUnique({\r\n      where: { id: empresaId },\r\n    });\r\n\r\n    if (!empresa) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo encontrada\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (!empresa.asaasSubscriptionId) {\r\n      // Se n├úo tem assinatura Asaas (legado ou erro), retorna nulo mas sucesso\r\n      return NextResponse.json({\r\n        status: empresa.status,\r\n        vencimentoPlano: empresa.vencimentoPlano,\r\n        plano: empresa.plano || \"PRO\",\r\n        subscription: null,\r\n        billing: null,\r\n        history: [],\r\n      });\r\n    }\r\n\r\n    // Buscar info atual da assinatura (fatura aberta)\r\n    const billingInfo = await asaas.getSubscriptionBillingInfo(\r\n      empresa.asaasSubscriptionId\r\n    );\r\n\r\n    // Buscar hist├│rico\r\n    const history = await asaas.listPaymentHistory(empresa.asaasSubscriptionId);\r\n\r\n    return NextResponse.json({\r\n      status: empresa.status,\r\n      vencimentoPlano: empresa.vencimentoPlano,\r\n      plano: empresa.plano || \"PRO\",\r\n      subscription: {\r\n        id: empresa.asaasSubscriptionId,\r\n      },\r\n      billing: billingInfo,\r\n      history,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Erro ao buscar dados da assinatura:\", error);\r\n    return NextResponse.json({ error: \"Erro interno\" }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\admin\\categories\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'request' is defined but never used.","line":6,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":47}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session?.user?.empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado ou empresa n├úo identificada\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const categories = await prisma.category.findMany({\r\n      where: {\r\n        empresaId: session.user.empresaId,\r\n      },\r\n      orderBy: {\r\n        nome: \"asc\",\r\n      },\r\n    });\r\n\r\n    return NextResponse.json(categories);\r\n  } catch (error) {\r\n    console.error(\"Erro ao buscar categorias:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno ao buscar categorias\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (\r\n      !session?.user ||\r\n      (session.user.role !== \"admin\" && session.user.role !== \"master\" && session.user.role !== \"gerente\")\r\n    ) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            \"Acesso negado. Apenas administradores podem criar categorias.\",\r\n        },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const empresaId = session.user.empresaId;\r\n\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { nome } = body;\r\n\r\n    if (!nome || typeof nome !== \"string\" || nome.trim() === \"\") {\r\n      return NextResponse.json(\r\n        { error: \"O nome da categoria ├® obrigat├│rio\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verificar duplicidade\r\n    const existingCategory = await prisma.category.findFirst({\r\n      where: {\r\n        empresaId,\r\n        nome: {\r\n          equals: nome.trim(),\r\n          mode: \"insensitive\",\r\n        },\r\n      },\r\n    });\r\n\r\n    if (existingCategory) {\r\n      return NextResponse.json(\r\n        { error: \"J├í existe uma categoria com este nome\" },\r\n        { status: 409 }\r\n      );\r\n    }\r\n\r\n    const category = await prisma.category.create({\r\n      data: {\r\n        nome: nome.trim(),\r\n        empresaId,\r\n      },\r\n    });\r\n\r\n    return NextResponse.json(category, { status: 201 });\r\n  } catch (error) {\r\n    console.error(\"Erro ao criar categoria:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno ao criar categoria\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\admin\\estoque-baixo\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'request' is defined but never used.","line":9,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":47}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n// GET - Listar produtos com estoque baixo (estoqueAtual <= estoqueMinimo)\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (\r\n      !session ||\r\n      (session.user.role !== \"admin\" && session.user.role !== \"master\" && session.user.role !== \"gerente\")\r\n    ) {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas administradores.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const empresaId = session.user.empresaId;\r\n\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Buscar produtos onde estoqueAtual <= estoqueMinimo\r\n    const produtosEstoqueBaixo = await prisma.$queryRaw`\r\n      SELECT \r\n        id,\r\n        nome,\r\n        sku,\r\n        preco_venda as \"precoVenda\",\r\n        estoque_atual as \"estoqueAtual\",\r\n        estoque_minimo as \"estoqueMinimo\",\r\n        imagem_url as \"imagemUrl\",\r\n        created_at as \"createdAt\",\r\n        updated_at as \"updatedAt\"\r\n      FROM products\r\n      WHERE empresa_id = ${empresaId}\r\n      AND estoque_atual <= estoque_minimo\r\n      ORDER BY (estoque_minimo - estoque_atual) DESC\r\n    `;\r\n\r\n    return NextResponse.json(produtosEstoqueBaixo);\r\n  } catch (error) {\r\n    console.error(\"Erro ao buscar produtos com estoque baixo:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro ao buscar produtos com estoque baixo\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\admin\\lotes\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":86,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2319,2322],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2319,2322],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":247,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":247,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6791,6794],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6791,6794],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":434,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":434,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11593,11596],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11593,11596],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":501,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":501,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13386,13389],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13386,13389],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n/**\r\n * GET /api/admin/lotes\r\n * Retorna todos os lotes de um produto espec├¡fico ou todos os lotes da empresa\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session?.user || session.user.role !== \"admin\" && session.user.role !== \"master\" && session.user.role !== \"gerente\") {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas administradores\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const empresaId = session.user.empresaId;\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const produtoId = searchParams.get(\"produtoId\");\r\n\r\n    let lotes;\r\n\r\n    if (produtoId) {\r\n      // Buscar lotes de um produto espec├¡fico\r\n      lotes = await prisma.lote.findMany({\r\n        where: {\r\n          produtoId,\r\n          produto: {\r\n            empresaId,\r\n          },\r\n        },\r\n        include: {\r\n          produto: {\r\n            select: {\r\n              nome: true,\r\n              sku: true,\r\n              estoqueMinimo: true,\r\n              estoqueAtual: true,\r\n            },\r\n          },\r\n        },\r\n        orderBy: {\r\n          dataValidade: \"asc\",\r\n        },\r\n      });\r\n    } else {\r\n      // Buscar todos os lotes da empresa\r\n      lotes = await prisma.lote.findMany({\r\n        where: {\r\n          produto: {\r\n            empresaId,\r\n          },\r\n        },\r\n        include: {\r\n          produto: {\r\n            select: {\r\n              nome: true,\r\n              sku: true,\r\n              estoqueMinimo: true,\r\n              estoqueAtual: true,\r\n            },\r\n          },\r\n        },\r\n        orderBy: [{ produto: { nome: \"asc\" } }, { dataValidade: \"asc\" }],\r\n      });\r\n    }\r\n\r\n    // Verificar lotes vencidos ou pr├│ximos do vencimento\r\n    const hoje = new Date();\r\n    const trintaDias = new Date();\r\n    trintaDias.setDate(hoje.getDate() + 30);\r\n\r\n    const lotesComStatus = lotes.map((lote: any) => {\r\n      let status = \"sem_validade\";\r\n      let diasParaVencer = null;\r\n\r\n      if (lote.quantidade === 0) {\r\n        status = \"esgotado\";\r\n      } else if (lote.dataValidade) {\r\n        const dataValidade = new Date(lote.dataValidade);\r\n        status = \"normal\";\r\n\r\n        if (dataValidade < hoje) {\r\n          status = \"vencido\";\r\n        } else if (dataValidade <= trintaDias) {\r\n          status = \"proximo_vencimento\";\r\n        }\r\n\r\n        diasParaVencer = Math.ceil(\r\n          (dataValidade.getTime() - hoje.getTime()) / (1000 * 60 * 60 * 24)\r\n        );\r\n      }\r\n\r\n      return {\r\n        ...lote,\r\n        status,\r\n        diasParaVencer,\r\n      };\r\n    });\r\n\r\n    return NextResponse.json(lotesComStatus);\r\n  } catch (error) {\r\n    console.error(\"Erro ao buscar lotes:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno do servidor\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/admin/lotes\r\n * Cria um novo lote e adiciona estoque ao produto\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session?.user || session.user.role !== \"admin\" && session.user.role !== \"master\" && session.user.role !== \"gerente\") {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas administradores\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const empresaId = session.user.empresaId;\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const {\r\n      produtoId,\r\n      numeroLote,\r\n      dataValidade,\r\n      quantidade,\r\n      precoCompra,\r\n      dataCompra,\r\n    } = body;\r\n\r\n    // Valida├º├Áes\r\n    if (!produtoId || !quantidade) {\r\n      return NextResponse.json(\r\n        { error: \"Produto e Quantidade s├úo obrigat├│rios\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Gerar n├║mero do lote se n├úo fornecido\r\n    let finalNumeroLote = numeroLote;\r\n    if (!finalNumeroLote || finalNumeroLote.trim() === \"\") {\r\n      const date = new Date();\r\n      const year = date.getFullYear();\r\n      const month = String(date.getMonth() + 1).padStart(2, \"0\");\r\n      const day = String(date.getDate()).padStart(2, \"0\");\r\n      const random = Math.floor(Math.random() * 10000)\r\n        .toString()\r\n        .padStart(4, \"0\");\r\n      finalNumeroLote = `LOTE${year}${month}${day}-${random}`;\r\n    }\r\n\r\n    if (quantidade <= 0) {\r\n      return NextResponse.json(\r\n        { error: \"Quantidade deve ser maior que zero\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verificar se o produto existe e pertence ├á empresa\r\n    const product = await prisma.product.findFirst({\r\n      where: {\r\n        id: produtoId,\r\n        empresaId,\r\n      },\r\n    });\r\n\r\n    if (!product) {\r\n      return NextResponse.json(\r\n        { error: \"Produto n├úo encontrado ou n├úo pertence ├á sua empresa\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Validar data de validade APENAS SE FORNECIDA\r\n    let dataValidadeDate: Date | null = null;\r\n    if (dataValidade) {\r\n      dataValidadeDate = new Date(dataValidade + \"T12:00:00Z\");\r\n      const hoje = new Date();\r\n      hoje.setHours(0, 0, 0, 0);\r\n\r\n      if (dataValidadeDate < hoje) {\r\n        return NextResponse.json(\r\n          { error: \"Data de validade n├úo pode estar no passado\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    const custoLote = Number(precoCompra || 0);\r\n\r\n    // Validar se dataCompra ├® futura\r\n    if (dataCompra) {\r\n      const dataCompraDate = new Date(dataCompra + \"T12:00:00Z\");\r\n      const hoje = new Date();\r\n      hoje.setHours(23, 59, 59, 999); // Considerar o final do dia de hoje\r\n\r\n      if (dataCompraDate > hoje) {\r\n        return NextResponse.json(\r\n          { error: \"Data de compra n├úo pode ser futura\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Verificar se o usu├írio existe para evitar erro de FK\r\n    const userExists = await prisma.user.findUnique({\r\n      where: { id: session.user.id },\r\n    });\r\n\r\n    if (!userExists) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            \"Usu├írio da sess├úo n├úo encontrado no banco de dados. Fa├ºa login novamente.\",\r\n        },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Criar lote e atualizar estoque em uma transa├º├úo\r\n    const result = await prisma.$transaction(async (tx: any) => {\r\n      // 1. Calcular Custo M├®dio Ponderado\r\n      // F├│rmula: ((QtdAtual * CustoAtual) + (QtdLote * CustoLote)) / (QtdAtual + QtdLote)\r\n      const qtdAtual = product.estoqueAtual;\r\n      const custoAtual = Number(product.precoCompra);\r\n\r\n      let novoCustoMedio = custoAtual;\r\n      const novaQtdTotal = qtdAtual + quantidade;\r\n\r\n      if (novaQtdTotal > 0) {\r\n        novoCustoMedio =\r\n          (qtdAtual * custoAtual + quantidade * custoLote) / novaQtdTotal;\r\n      }\r\n\r\n      // 2. Criar o lote\r\n      const novoLote = await tx.lote.create({\r\n        data: {\r\n          numeroLote: finalNumeroLote,\r\n          dataValidade: dataValidadeDate,\r\n          quantidade,\r\n          produtoId,\r\n          precoCompra: custoLote,\r\n          dataCompra: dataCompra\r\n            ? new Date(dataCompra + \"T12:00:00Z\")\r\n            : undefined,\r\n        },\r\n      });\r\n\r\n      // 3. Atualizar Produto (Estoque e Custo M├®dio)\r\n      await tx.product.update({\r\n        where: { id: produtoId },\r\n        data: {\r\n          estoqueAtual: novaQtdTotal,\r\n          precoCompra: novoCustoMedio,\r\n        },\r\n      });\r\n\r\n      // 4. Criar movimenta├º├úo de estoque\r\n      await tx.movimentacaoEstoque.create({\r\n        data: {\r\n          produtoId,\r\n          usuarioId: session.user.id,\r\n          empresaId,\r\n          tipo: \"ENTRADA\",\r\n          quantidade,\r\n          motivo: `Entrada de lote ${finalNumeroLote} - Custo: R$${custoLote.toFixed(\r\n            2\r\n          )}`,\r\n        },\r\n      });\r\n\r\n      return { novoLote, estoqueTotal: novaQtdTotal };\r\n    });\r\n\r\n    return NextResponse.json({\r\n      message: \"Lote criado com sucesso\",\r\n      lote: result.novoLote,\r\n      estoqueAtualizado: result.estoqueTotal,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Erro ao criar lote:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno do servidor\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * DELETE /api/admin/lotes/:id\r\n * Remove um lote (apenas se quantidade = 0)\r\n */\r\nexport async function DELETE(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session?.user || session.user.role !== \"admin\" && session.user.role !== \"master\" && session.user.role !== \"gerente\") {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas administradores\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const empresaId = session.user.empresaId;\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const loteId = searchParams.get(\"id\");\r\n\r\n    if (!loteId) {\r\n      return NextResponse.json(\r\n        { error: \"ID do lote ├® obrigat├│rio\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Buscar o lote\r\n    const lote = await prisma.lote.findFirst({\r\n      where: {\r\n        id: loteId,\r\n        produto: {\r\n          empresaId,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!lote) {\r\n      return NextResponse.json(\r\n        { error: \"Lote n├úo encontrado\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (lote.quantidade > 0) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            \"N├úo ├® poss├¡vel excluir lote com estoque. Quantidade atual: \" +\r\n            lote.quantidade,\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Excluir o lote\r\n    await prisma.lote.delete({\r\n      where: { id: loteId },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      message: \"Lote exclu├¡do com sucesso\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Erro ao excluir lote:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno do servidor\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * PUT /api/admin/lotes\r\n * Atualiza um lote existente\r\n */\r\nexport async function PUT(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session?.user || session.user.role !== \"admin\" && session.user.role !== \"master\" && session.user.role !== \"gerente\") {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas administradores\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const empresaId = session.user.empresaId;\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const {\r\n      id,\r\n      numeroLote,\r\n      dataValidade,\r\n      quantidade,\r\n      precoCompra,\r\n      dataCompra,\r\n    } = body;\r\n\r\n    if (!id) {\r\n      return NextResponse.json(\r\n        { error: \"ID do lote ├® obrigat├│rio\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Buscar o lote atual\r\n    const loteAtual: any = await prisma.lote.findFirst({\r\n      where: {\r\n        id,\r\n        produto: {\r\n          empresaId,\r\n        },\r\n      },\r\n      include: {\r\n        produto: true,\r\n      },\r\n    });\r\n\r\n    if (!loteAtual) {\r\n      return NextResponse.json(\r\n        { error: \"Lote n├úo encontrado\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Validar nova quantidade\r\n    const novaQuantidade = parseInt(quantidade);\r\n    if (isNaN(novaQuantidade) || novaQuantidade < 0) {\r\n      return NextResponse.json(\r\n        { error: \"Quantidade inv├ílida\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validar nova data\r\n    let novaDataValidade: Date | null = null;\r\n    if (dataValidade) {\r\n      novaDataValidade = new Date(dataValidade + \"T12:00:00Z\");\r\n    }\r\n\r\n    // Calcular diferen├ºa de quantidade\r\n    const diferencaQuantidade = novaQuantidade - loteAtual.quantidade;\r\n\r\n    // Validar se dataCompra ├® futura\r\n    if (dataCompra) {\r\n      const dataCompraDate = new Date(dataCompra + \"T12:00:00Z\");\r\n      const hoje = new Date();\r\n      hoje.setHours(23, 59, 59, 999); // Considerar o final do dia de hoje\r\n\r\n      if (dataCompraDate > hoje) {\r\n        return NextResponse.json(\r\n          { error: \"Data de compra n├úo pode ser futura\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Verificar se o usu├írio existe para evitar erro de FK\r\n    const userExists = await prisma.user.findUnique({\r\n      where: { id: session.user.id },\r\n    });\r\n\r\n    if (!userExists) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            \"Usu├írio da sess├úo n├úo encontrado no banco de dados. Fa├ºa login novamente.\",\r\n        },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Atualizar em transa├º├úo\r\n    const result = await prisma.$transaction(async (tx: any) => {\r\n      // 1. Atualizar o lote\r\n      const loteAtualizado = await tx.lote.update({\r\n        where: { id },\r\n        data: {\r\n          numeroLote,\r\n          dataValidade: novaDataValidade,\r\n          quantidade: novaQuantidade,\r\n          precoCompra:\r\n            precoCompra !== undefined ? Number(precoCompra) : undefined,\r\n          dataCompra: dataCompra\r\n            ? new Date(dataCompra + \"T12:00:00Z\")\r\n            : undefined,\r\n        },\r\n      });\r\n\r\n      // 2. Detectar mudan├ºas para registrar no hist├│rico\r\n      const changes = [];\r\n      if (diferencaQuantidade !== 0) {\r\n        changes.push(\r\n          `Qtd: ${diferencaQuantidade > 0 ? \"+\" : \"\"}${diferencaQuantidade}`\r\n        );\r\n      }\r\n      if (numeroLote !== loteAtual.numeroLote) {\r\n        changes.push(`Lote: ${loteAtual.numeroLote} -> ${numeroLote}`);\r\n      }\r\n      if (\r\n        (novaDataValidade?.getTime() || 0) !==\r\n        (loteAtual.dataValidade?.getTime() || 0)\r\n      ) {\r\n        const oldDate = loteAtual.dataValidade\r\n          ? new Date(loteAtual.dataValidade).toLocaleDateString(\"pt-BR\")\r\n          : \"S/ Validade\";\r\n        const newDate = novaDataValidade\r\n          ? new Date(novaDataValidade).toLocaleDateString(\"pt-BR\")\r\n          : \"S/ Validade\";\r\n        changes.push(`Validade: ${oldDate} -> ${newDate}`);\r\n      }\r\n      if (\r\n        precoCompra !== undefined &&\r\n        Number(precoCompra) !== Number(loteAtual.precoCompra)\r\n      ) {\r\n        changes.push(\r\n          `Custo: R$${Number(loteAtual.precoCompra).toFixed(2)} -> R$${Number(\r\n            precoCompra\r\n          ).toFixed(2)}`\r\n        );\r\n      }\r\n      // Check for dataCompra changes\r\n      const newDataCompra = dataCompra\r\n        ? new Date(dataCompra + \"T12:00:00Z\")\r\n        : null;\r\n      if (\r\n        (newDataCompra?.getTime() || 0) !==\r\n        (loteAtual.dataCompra?.getTime() || 0)\r\n      ) {\r\n        const oldDate = loteAtual.dataCompra\r\n          ? new Date(loteAtual.dataCompra).toLocaleDateString(\"pt-BR\")\r\n          : \"S/ Data\";\r\n        const newDate = newDataCompra\r\n          ? new Date(newDataCompra).toLocaleDateString(\"pt-BR\")\r\n          : \"S/ Data\";\r\n        changes.push(`Compra: ${oldDate} -> ${newDate}`);\r\n      }\r\n\r\n      // 3. Atualizar estoque do produto se houve mudan├ºa na quantidade\r\n      if (diferencaQuantidade !== 0) {\r\n        await tx.product.update({\r\n          where: { id: loteAtual.produtoId },\r\n          data: {\r\n            estoqueAtual: {\r\n              increment: diferencaQuantidade,\r\n            },\r\n          },\r\n        });\r\n      }\r\n\r\n      // 4. Registrar movimenta├º├úo se houve QUALQUER altera├º├úo\r\n      if (changes.length > 0) {\r\n        await tx.movimentacaoEstoque.create({\r\n          data: {\r\n            produtoId: loteAtual.produtoId,\r\n            usuarioId: session.user.id,\r\n            empresaId,\r\n            tipo: \"AJUSTE_INVENTARIO\",\r\n            quantidade: diferencaQuantidade, // Pode ser 0 se for apenas edi├º├úo de dados\r\n            motivo: `Edi├º├úo de Lote: ${changes.join(\", \")}`,\r\n          },\r\n        });\r\n      }\r\n\r\n      return loteAtualizado;\r\n    });\r\n\r\n    return NextResponse.json({\r\n      message: \"Lote atualizado com sucesso\",\r\n      lote: result,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Erro ao atualizar lote:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno do servidor\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\admin\\movimentacoes\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1185,1188],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1185,1188],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1484,1487],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1484,1487],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2233,2236],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2233,2236],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":79,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2577,2580],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2577,2580],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":100,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3336,3339],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3336,3339],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3867,3870],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3867,3870],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":146,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":146,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4784,4787],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4784,4787],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":295,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":295,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10018,10021],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10018,10021],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":357,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":357,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11919,11922],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11919,11922],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session?.user) {\r\n      return NextResponse.json({ error: \"N├úo autorizado\" }, { status: 401 });\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const companyIdParam = searchParams.get(\"companyId\");\r\n\r\n    let empresaId = session.user.empresaId;\r\n\r\n    // Se for master e tiver companyId na query, usa o da query\r\n    if (session.user.role === \"master\" && companyIdParam) {\r\n      empresaId = companyIdParam;\r\n    }\r\n\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo encontrada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const startDate = searchParams.get(\"startDate\");\r\n    const endDate = searchParams.get(\"endDate\");\r\n    const type = searchParams.get(\"type\"); // 'VENDA', 'ENTRADA', 'PERDA', 'AJUSTE', 'TODOS'\r\n\r\n    // Filtro de Data\r\n    const dateFilter: any = {};\r\n    if (startDate && endDate) {\r\n      dateFilter.gte = new Date(startDate);\r\n      dateFilter.lte = new Date(endDate);\r\n      // Ajustar para o final do dia\r\n      dateFilter.lte.setHours(23, 59, 59, 999);\r\n    }\r\n\r\n    // 1. Buscar Vendas (Se o tipo for TODOS ou VENDA)\r\n    let sales: any[] = [];\r\n    if (!type || type === \"TODOS\" || type === \"VENDA\") {\r\n      sales = await prisma.sale.findMany({\r\n        where: {\r\n          empresaId,\r\n          dataHora: startDate && endDate ? dateFilter : undefined,\r\n        },\r\n        include: {\r\n          user: {\r\n            select: { name: true, email: true },\r\n          },\r\n          saleItems: {\r\n            include: {\r\n              product: {\r\n                select: { nome: true, sku: true },\r\n              },\r\n            },\r\n          },\r\n        },\r\n        orderBy: { dataHora: \"desc\" },\r\n      });\r\n    }\r\n\r\n    // 2. Buscar Movimenta├º├Áes de Estoque (Se o tipo for TODOS ou OUTROS)\r\n    // Mapeamento de filtros do frontend para tipos do banco\r\n    let stockMovementTypes: any = undefined;\r\n    if (type && type !== \"TODOS\" && type !== \"VENDA\") {\r\n      if (type === \"ENTRADA\") stockMovementTypes = \"ENTRADA\";\r\n      if (type === \"PERDA\") stockMovementTypes = \"AJUSTE_QUEBRA\"; // Assumindo que PERDA = AJUSTE_QUEBRA\r\n      if (type === \"AJUSTE\") stockMovementTypes = \"AJUSTE_INVENTARIO\";\r\n    }\r\n\r\n    let movements: any[] = [];\r\n    if (!type || type === \"TODOS\" || type !== \"VENDA\") {\r\n      movements = await prisma.movimentacaoEstoque.findMany({\r\n        where: {\r\n          empresaId,\r\n          tipo: stockMovementTypes ? stockMovementTypes : { not: \"VENDA\" }, // Ignora vendas aqui pois j├í buscamos na tabela Sale\r\n          dataMovimentacao: startDate && endDate ? dateFilter : undefined,\r\n        },\r\n        include: {\r\n          produto: {\r\n            select: { nome: true, sku: true },\r\n          },\r\n          usuario: {\r\n            select: { name: true, email: true },\r\n          },\r\n        },\r\n        orderBy: { dataMovimentacao: \"desc\" },\r\n      });\r\n    }\r\n\r\n    // 3. Buscar Movimenta├º├Áes de Caixa (Se o tipo for TODOS ou OUTROS)\r\n    let cashMovements: any[] = [];\r\n    if (!type || type === \"TODOS\" || type !== \"VENDA\") {\r\n      cashMovements = await prisma.movimentacaoCaixa.findMany({\r\n        where: {\r\n          caixa: {\r\n            empresaId,\r\n          },\r\n          dataHora: startDate && endDate ? dateFilter : undefined,\r\n        },\r\n        include: {\r\n          usuario: {\r\n            select: { name: true, email: true },\r\n          },\r\n        },\r\n        orderBy: { dataHora: \"desc\" },\r\n      });\r\n    }\r\n\r\n    // 4. Buscar Fechamentos de Caixa\r\n    let closedCaixas: any[] = [];\r\n    if (!type || type === \"TODOS\" || type !== \"VENDA\") {\r\n      closedCaixas = await prisma.caixa.findMany({\r\n        where: {\r\n          empresaId,\r\n          status: \"FECHADO\",\r\n          dataFechamento: startDate && endDate ? dateFilter : undefined,\r\n        },\r\n        include: {\r\n          usuario: {\r\n            select: { name: true, email: true },\r\n          },\r\n        },\r\n        orderBy: { dataFechamento: \"desc\" },\r\n      });\r\n    }\r\n\r\n    // 5. Unificar e Padronizar\r\n    const unifiedTimeline = [\r\n      ...sales.map((sale) => ({\r\n        id: sale.id,\r\n        type: \"VENDA\",\r\n        date: sale.dataHora,\r\n        user: sale.user?.name || \"Desconhecido\",\r\n        totalValue: Number(sale.valorTotal),\r\n        amountPaid: sale.valorRecebido ? Number(sale.valorRecebido) : undefined,\r\n        change: sale.troco ? Number(sale.troco) : undefined,\r\n        items: sale.saleItems.map((item: any) => ({\r\n          productName: item.product.nome,\r\n          quantity: item.quantidade,\r\n          unitPrice: Number(item.precoUnitario),\r\n          subtotal: Number(item.subtotal),\r\n          discount: Number(item.descontoAplicado || 0),\r\n        })),\r\n        paymentMethod: sale.metodoPagamento,\r\n      })),\r\n      ...movements.map((mov) => ({\r\n        id: mov.id,\r\n        type: mov.tipo, // ENTRADA, AJUSTE_QUEBRA, etc.\r\n        date: mov.dataMovimentacao,\r\n        user: mov.usuario?.name || \"Desconhecido\",\r\n        productName: mov.produto.nome,\r\n        quantity: mov.quantidade,\r\n        reason: mov.motivo,\r\n      })),\r\n      ...cashMovements.map((mov) => ({\r\n        id: mov.id,\r\n        type: mov.tipo, // ABERTURA, SANGRIA, SUPRIMENTO\r\n        date: mov.dataHora,\r\n        user: mov.usuario?.name || \"Desconhecido\",\r\n        productName: \"Movimenta├º├úo de Caixa\", // Placeholder\r\n        quantity: 1,\r\n        totalValue: Number(mov.valor),\r\n        reason: mov.descricao,\r\n        paymentMethod: mov.metodoPagamento || null, // M├®todo de pagamento\r\n      })),\r\n      ...closedCaixas.map((caixa) => ({\r\n        id: caixa.id,\r\n        type: \"FECHAMENTO\",\r\n        date: caixa.dataFechamento,\r\n        user: caixa.usuario?.name || \"Desconhecido\",\r\n        productName: \"Fechamento de Caixa\",\r\n        quantity: 1,\r\n        totalValue: Number(caixa.saldoFinal),\r\n        reason: `Saldo Final: R$ ${Number(caixa.saldoFinal).toFixed(\r\n          2\r\n        )} | Quebra: R$ ${Number(caixa.quebraDeCaixa).toFixed(2)}`,\r\n      })),\r\n    ];\r\n\r\n    // 4. Ordenar por Data (Decrescente)\r\n    unifiedTimeline.sort(\r\n      (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()\r\n    );\r\n\r\n    return NextResponse.json(unifiedTimeline);\r\n  } catch (error) {\r\n    console.error(\"Erro ao buscar movimenta├º├Áes:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno do servidor\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/admin/movimentacoes\r\n * Cria uma nova movimenta├º├úo manual (Ajuste, Entrada, Perda)\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (\r\n      !session?.user ||\r\n      (session.user.role !== \"admin\" &&\r\n        session.user.role !== \"master\" &&\r\n        session.user.role !== \"gerente\")\r\n    ) {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas administradores\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const empresaId = session.user.empresaId;\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { produtoId, loteId, tipo, quantidade, motivo } = body;\r\n\r\n    // Valida├º├Áes b├ísicas\r\n    if (!produtoId || !tipo || !quantidade) {\r\n      return NextResponse.json(\r\n        { error: \"Produto, Tipo e Quantidade s├úo obrigat├│rios\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const qtd = Number(quantidade);\r\n    if (isNaN(qtd) || qtd <= 0) {\r\n      return NextResponse.json(\r\n        { error: \"Quantidade deve ser um n├║mero positivo\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Valida├º├úo Estrita de Lote para Sa├¡das/Perdas\r\n    if ((tipo === \"SAIDA\" || tipo === \"AJUSTE_QUEBRA\") && !loteId) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            \"├ë obrigat├│rio selecionar um Lote para registrar sa├¡das ou perdas.\",\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Determinar sinal da opera├º├úo\r\n    let multiplier = 1;\r\n    if (tipo === \"AJUSTE_QUEBRA\" || tipo === \"SAIDA\") {\r\n      multiplier = -1;\r\n    }\r\n    // Se for AJUSTE_INVENTARIO, depende do contexto, mas geralmente aqui vamos assumir que o usu├írio manda o valor absoluto e o tipo define se entra ou sai.\r\n    // Mas para simplificar, vamos assumir:\r\n    // ENTRADA: +\r\n    // AJUSTE_QUEBRA (Perda): -\r\n    // AJUSTE_INVENTARIO (Corre├º├úo): Pode ser + ou -.\r\n    // Vamos simplificar: O frontend manda o tipo.\r\n    // Se for ENTRADA -> +\r\n    // Se for SAIDA (Custom type, mapeado para AJUSTE_INVENTARIO ou similar) -> -\r\n    // Se for PERDA (AJUSTE_QUEBRA) -> -\r\n\r\n    // Vamos usar os tipos do Prisma: ENTRADA, AJUSTE_QUEBRA, AJUSTE_INVENTARIO, DEVOLUCAO, VENDA\r\n    // Mapeamento l├│gico:\r\n    // ENTRADA -> +\r\n    // AJUSTE_QUEBRA -> -\r\n    // DEVOLUCAO -> +\r\n    // AJUSTE_INVENTARIO -> Pode ser + ou -. O usu├írio deve especificar se ├® entrada ou sa├¡da no frontend, ou mandamos o sinal na quantidade?\r\n    // Vamos assumir que o frontend manda a quantidade POSITIVA e o tipo define o sinal.\r\n    // Para AJUSTE_INVENTARIO, vamos precisar de um subtipo ou sinal expl├¡cito.\r\n    // Vamos assumir que AJUSTE_INVENTARIO recebido aqui ser├í tratado como \"Corre├º├úo Manual\".\r\n    // Se o usu├írio quiser tirar, ele usa \"SAIDA\" (que n├úo existe no enum, ent├úo usaremos AJUSTE_INVENTARIO com valor negativo).\r\n\r\n    // Melhor: O frontend manda \"operacao\": \"ADICIONAR\" | \"REMOVER\"\r\n    const operacao = body.operacao || \"ADICIONAR\";\r\n    if (operacao === \"REMOVER\") multiplier = -1;\r\n\r\n    const delta = qtd * multiplier;\r\n\r\n    // Transa├º├úo\r\n    const result = await prisma.$transaction(async (tx: any) => {\r\n      // 1. Verificar Produto\r\n      const produto = await tx.product.findFirst({\r\n        where: { id: produtoId, empresaId },\r\n      });\r\n\r\n      if (!produto) throw new Error(\"Produto n├úo encontrado\");\r\n\r\n      // 2. Se tiver Lote, atualizar Lote\r\n      let loteInfo = \"\";\r\n      if (loteId) {\r\n        const lote = await tx.lote.findFirst({\r\n          where: { id: loteId, produtoId },\r\n        });\r\n\r\n        if (!lote) throw new Error(\"Lote n├úo encontrado\");\r\n\r\n        // Verificar estoque negativo no lote\r\n        if (lote.quantidade + delta < 0) {\r\n          throw new Error(\r\n            `Estoque insuficiente no lote. Dispon├¡vel: ${lote.quantidade}`\r\n          );\r\n        }\r\n\r\n        await tx.lote.update({\r\n          where: { id: loteId },\r\n          data: { quantidade: { increment: delta } },\r\n        });\r\n        loteInfo = ` (Lote: ${lote.numeroLote})`;\r\n      } else {\r\n        // Se n├úo tem lote, verificar estoque negativo no produto geral (opcional, mas recomendado)\r\n        if (produto.estoqueAtual + delta < 0) {\r\n          // Permitir negativo? Geralmente n├úo.\r\n          throw new Error(\r\n            `Estoque insuficiente. Dispon├¡vel: ${produto.estoqueAtual}`\r\n          );\r\n        }\r\n      }\r\n\r\n      // 3. Atualizar Produto\r\n      await tx.product.update({\r\n        where: { id: produtoId },\r\n        data: { estoqueAtual: { increment: delta } },\r\n      });\r\n\r\n      // 4. Criar Movimenta├º├úo\r\n      const mov = await tx.movimentacaoEstoque.create({\r\n        data: {\r\n          produtoId,\r\n          usuarioId: session.user.id,\r\n          empresaId,\r\n          tipo: tipo, // ENTRADA, AJUSTE_QUEBRA, AJUSTE_INVENTARIO\r\n          quantidade: delta,\r\n          motivo: `${motivo || \"Ajuste manual\"}${loteInfo}`,\r\n          loteId: loteId || null,\r\n        },\r\n      });\r\n\r\n      return mov;\r\n    });\r\n\r\n    return NextResponse.json(result);\r\n  } catch (error: any) {\r\n    console.error(\"Erro ao criar movimenta├º├úo:\", error);\r\n    return NextResponse.json(\r\n      { error: error.message || \"Erro interno do servidor\" },\r\n      { status: 400 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\admin\\products\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2083,2086],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2083,2086],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":189,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":189,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5201,5204],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5201,5204],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { validateProductData } from \"@/lib/validation/product\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { generateUniqueSKU } from \"@/lib/product-utils\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (\r\n      !session?.user ||\r\n      (session.user.role !== \"admin\" &&\r\n        session.user.role !== \"master\" &&\r\n        session.user.role !== \"gerente\")\r\n    ) {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas administradores podem acessar.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // ­ƒöÑ MASTER MODE: Verificar se h├í companyId na query\r\n    const { searchParams } = new URL(request.url);\r\n    const companyIdParam = searchParams.get(\"companyId\");\r\n\r\n    let empresaId: string | undefined;\r\n\r\n    if (companyIdParam) {\r\n      // Se h├í companyId, VALIDAR se usu├írio ├® MASTER\r\n      if (session.user.role !== \"master\") {\r\n        return NextResponse.json(\r\n          {\r\n            error:\r\n              \"Acesso negado. Apenas usu├írios master podem visualizar dados de outras empresas.\",\r\n          },\r\n          { status: 403 }\r\n        );\r\n      }\r\n      empresaId = companyIdParam;\r\n    } else {\r\n      // Uso normal: pegar empresaId da sess├úo\r\n      empresaId = session.user.empresaId || undefined;\r\n    }\r\n\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const products = await prisma.product.findMany({\r\n      where: {\r\n        empresaId: empresaId,\r\n      },\r\n      orderBy: {\r\n        nome: \"asc\",\r\n      },\r\n      include: {\r\n        category: {\r\n          select: {\r\n            nome: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Converter Decimal para number para serializa├º├úo JSON\r\n    const serializedProducts = products.map((product: any) => {\r\n      return {\r\n        ...product,\r\n        precoCompra: Number(product.precoCompra),\r\n        precoVenda: Number(product.precoVenda),\r\n      };\r\n    });\r\n\r\n    return NextResponse.json(serializedProducts);\r\n  } catch (error) {\r\n    console.error(\"Erro ao buscar produtos:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno ao buscar produtos\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (\r\n      !session?.user ||\r\n      (session.user.role !== \"admin\" &&\r\n        session.user.role !== \"master\" &&\r\n        session.user.role !== \"gerente\")\r\n    ) {\r\n      return NextResponse.json(\r\n        {\r\n          error: \"Acesso negado. Apenas administradores podem criar produtos.\",\r\n        },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const empresaId = session.user.empresaId;\r\n\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const {\r\n      nome,\r\n      sku,\r\n      precoVenda,\r\n      precoCompra,\r\n      estoqueAtual,\r\n      estoqueMinimo,\r\n      imagemUrl,\r\n      loteInicial,\r\n      validadeInicial,\r\n      categoryId,\r\n      dataCompraInicial,\r\n    } = body;\r\n    // Validation\r\n    const validation = validateProductData(body);\r\n    if (!validation.isValid) {\r\n      return validation.response;\r\n    }\r\n\r\n    // ­ƒöÑ VALIDA├ç├âO: Verificar se j├í existe produto com mesmo nome na empresa\r\n    const existingProductByName = await prisma.product.findFirst({\r\n      where: {\r\n        nome: nome.trim(),\r\n        empresaId: empresaId,\r\n      },\r\n    });\r\n\r\n    if (existingProductByName) {\r\n      return NextResponse.json(\r\n        {\r\n          error: `J├í existe um produto chamado \"${nome}\" cadastrado nesta empresa. Use um nome diferente.`,\r\n        },\r\n        { status: 409 } // 409 Conflict\r\n      );\r\n    }\r\n\r\n    // Valida├º├úo do lote inicial\r\n    if (loteInicial !== undefined) {\r\n      const quantidadeLote = parseInt(loteInicial);\r\n      if (quantidadeLote < 0) {\r\n        return NextResponse.json(\r\n          { error: \"Quantidade do lote n├úo pode ser negativa\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      if (quantidadeLote > 0 && !validadeInicial) {\r\n        // Opcional: validar validade se necess├írio\r\n      }\r\n    }\r\n\r\n    // Gerar SKU se n├úo fornecido\r\n    let productSku = sku;\r\n    if (!productSku || productSku.trim() === \"\") {\r\n      productSku = await generateUniqueSKU(empresaId);\r\n    } else {\r\n      // Verificar se SKU j├í existe na empresa\r\n      const existingProduct = await prisma.product.findFirst({\r\n        where: { sku: productSku, empresaId },\r\n      });\r\n\r\n      if (existingProduct) {\r\n        return NextResponse.json(\r\n          { error: \"SKU j├í existe nesta empresa. Escolha outro.\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // ­ƒöÑ TRANSACTION: Criar produto + lote simultaneamente\r\n    const result = await prisma.$transaction(async (tx: any) => {\r\n      // 1. Criar o produto\r\n      const product = await tx.product.create({\r\n        data: {\r\n          nome,\r\n          sku: productSku,\r\n          precoVenda,\r\n          precoCompra: precoCompra || 0,\r\n          estoqueAtual:\r\n            loteInicial && parseInt(loteInicial) > 0\r\n              ? parseInt(loteInicial)\r\n              : estoqueAtual,\r\n          estoqueMinimo: estoqueMinimo || 5,\r\n          empresaId,\r\n          imagemUrl: imagemUrl || null,\r\n          categoryId: categoryId || null,\r\n        },\r\n      });\r\n\r\n      // 2. Se houver lote inicial, criar o lote\r\n      let lote = null;\r\n      if (loteInicial && parseInt(loteInicial) > 0) {\r\n        const quantidadeLote = parseInt(loteInicial);\r\n\r\n        // Gerar n├║mero do lote automaticamente (formato: LOTE-YYYYMMDD-XXXXX)\r\n        const dataAtual = new Date();\r\n        const dataFormatada = dataAtual\r\n          .toISOString()\r\n          .split(\"T\")[0]\r\n          .replace(/-/g, \"\");\r\n        const numeroAleatorio = Math.floor(Math.random() * 99999)\r\n          .toString()\r\n          .padStart(5, \"0\");\r\n        const numeroLote = `LOTE-${dataFormatada}-${numeroAleatorio}`;\r\n\r\n        lote = await tx.lote.create({\r\n          data: {\r\n            numeroLote,\r\n            dataValidade: validadeInicial\r\n              ? new Date(validadeInicial + \"T12:00:00Z\")\r\n              : null,\r\n            quantidade: quantidadeLote,\r\n            produtoId: product.id,\r\n            precoCompra: precoCompra || 0,\r\n            dataCompra: dataCompraInicial\r\n              ? new Date(dataCompraInicial + \"T12:00:00Z\")\r\n              : undefined,\r\n          },\r\n        });\r\n\r\n        // 3. Registrar movimenta├º├úo de entrada\r\n        await tx.movimentacaoEstoque.create({\r\n          data: {\r\n            produtoId: product.id,\r\n            usuarioId: session.user.id,\r\n            empresaId: empresaId,\r\n            tipo: \"ENTRADA\",\r\n            quantidade: quantidadeLote,\r\n            motivo: \"Estoque Inicial (Cadastro de Produto)\",\r\n          },\r\n        });\r\n      }\r\n\r\n      return { product, lote };\r\n    });\r\n\r\n    const responseMessage = result.lote\r\n      ? `Produto e lote inicial criados com sucesso! Lote: ${result.lote.numeroLote}`\r\n      : \"Produto criado com sucesso\";\r\n\r\n    return NextResponse.json({\r\n      message: responseMessage,\r\n      product: {\r\n        ...result.product,\r\n        precoVenda: Number(result.product.precoVenda),\r\n        precoCompra: Number(result.product.precoCompra),\r\n      },\r\n      lote: result.lote\r\n        ? {\r\n            ...result.lote,\r\n            dataValidade: result.lote.dataValidade\r\n              ? result.lote.dataValidade.toISOString()\r\n              : null,\r\n          }\r\n        : null,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Erro ao criar produto:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno do servidor\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\admin\\sales\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":52,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1720,1723],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1720,1723],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":91,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2677,2680],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2677,2680],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":95,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2850,2853],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2850,2853],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (\r\n      !session?.user ||\r\n      (session.user.role !== \"admin\" && session.user.role !== \"master\" && session.user.role !== \"gerente\")\r\n    ) {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas administradores podem acessar.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const queryCompanyId = searchParams.get(\"companyId\");\r\n    const startDate = searchParams.get(\"startDate\");\r\n    const endDate = searchParams.get(\"endDate\");\r\n\r\n    // ­ƒöÑ MODO DEUS: L├│gica H├¡brida (Sess├úo vs. Query Param)\r\n    let targetEmpresaId = session.user.empresaId; // Padr├úo: empresa do usu├írio logado\r\n\r\n    // Se vier um ID na URL, verifica se ├® MASTER tentando acessar\r\n    if (queryCompanyId) {\r\n      if (session.user.role !== \"master\") {\r\n        return NextResponse.json(\r\n          { error: \"Acesso Negado: Apenas Master pode filtrar por empresa.\" },\r\n          { status: 403 }\r\n        );\r\n      }\r\n      targetEmpresaId = queryCompanyId; // Sobrescreve o ID alvo\r\n    }\r\n\r\n    // Validar que o ID alvo existe\r\n    if (!targetEmpresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const empresaId = targetEmpresaId;\r\n\r\n    // Filtro de data se fornecido - SEMPRE incluir empresaId\r\n    const dateFilter: any = {\r\n      empresaId: empresaId, // SEMPRE filtrar por empresa\r\n    };\r\n    if (startDate && endDate) {\r\n      const start = new Date(`${startDate}T00:00:00.000`);\r\n      const end = new Date(`${endDate}T23:59:59.999`);\r\n\r\n      dateFilter.dataHora = {\r\n        gte: start,\r\n        lte: end,\r\n      };\r\n    }\r\n\r\n    const sales = await prisma.sale.findMany({\r\n      where: dateFilter,\r\n      include: {\r\n        user: {\r\n          select: {\r\n            nome: true,\r\n            name: true,\r\n          },\r\n        },\r\n        saleItems: {\r\n          include: {\r\n            product: {\r\n              select: {\r\n                precoCompra: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n      orderBy: {\r\n        dataHora: \"desc\",\r\n      },\r\n      take: 50, // Limitar a 50 vendas mais recentes\r\n    });\r\n\r\n    // Converter Decimal para number, calcular lucro e formatar dados\r\n    const salesFormatted = sales.map((sale: any) => {\r\n      const valorTotal = Number(sale.valorTotal);\r\n\r\n      // Calcular custo total da venda\r\n      const custoTotal = sale.saleItems.reduce((total: number, item: any) => {\r\n        const custoItem =\r\n          item.quantidade * Number(item.product?.precoCompra || 0);\r\n        return total + custoItem;\r\n      }, 0);\r\n\r\n      const lucro = valorTotal - custoTotal;\r\n      const margem = valorTotal > 0 ? (lucro / valorTotal) * 100 : 0;\r\n\r\n      return {\r\n        id: sale.id,\r\n        dataHora: sale.dataHora.toISOString(),\r\n        valorTotal,\r\n        custoTotal,\r\n        lucro,\r\n        margem,\r\n        metodoPagamento: sale.metodoPagamento,\r\n        user: {\r\n          nome: sale.user?.nome || sale.user?.name || \"N/A\",\r\n        },\r\n      };\r\n    });\r\n\r\n    return NextResponse.json(salesFormatted);\r\n  } catch (error) {\r\n    console.error(\"Erro ao buscar vendas:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno do servidor\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\company\\status\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[390,393],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[390,393],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[629,632],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[629,632],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\n\r\nexport async function GET() {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session?.user?.empresaId) {\r\n      return NextResponse.json({ status: null });\r\n    }\r\n\r\n    const empresa: any = await prisma.empresa.findUnique({\r\n      where: { id: session.user.empresaId },\r\n      select: {\r\n        status: true,\r\n        vencimentoPlano: true,\r\n        plano: true,\r\n        liberacaoTemporariaAte: true,\r\n      },\r\n    } as any);\r\n\r\n    if (!empresa) {\r\n      return NextResponse.json({ status: null });\r\n    }\r\n\r\n    return NextResponse.json({\r\n      status: empresa.status,\r\n      vencimentoPlano: empresa.vencimentoPlano,\r\n      plano: empresa.plano,\r\n      liberacaoTemporariaAte: empresa.liberacaoTemporariaAte,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Erro ao buscar status da empresa:\", error);\r\n    return NextResponse.json({ status: null }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\master\\empresas\\actions\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":174,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5391,5394],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5391,5394],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { asaas } from \"@/lib/asaas\";\r\nimport bcrypt from \"bcryptjs\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    // Verificar se ├® master\r\n    if (!session?.user || session.user.role !== \"master\") {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas masters podem executar esta a├º├úo.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const {\r\n      action,\r\n      empresaId,\r\n      mensagem,\r\n      importante,\r\n      novoVencimento,\r\n      novoDiaVencimento,\r\n    } = body;\r\n\r\n    // Valida├º├Áes\r\n    if (!action) {\r\n      return NextResponse.json(\r\n        { error: \"A├º├úo n├úo especificada.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    switch (action) {\r\n      case \"aprovar\":\r\n        // Aprovar empresa (status = ATIVO, vencimento +30 dias)\r\n        if (!empresaId) {\r\n          return NextResponse.json(\r\n            { error: \"empresaId obrigat├│rio\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        const empresaParaAprovar = await prisma.empresa.findUnique({\r\n          where: { id: empresaId },\r\n        });\r\n\r\n        const vencimento = new Date();\r\n        vencimento.setDate(vencimento.getDate() + 30);\r\n\r\n        // Se tem assinatura no Asaas, reativar\r\n        if (empresaParaAprovar?.asaasSubscriptionId) {\r\n          try {\r\n            await asaas.reactivateSubscription(\r\n              empresaParaAprovar.asaasSubscriptionId\r\n            );\r\n            await asaas.updateSubscriptionDueDate(\r\n              empresaParaAprovar.asaasSubscriptionId,\r\n              vencimento\r\n            );\r\n          } catch (asaasError) {\r\n            console.error(\"Erro ao reativar no Asaas:\", asaasError);\r\n            // Continua mesmo se falhar no Asaas\r\n          }\r\n        }\r\n\r\n        const empresaAprovada = await prisma.empresa.update({\r\n          where: { id: empresaId },\r\n          data: {\r\n            status: \"ATIVO\",\r\n            vencimentoPlano: vencimento,\r\n          },\r\n        });\r\n\r\n        return NextResponse.json({\r\n          success: true,\r\n          message: \"Empresa aprovada com sucesso!\",\r\n          empresa: empresaAprovada,\r\n        });\r\n\r\n      case \"renovar\":\r\n        // Renovar plano (+30 dias no vencimento)\r\n        if (!empresaId) {\r\n          return NextResponse.json(\r\n            { error: \"empresaId obrigat├│rio\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        const empresa = await prisma.empresa.findUnique({\r\n          where: { id: empresaId },\r\n        });\r\n\r\n        if (!empresa) {\r\n          return NextResponse.json(\r\n            { error: \"Empresa n├úo encontrada\" },\r\n            { status: 404 }\r\n          );\r\n        }\r\n\r\n        // Nova data de vencimento = data atual do vencimento + 30 dias\r\n        const novoVencimentoCalculado = empresa.vencimentoPlano\r\n          ? new Date(\r\n              empresa.vencimentoPlano.getTime() + 30 * 24 * 60 * 60 * 1000\r\n            )\r\n          : new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);\r\n\r\n        // Atualizar no Asaas\r\n        if (empresa.asaasSubscriptionId) {\r\n          try {\r\n            await asaas.updateSubscriptionDueDate(\r\n              empresa.asaasSubscriptionId,\r\n              novoVencimentoCalculado\r\n            );\r\n            await asaas.reactivateSubscription(empresa.asaasSubscriptionId);\r\n          } catch (asaasError) {\r\n            console.error(\"Erro ao renovar no Asaas:\", asaasError);\r\n          }\r\n        }\r\n\r\n        const empresaRenovada = await prisma.empresa.update({\r\n          where: { id: empresaId },\r\n          data: {\r\n            vencimentoPlano: novoVencimentoCalculado,\r\n            status: \"ATIVO\", // Reativar se estiver pausado\r\n          },\r\n        });\r\n\r\n        return NextResponse.json({\r\n          success: true,\r\n          message: \"Plano renovado com sucesso! (+30 dias)\",\r\n          empresa: empresaRenovada,\r\n        });\r\n\r\n      case \"updateVencimento\":\r\n        // Atualizar data de vencimento espec├¡fica e dia de vencimento\r\n        if (!empresaId || !novoVencimento) {\r\n          return NextResponse.json(\r\n            { error: \"empresaId e novoVencimento obrigat├│rios\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        const empresaParaAtualizar = await prisma.empresa.findUnique({\r\n          where: { id: empresaId },\r\n        });\r\n\r\n        const novaDataVencimento = new Date(novoVencimento);\r\n\r\n        // Atualizar no Asaas\r\n        if (empresaParaAtualizar?.asaasSubscriptionId) {\r\n          try {\r\n            await asaas.updateSubscriptionDueDate(\r\n              empresaParaAtualizar.asaasSubscriptionId,\r\n              novaDataVencimento\r\n            );\r\n            // Se estava pausado, reativar no Asaas\r\n            if (empresaParaAtualizar.status === \"PAUSADO\") {\r\n              await asaas.reactivateSubscription(\r\n                empresaParaAtualizar.asaasSubscriptionId\r\n              );\r\n            }\r\n          } catch (asaasError) {\r\n            console.error(\"Erro ao atualizar vencimento no Asaas:\", asaasError);\r\n          }\r\n        }\r\n\r\n        const dataUpdate: any = {\r\n          vencimentoPlano: novaDataVencimento,\r\n          status: \"ATIVO\", // Reativa caso esteja pausado\r\n        };\r\n\r\n        if (novoDiaVencimento) {\r\n          dataUpdate.diaVencimento = Number(novoDiaVencimento);\r\n        }\r\n\r\n        const empresaAtualizadaData = await prisma.empresa.update({\r\n          where: { id: empresaId },\r\n          data: dataUpdate,\r\n        });\r\n\r\n        return NextResponse.json({\r\n          success: true,\r\n          message: \"Plano atualizado com sucesso!\",\r\n          empresa: empresaAtualizadaData,\r\n        });\r\n\r\n      case \"pausar\":\r\n        // Pausar empresa\r\n        if (!empresaId) {\r\n          return NextResponse.json(\r\n            { error: \"empresaId obrigat├│rio\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        const empresaParaPausar = await prisma.empresa.findUnique({\r\n          where: { id: empresaId },\r\n        });\r\n\r\n        // Pausar no Asaas tamb├®m\r\n        if (empresaParaPausar?.asaasSubscriptionId) {\r\n          try {\r\n            await asaas.pauseSubscription(\r\n              empresaParaPausar.asaasSubscriptionId\r\n            );\r\n          } catch (asaasError) {\r\n            console.error(\"Erro ao pausar no Asaas:\", asaasError);\r\n            // Continua mesmo se falhar no Asaas\r\n          }\r\n        }\r\n\r\n        const empresaPausada = await prisma.empresa.update({\r\n          where: { id: empresaId },\r\n          data: { status: \"PAUSADO\" },\r\n        });\r\n\r\n        return NextResponse.json({\r\n          success: true,\r\n          message: \"Empresa pausada com sucesso!\",\r\n          empresa: empresaPausada,\r\n        });\r\n\r\n      case \"reativar\":\r\n        // Reativar empresa pausada\r\n        if (!empresaId) {\r\n          return NextResponse.json(\r\n            { error: \"empresaId obrigat├│rio\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        const empresaParaReativar = await prisma.empresa.findUnique({\r\n          where: { id: empresaId },\r\n        });\r\n\r\n        // Reativar no Asaas tamb├®m\r\n        if (empresaParaReativar?.asaasSubscriptionId) {\r\n          try {\r\n            await asaas.reactivateSubscription(\r\n              empresaParaReativar.asaasSubscriptionId\r\n            );\r\n          } catch (asaasError) {\r\n            console.error(\"Erro ao reativar no Asaas:\", asaasError);\r\n            // Continua mesmo se falhar no Asaas\r\n          }\r\n        }\r\n\r\n        const empresaReativada = await prisma.empresa.update({\r\n          where: { id: empresaId },\r\n          data: { status: \"ATIVO\" },\r\n        });\r\n\r\n        return NextResponse.json({\r\n          success: true,\r\n          message: \"Empresa reativada com sucesso!\",\r\n          empresa: empresaReativada,\r\n        });\r\n\r\n      case \"spy\":\r\n        // Spy Mode - Buscar faturamento total da empresa\r\n        if (!empresaId) {\r\n          return NextResponse.json(\r\n            { error: \"empresaId obrigat├│rio\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        const faturamentoData = await prisma.sale.aggregate({\r\n          where: { empresaId },\r\n          _sum: { valorTotal: true },\r\n          _count: true,\r\n        });\r\n\r\n        const totalProdutos = await prisma.product.count({\r\n          where: { empresaId },\r\n        });\r\n\r\n        const totalUsuarios = await prisma.user.count({\r\n          where: { empresaId },\r\n        });\r\n\r\n        return NextResponse.json({\r\n          success: true,\r\n          data: {\r\n            faturamentoTotal: Number(faturamentoData._sum.valorTotal || 0),\r\n            totalVendas: faturamentoData._count,\r\n            totalProdutos,\r\n            totalUsuarios,\r\n          },\r\n        });\r\n\r\n      case \"resetSenha\":\r\n        // Reset de senha do admin da empresa para \"Mudar123\"\r\n        if (!empresaId) {\r\n          return NextResponse.json(\r\n            { error: \"empresaId obrigat├│rio\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        // Buscar o usu├írio admin dessa empresa\r\n        const adminUser = await prisma.user.findFirst({\r\n          where: {\r\n            empresaId: empresaId,\r\n            role: \"admin\",\r\n          },\r\n        });\r\n\r\n        if (!adminUser) {\r\n          return NextResponse.json(\r\n            { error: \"Admin n├úo encontrado para esta empresa\" },\r\n            { status: 404 }\r\n          );\r\n        }\r\n\r\n        const novaSenhaHash = await bcrypt.hash(\"Mudar123\", 10);\r\n\r\n        const userAtualizado = await prisma.user.update({\r\n          where: { id: adminUser.id },\r\n          data: { password: novaSenhaHash },\r\n        });\r\n\r\n        return NextResponse.json({\r\n          success: true,\r\n          message: `Senha do usu├írio ${userAtualizado.email} resetada para: Mudar123`,\r\n        });\r\n\r\n      case \"criarAviso\":\r\n        // Criar aviso para uma empresa\r\n        if (!empresaId || !mensagem) {\r\n          return NextResponse.json(\r\n            { error: \"empresaId e mensagem s├úo obrigat├│rios\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        const aviso = await prisma.aviso.create({\r\n          data: {\r\n            mensagem,\r\n            importante: importante || false,\r\n            empresaId,\r\n            remetenteId: session.user.id,\r\n          },\r\n        });\r\n\r\n        return NextResponse.json({\r\n          success: true,\r\n          message: \"Aviso criado com sucesso!\",\r\n          aviso,\r\n        });\r\n\r\n      case \"limparDadosTeste\":\r\n        // ÔÜá´©Å PERIGO: Limpar dados de teste (Vendas, Estoque, Caixas)\r\n        if (!empresaId) {\r\n          return NextResponse.json(\r\n            { error: \"empresaId obrigat├│rio\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        await prisma.$transaction(async (tx) => {\r\n          // 1. Apagar Itens de Venda (Cascade delete normalmente cuida disso, mas vamos garantir)\r\n          // Precisamos buscar as vendas da empresa primeiro para apagar os itens\r\n          const vendas = await tx.sale.findMany({\r\n            where: { empresaId },\r\n            select: { id: true },\r\n          });\r\n          const vendaIds = vendas.map((v) => v.id);\r\n\r\n          if (vendaIds.length > 0) {\r\n            await tx.saleItem.deleteMany({\r\n              where: { saleId: { in: vendaIds } },\r\n            });\r\n          }\r\n\r\n          // 2. Apagar Vendas\r\n          await tx.sale.deleteMany({\r\n            where: { empresaId },\r\n          });\r\n\r\n          // 3. Apagar Movimenta├º├Áes de Estoque (APENAS VENDAS)\r\n          await tx.movimentacaoEstoque.deleteMany({\r\n            where: {\r\n              empresaId,\r\n              tipo: \"VENDA\",\r\n            },\r\n          });\r\n\r\n          // 4. Apagar Caixas\r\n          await tx.caixa.deleteMany({\r\n            where: { empresaId },\r\n          });\r\n\r\n          // 5. N├âO apagar Avisos, Produtos (estoque) ou Lotes.\r\n          // O objetivo ├® limpar apenas o hist├│rico financeiro de vendas.\r\n        });\r\n\r\n        return NextResponse.json({\r\n          success: true,\r\n          message: \"Dados de teste limpos com sucesso! Estoque zerado.\",\r\n        });\r\n\r\n      case \"syncAsaas\":\r\n        // Sincronizar dados do Asaas para o sistema local\r\n        if (!empresaId) {\r\n          return NextResponse.json(\r\n            { error: \"empresaId obrigat├│rio\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        const empresaParaSync = await prisma.empresa.findUnique({\r\n          where: { id: empresaId },\r\n        });\r\n\r\n        if (!empresaParaSync?.asaasSubscriptionId) {\r\n          return NextResponse.json(\r\n            { error: \"Empresa n├úo tem assinatura no Asaas\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n\r\n        try {\r\n          const subscription = await asaas.getSubscription(\r\n            empresaParaSync.asaasSubscriptionId\r\n          );\r\n\r\n          // Mapear status do Asaas para status do sistema\r\n          let novoStatus = empresaParaSync.status;\r\n          if (subscription.status === \"ACTIVE\") {\r\n            novoStatus = \"ATIVO\";\r\n          } else if (subscription.status === \"INACTIVE\") {\r\n            novoStatus = \"PAUSADO\";\r\n          }\r\n\r\n          // Atualizar vencimento e status\r\n          const empresaSincronizada = await prisma.empresa.update({\r\n            where: { id: empresaId },\r\n            data: {\r\n              vencimentoPlano: subscription.nextDueDate\r\n                ? new Date(subscription.nextDueDate)\r\n                : empresaParaSync.vencimentoPlano,\r\n              status: novoStatus,\r\n            },\r\n          });\r\n\r\n          return NextResponse.json({\r\n            success: true,\r\n            message: `Sincronizado! Vencimento: ${subscription.nextDueDate}, Status Asaas: ${subscription.status}`,\r\n            empresa: empresaSincronizada,\r\n          });\r\n        } catch (syncError) {\r\n          console.error(\"Erro ao sincronizar com Asaas:\", syncError);\r\n          return NextResponse.json(\r\n            { error: \"Erro ao buscar dados do Asaas\" },\r\n            { status: 500 }\r\n          );\r\n        }\r\n\r\n      default:\r\n        return NextResponse.json({ error: \"A├º├úo inv├ílida.\" }, { status: 400 });\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Erro na a├º├úo master:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno do servidor\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\master\\empresas\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":136,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3676,3679],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3676,3679],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":251,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":251,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7105,7108],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7105,7108],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":267,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":267,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7615,7618],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7615,7618],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":281,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":281,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7960,7963],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7960,7963],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { asaas } from \"@/lib/asaas\";\r\nimport bcrypt from \"bcryptjs\";\r\n\r\n// GET - Listar todas as empresas (apenas master)\r\nexport async function GET() {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session || session.user.role !== \"master\") {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas usu├írios master.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const empresas = await prisma.empresa.findMany({\r\n      include: {\r\n        _count: {\r\n          select: {\r\n            users: true,\r\n            products: true,\r\n            sales: true,\r\n          },\r\n        },\r\n        sales: {\r\n          select: {\r\n            valorTotal: true,\r\n            createdAt: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: {\r\n        createdAt: \"desc\",\r\n      },\r\n    });\r\n\r\n    const now = new Date();\r\n    const currentMonth = now.getMonth();\r\n    const currentYear = now.getFullYear();\r\n\r\n    // Calcular faturamento total, mensal e formatar resposta\r\n    const empresasFormatadas = empresas.map((empresa) => {\r\n      const faturamentoTotal = empresa.sales.reduce(\r\n        (acc, sale) => acc + Number(sale.valorTotal),\r\n        0\r\n      );\r\n\r\n      const faturamentoMensal = empresa.sales.reduce((acc, sale) => {\r\n        const saleDate = new Date(sale.createdAt);\r\n        if (\r\n          saleDate.getMonth() === currentMonth &&\r\n          saleDate.getFullYear() === currentYear\r\n        ) {\r\n          return acc + Number(sale.valorTotal);\r\n        }\r\n        return acc;\r\n      }, 0);\r\n\r\n      // Remover o array de sales para n├úo pesar o JSON\r\n      const { _count, ...rest } = empresa;\r\n\r\n      return {\r\n        ...rest,\r\n        faturamentoTotal,\r\n        faturamentoMensal,\r\n        totalProdutos: _count.products,\r\n        totalVendas: _count.sales,\r\n        _count, // Mantendo _count caso o frontend ainda use para users\r\n      };\r\n    });\r\n\r\n    return NextResponse.json(empresasFormatadas);\r\n  } catch (error) {\r\n    console.error(\"Erro ao buscar empresas:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro ao buscar empresas\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// POST - Criar nova empresa com primeiro admin (apenas master)\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session || session.user.role !== \"master\") {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas usu├írios master.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const {\r\n      nomeEmpresa,\r\n      adminEmail,\r\n      adminSenha,\r\n      adminNome,\r\n      telefone,\r\n      diaVencimento,\r\n      cpfCnpj,\r\n      cep,\r\n      logradouro,\r\n      numero,\r\n      bairro,\r\n      cidade,\r\n      estado,\r\n    } = body;\r\n\r\n    // Valida├º├Áes\r\n    if (!nomeEmpresa || !adminEmail || !adminSenha) {\r\n      return NextResponse.json(\r\n        { error: \"Nome da empresa, email e senha do admin s├úo obrigat├│rios\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verificar se j├í existe usu├írio com esse email\r\n    const existingUser = await prisma.user.findUnique({\r\n      where: { email: adminEmail },\r\n    });\r\n\r\n    if (existingUser) {\r\n      return NextResponse.json(\r\n        { error: \"J├í existe um usu├írio com este email\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Criar empresa e admin em uma transa├º├úo\r\n    const result = await prisma.$transaction(async (tx: any) => {\r\n      // 1. Criar a empresa\r\n      const empresa = await tx.empresa.create({\r\n        data: {\r\n          nome: nomeEmpresa,\r\n          telefone: telefone || null,\r\n          diaVencimento: diaVencimento ? parseInt(diaVencimento) : 10,\r\n          cpfCnpj: cpfCnpj ? cpfCnpj.replace(/\\D/g, \"\") : null,\r\n          enderecoCep: cep,\r\n          enderecoLogradouro: logradouro,\r\n          enderecoNumero: numero,\r\n          enderecoBairro: bairro,\r\n          enderecoCidade: cidade,\r\n          enderecoUf: estado,\r\n        },\r\n      });\r\n\r\n      // 2. Hash da senha\r\n      const hashedPassword = await bcrypt.hash(adminSenha, 10);\r\n\r\n      // 3. Criar o usu├írio admin\r\n      const admin = await tx.user.create({\r\n        data: {\r\n          email: adminEmail,\r\n          password: hashedPassword,\r\n          nome: adminNome || adminEmail.split(\"@\")[0],\r\n          name: adminNome || adminEmail.split(\"@\")[0],\r\n          role: \"admin\",\r\n          empresaId: empresa.id,\r\n        },\r\n      });\r\n\r\n      return { empresa, admin };\r\n    });\r\n\r\n    return NextResponse.json(\r\n      {\r\n        message: \"Empresa e admin criados com sucesso\",\r\n        empresa: result.empresa,\r\n        admin: {\r\n          id: result.admin.id,\r\n          email: result.admin.email,\r\n          nome: result.admin.nome,\r\n        },\r\n      },\r\n      { status: 201 }\r\n    );\r\n  } catch (error) {\r\n    console.error(\"Erro ao criar empresa:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro ao criar empresa\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// DELETE - Excluir empresa (apenas master)\r\nexport async function DELETE(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session || session.user.role !== \"master\") {\r\n      return NextResponse.json(\r\n        { error: \"Acesso negado. Apenas usu├írios master.\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // ­ƒöÑ FIX: Aceitar empresaId do body ao inv├®s de query string\r\n    const body = await request.json();\r\n    const empresaId = body.empresaId;\r\n\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"ID da empresa ├® obrigat├│rio\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verificar se a empresa existe\r\n    const empresa = await prisma.empresa.findUnique({\r\n      where: { id: empresaId },\r\n    });\r\n\r\n    if (!empresa) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo encontrada\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Cancelar assinatura e cliente no Asaas antes de excluir\r\n    if (empresa.asaasSubscriptionId) {\r\n      try {\r\n        await asaas.cancelSubscription(empresa.asaasSubscriptionId);\r\n        console.log(\r\n          `Assinatura ${empresa.asaasSubscriptionId} cancelada no Asaas`\r\n        );\r\n      } catch (asaasError) {\r\n        console.error(\"Erro ao cancelar assinatura no Asaas:\", asaasError);\r\n        // Continua mesmo se falhar - n├úo bloqueia exclus├úo local\r\n      }\r\n    }\r\n\r\n    if (empresa.asaasCustomerId) {\r\n      try {\r\n        await asaas.deleteCustomer(empresa.asaasCustomerId);\r\n        console.log(`Cliente ${empresa.asaasCustomerId} deletado do Asaas`);\r\n      } catch (asaasError) {\r\n        console.error(\"Erro ao deletar cliente no Asaas:\", asaasError);\r\n        // Continua mesmo se falhar\r\n      }\r\n    }\r\n\r\n    // Excluir empresa e todos os dados relacionados em uma transa├º├úo\r\n    await prisma.$transaction(async (tx: any) => {\r\n      // 1. Excluir movimenta├º├Áes de estoque\r\n      await tx.movimentacaoEstoque.deleteMany({\r\n        where: { empresaId },\r\n      });\r\n\r\n      // 2. Buscar todos os produtos para deletar lotes\r\n      const products = await tx.product.findMany({\r\n        where: { empresaId },\r\n        select: { id: true },\r\n      });\r\n\r\n      // 3. Excluir lotes dos produtos\r\n      if (products.length > 0) {\r\n        await tx.lote.deleteMany({\r\n          where: {\r\n            produtoId: { in: products.map((p: any) => p.id) },\r\n          },\r\n        });\r\n      }\r\n\r\n      // 4. Excluir itens de vendas\r\n      const sales = await tx.sale.findMany({\r\n        where: { empresaId },\r\n        select: { id: true },\r\n      });\r\n\r\n      if (sales.length > 0) {\r\n        await tx.saleItem.deleteMany({\r\n          where: {\r\n            saleId: { in: sales.map((s: any) => s.id) },\r\n          },\r\n        });\r\n      }\r\n\r\n      // 5. Excluir vendas\r\n      await tx.sale.deleteMany({\r\n        where: { empresaId },\r\n      });\r\n\r\n      // 6. Excluir caixas\r\n      await tx.caixa.deleteMany({\r\n        where: { empresaId },\r\n      });\r\n\r\n      // 7. Excluir avisos\r\n      await tx.aviso.deleteMany({\r\n        where: { empresaId },\r\n      });\r\n\r\n      // 8. Excluir produtos\r\n      await tx.product.deleteMany({\r\n        where: { empresaId },\r\n      });\r\n\r\n      // 9. Excluir usu├írios\r\n      await tx.user.deleteMany({\r\n        where: { empresaId },\r\n      });\r\n\r\n      // 10. Excluir empresa\r\n      await tx.empresa.delete({\r\n        where: { id: empresaId },\r\n      });\r\n    });\r\n\r\n    return NextResponse.json(\r\n      { message: \"Empresa exclu├¡da com sucesso\" },\r\n      { status: 200 }\r\n    );\r\n  } catch (error) {\r\n    console.error(\"Erro ao excluir empresa:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro ao excluir empresa\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\master\\sync-all\\route.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'novoVencimento' is never reassigned. Use 'const' instead.","line":54,"column":13,"nodeType":"Identifier","messageId":"useConst","endLine":54,"endColumn":27,"fix":{"range":[1587,1659],"text":"const novoVencimento = sub.nextDueDate ? new Date(sub.nextDueDate) : null;"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { asaas } from \"@/lib/asaas\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\nexport const maxDuration = 60; // Permitir execu├º├Áes mais longas (Vercel/Next.js)\r\n\r\nexport async function POST() {\r\n  const session = await getServerSession(authOptions);\r\n\r\n  if (!session || session.user.role !== \"master\") {\r\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n  }\r\n\r\n  try {\r\n    // 1. Buscar todas as empresas com assinatura vinculada\r\n    const empresas = await prisma.empresa.findMany({\r\n      where: {\r\n        asaasSubscriptionId: { not: null },\r\n      },\r\n      select: {\r\n        id: true,\r\n        nome: true,\r\n        asaasSubscriptionId: true,\r\n        status: true,\r\n      },\r\n    });\r\n\r\n    console.log(\r\n      `­ƒöä Iniciando sincroniza├º├úo em massa para ${empresas.length} empresas...`\r\n    );\r\n\r\n    let updatedCount = 0;\r\n    let errorCount = 0;\r\n    const details: {\r\n      empresa: string;\r\n      status: string;\r\n      oldStatus?: string;\r\n      newStatus?: string;\r\n      error?: string;\r\n    }[] = [];\r\n\r\n    // 2. Iterar e atualizar (serialmente para evitar rate limit agressivo)\r\n    for (const empresa of empresas) {\r\n      if (!empresa.asaasSubscriptionId) continue;\r\n\r\n      try {\r\n        const sub = await asaas.getSubscription(empresa.asaasSubscriptionId);\r\n\r\n        // Mapear status do Asaas para o sistema local\r\n        let novoStatus = empresa.status;\r\n        let novoVencimento = sub.nextDueDate ? new Date(sub.nextDueDate) : null;\r\n\r\n        if (sub.status === \"ACTIVE\") novoStatus = \"ATIVO\";\r\n        else if (sub.status === \"OVERDUE\") novoStatus = \"PAUSADO\";\r\n        // Ou manter ATIVO se dentro do grace period (mas aqui for├ºamos o status real)\r\n        else if (sub.status === \"RECEIVED\" || sub.status === \"CONFIRMED\")\r\n          novoStatus = \"ATIVO\";\r\n        else if (sub.status === \"INACTIVE\" || sub.status === \"CANCELLED\")\r\n          novoStatus = \"CANCELADO\";\r\n\r\n        // Se estiver EM_TESTE, mantemos EM_TESTE at├® que o pagamento seja confirmado ou ven├ºa\r\n        if (\r\n          empresa.status === \"EM_TESTE\" &&\r\n          novoStatus !== \"ATIVO\" &&\r\n          novoStatus !== \"CANCELADO\"\r\n        ) {\r\n          // Verifica se o trial expirou\r\n          if (novoVencimento && new Date() > novoVencimento) {\r\n            novoStatus = \"PAUSADO\"; // Fim do trial sem pagamento\r\n          } else {\r\n            novoStatus = \"EM_TESTE\"; // Ainda no trial\r\n          }\r\n        }\r\n\r\n        // Atualizar no banco\r\n        await prisma.empresa.update({\r\n          where: { id: empresa.id },\r\n          data: {\r\n            status: novoStatus,\r\n            vencimentoPlano: novoVencimento,\r\n            plano: \"PRO\", // Garantir que tenha um plano setado\r\n            asaasCustomerId: sub.customerId, // Atualizar customer ID se necess├írio\r\n          },\r\n        });\r\n\r\n        updatedCount++;\r\n        details.push({\r\n          empresa: empresa.nome,\r\n          status: \"success\",\r\n          oldStatus: empresa.status,\r\n          newStatus: novoStatus,\r\n        });\r\n\r\n        // Pequeno delay para ser gentil com a API\r\n        await new Promise((resolve) => setTimeout(resolve, 200));\r\n      } catch (err) {\r\n        console.error(`ÔØî Falha ao sincronizar empresa ${empresa.nome}:`, err);\r\n        errorCount++;\r\n        details.push({\r\n          empresa: empresa.nome,\r\n          status: \"error\",\r\n          error: err instanceof Error ? err.message : \"Unknown error\",\r\n        });\r\n      }\r\n    }\r\n\r\n    console.log(\r\n      `Ô£à Sincroniza├º├úo conclu├¡da. Sucesso: ${updatedCount}, Erros: ${errorCount}`\r\n    );\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      total: empresas.length,\r\n      updated: updatedCount,\r\n      errors: errorCount,\r\n      details,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"ÔØî Erro fatal na sincroniza├º├úo em massa:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Internal Server Error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\products\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[358,361],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[358,361],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[401,404],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[401,404],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[604,607],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[604,607],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2227,2230],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2227,2230],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { getFileUrl } from \"@/lib/s3\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n// ­ƒÜÇ Otimiza├º├úo: Fun├º├úo helper para processar em batches\r\nasync function signUrlsInBatches(products: any[], batchSize = 10) {\r\n  const results: any[] = [];\r\n\r\n  for (let i = 0; i < products.length; i += batchSize) {\r\n    const batch = products.slice(i, i + batchSize);\r\n    const batchResults = await Promise.all(\r\n      batch.map(async (product: any) => {\r\n        let signedUrl = null;\r\n        if (product.imagemUrl) {\r\n          try {\r\n            signedUrl = await getFileUrl(product.imagemUrl, 3600);\r\n          } catch (e) {\r\n            // Silently fail - use original URL\r\n            console.error(`Erro ao assinar URL para produto ${product.id}`, e);\r\n          }\r\n        }\r\n        return {\r\n          ...product,\r\n          precoVenda: Number(product.precoVenda),\r\n          imagemUrl: signedUrl || product.imagemUrl,\r\n        };\r\n      })\r\n    );\r\n    results.push(...batchResults);\r\n  }\r\n\r\n  return results;\r\n}\r\n\r\nexport async function GET() {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session?.user) {\r\n      return NextResponse.json({ error: \"N├úo autorizado\" }, { status: 401 });\r\n    }\r\n\r\n    const empresaId = session.user.empresaId;\r\n    const isMaster = session.user.role === \"master\";\r\n\r\n    // Se n├úo ├® master e n├úo tem empresaId, retorna erro\r\n    if (!isMaster && !empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Master pode ver todos os produtos, outros usu├írios veem apenas da sua empresa\r\n    const products = await prisma.product.findMany({\r\n      where: isMaster\r\n        ? {}\r\n        : {\r\n            empresaId: empresaId,\r\n          },\r\n      orderBy: { nome: \"asc\" },\r\n    });\r\n\r\n    // ­ƒÜÇ Otimiza├º├úo: Processar URLs em batches de 10 para evitar sobrecarga\r\n    const serializedProducts = await signUrlsInBatches(products, 10);\r\n\r\n    return NextResponse.json(serializedProducts);\r\n  } catch (error: any) {\r\n    console.error(\"Erro detalhado ao buscar produtos:\", error);\r\n\r\n    let errorMessage = \"Erro ao buscar produtos\";\r\n    if (error.message) {\r\n      errorMessage = error.message;\r\n    }\r\n\r\n    return NextResponse.json({ error: errorMessage }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\products\\search\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[403,406],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[403,406],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[446,449],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[446,449],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[649,652],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[649,652],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { getFileUrl } from \"@/lib/s3\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n// ­ƒÜÇ Otimiza├º├úo: Fun├º├úo helper para processar em batches (consistente com /api/products)\r\nasync function signUrlsInBatches(products: any[], batchSize = 10) {\r\n  const results: any[] = [];\r\n\r\n  for (let i = 0; i < products.length; i += batchSize) {\r\n    const batch = products.slice(i, i + batchSize);\r\n    const batchResults = await Promise.all(\r\n      batch.map(async (product: any) => {\r\n        let signedUrl = null;\r\n        if (product.imagemUrl) {\r\n          try {\r\n            signedUrl = await getFileUrl(product.imagemUrl, 3600);\r\n          } catch (e) {\r\n            console.error(`Erro ao assinar URL para produto ${product.id}`, e);\r\n          }\r\n        }\r\n        return {\r\n          ...product,\r\n          precoVenda: Number(product.precoVenda),\r\n          imagemUrl: signedUrl || product.imagemUrl,\r\n        };\r\n      })\r\n    );\r\n    results.push(...batchResults);\r\n  }\r\n\r\n  return results;\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n    if (!session?.user?.empresaId) {\r\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n    }\r\n\r\n    const { searchParams } = new URL(request.url);\r\n    const query = searchParams.get(\"query\");\r\n\r\n    if (!query || query.trim() === \"\") {\r\n      return NextResponse.json([]);\r\n    }\r\n\r\n    const products = await prisma.product.findMany({\r\n      where: {\r\n        empresaId: session.user.empresaId,\r\n        OR: [\r\n          { nome: { contains: query, mode: \"insensitive\" } },\r\n          { sku: { contains: query, mode: \"insensitive\" } },\r\n        ],\r\n      },\r\n      select: {\r\n        id: true,\r\n        nome: true,\r\n        sku: true,\r\n        precoVenda: true,\r\n        estoqueAtual: true,\r\n        imagemUrl: true,\r\n      },\r\n      take: 20,\r\n    });\r\n\r\n    // ­ƒÜÇ Otimiza├º├úo: Processar URLs em batches\r\n    const formattedProducts = await signUrlsInBatches(products, 10);\r\n\r\n    return NextResponse.json(formattedProducts);\r\n  } catch (error) {\r\n    console.error(\"Search error:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Internal Server Error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\public\\unlock-account\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1132,1135],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1132,1135],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport bcrypt from \"bcryptjs\";\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const { email, password } = await req.json();\r\n\r\n    if (!email || !password) {\r\n      return NextResponse.json(\r\n        { error: \"Email e senha s├úo obrigat├│rios\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const user = await prisma.user.findUnique({\r\n      where: { email: email.toLowerCase() },\r\n      include: {\r\n        empresa: true,\r\n      },\r\n    });\r\n\r\n    if (!user || !user.password) {\r\n      return NextResponse.json(\r\n        { error: \"Credenciais inv├ílidas\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const isPasswordValid = await bcrypt.compare(password, user.password);\r\n\r\n    if (!isPasswordValid) {\r\n      return NextResponse.json(\r\n        { error: \"Credenciais inv├ílidas\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    if (!user.empresa) {\r\n      return NextResponse.json(\r\n        { error: \"Usu├írio n├úo possui uma empresa associada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const empresa: any = user.empresa;\r\n\r\n    if (empresa.status !== \"PAUSADO\") {\r\n      return NextResponse.json(\r\n        { error: \"Esta empresa n├úo est├í pausada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verificar Cooldown (20 dias)\r\n    if (empresa.ultimoDesbloqueio) {\r\n      const ultimoDesbloqueio = new Date(empresa.ultimoDesbloqueio);\r\n      const now = new Date();\r\n      const diffTime = Math.abs(now.getTime() - ultimoDesbloqueio.getTime());\r\n      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\r\n\r\n      if (diffDays < 20) {\r\n        return NextResponse.json(\r\n          {\r\n            error: `Voc├¬ j├í utilizou o desbloqueio tempor├írio recentemente. Tente novamente em ${\r\n              20 - diffDays\r\n            } dias ou entre em contato com o suporte.`,\r\n          },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Aplicar Desbloqueio de 24h\r\n    const tomorrow = new Date();\r\n    tomorrow.setHours(tomorrow.getHours() + 24);\r\n\r\n    await prisma.empresa.update({\r\n      where: { id: empresa.id },\r\n      data: {\r\n        liberacaoTemporariaAte: tomorrow,\r\n        ultimoDesbloqueio: new Date(),\r\n      },\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: \"Acesso liberado temporariamente por 24 horas\",\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Erro no desbloqueio p├║blico:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Erro interno ao processar desbloqueio\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\sales\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":7,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":10,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[404,407],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[404,407],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":178,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":178,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5081,5084],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5081,5084],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":194,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":194,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5541,5544],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5541,5544],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":213,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":213,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6089,6092],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6089,6092],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":227,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":227,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6596,6599],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6596,6599],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":302,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":302,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9028,9031],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9028,9031],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n/**\r\n * FEFO Engine - First Expired, First Out\r\n * Desconta a quantidade vendida dos lotes, priorizando os que vencem primeiro\r\n */\r\nasync function descontarLotesFEFO(\r\n  tx: any,\r\n  produtoId: string,\r\n  quantidadeNecessaria: number\r\n): Promise<{\r\n  lotesUsados: string[];\r\n  quantidadeTotal: number;\r\n  custoTotalBaixado: number;\r\n  quantidadeRestante: number;\r\n}> {\r\n  // 1. Buscar lotes ordenados por validade (FEFO)\r\n  const lotes = await tx.lote.findMany({\r\n    where: {\r\n      produtoId: produtoId,\r\n      quantidade: {\r\n        gt: 0,\r\n      },\r\n    },\r\n    orderBy: [\r\n      { dataValidade: \"asc\" }, // Menor data (mais antiga) primeiro\r\n      { createdAt: \"asc\" }, // Desempate: lote mais antigo primeiro\r\n    ],\r\n  });\r\n\r\n  let quantidadeRestante = quantidadeNecessaria;\r\n  let custoTotalBaixado = 0;\r\n  const lotesUsados: string[] = [];\r\n\r\n  // 2. Iterar pelos lotes e descontar\r\n  for (const lote of lotes) {\r\n    if (quantidadeRestante === 0) break;\r\n\r\n    const quantidadeADescontar = Math.min(lote.quantidade, quantidadeRestante);\r\n    const custoLote = Number(lote.precoCompra) || 0;\r\n\r\n    // Acumular o custo real dos itens retirados deste lote\r\n    custoTotalBaixado += quantidadeADescontar * custoLote;\r\n\r\n    // 3. Atualizar o lote\r\n    await tx.lote.update({\r\n      where: { id: lote.id },\r\n      data: {\r\n        quantidade: lote.quantidade - quantidadeADescontar,\r\n      },\r\n    });\r\n\r\n    quantidadeRestante -= quantidadeADescontar;\r\n    lotesUsados.push(`${lote.numeroLote} (${quantidadeADescontar} un)`);\r\n  }\r\n\r\n  // N├úo lan├ºa erro se faltar lote, apenas retorna o restante para tratamento\r\n  return {\r\n    lotesUsados,\r\n    quantidadeTotal: quantidadeNecessaria,\r\n    custoTotalBaixado,\r\n    quantidadeRestante,\r\n  };\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const session = await getServerSession(authOptions);\r\n\r\n    if (!session?.user) {\r\n      return NextResponse.json({ error: \"N├úo autorizado\" }, { status: 401 });\r\n    }\r\n\r\n    const empresaId = session.user.empresaId;\r\n\r\n    if (!empresaId) {\r\n      return NextResponse.json(\r\n        { error: \"Empresa n├úo identificada\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verificar se o caixa est├í aberto\r\n    const caixaAberto = await prisma.caixa.findFirst({\r\n      where: {\r\n        usuarioId: session.user.id,\r\n        status: \"ABERTO\",\r\n      },\r\n    });\r\n\r\n    if (!caixaAberto) {\r\n      // Se for admin ou master, permite vender mesmo sem caixa aberto\r\n      if (session.user.role === \"admin\" || session.user.role === \"master\") {\r\n        // Segue o fluxo...\r\n      } else {\r\n        return NextResponse.json(\r\n          { error: \"Caixa fechado. Abra o caixa para realizar vendas.\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { items, metodoPagamento, valorRecebido, troco } = body;\r\n\r\n    if (!items || !Array.isArray(items) || items.length === 0) {\r\n      return NextResponse.json(\r\n        { error: \"Itens s├úo obrigat├│rios\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (\r\n      !metodoPagamento ||\r\n      ![\"dinheiro\", \"debito\", \"credito\", \"pix\"].includes(metodoPagamento)\r\n    ) {\r\n      return NextResponse.json(\r\n        { error: \"M├®todo de pagamento inv├ílido\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validar e calcular valor total baseados nos itens\r\n    let valorTotal = 0;\r\n    for (const item of items) {\r\n      if (!item.productId || !item.quantidade || !item.precoUnitario) {\r\n        return NextResponse.json(\r\n          {\r\n            error:\r\n              \"Todos os itens devem ter productId, quantidade e pre├ºo unit├írio\",\r\n          },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      if (item.quantidade <= 0 || item.precoUnitario < 0) {\r\n        return NextResponse.json(\r\n          {\r\n            error:\r\n              \"Quantidade deve ser maior que zero e pre├ºo n├úo pode ser negativo\",\r\n          },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      const itemTotal =\r\n        item.precoUnitario * item.quantidade - (item.descontoAplicado || 0);\r\n      valorTotal += itemTotal;\r\n    }\r\n\r\n    if (valorTotal < 0) {\r\n      return NextResponse.json(\r\n        { error: \"Valor total da venda n├úo pode ser negativo\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (metodoPagamento === \"dinheiro\") {\r\n      if (valorRecebido === undefined || valorRecebido === null) {\r\n        return NextResponse.json(\r\n          { error: \"Valor recebido ├® obrigat├│rio para pagamento em dinheiro\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n      if (Number(valorRecebido) < valorTotal) {\r\n        return NextResponse.json(\r\n          { error: \"Valor recebido insuficiente para cobrir o total da venda\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    const productIds = items.map((item: any) => item.productId);\r\n    const products = await prisma.product.findMany({\r\n      where: {\r\n        id: { in: productIds },\r\n        empresaId: empresaId,\r\n      },\r\n    });\r\n\r\n    if (products.length !== productIds.length) {\r\n      return NextResponse.json(\r\n        { error: \"Produtos n├úo encontrados ou n├úo pertencem ├á sua empresa\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    for (const item of items) {\r\n      const product = products.find((p: any) => p.id === item.productId);\r\n      if (!product) {\r\n        return NextResponse.json(\r\n          { error: `Produto n├úo encontrado: ${item.productId}` },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      if (product.estoqueAtual < item.quantidade) {\r\n        return NextResponse.json(\r\n          {\r\n            error: `Estoque insuficiente para ${product.nome}. Dispon├¡vel: ${product.estoqueAtual}`,\r\n          },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    }\r\n\r\n    const result = await prisma.$transaction(\r\n      async (tx: any) => {\r\n        const sale = await tx.sale.create({\r\n          data: {\r\n            userId: session.user.id,\r\n            empresaId: empresaId,\r\n            valorTotal: valorTotal,\r\n            metodoPagamento: metodoPagamento,\r\n            valorRecebido:\r\n              metodoPagamento === \"dinheiro\" ? valorRecebido : null,\r\n            troco: metodoPagamento === \"dinheiro\" ? troco : null,\r\n          },\r\n        });\r\n\r\n        for (const item of items) {\r\n          const product = products.find((p: any) => p.id === item.productId)!;\r\n          const descontoAplicado = item.descontoAplicado || 0;\r\n          const subtotal =\r\n            item.quantidade * item.precoUnitario - descontoAplicado;\r\n\r\n          // *** APLICAR L├ôGICA FEFO ***\r\n          const { lotesUsados, custoTotalBaixado, quantidadeRestante } =\r\n            await descontarLotesFEFO(tx, item.productId, item.quantidade);\r\n\r\n          // Se sobrar quantidade (sem lote), usamos o pre├ºo de compra do produto como custo\r\n          let custoFinal = custoTotalBaixado;\r\n          if (quantidadeRestante > 0) {\r\n            const custoFallback = Number(product.precoCompra) || 0;\r\n            custoFinal += quantidadeRestante * custoFallback;\r\n            lotesUsados.push(`Sem Lote (${quantidadeRestante} un)`);\r\n          }\r\n\r\n          const custoUnitarioReal =\r\n            custoFinal > 0\r\n              ? custoFinal / item.quantidade\r\n              : Number(product.precoCompra);\r\n\r\n          await tx.saleItem.create({\r\n            data: {\r\n              saleId: sale.id,\r\n              productId: item.productId,\r\n              quantidade: item.quantidade,\r\n              precoUnitario: item.precoUnitario,\r\n              custoUnitario: custoUnitarioReal,\r\n              descontoAplicado: descontoAplicado,\r\n              subtotal: subtotal,\r\n            },\r\n          });\r\n\r\n          await tx.product.update({\r\n            where: { id: item.productId },\r\n            data: {\r\n              estoqueAtual: {\r\n                decrement: item.quantidade,\r\n              },\r\n            },\r\n          });\r\n\r\n          await tx.movimentacaoEstoque.create({\r\n            data: {\r\n              produtoId: item.productId,\r\n              usuarioId: session.user.id,\r\n              empresaId: empresaId,\r\n              tipo: \"VENDA\",\r\n              quantidade: -item.quantidade,\r\n              motivo: `Venda #${sale.id.substring(\r\n                0,\r\n                8\r\n              )} - Lotes: ${lotesUsados.join(\", \")}`,\r\n            },\r\n          });\r\n        }\r\n\r\n        return sale;\r\n      },\r\n      {\r\n        maxWait: 5000,\r\n        timeout: 20000,\r\n      }\r\n    );\r\n\r\n    return NextResponse.json({\r\n      message: \"Venda finalizada com sucesso\",\r\n      sale: {\r\n        id: result.id,\r\n        valorTotal: Number(result.valorTotal),\r\n        metodoPagamento: result.metodoPagamento,\r\n        dataHora: result.dataHora,\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"Erro detalhado ao finalizar venda:\", error);\r\n\r\n    let errorMessage = \"Erro ao finalizar venda\";\r\n    if (error.message) {\r\n      errorMessage = error.message;\r\n    }\r\n\r\n    return NextResponse.json({ error: errorMessage }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\signup\\route.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'cupom' is never reassigned. Use 'const' instead.","line":18,"column":18,"nodeType":"Identifier","messageId":"useConst","endLine":18,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\r\nimport bcrypt from \"bcryptjs\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { generateVerificationToken } from \"@/lib/tokens\";\r\nimport { sendVerificationEmail } from \"@/lib/mail\";\r\nimport { Prisma } from \"@prisma/client\";\r\nimport { asaas } from \"@/lib/asaas\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nexport async function POST(request: NextRequest) {\r\n  // Vari├íveis para rollback\r\n  let createdAsaasCustomerId: string | null = null;\r\n  let isNewCustomer = false;\r\n\r\n  try {\r\n    const body = await request.json();\r\n    let { email, cupom } = body;\r\n    const {\r\n      password,\r\n      nome,\r\n      nomeEmpresa,\r\n      telefone,\r\n      cpfCnpj,\r\n      termsAccepted,\r\n      logradouro,\r\n      numero,\r\n      bairro,\r\n      cep,\r\n      cidade,\r\n      uf,\r\n    } = body;\r\n\r\n    if (email) {\r\n      email = email.toLowerCase();\r\n    }\r\n\r\n    // ========== VALIDA├ç├òES ==========\r\n    if (!termsAccepted) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            \"├ë necess├írio aceitar os Termos de Uso e Pol├¡tica de Privacidade\",\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!email || !password || !nome || !nomeEmpresa || !cpfCnpj) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            \"Email, senha, nome, nome da empresa e CPF/CNPJ s├úo obrigat├│rios\",\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validar endere├ºo completo para NF\r\n    if (!logradouro || !numero || !bairro || !cep || !cidade || !uf) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            \"Endere├ºo completo (Logradouro, N├║mero, Bairro, CEP, Cidade, UF) ├® obrigat├│rio para emiss├úo de Nota Fiscal\",\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validar formato de email\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    if (!emailRegex.test(email)) {\r\n      return NextResponse.json(\r\n        { error: \"Formato de email inv├ílido\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (password.length < 6) {\r\n      return NextResponse.json(\r\n        { error: \"Senha deve ter no m├¡nimo 6 caracteres\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Limpar CPF/CNPJ (remover pontos, tra├ºos, barras)\r\n    const cpfCnpjClean = cpfCnpj.replace(/[.\\-\\/]/g, \"\");\r\n\r\n    // Validar tamanho do CPF/CNPJ\r\n    if (cpfCnpjClean.length !== 11 && cpfCnpjClean.length !== 14) {\r\n      return NextResponse.json(\r\n        { error: \"CPF deve ter 11 d├¡gitos ou CNPJ deve ter 14 d├¡gitos\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // ========== VALIDAR CUPOM ==========\r\n    let cupomDb: {\r\n      codigo: string;\r\n      descontoPorcentagem: number;\r\n      validoAte: Date | null;\r\n      usosAtuais: number;\r\n      limiteUsos: number | null;\r\n    } | null = null;\r\n    let subscriptionPrice = parseFloat(\r\n      process.env.NEXT_PUBLIC_PLAN_PRICE || \"49.90\"\r\n    );\r\n\r\n    if (cupom) {\r\n      console.log(\"­ƒÄƒ´©Å Verificando cupom:\", cupom);\r\n      cupomDb = await prisma.cupom.findUnique({\r\n        where: { codigo: cupom.toUpperCase() },\r\n      });\r\n\r\n      if (!cupomDb) {\r\n        return NextResponse.json({ error: \"Cupom inv├ílido\" }, { status: 400 });\r\n      }\r\n\r\n      const now = new Date();\r\n      if (cupomDb.validoAte && cupomDb.validoAte < now) {\r\n        return NextResponse.json(\r\n          { error: \"Este cupom expirou e n├úo pode mais ser utilizado\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      if (\r\n        cupomDb.limiteUsos !== null &&\r\n        cupomDb.usosAtuais >= cupomDb.limiteUsos\r\n      ) {\r\n        return NextResponse.json(\r\n          { error: \"O limite de usos deste cupom foi atingido\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      // Aplicar desconto\r\n      const originalPrice = subscriptionPrice;\r\n      const desconto = cupomDb.descontoPorcentagem;\r\n      subscriptionPrice = originalPrice * ((100 - desconto) / 100);\r\n      subscriptionPrice = Number(subscriptionPrice.toFixed(2));\r\n      console.log(\r\n        `Ô£à Cupom aplicado: ${desconto}% OFF. Pre├ºo final: R$ ${subscriptionPrice}`\r\n      );\r\n    }\r\n\r\n    // ========== VERIFICAR DUPLICATAS ==========\r\n    console.log(\"­ƒöì Verificando se usu├írio existe:\", email);\r\n    const existingUser = await prisma.user.findUnique({\r\n      where: { email },\r\n    });\r\n\r\n    if (existingUser) {\r\n      console.log(\"ÔØî Usu├írio j├í existe\");\r\n      return NextResponse.json(\r\n        { error: \"J├í existe uma conta com este email\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verificar se CPF/CNPJ j├í est├í cadastrado no sistema\r\n    const existingEmpresa = await prisma.empresa.findFirst({\r\n      where: { cpfCnpj: cpfCnpjClean },\r\n    });\r\n\r\n    if (existingEmpresa) {\r\n      console.log(\"ÔØî CPF/CNPJ j├í cadastrado\");\r\n      return NextResponse.json(\r\n        { error: \"Este CPF/CNPJ j├í est├í cadastrado no sistema\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Hash da senha\r\n    console.log(\"­ƒöÉ Gerando hash da senha\");\r\n    const hashedPassword = await bcrypt.hash(password, 10);\r\n\r\n    // ========== INTEGRA├ç├âO ASAAS ==========\r\n    console.log(\"­ƒöä Iniciando integra├º├úo com Asaas...\");\r\n    let asaasCustomer:\r\n      | { id: string; name: string; email: string; cpfCnpj: string }\r\n      | undefined;\r\n    let asaasSubscription:\r\n      | {\r\n          id: string;\r\n          customerId: string;\r\n          value: number;\r\n          nextDueDate: string;\r\n          cycle: string;\r\n          status: string;\r\n        }\r\n      | undefined;\r\n\r\n    try {\r\n      // 1. Criar/Recuperar Cliente no Asaas\r\n      const existingAsaasCustomer = await asaas.findCustomerByCpfCnpj(\r\n        cpfCnpjClean\r\n      );\r\n\r\n      if (existingAsaasCustomer) {\r\n        console.log(\r\n          \"Ôä╣´©Å Cliente j├í existe no Asaas, usando existente:\",\r\n          existingAsaasCustomer.id\r\n        );\r\n        asaasCustomer = existingAsaasCustomer;\r\n        isNewCustomer = false;\r\n      } else {\r\n        asaasCustomer = await asaas.createCustomer(\r\n          nomeEmpresa,\r\n          cpfCnpjClean,\r\n          email,\r\n          telefone,\r\n          {\r\n            logradouro,\r\n            numero,\r\n            bairro,\r\n            cep,\r\n            complemento: \"\", // Opcional\r\n          }\r\n        );\r\n        console.log(\"Ô£à Cliente Asaas criado:\", asaasCustomer.id);\r\n        createdAsaasCustomerId = asaasCustomer.id;\r\n        isNewCustomer = true;\r\n      }\r\n\r\n      // 2. Criar Assinatura (com pre├ºo ajustado pelo cupom)\r\n      asaasSubscription = await asaas.createSubscription(\r\n        asaasCustomer.id,\r\n        subscriptionPrice\r\n      );\r\n      console.log(\"Ô£à Assinatura Asaas criada:\", asaasSubscription.id);\r\n    } catch (asaasError: unknown) {\r\n      console.error(\"ÔØî Erro na integra├º├úo Asaas:\", asaasError);\r\n\r\n      // ROLLBACK: Se criamos um cliente novo e ele falhou na assinatura, deletar\r\n      if (createdAsaasCustomerId && isNewCustomer) {\r\n        console.log(\"­ƒöä Executando rollback - deletando cliente Asaas...\");\r\n        await asaas.deleteCustomer(createdAsaasCustomerId);\r\n      }\r\n\r\n      const errorMessage =\r\n        asaasError instanceof Error ? asaasError.message : \"Erro desconhecido\";\r\n\r\n      if (\r\n        errorMessage.toLowerCase().includes(\"cpf\") ||\r\n        errorMessage.toLowerCase().includes(\"cnpj\")\r\n      ) {\r\n        return NextResponse.json(\r\n          { error: \"CPF/CNPJ inv├ílido. Verifique os dados informados.\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      return NextResponse.json(\r\n        { error: \"Erro ao configurar pagamento: \" + errorMessage },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // ========== CRIAR EMPRESA E ADMIN NO BANCO ==========\r\n    console.log(\"­ƒùä´©Å Iniciando transa├º├úo de cria├º├úo local\");\r\n\r\n    // Ensure Asaas integration completed successfully\r\n    if (!asaasCustomer || !asaasSubscription) {\r\n      return NextResponse.json(\r\n        { error: \"Erro ao configurar pagamento. Tente novamente.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    try {\r\n      const result = await prisma.$transaction(\r\n        async (tx: Prisma.TransactionClient) => {\r\n          // Calcular vencimento (Hoje + Trial Days)\r\n          const trialDays = parseInt(\r\n            process.env.NEXT_PUBLIC_TRIAL_DAYS || \"14\",\r\n            10\r\n          );\r\n          const vencimento = new Date();\r\n          vencimento.setDate(vencimento.getDate() + trialDays);\r\n\r\n          // 1. Criar empresa EM_TESTE\r\n          console.log(\"­ƒôª Criando empresa:\", nomeEmpresa);\r\n          const empresa = await tx.empresa.create({\r\n            data: {\r\n              nome: nomeEmpresa,\r\n              telefone,\r\n              cpfCnpj: cpfCnpjClean,\r\n              status: \"EM_TESTE\",\r\n              plano: \"PRO\",\r\n              vencimentoPlano: vencimento,\r\n              asaasCustomerId: asaasCustomer!.id,\r\n              asaasSubscriptionId: asaasSubscription!.id,\r\n\r\n              // Endere├ºo\r\n              enderecoLogradouro: logradouro,\r\n              enderecoNumero: numero,\r\n              enderecoBairro: bairro,\r\n              enderecoCidade: cidade,\r\n              enderecoUf: uf,\r\n              enderecoCep: cep,\r\n              // Cupom\r\n              cupomAplicado: cupom ? cupom.toUpperCase() : null,\r\n            },\r\n          });\r\n          console.log(\"Ô£à Empresa criada:\", empresa.id);\r\n\r\n          // 2. Criar usu├írio admin da empresa\r\n          console.log(\"­ƒæñ Criando usu├írio admin:\", email);\r\n          const admin = await tx.user.create({\r\n            data: {\r\n              email,\r\n              password: hashedPassword,\r\n              name: nome,\r\n              nome,\r\n              role: \"admin\",\r\n              empresaId: empresa.id,\r\n              tourCompleted: false,\r\n            },\r\n          });\r\n          console.log(\"Ô£à Usu├írio admin criado:\", admin.id);\r\n\r\n          // 3. Incrementar uso do cupom (se aplicado)\r\n          if (cupomDb) {\r\n            console.log(\"­ƒÄƒ´©Å Incrementando uso do cupom:\", cupomDb.codigo);\r\n            await tx.cupom.update({\r\n              where: { codigo: cupomDb.codigo },\r\n              data: { usosAtuais: { increment: 1 } },\r\n            });\r\n          }\r\n\r\n          return { empresa, admin };\r\n        }\r\n      );\r\n\r\n      console.log(\"Ô£à Transa├º├úo conclu├¡da com sucesso\");\r\n\r\n      // Enviar email de verifica├º├úo\r\n      try {\r\n        const verificationToken = await generateVerificationToken(email);\r\n        await sendVerificationEmail(email, verificationToken.token);\r\n        console.log(\"­ƒôº Email de verifica├º├úo enviado\");\r\n      } catch (emailError) {\r\n        console.warn(\"ÔÜá´©Å Erro ao enviar email de verifica├º├úo:\", emailError);\r\n      }\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        message:\r\n          \"Cadastro realizado com sucesso! Seu per├¡odo de teste de 14 dias come├ºou.\",\r\n        empresa: {\r\n          id: result.empresa.id,\r\n          nome: result.empresa.nome,\r\n          status: result.empresa.status,\r\n        },\r\n        user: {\r\n          id: result.admin.id,\r\n          email: result.admin.email,\r\n          name: result.admin.name,\r\n          role: result.admin.role,\r\n        },\r\n      });\r\n    } catch (dbError: unknown) {\r\n      console.error(\"ÔØî Erro ao criar registros no banco:\", dbError);\r\n\r\n      // ROLLBACK: Cancelar assinatura e deletar cliente no Asaas\r\n      console.log(\"­ƒöä Executando rollback completo...\");\r\n\r\n      if (asaasSubscription) {\r\n        try {\r\n          await asaas.cancelSubscription(asaasSubscription.id);\r\n          console.log(\"Ô£à Assinatura cancelada no Asaas\");\r\n        } catch (e) {\r\n          console.warn(\"ÔÜá´©Å Falha ao cancelar assinatura:\", e);\r\n        }\r\n      }\r\n\r\n      if (isNewCustomer && createdAsaasCustomerId) {\r\n        try {\r\n          await asaas.deleteCustomer(createdAsaasCustomerId);\r\n          console.log(\"Ô£à Cliente deletado do Asaas\");\r\n        } catch (e) {\r\n          console.warn(\"ÔÜá´©Å Falha ao deletar cliente:\", e);\r\n        }\r\n      }\r\n\r\n      throw dbError; // Re-throw para o catch externo\r\n    }\r\n  } catch (error: unknown) {\r\n    console.error(\"ÔØî Erro detalhado ao criar cadastro:\", error);\r\n\r\n    // Tratamento de erros gen├®rico\r\n    let errorMessage = \"Erro ao criar conta e empresa\";\r\n\r\n    if (typeof error === \"object\" && error !== null && \"code\" in error) {\r\n      const prismaError = error as { code: string };\r\n      if (prismaError.code === \"P2002\") {\r\n        errorMessage = \"Este email ou CPF/CNPJ j├í est├í cadastrado no sistema\";\r\n      }\r\n    } else if (error instanceof Error) {\r\n      errorMessage = error.message;\r\n    }\r\n\r\n    return NextResponse.json({ error: errorMessage }, { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\api\\sync\\products\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":8,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[317,320],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[317,320],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[360,363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[360,363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[563,566],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[563,566],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { getFileUrl } from \"@/lib/s3\";\r\n\r\n// Helper para processar URLs em batches (evita sobrecarga)\r\nasync function signUrlsInBatches(products: any[], batchSize = 10) {\r\n  const results: any[] = [];\r\n\r\n  for (let i = 0; i < products.length; i += batchSize) {\r\n    const batch = products.slice(i, i + batchSize);\r\n    const batchResults = await Promise.all(\r\n      batch.map(async (product: any) => {\r\n        let finalImageUrl: string | null = null;\r\n\r\n        if (product.imagemUrl) {\r\n          // Se j├í ├® uma URL completa (http/https), usa direto\r\n          if (\r\n            product.imagemUrl.startsWith(\"http://\") ||\r\n            product.imagemUrl.startsWith(\"https://\")\r\n          ) {\r\n            finalImageUrl = product.imagemUrl;\r\n          } else {\r\n            // ├ë um path do S3, precisa gerar signed URL\r\n            try {\r\n              finalImageUrl = await getFileUrl(product.imagemUrl, 3600);\r\n            } catch (e) {\r\n              // Se falhar, N├âO usa o path original (evita 404 local)\r\n              // Retorna null para mostrar o placeholder\r\n              console.error(\r\n                `[SYNC] Erro ao assinar URL para produto ${product.id} (path: ${product.imagemUrl})`,\r\n                e\r\n              );\r\n              finalImageUrl = null;\r\n            }\r\n          }\r\n        }\r\n\r\n        return {\r\n          id: product.id,\r\n          nome: product.nome,\r\n          sku: product.sku,\r\n          precoVenda: Number(product.precoVenda),\r\n          estoqueAtual: product.estoqueAtual,\r\n          imagemUrl: finalImageUrl,\r\n        };\r\n      })\r\n    );\r\n    results.push(...batchResults);\r\n  }\r\n\r\n  return results;\r\n}\r\n\r\nexport async function GET() {\r\n  const session = await getServerSession(authOptions);\r\n\r\n  if (!session || !session.user || !session.user.empresaId) {\r\n    return new NextResponse(\"Unauthorized\", { status: 401 });\r\n  }\r\n\r\n  try {\r\n    const products = await prisma.product.findMany({\r\n      where: {\r\n        empresaId: session.user.empresaId,\r\n      },\r\n      select: {\r\n        id: true,\r\n        nome: true,\r\n        sku: true,\r\n        precoVenda: true,\r\n        estoqueAtual: true,\r\n        imagemUrl: true,\r\n      },\r\n    });\r\n\r\n    // Processar URLs em batches para gerar signed URLs\r\n    const formattedProducts = await signUrlsInBatches(products, 10);\r\n\r\n    return NextResponse.json(formattedProducts);\r\n  } catch (error) {\r\n    console.error(\"[SYNC_PRODUCTS_ERROR]\", error);\r\n    return new NextResponse(\"Internal Error\", { status: 500 });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\equipe\\[id]\\_components\\funcionario-detalhes.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[924,927],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[924,927],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1910,1913],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1910,1913],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":148,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4625,4628],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4625,4628],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { AnimatedLoadingSkeleton } from \"@/components/ui/loading\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useSession } from \"next-auth/react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { ArrowLeft } from \"lucide-react\";\r\nimport { EmployeeKPIs, CashAuditTable, EmployeeActions } from \"./parts\";\r\n\r\ninterface FuncionarioDetalhesProps {\r\n  funcionarioId: string;\r\n}\r\n\r\n// Format currency\r\nconst formatCurrency = (value: number | string) => {\r\n  return new Intl.NumberFormat(\"pt-BR\", {\r\n    style: \"currency\",\r\n    currency: \"BRL\",\r\n  }).format(Number(value));\r\n};\r\n\r\nexport default function FuncionarioDetalhes({\r\n  funcionarioId,\r\n}: FuncionarioDetalhesProps) {\r\n  const { data: session } = useSession();\r\n  const router = useRouter();\r\n  const [funcionario, setFuncionario] = useState<any>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [meta, setMeta] = useState(\"\");\r\n  const [mensagemAviso, setMensagemAviso] = useState(\"\");\r\n  const [dialogAvisoOpen, setDialogAvisoOpen] = useState(false);\r\n  const [savingMeta, setSavingMeta] = useState(false);\r\n  const [sendingAviso, setSendingAviso] = useState(false);\r\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\r\n  const [deleting, setDeleting] = useState(false);\r\n\r\n  const handleDeleteFuncionario = async () => {\r\n    setDeleting(true);\r\n    try {\r\n      const response = await fetch(`/api/admin/equipe?id=${funcionarioId}`, {\r\n        method: \"DELETE\",\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        throw new Error(data.error || \"Erro ao excluir funcion├írio\");\r\n      }\r\n\r\n      toast({\r\n        title: \"Sucesso\",\r\n        description: \"Funcion├írio exclu├¡do com sucesso.\",\r\n      });\r\n      router.push(\"/equipe\");\r\n    } catch (error: any) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setDeleting(false);\r\n      setDeleteDialogOpen(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (session?.user?.id === funcionarioId) {\r\n      toast({\r\n        title: \"Acesso Negado\",\r\n        description: \"Voc├¬ n├úo pode gerenciar seu pr├│prio perfil aqui.\",\r\n        variant: \"destructive\",\r\n      });\r\n      router.push(\"/equipe\");\r\n      return;\r\n    }\r\n    fetchFuncionario();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [funcionarioId]);\r\n\r\n  const fetchFuncionario = async () => {\r\n    try {\r\n      const response = await fetch(\r\n        `/api/admin/equipe/${funcionarioId}?t=${new Date().getTime()}`\r\n      );\r\n      if (!response.ok) throw new Error(\"Erro ao carregar funcion├írio\");\r\n      const data = await response.json();\r\n      setFuncionario(data);\r\n      setMeta(\r\n        Number(data.metaMensal || 0).toLocaleString(\"pt-BR\", {\r\n          minimumFractionDigits: 2,\r\n          maximumFractionDigits: 2,\r\n        })\r\n      );\r\n    } catch (error) {\r\n      console.error(error);\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"N├úo foi poss├¡vel carregar os dados do funcion├írio.\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleUpdateMeta = async () => {\r\n    setSavingMeta(true);\r\n    try {\r\n      // Robust parsing for PT-BR currency\r\n      let numericMeta = 0;\r\n      if (meta) {\r\n        const cleanValue = meta.replace(/[^\\d.,-]/g, \"\");\r\n        if (cleanValue.includes(\",\")) {\r\n          // PT-BR format: 1.000,00 -> 1000.00\r\n          numericMeta = parseFloat(\r\n            cleanValue.replace(/\\./g, \"\").replace(\",\", \".\")\r\n          );\r\n        } else {\r\n          // Se tem ponto mas n├úo tem v├¡rgula, assume que o ponto ├® milhar (pt-BR)\r\n          // Ex: 1.500 -> 1500\r\n          if (cleanValue.includes(\".\")) {\r\n            numericMeta = parseFloat(cleanValue.replace(/\\./g, \"\"));\r\n          } else {\r\n            numericMeta = parseFloat(cleanValue);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (isNaN(numericMeta)) numericMeta = 0;\r\n\r\n      const response = await fetch(`/api/admin/equipe/${funcionarioId}`, {\r\n        method: \"PUT\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ metaMensal: numericMeta }),\r\n      });\r\n\r\n      if (!response.ok) throw new Error(\"Erro ao atualizar meta\");\r\n\r\n      const updatedData = await response.json();\r\n\r\n      toast({\r\n        title: \"Sucesso\",\r\n        description: \"Meta mensal atualizada com sucesso!\",\r\n      });\r\n\r\n      setFuncionario((prev: any) => ({\r\n        ...prev,\r\n        metaMensal: updatedData.metaMensal,\r\n      }));\r\n\r\n      // Update local state with formatted string (pt-BR) including thousands separator\r\n      setMeta(\r\n        Number(updatedData.metaMensal).toLocaleString(\"pt-BR\", {\r\n          minimumFractionDigits: 2,\r\n          maximumFractionDigits: 2,\r\n        })\r\n      );\r\n    } catch (error) {\r\n      console.error(error);\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"Falha ao atualizar a meta.\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setSavingMeta(false);\r\n    }\r\n  };\r\n\r\n  const handleSendAviso = async () => {\r\n    if (!mensagemAviso.trim()) return;\r\n    setSendingAviso(true);\r\n    try {\r\n      const response = await fetch(\"/api/avisos\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          mensagem: mensagemAviso,\r\n          destinatarioId: funcionarioId,\r\n          importante: true,\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) throw new Error(\"Erro ao enviar aviso\");\r\n\r\n      toast({\r\n        title: \"Sucesso\",\r\n        description: \"Aviso enviado com sucesso!\",\r\n      });\r\n      setDialogAvisoOpen(false);\r\n      setMensagemAviso(\"\");\r\n    } catch (error) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"Falha ao enviar o aviso.\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setSendingAviso(false);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"container mx-auto py-10\">\r\n        <AnimatedLoadingSkeleton />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!funcionario) {\r\n    return <div className=\"p-8 text-center\">Funcion├írio n├úo encontrado.</div>;\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex items-center gap-4\">\r\n        <Button variant=\"ghost\" size=\"icon\" onClick={() => router.back()}>\r\n          <ArrowLeft className=\"h-5 w-5\" />\r\n        </Button>\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-gray-900\">\r\n            {funcionario.nome || funcionario.name || funcionario.email}\r\n          </h1>\r\n          <p className=\"text-gray-500\">{funcionario.email}</p>\r\n        </div>\r\n      </div>\r\n\r\n      <EmployeeKPIs\r\n        funcionario={funcionario}\r\n        meta={meta}\r\n        setMeta={setMeta}\r\n        handleUpdateMeta={handleUpdateMeta}\r\n        savingMeta={savingMeta}\r\n        formatCurrency={formatCurrency}\r\n      />\r\n\r\n      {/* Tabela de Auditoria de Caixa */}\r\n      <CashAuditTable\r\n        caixas={funcionario.caixas}\r\n        formatCurrency={formatCurrency}\r\n      />\r\n\r\n      <EmployeeActions\r\n        funcionario={funcionario}\r\n        dialogAvisoOpen={dialogAvisoOpen}\r\n        setDialogAvisoOpen={setDialogAvisoOpen}\r\n        mensagemAviso={mensagemAviso}\r\n        setMensagemAviso={setMensagemAviso}\r\n        handleSendAviso={handleSendAviso}\r\n        sendingAviso={sendingAviso}\r\n        deleteDialogOpen={deleteDialogOpen}\r\n        setDeleteDialogOpen={setDeleteDialogOpen}\r\n        handleDeleteFuncionario={handleDeleteFuncionario}\r\n        deleting={deleting}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\equipe\\[id]\\_components\\parts\\EmployeeActions.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[694,697],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[694,697],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":81,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2369,2372],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2369,2372],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { InteractiveHoverButton } from \"@/components/ui/interactive-hover-button\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Mail, Trash2, Lock } from \"lucide-react\";\r\nimport { useState } from \"react\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\n\r\ninterface EmployeeActionsProps {\r\n  funcionario: any;\r\n  dialogAvisoOpen: boolean;\r\n  setDialogAvisoOpen: (open: boolean) => void;\r\n  mensagemAviso: string;\r\n  setMensagemAviso: (value: string) => void;\r\n  handleSendAviso: () => void;\r\n  sendingAviso: boolean;\r\n  deleteDialogOpen: boolean;\r\n  setDeleteDialogOpen: (open: boolean) => void;\r\n  handleDeleteFuncionario: () => void;\r\n  deleting: boolean;\r\n}\r\n\r\nexport function EmployeeActions({\r\n  funcionario,\r\n  dialogAvisoOpen,\r\n  setDialogAvisoOpen,\r\n  mensagemAviso,\r\n  setMensagemAviso,\r\n  handleSendAviso,\r\n  sendingAviso,\r\n  deleteDialogOpen,\r\n  setDeleteDialogOpen,\r\n  handleDeleteFuncionario,\r\n  deleting,\r\n}: EmployeeActionsProps) {\r\n  const [resetDialogOpen, setResetDialogOpen] = useState(false);\r\n  const [newPassword, setNewPassword] = useState(\"\");\r\n  const [resetLoading, setResetLoading] = useState(false);\r\n\r\n  const handleResetPassword = async () => {\r\n    if (newPassword.length < 6) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"A senha deve ter pelo menos 6 caracteres\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    setResetLoading(true);\r\n    try {\r\n      const response = await fetch(\r\n        `/api/admin/users/${funcionario.id}/reset-password`,\r\n        {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({ newPassword }),\r\n        }\r\n      );\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) throw new Error(data.error);\r\n\r\n      toast({\r\n        title: \"Sucesso\",\r\n        description: \"Senha resetada com sucesso\",\r\n      });\r\n      setResetDialogOpen(false);\r\n      setNewPassword(\"\");\r\n    } catch (error: any) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: error.message || \"Erro ao resetar senha\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setResetLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader>\r\n        <CardTitle>A├º├Áes de Gest├úo</CardTitle>\r\n      </CardHeader>\r\n      <CardContent>\r\n        <div className=\"flex flex-wrap gap-4\">\r\n          <Dialog open={dialogAvisoOpen} onOpenChange={setDialogAvisoOpen}>\r\n            <DialogTrigger asChild>\r\n              <InteractiveHoverButton className=\"bg-blue-600 text-white hover:bg-blue-700\">\r\n                <Mail className=\"mr-2 h-4 w-4\" />\r\n                Enviar Aviso\r\n              </InteractiveHoverButton>\r\n            </DialogTrigger>\r\n            <DialogContent>\r\n              <DialogHeader>\r\n                <DialogTitle>Enviar Aviso para {funcionario.nome}</DialogTitle>\r\n                <DialogDescription>\r\n                  Esta mensagem aparecer├í no mural de avisos do funcion├írio.\r\n                </DialogDescription>\r\n              </DialogHeader>\r\n              <div className=\"space-y-4 py-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label>Mensagem</Label>\r\n                  <Textarea\r\n                    placeholder=\"Digite sua mensagem aqui...\"\r\n                    value={mensagemAviso}\r\n                    onChange={(e) => setMensagemAviso(e.target.value)}\r\n                    rows={4}\r\n                  />\r\n                </div>\r\n                <div className=\"flex justify-end gap-2\">\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    onClick={() => setDialogAvisoOpen(false)}\r\n                  >\r\n                    Cancelar\r\n                  </Button>\r\n                  <Button onClick={handleSendAviso} disabled={sendingAviso}>\r\n                    {sendingAviso ? \"Enviando...\" : \"Enviar\"}\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </DialogContent>\r\n          </Dialog>\r\n\r\n          <Dialog open={resetDialogOpen} onOpenChange={setResetDialogOpen}>\r\n            <DialogTrigger asChild>\r\n              <InteractiveHoverButton className=\"bg-amber-500 text-white hover:bg-amber-600 border-amber-600\">\r\n                <Lock className=\"mr-2 h-4 w-4\" />\r\n                Resetar Senha\r\n              </InteractiveHoverButton>\r\n            </DialogTrigger>\r\n            <DialogContent>\r\n              <DialogHeader>\r\n                <DialogTitle>Resetar Senha de {funcionario.nome}</DialogTitle>\r\n                <DialogDescription>\r\n                  Defina uma nova senha para este usu├írio.\r\n                </DialogDescription>\r\n              </DialogHeader>\r\n              <div className=\"space-y-4 py-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label>Nova Senha</Label>\r\n                  <Input\r\n                    type=\"password\"\r\n                    placeholder=\"M├¡nimo 6 caracteres\"\r\n                    value={newPassword}\r\n                    onChange={(e) => setNewPassword(e.target.value)}\r\n                  />\r\n                </div>\r\n                <div className=\"flex justify-end gap-2\">\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    onClick={() => setResetDialogOpen(false)}\r\n                  >\r\n                    Cancelar\r\n                  </Button>\r\n                  <Button onClick={handleResetPassword} disabled={resetLoading}>\r\n                    {resetLoading ? \"Salvando...\" : \"Salvar Nova Senha\"}\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </DialogContent>\r\n          </Dialog>\r\n\r\n          <Dialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\r\n            <DialogTrigger asChild>\r\n              <InteractiveHoverButton className=\"bg-red-500 text-white hover:bg-red-600 border-red-600\">\r\n                <Trash2 className=\"mr-2 h-4 w-4\" />\r\n                Excluir Funcion├írio\r\n              </InteractiveHoverButton>\r\n            </DialogTrigger>\r\n            <DialogContent>\r\n              <DialogHeader>\r\n                <DialogTitle>Excluir Funcion├írio</DialogTitle>\r\n                <DialogDescription>\r\n                  Tem certeza que deseja excluir{\" \"}\r\n                  <strong>{funcionario.nome}</strong>? Esta a├º├úo n├úo pode ser\r\n                  desfeita e remover├í o acesso deste usu├írio ao sistema.\r\n                </DialogDescription>\r\n              </DialogHeader>\r\n              <div className=\"flex justify-end gap-2 mt-4\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  onClick={() => setDeleteDialogOpen(false)}\r\n                  disabled={deleting}\r\n                >\r\n                  Cancelar\r\n                </Button>\r\n                <Button\r\n                  variant=\"destructive\"\r\n                  onClick={handleDeleteFuncionario}\r\n                  disabled={deleting}\r\n                >\r\n                  {deleting ? \"Excluindo...\" : \"Confirmar Exclus├úo\"}\r\n                </Button>\r\n              </div>\r\n            </DialogContent>\r\n          </Dialog>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\estoque\\_components\\lot-manager-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":114,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3102,3105],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3102,3105],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":114,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3110,3113],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3110,3113],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AnimatedLoadingSkeleton } from \"@/components/ui/loading\";\r\nimport { useState, useEffect } from \"react\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { InteractiveHoverButton } from \"@/components/ui/interactive-hover-button\";\r\nimport { Plus, Calendar } from \"lucide-react\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { parseCurrency } from \"@/lib/utils\";\r\n\r\ninterface Lote {\r\n  id: string;\r\n  numeroLote: string;\r\n  dataValidade: string | null;\r\n  quantidade: number;\r\n  precoCompra: number;\r\n  status?: string;\r\n  createdAt: string;\r\n  dataCompra?: string;\r\n}\r\n\r\ninterface Product {\r\n  id: string;\r\n  nome: string;\r\n}\r\n\r\ninterface LotManagerDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  product: Product | null;\r\n  onSuccess?: () => void;\r\n}\r\n\r\nexport function LotManagerDialog({\r\n  open,\r\n  onOpenChange,\r\n  product,\r\n  onSuccess,\r\n}: LotManagerDialogProps) {\r\n  const [productLots, setProductLots] = useState<Lote[]>([]);\r\n  const [loadingLots, setLoadingLots] = useState(false);\r\n  const [hideFinishedLots, setHideFinishedLots] = useState(true);\r\n  const [showNewLoteForm, setShowNewLoteForm] = useState(false);\r\n  const [creatingLote, setCreatingLote] = useState(false);\r\n\r\n  const [semValidade, setSemValidade] = useState(false);\r\n  const [newLoteData, setNewLoteData] = useState({\r\n    numeroLote: \"\",\r\n    dataValidade: \"\",\r\n    quantidade: \"\",\r\n    precoCompra: \"\",\r\n    dataCompra: \"\",\r\n    valorTotalLote: \"\",\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (open && product) {\r\n      fetchProductLots(product.id);\r\n      setShowNewLoteForm(false);\r\n      resetForm();\r\n    }\r\n  }, [open, product]);\r\n\r\n  // C├ílculo autom├ítico do Custo Unit├írio\r\n  useEffect(() => {\r\n    const qtd = parseCurrency(newLoteData.quantidade);\r\n    const total = parseCurrency(newLoteData.valorTotalLote);\r\n\r\n    if (!isNaN(qtd) && qtd > 0 && !isNaN(total)) {\r\n      const unitario = total / qtd;\r\n      setNewLoteData((prev) => ({\r\n        ...prev,\r\n        precoCompra: unitario.toFixed(2),\r\n      }));\r\n    }\r\n  }, [newLoteData.quantidade, newLoteData.valorTotalLote]);\r\n\r\n  const resetForm = () => {\r\n    setNewLoteData({\r\n      numeroLote: \"\",\r\n      dataValidade: \"\",\r\n      quantidade: \"\",\r\n      precoCompra: \"\",\r\n      dataCompra: \"\",\r\n      valorTotalLote: \"\",\r\n    });\r\n    setSemValidade(false);\r\n  };\r\n\r\n  const fetchProductLots = async (productId: string) => {\r\n    setLoadingLots(true);\r\n    setProductLots([]);\r\n    try {\r\n      const response = await fetch(`/api/admin/lotes?produtoId=${productId}`);\r\n      const data = await response.json();\r\n      if (response.ok) {\r\n        const sortedLots = Array.isArray(data)\r\n          ? data.sort((a: any, b: any) => {\r\n              if (!a.dataValidade) return 1;\r\n              if (!b.dataValidade) return -1;\r\n              return (\r\n                new Date(a.dataValidade).getTime() -\r\n                new Date(b.dataValidade).getTime()\r\n              );\r\n            })\r\n          : [];\r\n        setProductLots(sortedLots);\r\n      } else {\r\n        toast({\r\n          title: \"Erro\",\r\n          description: \"Erro ao buscar lotes.\",\r\n          variant: \"destructive\",\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Erro ao buscar lotes:\", error);\r\n    } finally {\r\n      setLoadingLots(false);\r\n    }\r\n  };\r\n\r\n  const handleCreateLote = async () => {\r\n    if (!product || !newLoteData.quantidade) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"Preencha a quantidade.\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (!semValidade && !newLoteData.dataValidade) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"Preencha a data de validade ou marque 'Sem validade'.\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    setCreatingLote(true);\r\n    try {\r\n      const response = await fetch(\"/api/admin/lotes\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          produtoId: product.id,\r\n          numeroLote: newLoteData.numeroLote,\r\n          dataValidade: semValidade ? null : newLoteData.dataValidade,\r\n          quantidade: parseInt(newLoteData.quantidade),\r\n          precoCompra: newLoteData.precoCompra\r\n            ? parseCurrency(newLoteData.precoCompra)\r\n            : 0,\r\n          dataCompra: newLoteData.dataCompra || null,\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || \"Erro ao criar lote\");\r\n      }\r\n\r\n      toast({\r\n        title: \"Sucesso\",\r\n        description: \"Lote criado com sucesso!\",\r\n      });\r\n\r\n      fetchProductLots(product.id);\r\n      resetForm();\r\n      setShowNewLoteForm(false);\r\n      onSuccess?.();\r\n    } catch (error) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description:\r\n          error instanceof Error ? error.message : \"Erro ao criar lote\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setCreatingLote(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"sm:max-w-[900px] bg-white dark:bg-zinc-900 border-gray-200 dark:border-zinc-800\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"text-gray-900 dark:text-gray-100\">\r\n            Lotes: {product?.nome}\r\n          </DialogTitle>\r\n          <DialogDescription className=\"text-gray-500 dark:text-gray-400\">\r\n            Gerenciamento de validade e lotes ativos.\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        {showNewLoteForm ? (\r\n          <div className=\"space-y-4 py-2\">\r\n            <div className=\"grid grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label\r\n                  htmlFor=\"numeroLote\"\r\n                  className=\"text-gray-700 dark:text-gray-300\"\r\n                >\r\n                  N├║mero do Lote (Opcional)\r\n                </Label>\r\n                <Input\r\n                  id=\"numeroLote\"\r\n                  value={newLoteData.numeroLote}\r\n                  onChange={(e) =>\r\n                    setNewLoteData({\r\n                      ...newLoteData,\r\n                      numeroLote: e.target.value,\r\n                    })\r\n                  }\r\n                  placeholder=\"Gerado automaticamente\"\r\n                  className=\"bg-white dark:bg-zinc-800 border-gray-200 dark:border-zinc-700 text-gray-900 dark:text-gray-100\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label\r\n                  htmlFor=\"quantidadeLote\"\r\n                  className=\"text-gray-700 dark:text-gray-300\"\r\n                >\r\n                  Quantidade\r\n                </Label>\r\n                <Input\r\n                  id=\"quantidadeLote\"\r\n                  type=\"number\"\r\n                  value={newLoteData.quantidade}\r\n                  onChange={(e) =>\r\n                    setNewLoteData({\r\n                      ...newLoteData,\r\n                      quantidade: e.target.value,\r\n                    })\r\n                  }\r\n                  placeholder=\"Qtd\"\r\n                  className=\"bg-white dark:bg-zinc-800 border-gray-200 dark:border-zinc-700 text-gray-900 dark:text-gray-100\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label\r\n                htmlFor=\"dataCompraLote\"\r\n                className=\"text-gray-700 dark:text-gray-300\"\r\n              >\r\n                Data Compra\r\n              </Label>\r\n              <Input\r\n                id=\"dataCompraLote\"\r\n                type=\"date\"\r\n                value={newLoteData.dataCompra}\r\n                onChange={(e) =>\r\n                  setNewLoteData({\r\n                    ...newLoteData,\r\n                    dataCompra: e.target.value,\r\n                  })\r\n                }\r\n                max={new Date().toISOString().split(\"T\")[0]}\r\n                className=\"bg-white dark:bg-zinc-800 border-gray-200 dark:border-zinc-700 text-gray-900 dark:text-gray-100\"\r\n              />\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label\r\n                  htmlFor=\"valorTotalLote\"\r\n                  className=\"text-gray-700 dark:text-gray-300\"\r\n                >\r\n                  Valor Total do Lote (R$)\r\n                </Label>\r\n                <Input\r\n                  id=\"valorTotalLote\"\r\n                  type=\"number\"\r\n                  step=\"0.01\"\r\n                  value={newLoteData.valorTotalLote}\r\n                  onChange={(e) =>\r\n                    setNewLoteData({\r\n                      ...newLoteData,\r\n                      valorTotalLote: e.target.value,\r\n                    })\r\n                  }\r\n                  placeholder=\"0.00\"\r\n                  className=\"bg-white dark:bg-zinc-800 border-gray-200 dark:border-zinc-700 text-gray-900 dark:text-gray-100\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label\r\n                  htmlFor=\"custoLote\"\r\n                  className=\"text-gray-700 dark:text-gray-300\"\r\n                >\r\n                  Custo Unit. (R$)\r\n                </Label>\r\n                <Input\r\n                  id=\"custoLote\"\r\n                  type=\"number\"\r\n                  step=\"0.01\"\r\n                  value={newLoteData.precoCompra}\r\n                  readOnly\r\n                  placeholder=\"Calculado auto\"\r\n                  className=\"bg-gray-100 dark:bg-zinc-800 dark:text-gray-300 cursor-not-allowed\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <Label\r\n                  htmlFor=\"validadeLote\"\r\n                  className=\"text-gray-700 dark:text-gray-300\"\r\n                >\r\n                  Data de Validade\r\n                </Label>\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <Checkbox\r\n                    id=\"semValidade\"\r\n                    checked={semValidade}\r\n                    onCheckedChange={(checked) => {\r\n                      setSemValidade(checked as boolean);\r\n                      if (checked) {\r\n                        setNewLoteData((prev) => ({\r\n                          ...prev,\r\n                          dataValidade: \"\",\r\n                        }));\r\n                      }\r\n                    }}\r\n                  />\r\n                  <Label\r\n                    htmlFor=\"semValidade\"\r\n                    className=\"text-sm font-normal cursor-pointer text-gray-700 dark:text-gray-300\"\r\n                  >\r\n                    Sem validade\r\n                  </Label>\r\n                </div>\r\n              </div>\r\n              <Input\r\n                id=\"validadeLote\"\r\n                type=\"date\"\r\n                value={newLoteData.dataValidade}\r\n                onChange={(e) =>\r\n                  setNewLoteData({\r\n                    ...newLoteData,\r\n                    dataValidade: e.target.value,\r\n                  })\r\n                }\r\n                disabled={semValidade}\r\n                className=\"bg-white dark:bg-zinc-800 border-gray-200 dark:border-zinc-700 text-gray-900 dark:text-gray-100\"\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex justify-end gap-2 pt-2\">\r\n              <InteractiveHoverButton\r\n                className=\"bg-white hover:bg-gray-50 dark:bg-zinc-800 dark:hover:bg-zinc-700 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-zinc-700\"\r\n                onClick={() => setShowNewLoteForm(false)}\r\n              >\r\n                Cancelar\r\n              </InteractiveHoverButton>\r\n              <InteractiveHoverButton\r\n                onClick={handleCreateLote}\r\n                disabled={creatingLote}\r\n                className=\"bg-primary text-primary-foreground border-primary hover:bg-primary/90\"\r\n              >\r\n                {creatingLote ? \"Salvando...\" : \"Salvar Lote\"}\r\n              </InteractiveHoverButton>\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {loadingLots ? (\r\n              <div className=\"py-4\">\r\n                <AnimatedLoadingSkeleton />\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex justify-between items-center\">\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <Checkbox\r\n                      id=\"hideFinishedLots\"\r\n                      checked={hideFinishedLots}\r\n                      onCheckedChange={(checked) =>\r\n                        setHideFinishedLots(checked as boolean)\r\n                      }\r\n                      className=\"border-gray-300 dark:border-zinc-600 data-[state=checked]:bg-primary dark:data-[state=checked]:bg-primary\"\r\n                    />\r\n                    <Label\r\n                      htmlFor=\"hideFinishedLots\"\r\n                      className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-gray-700 dark:text-gray-300\"\r\n                    >\r\n                      Ocultar finalizados\r\n                    </Label>\r\n                  </div>\r\n                  <InteractiveHoverButton\r\n                    onClick={() => setShowNewLoteForm(true)}\r\n                    className=\"gap-2 bg-primary text-primary-foreground border-primary hover:bg-primary/90\"\r\n                  >\r\n                    <span className=\"flex items-center gap-2\">\r\n                      <Plus className=\"h-4 w-4\" />\r\n                      Novo Lote\r\n                    </span>\r\n                  </InteractiveHoverButton>\r\n                </div>\r\n                <div className=\"border border-gray-200 dark:border-zinc-800 rounded-md overflow-hidden max-h-[300px] overflow-y-auto\">\r\n                  <Table>\r\n                    <TableHeader>\r\n                      <TableRow className=\"bg-gray-50 dark:bg-zinc-800 hover:bg-gray-50 dark:hover:bg-zinc-800 border-gray-200 dark:border-zinc-700\">\r\n                        <TableHead className=\"text-gray-700 dark:text-gray-300\">\r\n                          Lote\r\n                        </TableHead>\r\n                        <TableHead className=\"text-gray-700 dark:text-gray-300\">\r\n                          Data Compra\r\n                        </TableHead>\r\n                        <TableHead className=\"text-gray-700 dark:text-gray-300\">\r\n                          Validade\r\n                        </TableHead>\r\n                        <TableHead className=\"text-gray-700 dark:text-gray-300\">\r\n                          Custo Total\r\n                        </TableHead>\r\n                        <TableHead className=\"text-gray-700 dark:text-gray-300\">\r\n                          Qtd.\r\n                        </TableHead>\r\n                        <TableHead className=\"text-gray-700 dark:text-gray-300\">\r\n                          Status\r\n                        </TableHead>\r\n                      </TableRow>\r\n                    </TableHeader>\r\n                    <TableBody>\r\n                      {productLots.filter((lote) =>\r\n                        hideFinishedLots\r\n                          ? lote.status !== \"esgotado\" && lote.quantidade > 0\r\n                          : true\r\n                      ).length === 0 ? (\r\n                        <TableRow>\r\n                          <TableCell\r\n                            colSpan={6}\r\n                            className=\"text-center py-4 text-gray-500 dark:text-gray-400\"\r\n                          >\r\n                            Nenhum lote encontrado.\r\n                          </TableCell>\r\n                        </TableRow>\r\n                      ) : (\r\n                        productLots\r\n                          .filter((lote) =>\r\n                            hideFinishedLots\r\n                              ? lote.status !== \"esgotado\" &&\r\n                                lote.quantidade > 0\r\n                              : true\r\n                          )\r\n                          .map((lote) => {\r\n                            // L├│gica de Status simplificada\r\n                            let statusBadge;\r\n                            if (lote.status === \"vencido\") {\r\n                              statusBadge = (\r\n                                <Badge\r\n                                  variant=\"destructive\"\r\n                                  className=\"text-[10px] h-5 whitespace-nowrap\"\r\n                                >\r\n                                  Vencido\r\n                                </Badge>\r\n                              );\r\n                            } else if (lote.status === \"proximo_vencimento\") {\r\n                              statusBadge = (\r\n                                <Badge className=\"bg-yellow-500 text-[10px] h-5 whitespace-nowrap\">\r\n                                  Vence Logo\r\n                                </Badge>\r\n                              );\r\n                            } else if (!lote.dataValidade) {\r\n                              statusBadge = (\r\n                                <Badge\r\n                                  variant=\"secondary\"\r\n                                  className=\"text-[10px] h-5 whitespace-nowrap bg-gray-100 dark:bg-zinc-800 text-gray-700 dark:text-gray-300\"\r\n                                >\r\n                                  S/ Validade\r\n                                </Badge>\r\n                              );\r\n                            } else if (\r\n                              lote.quantidade === 0 ||\r\n                              lote.status === \"esgotado\"\r\n                            ) {\r\n                              statusBadge = (\r\n                                <Badge\r\n                                  variant=\"secondary\"\r\n                                  className=\"bg-gray-200 dark:bg-zinc-800 text-gray-600 dark:text-gray-400 text-[10px] h-5 whitespace-nowrap\"\r\n                                >\r\n                                  Finalizado\r\n                                </Badge>\r\n                              );\r\n                            } else {\r\n                              statusBadge = (\r\n                                <Badge\r\n                                  variant=\"outline\"\r\n                                  className=\"text-green-600 dark:text-green-400 border-green-200 dark:border-green-800 text-[10px] h-5 whitespace-nowrap\"\r\n                                >\r\n                                  Normal\r\n                                </Badge>\r\n                              );\r\n                            }\r\n\r\n                            return (\r\n                              <TableRow\r\n                                key={lote.id}\r\n                                className=\"border-gray-200 dark:border-zinc-800 hover:bg-gray-50 dark:hover:bg-zinc-800/50\"\r\n                              >\r\n                                <TableCell className=\"font-mono text-xs text-gray-600 dark:text-gray-300\">\r\n                                  {lote.numeroLote}\r\n                                </TableCell>\r\n                                <TableCell className=\"text-gray-600 dark:text-gray-300\">\r\n                                  {lote.dataCompra || lote.createdAt\r\n                                    ? new Date(\r\n                                        lote.dataCompra || lote.createdAt\r\n                                      ).toLocaleDateString(\"pt-BR\")\r\n                                    : \"-\"}\r\n                                </TableCell>\r\n                                <TableCell>\r\n                                  {lote.dataValidade ? (\r\n                                    <div className=\"flex items-center gap-1 text-gray-600 dark:text-gray-300\">\r\n                                      <Calendar className=\"h-3 w-3 text-gray-400\" />\r\n                                      {new Date(\r\n                                        lote.dataValidade\r\n                                      ).toLocaleDateString(\"pt-BR\")}\r\n                                    </div>\r\n                                  ) : (\r\n                                    <span className=\"text-gray-500 dark:text-gray-400 italic\">\r\n                                      Indeterminado\r\n                                    </span>\r\n                                  )}\r\n                                </TableCell>\r\n                                <TableCell className=\"text-gray-600 dark:text-gray-300\">\r\n                                  R${\" \"}\r\n                                  {(\r\n                                    Number(lote.precoCompra || 0) *\r\n                                    lote.quantidade\r\n                                  ).toFixed(2)}\r\n                                </TableCell>\r\n                                <TableCell className=\"font-medium text-gray-900 dark:text-gray-100\">\r\n                                  {lote.quantidade}\r\n                                </TableCell>\r\n                                <TableCell>{statusBadge}</TableCell>\r\n                              </TableRow>\r\n                            );\r\n                          })\r\n                      )}\r\n                    </TableBody>\r\n                  </Table>\r\n                </div>\r\n                <div className=\"flex justify-end\">\r\n                  <InteractiveHoverButton\r\n                    className=\"bg-white hover:bg-gray-50 dark:bg-zinc-800 dark:hover:bg-zinc-700 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-zinc-700\"\r\n                    onClick={() => onOpenChange(false)}\r\n                  >\r\n                    Fechar\r\n                  </InteractiveHoverButton>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </>\r\n        )}\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\forgot-password\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1228,1231],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1228,1231],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  Mail,\r\n  ArrowRight,\r\n  Loader2,\r\n  AlertTriangle,\r\n  CheckCircle2,\r\n  ArrowLeft,\r\n} from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Sparkles } from \"@/components/Sparkles\";\r\nimport { ThemeToggle } from \"@/components/theme-toggle\";\r\n\r\nexport default function ForgotPasswordPage() {\r\n  const [email, setEmail] = useState(\"\");\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [success, setSuccess] = useState(false);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n    setError(\"\");\r\n    setSuccess(false);\r\n\r\n    try {\r\n      const res = await fetch(\"/api/auth/forgot-password\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ email }),\r\n      });\r\n\r\n      const data = await res.json();\r\n\r\n      if (!res.ok) {\r\n        throw new Error(\r\n          data.error || \"Ocorreu um erro ao tentar recuperar a senha.\"\r\n        );\r\n      }\r\n\r\n      setSuccess(true);\r\n    } catch (error: any) {\r\n      setError(\r\n        error.message ||\r\n          \"Ocorreu um erro ao tentar recuperar a senha. Tente novamente.\"\r\n      );\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"min-h-screen w-full flex bg-white dark:bg-black text-gray-900 dark:text-white overflow-hidden relative\">\r\n      {/* Background */}\r\n      <div className=\"absolute inset-0 z-0\">\r\n        <Sparkles />\r\n      </div>\r\n\r\n      <div className=\"absolute top-8 right-8 z-50\">\r\n        <ThemeToggle />\r\n      </div>\r\n\r\n      <div className=\"w-full h-full flex items-center justify-center relative z-10 p-4\">\r\n        <motion.div\r\n          initial={{ opacity: 0, y: 20 }}\r\n          animate={{ opacity: 1, y: 0 }}\r\n          transition={{ duration: 0.5 }}\r\n          className=\"w-full max-w-md bg-white/80 dark:bg-zinc-900/80 backdrop-blur-xl border border-gray-200 dark:border-zinc-800 rounded-2xl p-8 shadow-2xl\"\r\n        >\r\n          <div className=\"mb-8\">\r\n            <Link\r\n              href=\"/login\"\r\n              className=\"inline-flex items-center text-sm text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 mb-6 transition-colors\"\r\n            >\r\n              <ArrowLeft size={16} className=\"mr-2\" />\r\n              Voltar para o login\r\n            </Link>\r\n            <h1 className=\"text-3xl font-bold tracking-tight mb-2\">\r\n              Recuperar senha\r\n            </h1>\r\n            <p className=\"text-gray-500 dark:text-gray-400\">\r\n              Digite seu email para receber as instru├º├Áes de recupera├º├úo.\r\n            </p>\r\n          </div>\r\n\r\n          {success ? (\r\n            <motion.div\r\n              initial={{ opacity: 0, scale: 0.95 }}\r\n              animate={{ opacity: 1, scale: 1 }}\r\n              className=\"text-center py-8\"\r\n            >\r\n              <div className=\"w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600\">\r\n                <CheckCircle2 size={32} />\r\n              </div>\r\n              <h3 className=\"text-xl font-bold mb-2\">Email enviado!</h3>\r\n              <p className=\"text-gray-500 dark:text-gray-400 mb-6\">\r\n                Verifique sua caixa de entrada para redefinir sua senha.\r\n              </p>\r\n              <Button\r\n                variant=\"outline\"\r\n                className=\"w-full\"\r\n                onClick={() => setSuccess(false)}\r\n              >\r\n                Enviar novamente\r\n              </Button>\r\n            </motion.div>\r\n          ) : (\r\n            <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n              <div className=\"space-y-2\">\r\n                <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n                  Email\r\n                </label>\r\n                <div className=\"relative\">\r\n                  <Mail className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n                  <input\r\n                    type=\"email\"\r\n                    value={email}\r\n                    onChange={(e) => setEmail(e.target.value)}\r\n                    className=\"w-full bg-gray-50 dark:bg-zinc-950 border border-gray-200 dark:border-zinc-800 rounded-xl px-12 py-4 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                    placeholder=\"seu@email.com\"\r\n                    required\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              {error && (\r\n                <motion.div\r\n                  initial={{ opacity: 0, height: 0 }}\r\n                  animate={{ opacity: 1, height: \"auto\" }}\r\n                  className=\"flex items-center gap-2 text-red-600 bg-red-50 dark:bg-red-900/20 p-3 rounded-lg text-sm font-medium\"\r\n                >\r\n                  <AlertTriangle size={16} />\r\n                  {error}\r\n                </motion.div>\r\n              )}\r\n\r\n              <Button\r\n                type=\"submit\"\r\n                disabled={loading}\r\n                className=\"w-full h-14 text-lg font-bold rounded-xl flex items-center justify-center gap-2\"\r\n              >\r\n                {loading ? (\r\n                  <Loader2 className=\"animate-spin w-5 h-5\" />\r\n                ) : (\r\n                  <>\r\n                    Enviar instru├º├Áes\r\n                    <ArrowRight size={20} />\r\n                  </>\r\n                )}\r\n              </Button>\r\n            </form>\r\n          )}\r\n        </motion.div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\gerente\\_components\\dashboard-client.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is assigned a value but never used.","line":64,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":64,"endColumn":51}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useSession } from \"next-auth/react\";\r\nimport { StockAlerts } from \"@/app/admin/_components/parts/StockAlerts\";\r\nimport { ProductWithCategory } from \"@/lib/types\";\r\nimport {\r\n  SharedDashboard,\r\n  DashboardMetrics,\r\n  CaixaData,\r\n} from \"@/components/dashboard/shared-dashboard\";\r\n\r\n// Interface local para lotes (com data em string como vem da API)\r\ninterface LoteVencimentoData {\r\n  id: string;\r\n  numeroLote: string;\r\n  quantidade: number;\r\n  dataValidade: string;\r\n  produto: {\r\n    id: string;\r\n    nome: string;\r\n    sku: string;\r\n  };\r\n}\r\n\r\ninterface DashboardData extends DashboardMetrics {\r\n  lastSales: {\r\n    id: string;\r\n    valorTotal: number;\r\n    createdAt: string;\r\n  }[];\r\n  avisos: {\r\n    id: string;\r\n    mensagem: string;\r\n    importante: boolean;\r\n    criadoEm: string;\r\n  }[];\r\n  produtosEstoqueBaixo: ProductWithCategory[];\r\n  lotesVencimentoProximo: LoteVencimentoData[];\r\n  topLowStock?: ProductWithCategory[];\r\n}\r\n\r\ninterface AdminStatsResponse {\r\n  stats?: {\r\n    topLowStock: ProductWithCategory[];\r\n  };\r\n  produtosEstoqueBaixo?: ProductWithCategory[];\r\n  lotesVencimentoProximo?: LoteVencimentoData[];\r\n}\r\n\r\nexport default function GerenteDashboardClient() {\r\n  const { data: session } = useSession();\r\n  const [data, setData] = useState<DashboardData | null>(null);\r\n  const [caixaData, setCaixaData] = useState<CaixaData | null | undefined>(\r\n    undefined\r\n  ); // undefined = ainda n├úo buscou\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    async function fetchData() {\r\n      try {\r\n        // ­ƒÜÇ Otimiza├º├úo: Buscar TODOS os dados em paralelo\r\n        // Isso inclui analytics, dashboard-stats, caixa e avisos\r\n        const [resAnalytics, resAdmin, resCaixa, _] = await Promise.all([\r\n          fetch(\"/api/employee/analytics\"),\r\n          fetch(\"/api/admin/dashboard-stats\"),\r\n          fetch(\"/api/caixa\", { cache: \"no-store\" }),\r\n          fetch(\"/api/avisos\"),\r\n        ]);\r\n\r\n        let analyticsData = {};\r\n        let adminData: AdminStatsResponse = {};\r\n\r\n        if (resAnalytics.ok) {\r\n          analyticsData = await resAnalytics.json();\r\n        } else {\r\n          console.error(\"Failed to fetch analytics data\");\r\n        }\r\n\r\n        if (resAdmin.ok) {\r\n          adminData = await resAdmin.json();\r\n        } else {\r\n          console.error(\"Failed to fetch admin stats\");\r\n        }\r\n\r\n        // ­ƒÜÇ Armazenar dados do caixa para passar ao MeuCaixa\r\n        if (resCaixa.ok) {\r\n          const caixaJson = await resCaixa.json();\r\n          setCaixaData(caixaJson.caixaAberto || null);\r\n        } else {\r\n          setCaixaData(null);\r\n        }\r\n\r\n        setData({\r\n          salesToday: 0, // Fallbacks\r\n          salesMonth: 0,\r\n          totalItemsSold: 0,\r\n          lastSales: [],\r\n          weeklySales: [],\r\n          avisos: [],\r\n          ...analyticsData, // Override with analytics\r\n          produtosEstoqueBaixo: adminData.produtosEstoqueBaixo || [],\r\n          lotesVencimentoProximo: adminData.lotesVencimentoProximo || [],\r\n          topLowStock: adminData.stats?.topLowStock || [],\r\n        } as DashboardData);\r\n      } catch (error) {\r\n        console.error(\"Failed to fetch dashboard data\", error);\r\n        setCaixaData(null); // Em caso de erro, seta como null\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    }\r\n    fetchData();\r\n  }, []);\r\n\r\n  const currentDate = new Date().toLocaleDateString(\"pt-BR\", {\r\n    weekday: \"long\",\r\n    year: \"numeric\",\r\n    month: \"long\",\r\n    day: \"numeric\",\r\n  });\r\n\r\n  const formattedDate =\r\n    currentDate.charAt(0).toUpperCase() + currentDate.slice(1);\r\n\r\n  return (\r\n    <SharedDashboard\r\n      title={`Painel do Gerente - ${session?.user?.name?.split(\" \")[0]} ­ƒæï`}\r\n      subtitle={formattedDate}\r\n      metrics={data}\r\n      caixaData={caixaData}\r\n      loading={loading}\r\n    >\r\n      {/* Alertas de Estoque (Novo para Gerente) */}\r\n      <div className=\"mt-2\">\r\n        <h2 className=\"text-xl font-bold text-gray-900 dark:text-white mb-4\">\r\n          Alertas de Estoque\r\n        </h2>\r\n        <StockAlerts\r\n          produtosEstoqueBaixo={data?.produtosEstoqueBaixo || []}\r\n          lotesVencimentoProximo={data?.lotesVencimentoProximo || []}\r\n          topLowStock={data?.topLowStock}\r\n        />\r\n      </div>\r\n    </SharedDashboard>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\login\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ThemeToggle' is defined but never used.","line":17,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Sparkles' is defined but never used.","line":19,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { signIn } from \"next-auth/react\";\r\nimport { useRouter, useSearchParams } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  Mail,\r\n  Lock,\r\n  Eye,\r\n  EyeOff,\r\n  AlertTriangle,\r\n  ArrowRight,\r\n  Loader2,\r\n} from \"lucide-react\";\r\nimport { ThemeToggle } from \"@/components/theme-toggle\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Sparkles } from \"@/components/Sparkles\";\r\nimport { AuthLayout } from \"@/components/auth/auth-layout\";\r\n\r\nexport default function LoginPage() {\r\n  const [email, setEmail] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n\r\n  useEffect(() => {\r\n    const reason = searchParams?.get(\"reason\");\r\n    if (reason === \"inactivity\") {\r\n      setError(\"Sua sess├úo expirou por inatividade.\");\r\n    }\r\n  }, [searchParams]);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n    setError(\"\");\r\n\r\n    try {\r\n      const result = await signIn(\"credentials\", {\r\n        email: email.toLowerCase(),\r\n        password,\r\n        redirect: false,\r\n      });\r\n\r\n      if (result?.error) {\r\n        if (result.error === \"CredentialsSignin\") {\r\n          setError(\"Email ou senha inv├ílidos\");\r\n        } else if (result.error.includes(\"aguardando aprova├º├úo\")) {\r\n          // Redirecionar para p├ígina de bloqueio - empresa pendente\r\n          router.push(\r\n            `/bloqueado?reason=pendente&email=${encodeURIComponent(email)}`\r\n          );\r\n        } else if (\r\n          result.error.includes(\"Acesso suspenso\") ||\r\n          result.error.includes(\"Pagamento n├úo identificado\")\r\n        ) {\r\n          // Redirecionar para p├ígina de bloqueio - empresa pausada\r\n          router.push(\r\n            `/bloqueado?reason=pausado&email=${encodeURIComponent(email)}`\r\n          );\r\n        } else if (\r\n          result.error.includes(\"Acesso bloqueado\") ||\r\n          result.error.includes(\"mensalidade\")\r\n        ) {\r\n          // Redirecionar para p├ígina de bloqueio - mensalidade vencida\r\n          router.push(\r\n            `/bloqueado?reason=vencido&email=${encodeURIComponent(email)}`\r\n          );\r\n        } else {\r\n          setError(result.error);\r\n        }\r\n      } else {\r\n        const currentTime = Date.now().toString();\r\n        sessionStorage.setItem(\"pdv_tab_session_id\", currentTime);\r\n        localStorage.setItem(\"pdv_browser_session_id\", currentTime);\r\n\r\n        const response = await fetch(\"/api/auth/session\");\r\n        const session = await response.json();\r\n\r\n        if (session?.user?.role === \"master\") {\r\n          router.push(\"/master\");\r\n        } else if (session?.user?.role === \"admin\") {\r\n          router.push(\"/admin\");\r\n        } else {\r\n          router.push(\"/dashboard\");\r\n        }\r\n      }\r\n    } catch (error) {\r\n      setError(\"Erro ao fazer login\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <AuthLayout formPosition=\"right\">\r\n      <motion.div\r\n        initial={{ opacity: 0, y: 20 }}\r\n        animate={{ opacity: 1, y: 0 }}\r\n        transition={{ duration: 0.5 }}\r\n        className=\"w-full max-w-sm\"\r\n      >\r\n        <div className=\"mb-10\">\r\n          <h1 className=\"text-4xl font-bold tracking-tight mb-3\">\r\n            Bem-vindo de volta!\r\n          </h1>\r\n          <p className=\"text-gray-500 dark:text-gray-400 text-lg\">\r\n            Digite suas credenciais para acessar o painel.\r\n          </p>\r\n        </div>\r\n\r\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n              Email\r\n            </label>\r\n            <div className=\"relative\">\r\n              <Mail className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n              <input\r\n                type=\"email\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n                className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-12 py-4 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                placeholder=\"seu@email.com\"\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <div className=\"flex justify-between items-center\">\r\n              <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n                Senha\r\n              </label>\r\n              <Link\r\n                href=\"/forgot-password\"\r\n                className=\"text-sm text-blue-600 hover:text-blue-700 font-medium\"\r\n              >\r\n                Esqueceu a senha?\r\n              </Link>\r\n            </div>\r\n            <div className=\"relative\">\r\n              <Lock className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n              <input\r\n                type={showPassword ? \"text\" : \"password\"}\r\n                value={password}\r\n                onChange={(e) => setPassword(e.target.value)}\r\n                className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-12 py-4 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                placeholder=\"ÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇó\"\r\n                required\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowPassword(!showPassword)}\r\n                className=\"absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors\"\r\n              >\r\n                {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {error && (\r\n            <motion.div\r\n              initial={{ opacity: 0, height: 0 }}\r\n              animate={{ opacity: 1, height: \"auto\" }}\r\n              className=\"flex items-center gap-2 text-red-600 bg-red-50 dark:bg-red-900/20 p-3 rounded-lg text-sm font-medium\"\r\n            >\r\n              <AlertTriangle size={16} />\r\n              {error}\r\n            </motion.div>\r\n          )}\r\n\r\n          <Button\r\n            type=\"submit\"\r\n            disabled={loading}\r\n            className=\"w-full h-14 text-lg font-bold rounded-xl flex items-center justify-center gap-2\"\r\n          >\r\n            {loading ? (\r\n              <Loader2 className=\"animate-spin w-5 h-5\" />\r\n            ) : (\r\n              <>\r\n                Entrar\r\n                <ArrowRight size={20} />\r\n              </>\r\n            )}\r\n          </Button>\r\n        </form>\r\n\r\n        <div className=\"mt-8 text-center\">\r\n          <p className=\"text-gray-500 dark:text-gray-400\">\r\n            N├úo tem uma conta?{\" \"}\r\n            <Link\r\n              href=\"/signup\"\r\n              className=\"text-blue-600 font-bold hover:underline\"\r\n            >\r\n              Criar conta gr├ítis\r\n            </Link>\r\n          </p>\r\n        </div>\r\n      </motion.div>\r\n    </AuthLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\lotes\\_components\\lotes-client.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":486,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":486,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14067,14070],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14067,14070],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { InteractiveHoverButton } from \"@/components/ui/interactive-hover-button\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport {\r\n  Plus,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  XCircle,\r\n  Package,\r\n  Search,\r\n  Edit,\r\n} from \"lucide-react\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { AnimatedLoadingSkeleton } from \"@/components/ui/loading\";\r\nimport { parseCurrency } from \"@/lib/utils\";\r\n\r\ninterface Product {\r\n  id: string;\r\n  nome: string;\r\n  sku: string;\r\n  estoqueAtual: number;\r\n  estoqueMinimo: number;\r\n}\r\n\r\ninterface Lote {\r\n  id: string;\r\n  numeroLote: string;\r\n  dataValidade: string | null;\r\n  quantidade: number;\r\n  produtoId: string;\r\n  precoCompra: number;\r\n  createdAt: string;\r\n  produto: {\r\n    nome: string;\r\n    sku: string;\r\n    estoqueAtual: number;\r\n    estoqueMinimo: number;\r\n  };\r\n  status?: string;\r\n  diasParaVencer?: number;\r\n  dataCompra?: string;\r\n}\r\n\r\nexport default function LotesClient() {\r\n  const [lotes, setLotes] = useState<Lote[]>([]);\r\n  const [products, setProducts] = useState<Product[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [dialogOpen, setDialogOpen] = useState(false);\r\n  const [editingLoteId, setEditingLoteId] = useState<string | null>(null);\r\n\r\n  // Filtros\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [statusFilter, setStatusFilter] = useState<\r\n    | \"todos\"\r\n    | \"vencido\"\r\n    | \"proximo_vencimento\"\r\n    | \"normal\"\r\n    | \"sem_validade\"\r\n    | \"estoque_baixo\"\r\n    | \"esgotado\"\r\n  >(\"todos\");\r\n  const [ordenacao, setOrdenacao] = useState(\"nome-asc\");\r\n  const [hideFinished, setHideFinished] = useState(true);\r\n\r\n  // Form state\r\n  const [formData, setFormData] = useState({\r\n    produtoId: \"\",\r\n    numeroLote: \"\",\r\n    dataValidade: \"\",\r\n    quantidade: \"\",\r\n    valorTotalLote: \"\",\r\n    precoCompra: \"\",\r\n    dataCompra: \"\",\r\n  });\r\n  const [semValidade, setSemValidade] = useState(false);\r\n\r\n  useEffect(() => {\r\n    fetchLotes();\r\n    fetchProducts();\r\n  }, []);\r\n\r\n  // C├ílculo autom├ítico do Custo Unit├írio\r\n  useEffect(() => {\r\n    const qtd = parseCurrency(formData.quantidade);\r\n    const total = parseCurrency(formData.valorTotalLote);\r\n\r\n    if (!isNaN(qtd) && qtd > 0 && !isNaN(total)) {\r\n      const unitario = total / qtd;\r\n      setFormData((prev) => ({\r\n        ...prev,\r\n        precoCompra: unitario.toFixed(2),\r\n      }));\r\n    } else if (!formData.valorTotalLote) {\r\n      // Se limpar o valor total, limpa o unit├írio (opcional, mas bom pra UX)\r\n      // Mas se estiver editando e s├│ mudou a quantidade, talvez queira manter?\r\n      // A regra do usu├írio ├®: dividir valor do lote pela quantidade.\r\n      // Se n├úo tem valor do lote, n├úo calcula.\r\n    }\r\n  }, [formData.quantidade, formData.valorTotalLote]);\r\n\r\n  const fetchLotes = async () => {\r\n    try {\r\n      const response = await fetch(\"/api/admin/lotes\", { cache: \"no-store\" });\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || \"Erro ao carregar lotes\");\r\n      }\r\n\r\n      if (Array.isArray(data)) {\r\n        setLotes(data);\r\n      } else {\r\n        setLotes([]);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Erro ao carregar lotes:\", error);\r\n      setLotes([]);\r\n      toast({\r\n        title: \"Erro\",\r\n        description:\r\n          error instanceof Error ? error.message : \"Erro ao carregar lotes\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const fetchProducts = async () => {\r\n    try {\r\n      const response = await fetch(\"/api/admin/products\");\r\n      const data = await response.json();\r\n\r\n      if (Array.isArray(data)) {\r\n        setProducts(data);\r\n      } else {\r\n        setProducts([]);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Erro ao carregar produtos:\", error);\r\n      setProducts([]);\r\n    }\r\n  };\r\n\r\n  const handleOpenDialog = (lote?: Lote) => {\r\n    if (lote) {\r\n      setEditingLoteId(lote.id);\r\n      setFormData({\r\n        produtoId: lote.produtoId,\r\n        numeroLote: lote.numeroLote,\r\n        dataValidade: lote.dataValidade\r\n          ? new Date(lote.dataValidade).toISOString().split(\"T\")[0]\r\n          : \"\",\r\n        quantidade: lote.quantidade.toString(),\r\n        valorTotalLote: (Number(lote.precoCompra) * lote.quantidade).toFixed(2),\r\n        precoCompra: Number(lote.precoCompra).toFixed(2),\r\n        dataCompra: lote.dataCompra\r\n          ? new Date(lote.dataCompra).toISOString().split(\"T\")[0]\r\n          : \"\",\r\n      });\r\n      setSemValidade(!lote.dataValidade);\r\n    } else {\r\n      setEditingLoteId(null);\r\n      setFormData({\r\n        produtoId: \"\",\r\n        numeroLote: \"\",\r\n        dataValidade: \"\",\r\n        quantidade: \"\",\r\n        valorTotalLote: \"\",\r\n        precoCompra: \"\",\r\n        dataCompra: \"\",\r\n      });\r\n      setSemValidade(false);\r\n    }\r\n    setDialogOpen(true);\r\n  };\r\n\r\n  const handleCloseDialog = () => {\r\n    setDialogOpen(false);\r\n    setEditingLoteId(null);\r\n    setFormData({\r\n      produtoId: \"\",\r\n      numeroLote: \"\",\r\n      dataValidade: \"\",\r\n      quantidade: \"\",\r\n      valorTotalLote: \"\",\r\n      precoCompra: \"\",\r\n      dataCompra: \"\",\r\n    });\r\n    setSemValidade(false);\r\n  };\r\n\r\n  const handleDialogChange = (open: boolean) => {\r\n    if (!open) {\r\n      handleCloseDialog();\r\n    } else {\r\n      setDialogOpen(true);\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n\r\n    if (\r\n      !formData.produtoId ||\r\n      (!semValidade && !formData.dataValidade) ||\r\n      !formData.quantidade\r\n    ) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"Preencha os campos obrigat├│rios\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    const quantidade = parseInt(formData.quantidade);\r\n\r\n    if (quantidade <= 0) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"Quantidade deve ser maior que zero\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const url = \"/api/admin/lotes\";\r\n      const method = editingLoteId ? \"PUT\" : \"POST\";\r\n      const body = {\r\n        id: editingLoteId,\r\n        produtoId: formData.produtoId,\r\n        numeroLote: formData.numeroLote,\r\n        dataValidade: semValidade ? null : formData.dataValidade,\r\n        quantidade,\r\n        precoCompra: parseCurrency(formData.precoCompra) || 0,\r\n        dataCompra: formData.dataCompra || null,\r\n      };\r\n\r\n      const response = await fetch(url, {\r\n        method,\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(body),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 401) {\r\n          toast({\r\n            title: \"Sess├úo Expirada\",\r\n            description: \"Por favor, fa├ºa login novamente.\",\r\n            variant: \"destructive\",\r\n          });\r\n          // Opcional: Redirecionar para login ou for├ºar logout\r\n          // window.location.href = \"/login\";\r\n          return;\r\n        }\r\n        throw new Error(data.error || \"Erro ao salvar lote\");\r\n      }\r\n\r\n      toast({\r\n        title: \"Sucesso\",\r\n        description: editingLoteId\r\n          ? \"Lote atualizado com sucesso\"\r\n          : \"Lote criado com sucesso\",\r\n      });\r\n\r\n      handleCloseDialog();\r\n      fetchLotes();\r\n      fetchProducts(); // Atualizar lista de produtos para mostrar novo estoque\r\n    } catch (error) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description:\r\n          error instanceof Error ? error.message : \"Erro ao salvar lote\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  };\r\n\r\n  const getStatusBadge = (lote: Lote) => {\r\n    if (lote.status === \"esgotado\") {\r\n      return (\r\n        <Badge\r\n          variant=\"secondary\"\r\n          className=\"bg-gray-200 text-gray-600 hover:bg-gray-300 flex items-center gap-1\"\r\n        >\r\n          <Package className=\"h-3 w-3\" />\r\n          Finalizado\r\n        </Badge>\r\n      );\r\n    } else if (\r\n      lote.produto.estoqueAtual <= lote.produto.estoqueMinimo &&\r\n      lote.status !== \"vencido\"\r\n    ) {\r\n      return (\r\n        <Badge\r\n          variant=\"destructive\"\r\n          className=\"bg-red-100 text-red-800 hover:bg-red-200 flex items-center gap-1\"\r\n        >\r\n          <AlertTriangle className=\"h-3 w-3\" />\r\n          Estoque Baixo\r\n        </Badge>\r\n      );\r\n    } else if (lote.status === \"sem_validade\") {\r\n      return (\r\n        <Badge\r\n          variant=\"secondary\"\r\n          className=\"bg-gray-100 text-gray-800 hover:bg-gray-200 flex items-center gap-1\"\r\n        >\r\n          <CheckCircle className=\"h-3 w-3\" />\r\n          Sem Validade\r\n        </Badge>\r\n      );\r\n    } else if (lote.status === \"vencido\") {\r\n      return (\r\n        <Badge variant=\"destructive\" className=\"flex items-center gap-1\">\r\n          <XCircle className=\"h-3 w-3\" />\r\n          Vencido\r\n        </Badge>\r\n      );\r\n    } else if (lote.status === \"proximo_vencimento\") {\r\n      return (\r\n        <Badge\r\n          variant=\"default\"\r\n          className=\"bg-yellow-500 hover:bg-yellow-600 flex items-center gap-1\"\r\n        >\r\n          <AlertTriangle className=\"h-3 w-3\" />\r\n          Vence em {lote.diasParaVencer} dias\r\n        </Badge>\r\n      );\r\n    } else {\r\n      return (\r\n        <Badge\r\n          variant=\"default\"\r\n          className=\"bg-green-500 hover:bg-green-600 flex items-center gap-1\"\r\n        >\r\n          <CheckCircle className=\"h-3 w-3\" />\r\n          Normal\r\n        </Badge>\r\n      );\r\n    }\r\n  };\r\n\r\n  // L├│gica de Filtragem e Ordena├º├úo\r\n  const filteredAndSortedLotes = lotes\r\n    .filter((lote) => {\r\n      const matchesSearch =\r\n        lote.produto.nome.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        lote.numeroLote.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        lote.produto.sku.toLowerCase().includes(searchTerm.toLowerCase());\r\n\r\n      let matchesStatus = true;\r\n      if (statusFilter !== \"todos\") {\r\n        if (statusFilter === \"estoque_baixo\") {\r\n          matchesStatus =\r\n            lote.produto.estoqueAtual <= lote.produto.estoqueMinimo &&\r\n            lote.status !== \"vencido\" &&\r\n            lote.status !== \"esgotado\";\r\n        } else {\r\n          matchesStatus = lote.status === statusFilter;\r\n        }\r\n      }\r\n\r\n      // Filtro de ocultar finalizados\r\n      if (hideFinished && lote.status === \"esgotado\") {\r\n        return false;\r\n      }\r\n\r\n      return matchesSearch && matchesStatus;\r\n    })\r\n    .sort((a, b) => {\r\n      switch (ordenacao) {\r\n        case \"nome-asc\":\r\n          return a.produto.nome.localeCompare(b.produto.nome);\r\n        case \"nome-desc\":\r\n          return b.produto.nome.localeCompare(a.produto.nome);\r\n        case \"quantidade-asc\":\r\n          return a.quantidade - b.quantidade;\r\n        case \"quantidade-desc\":\r\n          return b.quantidade - a.quantidade;\r\n        case \"validade-proxima\":\r\n          if (!a.dataValidade) return 1;\r\n          if (!b.dataValidade) return -1;\r\n          return (\r\n            new Date(a.dataValidade).getTime() -\r\n            new Date(b.dataValidade).getTime()\r\n          );\r\n        case \"validade-distante\":\r\n          if (!a.dataValidade) return 1;\r\n          if (!b.dataValidade) return -1;\r\n          return (\r\n            new Date(b.dataValidade).getTime() -\r\n            new Date(a.dataValidade).getTime()\r\n          );\r\n        default:\r\n          return 0;\r\n      }\r\n    });\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"container mx-auto py-10\">\r\n        <AnimatedLoadingSkeleton />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <Card>\r\n        <CardHeader>\r\n          <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\r\n            <div>\r\n              <CardTitle className=\"text-gray-900 dark:text-gray-100\">\r\n                Lotes Cadastrados\r\n              </CardTitle>\r\n              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\r\n                Gerencie validades e estoque por lote\r\n              </p>\r\n            </div>\r\n\r\n            <InteractiveHoverButton\r\n              onClick={() => handleOpenDialog()}\r\n              className=\"bg-cta-bg text-white border-cta-bg hover:bg-cta-bg/90\"\r\n            >\r\n              <span className=\"flex items-center gap-2\">\r\n                <Plus className=\"h-4 w-4\" />\r\n                Novo Lote\r\n              </span>\r\n            </InteractiveHoverButton>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex flex-col md:flex-row gap-4 items-end mb-6\">\r\n            <div className=\"flex-1 w-full\">\r\n              <Label htmlFor=\"search\">Buscar Lote</Label>\r\n              <div className=\"relative\">\r\n                <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-gray-400\" />\r\n                <Input\r\n                  id=\"search\"\r\n                  placeholder=\"Nome do produto ou n├║mero do lote...\"\r\n                  className=\"pl-8\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                />\r\n              </div>\r\n            </div>\r\n            <div className=\"w-full md:w-[250px]\">\r\n              <Label>Status</Label>\r\n              <Select\r\n                value={statusFilter}\r\n                onValueChange={(value: any) => setStatusFilter(value)}\r\n              >\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Filtrar por status\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"todos\">Todos</SelectItem>\r\n                  <SelectItem value=\"normal\">Ô£à Normal</SelectItem>\r\n                  <SelectItem value=\"estoque_baixo\">\r\n                    ÔÜá´©Å Estoque Baixo\r\n                  </SelectItem>\r\n                  <SelectItem value=\"proximo_vencimento\">\r\n                    ÔÜá´©Å Pr├│ximo Vencimento\r\n                  </SelectItem>\r\n                  <SelectItem value=\"vencido\">ÔØî Vencido</SelectItem>\r\n                  <SelectItem value=\"esgotado\">­ƒôª Finalizado</SelectItem>\r\n                  <SelectItem value=\"sem_validade\">ÔÖ¥´©Å Sem Validade</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n            <div className=\"w-full md:w-[250px]\">\r\n              <Label>Ordenar por</Label>\r\n              <Select value={ordenacao} onValueChange={setOrdenacao}>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Ordenar por\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"nome-asc\">Nome (A-Z)</SelectItem>\r\n                  <SelectItem value=\"nome-desc\">Nome (Z-A)</SelectItem>\r\n                  <SelectItem value=\"quantidade-asc\">\r\n                    Quantidade (Menor &gt; Maior)\r\n                  </SelectItem>\r\n                  <SelectItem value=\"quantidade-desc\">\r\n                    Quantidade (Maior &gt; Menor)\r\n                  </SelectItem>\r\n                  <SelectItem value=\"validade-proxima\">\r\n                    Validade (Mais Pr├│xima)\r\n                  </SelectItem>\r\n                  <SelectItem value=\"validade-distante\">\r\n                    Validade (Mais Distante)\r\n                  </SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center space-x-2 mb-4\">\r\n            <Checkbox\r\n              id=\"hideFinished\"\r\n              checked={hideFinished}\r\n              onCheckedChange={(checked) => setHideFinished(checked as boolean)}\r\n            />\r\n            <Label\r\n              htmlFor=\"hideFinished\"\r\n              className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\r\n            >\r\n              Ocultar lotes finalizados/esgotados\r\n            </Label>\r\n          </div>\r\n\r\n          {filteredAndSortedLotes.length === 0 ? (\r\n            <div className=\"p-8 text-center text-gray-500 dark:text-gray-400 border rounded-md bg-gray-50 dark:bg-zinc-800 dark:border-zinc-700\">\r\n              <Package className=\"h-12 w-12 mx-auto mb-4 text-gray-400 dark:text-gray-600\" />\r\n              <p>Nenhum lote encontrado</p>\r\n              <p className=\"text-sm\">Tente ajustar os filtros de busca</p>\r\n            </div>\r\n          ) : (\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow className=\"hover:bg-gray-50 dark:hover:bg-zinc-800 border-gray-200 dark:border-zinc-700\">\r\n                  <TableHead className=\"text-gray-600 dark:text-gray-400\">\r\n                    Produto\r\n                  </TableHead>\r\n                  <TableHead className=\"text-gray-600 dark:text-gray-400\">\r\n                    N├║mero do Lote\r\n                  </TableHead>\r\n                  <TableHead className=\"text-gray-600 dark:text-gray-400\">\r\n                    Quantidade\r\n                  </TableHead>\r\n                  <TableHead className=\"text-gray-600 dark:text-gray-400\">\r\n                    Custo Unit.\r\n                  </TableHead>\r\n                  <TableHead className=\"text-gray-600 dark:text-gray-400\">\r\n                    Data Compra\r\n                  </TableHead>\r\n                  <TableHead className=\"text-gray-600 dark:text-gray-400\">\r\n                    Data de Validade\r\n                  </TableHead>\r\n                  <TableHead className=\"text-gray-600 dark:text-gray-400\">\r\n                    Status\r\n                  </TableHead>\r\n                  <TableHead className=\"text-right text-gray-600 dark:text-gray-400\">\r\n                    A├º├Áes\r\n                  </TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {filteredAndSortedLotes.map((lote) => (\r\n                  <TableRow\r\n                    key={lote.id}\r\n                    className=\"hover:bg-gray-50 dark:hover:bg-zinc-800 border-gray-200 dark:border-zinc-700\"\r\n                  >\r\n                    <TableCell>\r\n                      <div>\r\n                        <p className=\"font-medium text-gray-900 dark:text-gray-100\">\r\n                          {lote.produto.nome}\r\n                        </p>\r\n                        <p className=\"text-sm text-gray-500 dark:text-gray-400\">\r\n                          SKU: {lote.produto.sku}\r\n                        </p>\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell className=\"font-mono text-sm text-gray-600 dark:text-gray-300\">\r\n                      {lote.numeroLote}\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Badge\r\n                        variant=\"outline\"\r\n                        className=\"text-gray-700 dark:text-gray-300 border-gray-200 dark:border-zinc-700\"\r\n                      >\r\n                        {lote.quantidade} un\r\n                      </Badge>\r\n                    </TableCell>\r\n                    <TableCell className=\"text-gray-600 dark:text-gray-300\">\r\n                      R$ {Number(lote.precoCompra).toFixed(2)}\r\n                    </TableCell>\r\n                    <TableCell className=\"text-gray-600 dark:text-gray-300\">\r\n                      {lote.dataCompra\r\n                        ? new Date(lote.dataCompra).toLocaleDateString(\"pt-BR\")\r\n                        : \"-\"}\r\n                    </TableCell>\r\n                    <TableCell className=\"text-gray-600 dark:text-gray-300\">\r\n                      {lote.dataValidade\r\n                        ? new Date(lote.dataValidade).toLocaleDateString(\r\n                            \"pt-BR\"\r\n                          )\r\n                        : \"Indeterminado\"}\r\n                    </TableCell>\r\n                    <TableCell>{getStatusBadge(lote)}</TableCell>\r\n                    <TableCell className=\"text-right\">\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        onClick={() => handleOpenDialog(lote)}\r\n                        className=\"h-8 w-8 text-blue-600 hover:text-blue-700 hover:bg-blue-50 dark:text-blue-400 dark:hover:text-blue-300 dark:hover:bg-blue-900/20\"\r\n                      >\r\n                        <Edit className=\"h-4 w-4\" />\r\n                      </Button>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ))}\r\n              </TableBody>\r\n            </Table>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Dialog Novo Lote */}\r\n      <Dialog open={dialogOpen} onOpenChange={handleDialogChange}>\r\n        <DialogContent className=\"sm:max-w-[500px]\">\r\n          <DialogHeader>\r\n            <DialogTitle>\r\n              {editingLoteId ? \"Editar Lote\" : \"Novo Lote\"}\r\n            </DialogTitle>\r\n            <DialogDescription>\r\n              {editingLoteId\r\n                ? \"Edite as informa├º├Áes do lote.\"\r\n                : \"Adicione um novo lote ao estoque.\"}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <form onSubmit={handleSubmit} className=\"space-y-4 py-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"produto\">Produto</Label>\r\n              <Select\r\n                value={formData.produtoId}\r\n                onValueChange={(value) =>\r\n                  setFormData({ ...formData, produtoId: value })\r\n                }\r\n                disabled={!!editingLoteId}\r\n              >\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Selecione um produto\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {products.map((product) => (\r\n                    <SelectItem key={product.id} value={product.id}>\r\n                      {product.nome} (SKU: {product.sku})\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"numeroLote\">N├║mero do Lote</Label>\r\n                <Input\r\n                  id=\"numeroLote\"\r\n                  value={formData.numeroLote}\r\n                  onChange={(e) =>\r\n                    setFormData({ ...formData, numeroLote: e.target.value })\r\n                  }\r\n                  placeholder=\"Opcional (Gerado auto)\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"quantidade\">Quantidade</Label>\r\n                <Input\r\n                  id=\"quantidade\"\r\n                  type=\"number\"\r\n                  value={formData.quantidade}\r\n                  onChange={(e) =>\r\n                    setFormData({ ...formData, quantidade: e.target.value })\r\n                  }\r\n                  placeholder=\"Qtd\"\r\n                  required\r\n                  disabled={!!editingLoteId}\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"dataCompra\">Data de Compra</Label>\r\n              <Input\r\n                id=\"dataCompra\"\r\n                type=\"date\"\r\n                value={formData.dataCompra}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, dataCompra: e.target.value })\r\n                }\r\n                max={new Date().toISOString().split(\"T\")[0]}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"valorTotalLote\">Valor Total do Lote (R$)</Label>\r\n                <Input\r\n                  id=\"valorTotalLote\"\r\n                  type=\"number\"\r\n                  step=\"0.01\"\r\n                  value={formData.valorTotalLote}\r\n                  onChange={(e) =>\r\n                    setFormData({ ...formData, valorTotalLote: e.target.value })\r\n                  }\r\n                  placeholder=\"0.00\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"precoCompra\">Custo Unit├írio (R$)</Label>\r\n                <Input\r\n                  id=\"precoCompra\"\r\n                  type=\"number\"\r\n                  step=\"0.01\"\r\n                  value={formData.precoCompra}\r\n                  readOnly\r\n                  className=\"bg-gray-100 dark:bg-zinc-800 dark:text-gray-300\"\r\n                  placeholder=\"Calculado auto\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <Label htmlFor=\"dataValidade\">Data de Validade</Label>\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <Checkbox\r\n                    id=\"semValidade\"\r\n                    checked={semValidade}\r\n                    onCheckedChange={(checked) => {\r\n                      setSemValidade(checked as boolean);\r\n                      if (checked) {\r\n                        setFormData({ ...formData, dataValidade: \"\" });\r\n                      }\r\n                    }}\r\n                  />\r\n                  <Label\r\n                    htmlFor=\"semValidade\"\r\n                    className=\"text-sm font-normal cursor-pointer\"\r\n                  >\r\n                    Sem validade\r\n                  </Label>\r\n                </div>\r\n              </div>\r\n              <Input\r\n                id=\"dataValidade\"\r\n                type=\"date\"\r\n                value={formData.dataValidade}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, dataValidade: e.target.value })\r\n                }\r\n                disabled={semValidade}\r\n                required={!semValidade}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex justify-end gap-2 pt-4\">\r\n              <InteractiveHoverButton\r\n                type=\"button\"\r\n                className=\"bg-white hover:bg-gray-50 dark:bg-zinc-800 dark:hover:bg-zinc-700 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-zinc-700\"\r\n                onClick={handleCloseDialog}\r\n              >\r\n                Cancelar\r\n              </InteractiveHoverButton>\r\n              <InteractiveHoverButton\r\n                type=\"submit\"\r\n                className=\"bg-cta-bg text-white border-cta-bg hover:bg-cta-bg/90\"\r\n              >\r\n                {editingLoteId ? \"Salvar Altera├º├Áes\" : \"Criar Lote\"}\r\n              </InteractiveHoverButton>\r\n            </div>\r\n          </form>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\master\\empresas\\_components\\parts\\AvisoDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[403,406],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[403,406],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[422,425],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[422,425],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[451,454],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[451,454],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { InteractiveHoverButton } from \"@/components/ui/interactive-hover-button\";\r\n\r\ninterface AvisoDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  selectedEmpresa: any;\r\n  avisoData: any;\r\n  setAvisoData: (data: any) => void;\r\n  handleCriarAviso: () => void;\r\n}\r\n\r\nexport function AvisoDialog({\r\n  open,\r\n  onOpenChange,\r\n  selectedEmpresa,\r\n  avisoData,\r\n  setAvisoData,\r\n  handleCriarAviso,\r\n}: AvisoDialogProps) {\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent>\r\n        <DialogHeader>\r\n          <DialogTitle>Criar Aviso para: {selectedEmpresa?.nome}</DialogTitle>\r\n        </DialogHeader>\r\n        <div className=\"space-y-4\">\r\n          <div>\r\n            <Label htmlFor=\"mensagem\">Mensagem</Label>\r\n            <Textarea\r\n              id=\"mensagem\"\r\n              value={avisoData.mensagem}\r\n              onChange={(e) =>\r\n                setAvisoData({ ...avisoData, mensagem: e.target.value })\r\n              }\r\n              placeholder=\"Digite o aviso...\"\r\n              rows={4}\r\n            />\r\n          </div>\r\n          <div className=\"flex items-center space-x-2\">\r\n            <input\r\n              type=\"checkbox\"\r\n              id=\"importante\"\r\n              checked={avisoData.importante}\r\n              onChange={(e) =>\r\n                setAvisoData({ ...avisoData, importante: e.target.checked })\r\n              }\r\n            />\r\n            <Label htmlFor=\"importante\">Marcar como importante</Label>\r\n          </div>\r\n          <InteractiveHoverButton\r\n            onClick={handleCriarAviso}\r\n            className=\"w-full bg-primary text-primary-foreground border-primary hover:bg-primary/90\"\r\n          >\r\n            Criar Aviso\r\n          </InteractiveHoverButton>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\master\\empresas\\_components\\parts\\ClearDataAlert.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[466,469],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[466,469],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[503,506],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[503,506],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  AlertDialog,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { InteractiveHoverButton } from \"@/components/ui/interactive-hover-button\";\r\nimport { Trash2 } from \"lucide-react\";\r\n\r\ninterface ClearDataAlertProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  empresaToClear: any;\r\n  setEmpresaToClear: (empresa: any) => void;\r\n  clearDataConfirmText: string;\r\n  setClearDataConfirmText: (text: string) => void;\r\n  handleConfirmClearData: () => void;\r\n}\r\n\r\nexport function ClearDataAlert({\r\n  open,\r\n  onOpenChange,\r\n  empresaToClear,\r\n  setEmpresaToClear,\r\n  clearDataConfirmText,\r\n  setClearDataConfirmText,\r\n  handleConfirmClearData,\r\n}: ClearDataAlertProps) {\r\n  return (\r\n    <AlertDialog open={open} onOpenChange={onOpenChange}>\r\n      <AlertDialogContent>\r\n        <AlertDialogHeader>\r\n          <AlertDialogTitle>Limpar Dados de Teste?</AlertDialogTitle>\r\n          <AlertDialogDescription className=\"space-y-4\">\r\n            <div className=\"bg-orange-50 border border-orange-200 rounded p-3 text-orange-800 text-sm\">\r\n              ÔÜá´©Å <strong>Aten├º├úo:</strong> Esta a├º├úo ├® ideal para zerar uma\r\n              conta ap├│s testes.\r\n            </div>\r\n            <p>\r\n              Voc├¬ est├í prestes a apagar <strong>TODAS</strong> as movimenta├º├Áes\r\n              da empresa{\" \"}\r\n              <strong className=\"text-black\">{empresaToClear?.nome}</strong>.\r\n            </p>\r\n            <div className=\"space-y-2 pt-2\">\r\n              <p className=\"font-semibold text-sm\">\r\n                Digite{\" \"}\r\n                <span className=\"text-red-600 font-mono\">LIMPAR DADOS</span>{\" \"}\r\n                abaixo para confirmar:\r\n              </p>\r\n              <Input\r\n                value={clearDataConfirmText}\r\n                onChange={(e) =>\r\n                  setClearDataConfirmText(e.target.value.toUpperCase())\r\n                }\r\n                placeholder=\"LIMPAR DADOS\"\r\n                className=\"font-mono uppercase\"\r\n              />\r\n            </div>\r\n          </AlertDialogDescription>\r\n        </AlertDialogHeader>\r\n        <AlertDialogFooter>\r\n          <InteractiveHoverButton\r\n            className=\"bg-white hover:bg-gray-50 text-gray-700 border-gray-200\"\r\n            onClick={() => {\r\n              setClearDataConfirmText(\"\");\r\n              setEmpresaToClear(null);\r\n              onOpenChange(false);\r\n            }}\r\n          >\r\n            Cancelar\r\n          </InteractiveHoverButton>\r\n          <InteractiveHoverButton\r\n            onClick={handleConfirmClearData}\r\n            disabled={clearDataConfirmText !== \"LIMPAR DADOS\"}\r\n            className=\"bg-orange-600 hover:bg-orange-700 text-white border-orange-600 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            <Trash2 className=\"h-4 w-4 mr-2\" />\r\n            Limpar Tudo\r\n          </InteractiveHoverButton>\r\n        </AlertDialogFooter>\r\n      </AlertDialogContent>\r\n    </AlertDialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\master\\empresas\\_components\\parts\\CreateCompanyDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[951,954],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[951,954],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { InteractiveHoverButton } from \"@/components/ui/interactive-hover-button\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Loader2 } from \"lucide-react\";\r\n\r\ninterface CreateCompanyDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  onSubmit: (e: React.FormEvent) => void;\r\n  formData: {\r\n    nomeEmpresa: string;\r\n    cpfCnpj: string;\r\n    adminNome: string;\r\n    adminEmail: string;\r\n    adminSenha: string;\r\n    telefone: string;\r\n    diaVencimento: number;\r\n    // Address\r\n    cep: string;\r\n    logradouro: string;\r\n    numero: string;\r\n    bairro: string;\r\n    cidade: string;\r\n    estado: string;\r\n  };\r\n  setFormData: (data: any) => void;\r\n  submitting: boolean;\r\n  loadingCep?: boolean;\r\n  onCepBlur?: () => void;\r\n}\r\n\r\n// Format phone function\r\nconst formatPhone = (value: string) => {\r\n  const numbers = value.replace(/\\D/g, \"\");\r\n  if (numbers.length === 0) return \"\";\r\n  if (numbers.length <= 2) return `(${numbers}`;\r\n  if (numbers.length <= 6)\r\n    return `(${numbers.slice(0, 2)}) ${numbers.slice(2)}`;\r\n  if (numbers.length <= 10)\r\n    return `(${numbers.slice(0, 2)}) ${numbers.slice(2, 6)}-${numbers.slice(\r\n      6\r\n    )}`;\r\n  return `(${numbers.slice(0, 2)}) ${numbers.slice(2, 7)}-${numbers.slice(\r\n    7,\r\n    11\r\n  )}`;\r\n};\r\n\r\nconst formatCpfCnpj = (value: string) => {\r\n  const numbers = value.replace(/\\D/g, \"\");\r\n  if (numbers.length <= 11) {\r\n    return numbers\r\n      .replace(/(\\d{3})(\\d)/, \"$1.$2\")\r\n      .replace(/(\\d{3})(\\d)/, \"$1.$2\")\r\n      .replace(/(\\d{3})(\\d{1,2})/, \"$1-$2\")\r\n      .replace(/(-\\d{2})\\d+?$/, \"$1\");\r\n  }\r\n  return numbers\r\n    .replace(/^(\\d{2})(\\d)/, \"$1.$2\")\r\n    .replace(/^(\\d{2})\\.(\\d{3})(\\d)/, \"$1.$2.$3\")\r\n    .replace(/\\.(\\d{3})(\\d)/, \".$1/$2\")\r\n    .replace(/(\\d{4})(\\d)/, \"$1-$2\")\r\n    .replace(/(-\\d{2})\\d+?$/, \"$1\");\r\n};\r\n\r\nconst formatCep = (value: string) => {\r\n  return value\r\n    .replace(/\\D/g, \"\")\r\n    .replace(/^(\\d{5})(\\d)/, \"$1-$2\")\r\n    .slice(0, 9);\r\n};\r\n\r\nexport function CreateCompanyDialog({\r\n  open,\r\n  onOpenChange,\r\n  onSubmit,\r\n  formData,\r\n  setFormData,\r\n  submitting,\r\n  loadingCep,\r\n  onCepBlur,\r\n}: CreateCompanyDialogProps) {\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle>Criar Nova Empresa</DialogTitle>\r\n        </DialogHeader>\r\n        <form onSubmit={onSubmit} className=\"space-y-4\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div className=\"md:col-span-2\">\r\n              <Label htmlFor=\"nomeEmpresa\">Nome da Empresa</Label>\r\n              <Input\r\n                id=\"nomeEmpresa\"\r\n                value={formData.nomeEmpresa}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, nomeEmpresa: e.target.value })\r\n                }\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div>\r\n              <Label htmlFor=\"cpfCnpj\">CPF / CNPJ</Label>\r\n              <Input\r\n                id=\"cpfCnpj\"\r\n                value={formData.cpfCnpj}\r\n                onChange={(e) =>\r\n                  setFormData({\r\n                    ...formData,\r\n                    cpfCnpj: formatCpfCnpj(e.target.value),\r\n                  })\r\n                }\r\n                placeholder=\"00.000.000/0000-00\"\r\n                required\r\n              />\r\n            </div>\r\n            <div>\r\n              <Label htmlFor=\"telefone\">WhatsApp/Telefone</Label>\r\n              <Input\r\n                id=\"telefone\"\r\n                placeholder=\"(99) 99999-9999\"\r\n                value={formData.telefone}\r\n                onChange={(e) =>\r\n                  setFormData({\r\n                    ...formData,\r\n                    telefone: formatPhone(e.target.value),\r\n                  })\r\n                }\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"border-t pt-4\">\r\n            <h3 className=\"text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300\">\r\n              Endere├ºo\r\n            </h3>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-2\">\r\n              <div>\r\n                <Label htmlFor=\"cep\">CEP</Label>\r\n                <div className=\"relative\">\r\n                  <Input\r\n                    id=\"cep\"\r\n                    value={formData.cep}\r\n                    onChange={(e) =>\r\n                      setFormData({\r\n                        ...formData,\r\n                        cep: formatCep(e.target.value),\r\n                      })\r\n                    }\r\n                    onBlur={onCepBlur}\r\n                    placeholder=\"00000-000\"\r\n                    required\r\n                  />\r\n                  {loadingCep && (\r\n                    <div className=\"absolute right-2 top-1/2 -translate-y-1/2\">\r\n                      <Loader2 className=\"h-4 w-4 animate-spin text-gray-500\" />\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n              <div className=\"md:col-span-2\">\r\n                <Label htmlFor=\"logradouro\">Logradouro</Label>\r\n                <Input\r\n                  id=\"logradouro\"\r\n                  value={formData.logradouro}\r\n                  onChange={(e) =>\r\n                    setFormData({ ...formData, logradouro: e.target.value })\r\n                  }\r\n                  required\r\n                />\r\n              </div>\r\n            </div>\r\n            <div className=\"grid grid-cols-3 gap-4 mb-2\">\r\n              <div>\r\n                <Label htmlFor=\"numero\">N├║mero</Label>\r\n                <Input\r\n                  id=\"numero\"\r\n                  value={formData.numero}\r\n                  onChange={(e) =>\r\n                    setFormData({ ...formData, numero: e.target.value })\r\n                  }\r\n                  required\r\n                />\r\n              </div>\r\n              <div className=\"col-span-2\">\r\n                <Label htmlFor=\"bairro\">Bairro</Label>\r\n                <Input\r\n                  id=\"bairro\"\r\n                  value={formData.bairro}\r\n                  onChange={(e) =>\r\n                    setFormData({ ...formData, bairro: e.target.value })\r\n                  }\r\n                  required\r\n                />\r\n              </div>\r\n            </div>\r\n            <div className=\"grid grid-cols-3 gap-4\">\r\n              <div className=\"col-span-2\">\r\n                <Label htmlFor=\"cidade\">Cidade</Label>\r\n                <Input\r\n                  id=\"cidade\"\r\n                  value={formData.cidade}\r\n                  onChange={(e) =>\r\n                    setFormData({ ...formData, cidade: e.target.value })\r\n                  }\r\n                  required\r\n                />\r\n              </div>\r\n              <div>\r\n                <Label htmlFor=\"estado\">Estado (UF)</Label>\r\n                <Input\r\n                  id=\"estado\"\r\n                  value={formData.estado}\r\n                  maxLength={2}\r\n                  onChange={(e) =>\r\n                    setFormData({\r\n                      ...formData,\r\n                      estado: e.target.value.toUpperCase(),\r\n                    })\r\n                  }\r\n                  required\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"border-t pt-4\">\r\n            <h3 className=\"text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300\">\r\n              Administrador\r\n            </h3>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <div>\r\n                <Label htmlFor=\"adminNome\">Nome do Admin</Label>\r\n                <Input\r\n                  id=\"adminNome\"\r\n                  value={formData.adminNome}\r\n                  onChange={(e) =>\r\n                    setFormData({ ...formData, adminNome: e.target.value })\r\n                  }\r\n                  required\r\n                />\r\n              </div>\r\n              <div>\r\n                <Label htmlFor=\"adminEmail\">Email do Admin</Label>\r\n                <Input\r\n                  id=\"adminEmail\"\r\n                  type=\"email\"\r\n                  value={formData.adminEmail}\r\n                  onChange={(e) =>\r\n                    setFormData({ ...formData, adminEmail: e.target.value })\r\n                  }\r\n                  required\r\n                />\r\n              </div>\r\n            </div>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mt-2\">\r\n              <div>\r\n                <Label htmlFor=\"adminSenha\">Senha do Admin</Label>\r\n                <Input\r\n                  id=\"adminSenha\"\r\n                  type=\"password\"\r\n                  value={formData.adminSenha}\r\n                  onChange={(e) =>\r\n                    setFormData({ ...formData, adminSenha: e.target.value })\r\n                  }\r\n                  required\r\n                />\r\n              </div>\r\n              <div>\r\n                <Label htmlFor=\"diaVencimento\">Dia de Vencimento</Label>\r\n                <Select\r\n                  value={String(formData.diaVencimento)}\r\n                  onValueChange={(value) =>\r\n                    setFormData({ ...formData, diaVencimento: parseInt(value) })\r\n                  }\r\n                >\r\n                  <SelectTrigger id=\"diaVencimento\">\r\n                    <SelectValue placeholder=\"Selecione o dia\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {Array.from({ length: 28 }, (_, i) => i + 1).map((day) => (\r\n                      <SelectItem key={day} value={String(day)}>\r\n                        {day}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <InteractiveHoverButton\r\n            type=\"submit\"\r\n            className=\"w-full bg-cta-bg text-white border-cta-bg hover:bg-cta-bg/90 mt-4\"\r\n            disabled={submitting}\r\n          >\r\n            {submitting ? (\r\n              <div className=\"flex items-center justify-center gap-2\">\r\n                <Loader2 className=\"animate-spin h-5 w-5\" />\r\n                <span>Criando...</span>\r\n              </div>\r\n            ) : (\r\n              \"Criar Empresa\"\r\n            )}\r\n          </InteractiveHoverButton>\r\n        </form>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\master\\empresas\\_components\\parts\\DeleteCompanyAlert.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[431,434],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[431,434],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[469,472],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[469,472],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  AlertDialog,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { InteractiveHoverButton } from \"@/components/ui/interactive-hover-button\";\r\n\r\ninterface DeleteCompanyAlertProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  empresaToDelete: any;\r\n  setEmpresaToDelete: (empresa: any) => void;\r\n  deleteConfirmText: string;\r\n  setDeleteConfirmText: (text: string) => void;\r\n  handleConfirmDelete: () => void;\r\n}\r\n\r\nexport function DeleteCompanyAlert({\r\n  open,\r\n  onOpenChange,\r\n  empresaToDelete,\r\n  setEmpresaToDelete,\r\n  deleteConfirmText,\r\n  setDeleteConfirmText,\r\n  handleConfirmDelete,\r\n}: DeleteCompanyAlertProps) {\r\n  return (\r\n    <AlertDialog open={open} onOpenChange={onOpenChange}>\r\n      <AlertDialogContent>\r\n        <AlertDialogHeader>\r\n          <AlertDialogTitle>Tem certeza absoluta?</AlertDialogTitle>\r\n          <AlertDialogDescription className=\"space-y-4\">\r\n            <p>\r\n              Esta a├º├úo ├® <strong className=\"text-red-600\">IRREVERS├ìVEL</strong>{\" \"}\r\n              e excluir├í permanentemente a empresa{\" \"}\r\n              <strong className=\"text-black\">{empresaToDelete?.nome}</strong> e\r\n              todos os dados relacionados.\r\n            </p>\r\n            <div className=\"space-y-2 pt-2\">\r\n              <p className=\"font-semibold\">\r\n                Digite{\" \"}\r\n                <span className=\"text-red-600 font-mono\">\r\n                  {empresaToDelete?.nome}\r\n                </span>{\" \"}\r\n                abaixo para confirmar:\r\n              </p>\r\n              <Input\r\n                value={deleteConfirmText}\r\n                onChange={(e) => setDeleteConfirmText(e.target.value)}\r\n                placeholder=\"Digite o nome da empresa\"\r\n                className=\"font-mono\"\r\n              />\r\n            </div>\r\n          </AlertDialogDescription>\r\n        </AlertDialogHeader>\r\n        <AlertDialogFooter>\r\n          <InteractiveHoverButton\r\n            className=\"bg-white hover:bg-gray-50 text-gray-700 border-gray-200\"\r\n            onClick={() => {\r\n              setDeleteConfirmText(\"\");\r\n              setEmpresaToDelete(null);\r\n              onOpenChange(false);\r\n            }}\r\n          >\r\n            Cancelar\r\n          </InteractiveHoverButton>\r\n          <InteractiveHoverButton\r\n            onClick={handleConfirmDelete}\r\n            disabled={deleteConfirmText !== empresaToDelete?.nome}\r\n            className=\"bg-red-600 hover:bg-red-700 text-white border-red-600 disabled:opacity-50 disabled:cursor-not-allowed\"\r\n          >\r\n            Excluir Permanentemente\r\n          </InteractiveHoverButton>\r\n        </AlertDialogFooter>\r\n      </AlertDialogContent>\r\n    </AlertDialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\master\\empresas\\_components\\parts\\ResetPasswordDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[383,386],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[383,386],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[420,423],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[420,423],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  AlertDialog,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\";\r\nimport { InteractiveHoverButton } from \"@/components/ui/interactive-hover-button\";\r\n\r\ninterface ResetPasswordDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  empresaToReset: any;\r\n  setEmpresaToReset: (empresa: any) => void;\r\n  confirmResetSenha: () => void;\r\n}\r\n\r\nexport function ResetPasswordDialog({\r\n  open,\r\n  onOpenChange,\r\n  empresaToReset,\r\n  setEmpresaToReset,\r\n  confirmResetSenha,\r\n}: ResetPasswordDialogProps) {\r\n  return (\r\n    <AlertDialog open={open} onOpenChange={onOpenChange}>\r\n      <AlertDialogContent>\r\n        <AlertDialogHeader>\r\n          <AlertDialogTitle>Resetar Senha do Administrador?</AlertDialogTitle>\r\n          <AlertDialogDescription>\r\n            Voc├¬ est├í prestes a resetar a senha do admin da empresa{\" \"}\r\n            <strong className=\"text-black\">{empresaToReset?.nome}</strong>. A\r\n            senha tempor├íria ser├í definida como{\" \"}\r\n            <strong className=\"text-black\">Mudar123</strong>. O usu├írio\r\n            precisar├í alter├í-la no pr├│ximo login.\r\n          </AlertDialogDescription>\r\n        </AlertDialogHeader>\r\n        <AlertDialogFooter>\r\n          <InteractiveHoverButton\r\n            className=\"bg-white hover:bg-gray-50 text-gray-700 border-gray-200\"\r\n            onClick={() => {\r\n              onOpenChange(false);\r\n              setEmpresaToReset(null);\r\n            }}\r\n          >\r\n            Cancelar\r\n          </InteractiveHoverButton>\r\n          <InteractiveHoverButton\r\n            onClick={confirmResetSenha}\r\n            className=\"bg-orange-600 hover:bg-orange-700 text-white border-orange-600\"\r\n          >\r\n            Confirmar Reset\r\n          </InteractiveHoverButton>\r\n        </AlertDialogFooter>\r\n      </AlertDialogContent>\r\n    </AlertDialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\master\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":79,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2548,2551],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2548,2551],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":115,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3612,3615],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3612,3615],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getServerSession } from \"next-auth\";\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { redirect } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { prisma } from \"@/lib/db\";\r\nimport { Plus, UserCog } from \"lucide-react\";\r\nimport { InteractiveHoverButton } from \"@/components/ui/interactive-hover-button\";\r\nimport { PageHeader } from \"@/components/ui/page-header\";\r\nimport { MasterStats } from \"./_components/master-stats\";\r\nimport {\r\n  RecentCompaniesTable,\r\n  EmpresaRecente,\r\n} from \"./_components/recent-companies-table\";\r\nimport { SyncPanel } from \"./_components/sync-panel\";\r\n\r\n// Pre├ºo base do plano para c├ílculo de MRR estimado\r\nconst PLAN_PRICE = parseFloat(process.env.NEXT_PUBLIC_PLAN_PRICE || \"49.90\");\r\n\r\nexport default async function MasterDashboard() {\r\n  const session = await getServerSession(authOptions);\r\n\r\n  if (!session || session.user.role !== \"master\") {\r\n    redirect(\"/vender\");\r\n  }\r\n\r\n  const now = new Date();\r\n  const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\r\n  const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\r\n\r\n  // 1. Estat├¡sticas de Empresas\r\n  const empresasAtivas = await prisma.empresa.count({\r\n    where: { status: \"ATIVO\" },\r\n  });\r\n\r\n  const empresasPausadas = await prisma.empresa.count({\r\n    where: { status: \"PAUSADO\" },\r\n  });\r\n\r\n  // 2. Faturamento Total (Acumulado de todas as vendas do sistema)\r\n  const faturamentoData = await prisma.sale.aggregate({\r\n    _sum: { valorTotal: true },\r\n  });\r\n  const faturamentoTotal = Number(faturamentoData._sum.valorTotal || 0);\r\n\r\n  // 3. C├ílculo de MRR (Estimado: Empresas Ativas * Valor do Plano)\r\n  // Idealmente somaria o valor individual de cada assinatura ativa no Asaas,\r\n  // mas para performance usamos a estimativa baseada no plano padr├úo.\r\n  const mrr = empresasAtivas * PLAN_PRICE;\r\n\r\n  // 4. Buscar empresas recentes\r\n  const empresasRecentesRaw = await prisma.empresa.findMany({\r\n    take: 5,\r\n    orderBy: { createdAt: \"desc\" },\r\n    include: {\r\n      _count: {\r\n        select: {\r\n          products: true,\r\n          sales: true,\r\n        },\r\n      },\r\n      sales: {\r\n        where: {\r\n          createdAt: {\r\n            gte: firstDayOfMonth,\r\n            lte: lastDayOfMonth,\r\n          },\r\n        },\r\n        select: {\r\n          valorTotal: true,\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  const empresasRecentes: EmpresaRecente[] = empresasRecentesRaw.map(\r\n    (empresa) => ({\r\n      id: empresa.id,\r\n      nome: empresa.nome,\r\n      status: empresa.status as any, // Cast para o tipo da interface\r\n      vencimentoPlano: empresa.vencimentoPlano,\r\n      faturamentoMensal: empresa.sales.reduce(\r\n        (acc, curr) => acc + Number(curr.valorTotal),\r\n        0\r\n      ),\r\n      totalProdutos: empresa._count.products,\r\n      totalVendas: empresa._count.sales,\r\n    })\r\n  );\r\n\r\n  // 5. Buscar inadimplentes (PAUSADO) para destaque\r\n  const empresasInadimplentesRaw = await prisma.empresa.findMany({\r\n    where: { status: \"PAUSADO\" },\r\n    take: 5,\r\n    orderBy: { vencimentoPlano: \"asc\" }, // Mais antigas primeiro (prioridade)\r\n    include: {\r\n      _count: {\r\n        select: { products: true, sales: true },\r\n      },\r\n      sales: {\r\n        where: {\r\n          createdAt: {\r\n            gte: firstDayOfMonth,\r\n            lte: lastDayOfMonth,\r\n          },\r\n        },\r\n        select: { valorTotal: true },\r\n      },\r\n    },\r\n  });\r\n\r\n  const empresasInadimplentes: EmpresaRecente[] = empresasInadimplentesRaw.map(\r\n    (empresa) => ({\r\n      id: empresa.id,\r\n      nome: empresa.nome,\r\n      status: empresa.status as any,\r\n      vencimentoPlano: empresa.vencimentoPlano,\r\n      faturamentoMensal: empresa.sales.reduce(\r\n        (acc, curr) => acc + Number(curr.valorTotal),\r\n        0\r\n      ),\r\n      totalProdutos: empresa._count.products,\r\n      totalVendas: empresa._count.sales,\r\n    })\r\n  );\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <PageHeader\r\n        title=\"Dashboard Master\"\r\n        description=\"Vis├úo geral do sistema e m├®tricas SaaS\"\r\n        actions={\r\n          <div className=\"flex gap-2\">\r\n            <Link href=\"/master/empresas\">\r\n              <InteractiveHoverButton className=\"bg-cta-bg text-white border-cta-bg hover:bg-cta-bg/90\">\r\n                <span className=\"flex items-center gap-2\">\r\n                  <Plus className=\"h-4 w-4\" />\r\n                  <span className=\"truncate\">Adicionar Empresa</span>\r\n                </span>\r\n              </InteractiveHoverButton>\r\n            </Link>\r\n            <Link href=\"/master/usuarios\">\r\n              <InteractiveHoverButton className=\"bg-gray-200 dark:bg-zinc-800 text-gray-800 dark:text-gray-200 border-gray-200 dark:border-zinc-800 hover:bg-gray-300 dark:hover:bg-zinc-700\">\r\n                <span className=\"flex items-center gap-2\">\r\n                  <UserCog className=\"h-4 w-4\" />\r\n                  <span className=\"truncate\">Gerenciar Usu├írios</span>\r\n                </span>\r\n              </InteractiveHoverButton>\r\n            </Link>\r\n          </div>\r\n        }\r\n      />\r\n\r\n      {/* Stats Section with MRR and Inadimpl├¬ncia */}\r\n      <MasterStats\r\n        faturamentoTotal={faturamentoTotal}\r\n        empresasAtivas={empresasAtivas}\r\n        mrr={mrr}\r\n        inadimplentesCount={empresasPausadas}\r\n      />\r\n\r\n      {/* Sync Panel Section (Legacy/Maintenance) */}\r\n      <section>\r\n        <SyncPanel />\r\n      </section>\r\n\r\n      {/* Se├º├úo de Inadimpl├¬ncia (S├│ aparece se houver) */}\r\n      {empresasInadimplentes.length > 0 && (\r\n        <section className=\"border rounded-xl p-4 border-red-200 bg-red-50 dark:bg-red-900/10 dark:border-red-900/30\">\r\n          <h3 className=\"text-red-700 dark:text-red-400 text-lg font-bold leading-tight tracking-[-0.015em] pb-4 flex items-center gap-2\">\r\n            ÔÜá´©Å Empresas Inadimplentes (Pausadas)\r\n          </h3>\r\n          <RecentCompaniesTable empresas={empresasInadimplentes} />\r\n        </section>\r\n      )}\r\n\r\n      {/* Recent Activity Section */}\r\n      <section>\r\n        <h3 className=\"text-gray-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] pb-2 pt-4\">\r\n          Empresas Recentes\r\n        </h3>\r\n        <RecentCompaniesTable empresas={empresasRecentes} />\r\n      </section>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\master\\usuarios\\_components\\usuarios-client.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'cn' is defined but never used.","line":23,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":12},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2960,2963],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2960,2963],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3686,3689],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3686,3689],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { InteractiveHoverButton } from \"@/components/ui/interactive-hover-button\";\r\nimport { AnimatedLoadingSkeleton } from \"@/components/ui/loading\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\n\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n  AlertDialogTrigger,\r\n} from \"@/components/ui/alert-dialog\";\r\nimport { Plus, Trash2, Users, Shield, ArrowLeft, Calendar } from \"lucide-react\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { useSession } from \"next-auth/react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { UserCard } from \"@/components/shared/user-card\";\r\nimport {\r\n  UserFormDialog,\r\n  UserFormData,\r\n} from \"@/components/shared/user-form-dialog\";\r\n\r\ninterface Master {\r\n  id: string;\r\n  email: string;\r\n  nome: string;\r\n  name: string;\r\n  createdAt: string;\r\n}\r\n\r\nexport default function UsuariosClient() {\r\n  const router = useRouter();\r\n  const { data: session } = useSession() || {};\r\n  const [masters, setMasters] = useState<Master[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [dialogOpen, setDialogOpen] = useState(false);\r\n  const [submitting, setSubmitting] = useState(false);\r\n\r\n  useEffect(() => {\r\n    fetchMasters();\r\n  }, []);\r\n\r\n  const fetchMasters = async () => {\r\n    try {\r\n      const response = await fetch(\"/api/master/usuarios\");\r\n      if (!response.ok) throw new Error(\"Erro ao buscar usu├írios master\");\r\n      const data = await response.json();\r\n\r\n      // Ensure data is an array\r\n      if (Array.isArray(data)) {\r\n        setMasters(data);\r\n      } else {\r\n        setMasters([]);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Erro ao buscar usu├írios master:\", error);\r\n      setMasters([]);\r\n      toast({\r\n        title: \"Erro\",\r\n        description:\r\n          error instanceof Error\r\n            ? error.message\r\n            : \"N├úo foi poss├¡vel carregar os usu├írios master\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const createMaster = async (data: UserFormData) => {\r\n    setSubmitting(true);\r\n    try {\r\n      const response = await fetch(\"/api/master/usuarios\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        // Ensure role is sent if API needs it, though endpoint implies Master\r\n        body: JSON.stringify(data),\r\n      });\r\n\r\n      const resData = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(resData.error || \"Erro ao criar usu├írio master\");\r\n      }\r\n\r\n      toast({\r\n        title: \"Sucesso!\",\r\n        description: \"Usu├írio master criado com sucesso\",\r\n      });\r\n\r\n      setDialogOpen(false);\r\n      fetchMasters();\r\n    } catch (error: any) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (masterId: string, masterEmail: string) => {\r\n    try {\r\n      const response = await fetch(`/api/master/usuarios?id=${masterId}`, {\r\n        method: \"DELETE\",\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || \"Erro ao excluir usu├írio master\");\r\n      }\r\n\r\n      toast({\r\n        title: \"Sucesso!\",\r\n        description: `Usu├írio master \"${masterEmail}\" exclu├¡do com sucesso`,\r\n      });\r\n\r\n      fetchMasters();\r\n    } catch (error: any) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"container mx-auto py-10\">\r\n        <AnimatedLoadingSkeleton />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const currentUserId = session?.user?.id;\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header Section */}\r\n      <div className=\"flex justify-between items-start\">\r\n        <div className=\"flex-1\">\r\n          <div className=\"flex items-center gap-4 mb-2\">\r\n            <InteractiveHoverButton\r\n              onClick={() => router.push(\"/master\")}\r\n              className=\"flex items-center gap-2 border-2 hover:bg-purple-50 dark:hover:bg-purple-900/20 hover:border-purple-300 dark:hover:border-purple-700 bg-white dark:bg-zinc-900 text-gray-900 dark:text-gray-100 border-gray-200 dark:border-zinc-700\"\r\n            >\r\n              <ArrowLeft className=\"h-4 w-4\" />\r\n              Voltar ao In├¡cio\r\n            </InteractiveHoverButton>\r\n          </div>\r\n          <h1 className=\"text-3xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-3\">\r\n            <Shield className=\"h-8 w-8 text-purple-600 dark:text-purple-400\" />\r\n            Gerenciamento de Masters\r\n          </h1>\r\n          <p className=\"text-gray-600 dark:text-gray-400 mt-2\">\r\n            Visualize e gerencie todos os usu├írios master do sistema\r\n          </p>\r\n        </div>\r\n        <UserFormDialog\r\n          open={dialogOpen}\r\n          onOpenChange={setDialogOpen}\r\n          title=\"Criar Novo Usu├írio Master\"\r\n          description=\"Preencha os dados do novo usu├írio master\"\r\n          onSubmit={createMaster}\r\n          loading={submitting}\r\n          roles={[]} // No visible role selector\r\n          defaultRole=\"master\"\r\n          trigger={\r\n            <InteractiveHoverButton className=\"bg-purple-600 hover:bg-purple-700 text-white border-purple-600\">\r\n              <span className=\"flex items-center gap-2\">\r\n                <Plus className=\"h-4 w-4\" />\r\n                Criar Novo Master\r\n              </span>\r\n            </InteractiveHoverButton>\r\n          }\r\n        />\r\n      </div>\r\n\r\n      {/* Stats Section */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n        <Card className=\"bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-900/10 border-purple-200 dark:border-purple-900/30\">\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm font-medium text-purple-700 dark:text-purple-300 flex items-center gap-2\">\r\n              <Users className=\"h-4 w-4\" />\r\n              Total de Masters\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-3xl font-bold text-purple-900 dark:text-purple-100\">\r\n              {masters.length}\r\n            </div>\r\n            <p className=\"text-xs text-purple-600 dark:text-purple-400 mt-1\">\r\n              Usu├írios cadastrados\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card className=\"bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-900/10 border-blue-200 dark:border-blue-900/30\">\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm font-medium text-blue-700 dark:text-blue-300 flex items-center gap-2\">\r\n              <Shield className=\"h-4 w-4\" />\r\n              Sua Conta\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-sm font-semibold text-blue-900 dark:text-blue-100 truncate\">\r\n              {session?.user?.email}\r\n            </div>\r\n            <p className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">\r\n              Master atual\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card className=\"bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-900/10 border-green-200 dark:border-green-900/30\">\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm font-medium text-green-700 dark:text-green-300 flex items-center gap-2\">\r\n              <Calendar className=\"h-4 w-4\" />\r\n              ├Ültimo Cadastro\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-sm font-semibold text-green-900 dark:text-green-100\">\r\n              {masters.length > 0\r\n                ? new Date(\r\n                    masters[masters.length - 1].createdAt\r\n                  ).toLocaleDateString(\"pt-BR\")\r\n                : \"N/A\"}\r\n            </div>\r\n            <p className=\"text-xs text-green-600 dark:text-green-400 mt-1\">\r\n              Data do ├║ltimo master\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Masters List */}\r\n      <div>\r\n        <h2 className=\"text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4\">\r\n          Lista de Usu├írios Master\r\n        </h2>\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n          {masters.map((master) => {\r\n            const isCurrentUser = currentUserId === master.id;\r\n            const displayName = master.nome || master.name;\r\n\r\n            const footerContent = !isCurrentUser ? (\r\n              <AlertDialog>\r\n                <AlertDialogTrigger asChild>\r\n                  <InteractiveHoverButton className=\"w-full bg-red-600 hover:bg-red-700 text-white border-red-600\">\r\n                    <span className=\"flex items-center gap-2\">\r\n                      <Trash2 className=\"h-4 w-4\" />\r\n                      Excluir Master\r\n                    </span>\r\n                  </InteractiveHoverButton>\r\n                </AlertDialogTrigger>\r\n                <AlertDialogContent>\r\n                  <AlertDialogHeader>\r\n                    <AlertDialogTitle className=\"flex items-center gap-2\">\r\n                      <Trash2 className=\"h-5 w-5 text-red-600\" />\r\n                      Confirmar Exclus├úo\r\n                    </AlertDialogTitle>\r\n                    <AlertDialogDescription className=\"space-y-3\">\r\n                      <p>Tem certeza que deseja excluir o usu├írio master:</p>\r\n                      <div className=\"bg-gray-100 p-3 rounded border-l-4 border-red-500\">\r\n                        <p className=\"font-semibold text-gray-900\">\r\n                          {displayName}\r\n                        </p>\r\n                        <p className=\"text-sm text-gray-600\">{master.email}</p>\r\n                      </div>\r\n                      <p className=\"text-red-600 font-semibold\">\r\n                        ÔÜá´©Å Esta a├º├úo n├úo pode ser desfeita!\r\n                      </p>\r\n                    </AlertDialogDescription>\r\n                  </AlertDialogHeader>\r\n                  <AlertDialogFooter>\r\n                    <AlertDialogCancel asChild>\r\n                      <InteractiveHoverButton className=\"bg-white hover:bg-gray-50 dark:bg-zinc-800 dark:hover:bg-zinc-700 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-zinc-700\">\r\n                        Cancelar\r\n                      </InteractiveHoverButton>\r\n                    </AlertDialogCancel>\r\n                    <AlertDialogAction\r\n                      onClick={() => handleDelete(master.id, master.email)}\r\n                      asChild\r\n                    >\r\n                      <InteractiveHoverButton className=\"bg-red-600 hover:bg-red-700 text-white border-red-600\">\r\n                        Sim, Excluir Permanentemente\r\n                      </InteractiveHoverButton>\r\n                    </AlertDialogAction>\r\n                  </AlertDialogFooter>\r\n                </AlertDialogContent>\r\n              </AlertDialog>\r\n            ) : (\r\n              <div className=\"text-sm text-center py-2.5 bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300 rounded font-medium\">\r\n                ­ƒöÆ Sua conta atual\r\n              </div>\r\n            );\r\n\r\n            return (\r\n              <UserCard\r\n                key={master.id}\r\n                id={master.id}\r\n                name={displayName}\r\n                email={master.email}\r\n                createdAt={master.createdAt}\r\n                isCurrentUser={isCurrentUser}\r\n                icon={\r\n                  <Shield className=\"h-6 w-6 text-purple-600 dark:text-purple-400\" />\r\n                }\r\n                footer={footerContent}\r\n                role=\"master\"\r\n              />\r\n            );\r\n          })}\r\n        </div>\r\n\r\n        {masters.length === 0 && (\r\n          <Card className=\"border-2 border-dashed border-gray-300 dark:border-zinc-700 bg-white dark:bg-zinc-900\">\r\n            <CardContent className=\"flex flex-col items-center justify-center py-16\">\r\n              <div className=\"p-4 bg-purple-100 dark:bg-purple-900/20 rounded-full mb-4\">\r\n                <Shield className=\"h-12 w-12 text-purple-600 dark:text-purple-400\" />\r\n              </div>\r\n              <h3 className=\"text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2\">\r\n                Nenhum usu├írio master encontrado\r\n              </h3>\r\n              <p className=\"text-gray-600 dark:text-gray-400 text-center mb-6 max-w-md\">\r\n                Comece criando seu primeiro usu├írio master clicando no bot├úo\r\n                &quot;Criar Novo Master&quot; acima\r\n              </p>\r\n              <InteractiveHoverButton\r\n                onClick={() => setDialogOpen(true)}\r\n                className=\"bg-purple-600 hover:bg-purple-700 text-white border-purple-600\"\r\n              >\r\n                <span className=\"flex items-center gap-2\">\r\n                  <Plus className=\"h-4 w-4\" />\r\n                  Criar Primeiro Master\r\n                </span>\r\n              </InteractiveHoverButton>\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\movimentacoes\\_components\\movimentacoes-client.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":228,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":228,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6412,6415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6412,6415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":229,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":229,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6462,6465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6462,6465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useCallback } from \"react\";\r\nimport { format } from \"date-fns\";\r\nimport { ptBR } from \"date-fns/locale\";\r\nimport {\r\n  ShoppingCart,\r\n  ArrowDownCircle,\r\n  AlertTriangle,\r\n  Wrench,\r\n  Search,\r\n  ArrowRightLeft,\r\n  DollarSign,\r\n  ArrowUpCircle,\r\n} from \"lucide-react\";\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport { InteractiveHoverButton } from \"@/components/ui/interactive-hover-button\";\r\n\r\nimport { AnimatedLoadingSkeleton } from \"@/components/ui/loading\";\r\nimport {\r\n  Accordion,\r\n  AccordionContent,\r\n  AccordionItem,\r\n  AccordionTrigger,\r\n} from \"@/components/ui/accordion\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { formatCurrency } from \"@/lib/utils\";\r\n\r\ninterface MovementItem {\r\n  productName: string;\r\n  quantity: number;\r\n  unitPrice: number;\r\n  subtotal: number;\r\n  discount?: number;\r\n}\r\n\r\ninterface UnifiedMovement {\r\n  id: string;\r\n  type:\r\n    | \"VENDA\"\r\n    | \"ENTRADA\"\r\n    | \"AJUSTE_QUEBRA\"\r\n    | \"AJUSTE_INVENTARIO\"\r\n    | \"DEVOLUCAO\"\r\n    | \"ABERTURA\"\r\n    | \"SANGRIA\"\r\n    | \"SUPRIMENTO\"\r\n    | \"FECHAMENTO\";\r\n  date: string;\r\n  user: string;\r\n  // Fields for Sales\r\n  totalValue?: number;\r\n  items?: MovementItem[];\r\n  paymentMethod?: string;\r\n  amountPaid?: number;\r\n  change?: number;\r\n  // Fields for Stock Movements\r\n  productName?: string;\r\n  quantity?: number;\r\n  reason?: string;\r\n}\r\n\r\ninterface MovimentacoesClientProps {\r\n  companyId?: string;\r\n}\r\n\r\nexport default function MovimentacoesClient({\r\n  companyId,\r\n}: MovimentacoesClientProps) {\r\n  const [movements, setMovements] = useState<UnifiedMovement[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [typeFilter, setTypeFilter] = useState(\"TODOS\");\r\n  const [startDate, setStartDate] = useState(\"\");\r\n  const [endDate, setEndDate] = useState(\"\");\r\n\r\n  const fetchMovements = useCallback(async () => {\r\n    setLoading(true);\r\n    try {\r\n      const params = new URLSearchParams();\r\n      if (typeFilter !== \"TODOS\") params.append(\"type\", typeFilter);\r\n      if (startDate) params.append(\"startDate\", startDate);\r\n      if (endDate) params.append(\"endDate\", endDate);\r\n\r\n      const response = await fetch(\r\n        `/api/admin/movimentacoes?${params.toString()}${\r\n          companyId ? `&companyId=${companyId}` : \"\"\r\n        }`\r\n      );\r\n      const data = await response.json();\r\n\r\n      if (!response.ok)\r\n        throw new Error(data.error || \"Erro ao buscar movimenta├º├Áes\");\r\n\r\n      setMovements(data);\r\n    } catch (error) {\r\n      console.error(\"Erro:\", error);\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"N├úo foi poss├¡vel carregar as movimenta├º├Áes.\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [typeFilter, startDate, endDate, companyId]);\r\n\r\n  useEffect(() => {\r\n    fetchMovements();\r\n  }, [fetchMovements]);\r\n\r\n  const filteredMovements = movements.filter((mov) => {\r\n    const searchLower = searchTerm.toLowerCase();\r\n    const matchesUser = mov.user.toLowerCase().includes(searchLower);\r\n    const matchesProduct =\r\n      mov.productName?.toLowerCase().includes(searchLower) ||\r\n      mov.items?.some((item) =>\r\n        item.productName.toLowerCase().includes(searchLower)\r\n      );\r\n\r\n    return matchesUser || matchesProduct;\r\n  });\r\n\r\n  const getIcon = (type: string) => {\r\n    switch (type) {\r\n      case \"VENDA\":\r\n        return <ShoppingCart className=\"h-5 w-5 text-blue-500\" />;\r\n      case \"ENTRADA\":\r\n        return <ArrowDownCircle className=\"h-5 w-5 text-green-500\" />;\r\n      case \"AJUSTE_QUEBRA\":\r\n        return <AlertTriangle className=\"h-5 w-5 text-red-500\" />;\r\n      case \"AJUSTE_INVENTARIO\":\r\n        return <Wrench className=\"h-5 w-5 text-gray-500\" />;\r\n      case \"ABERTURA\":\r\n        return <DollarSign className=\"h-5 w-5 text-blue-500\" />;\r\n      case \"SANGRIA\":\r\n        return <ArrowUpCircle className=\"h-5 w-5 text-red-500\" />;\r\n      case \"SUPRIMENTO\":\r\n        return <ArrowDownCircle className=\"h-5 w-5 text-green-500\" />;\r\n      case \"FECHAMENTO\":\r\n        return <DollarSign className=\"h-5 w-5 text-purple-500\" />;\r\n      default:\r\n        return <Wrench className=\"h-5 w-5 text-gray-500\" />;\r\n    }\r\n  };\r\n\r\n  const getTypeLabel = (type: string, paymentMethod?: string) => {\r\n    const methodLabels: Record<string, string> = {\r\n      dinheiro: \"Dinheiro\",\r\n      pix: \"Pix\",\r\n      debito: \"D├®bito\",\r\n      credito: \"Cr├®dito\",\r\n    };\r\n\r\n    let baseLabel = \"\";\r\n    switch (type) {\r\n      case \"VENDA\":\r\n        baseLabel = \"Venda\";\r\n        break;\r\n      case \"ENTRADA\":\r\n        baseLabel = \"Entrada de Estoque\";\r\n        break;\r\n      case \"AJUSTE_QUEBRA\":\r\n        baseLabel = \"Quebra/Perda\";\r\n        break;\r\n      case \"AJUSTE_INVENTARIO\":\r\n        baseLabel = \"Ajuste Manual\";\r\n        break;\r\n      case \"DEVOLUCAO\":\r\n        baseLabel = \"Devolu├º├úo\";\r\n        break;\r\n      case \"ABERTURA\":\r\n        baseLabel = \"Abertura de Caixa\";\r\n        break;\r\n      case \"SANGRIA\":\r\n        baseLabel = \"Sangria de Caixa\";\r\n        break;\r\n      case \"SUPRIMENTO\":\r\n        baseLabel = \"Suprimento de Caixa\";\r\n        break;\r\n      case \"FECHAMENTO\":\r\n        baseLabel = \"Fechamento de Caixa\";\r\n        break;\r\n      default:\r\n        baseLabel = type;\r\n    }\r\n\r\n    // Adicionar m├®todo de pagamento para sangrias e suprimentos\r\n    if ((type === \"SANGRIA\" || type === \"SUPRIMENTO\") && paymentMethod) {\r\n      return `${baseLabel} (${methodLabels[paymentMethod] || paymentMethod})`;\r\n    }\r\n\r\n    return baseLabel;\r\n  };\r\n\r\n  // Movement Dialog State\r\n  const [movementDialogOpen, setMovementDialogOpen] = useState(false);\r\n  const [movementFormData, setMovementFormData] = useState({\r\n    produtoId: \"\",\r\n    loteId: \"sem_lote\", // \"sem_lote\" ou ID do lote\r\n    tipo: \"ENTRADA\", // ENTRADA, SAIDA, PERDA, AJUSTE\r\n    quantidade: \"\",\r\n    motivo: \"\",\r\n  });\r\n  const [products, setProducts] = useState<any[]>([]);\r\n  const [lotes, setLotes] = useState<any[]>([]);\r\n\r\n  useEffect(() => {\r\n    fetchProducts();\r\n    fetchLotes();\r\n  }, []);\r\n\r\n  const fetchProducts = async () => {\r\n    try {\r\n      const response = await fetch(\"/api/admin/products\");\r\n      const data = await response.json();\r\n      if (Array.isArray(data)) setProducts(data);\r\n    } catch (error) {\r\n      console.error(\"Erro ao carregar produtos:\", error);\r\n    }\r\n  };\r\n\r\n  const fetchLotes = async () => {\r\n    try {\r\n      const response = await fetch(\"/api/admin/lotes\");\r\n      const data = await response.json();\r\n      if (Array.isArray(data)) setLotes(data);\r\n    } catch (error) {\r\n      console.error(\"Erro ao carregar lotes:\", error);\r\n    }\r\n  };\r\n\r\n  const handleOpenMovementDialog = () => {\r\n    setMovementFormData({\r\n      produtoId: \"\",\r\n      loteId: \"sem_lote\",\r\n      tipo: \"ENTRADA\",\r\n      quantidade: \"\",\r\n      motivo: \"\",\r\n    });\r\n    setMovementDialogOpen(true);\r\n  };\r\n\r\n  const handleMovementSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n\r\n    if (\r\n      !movementFormData.produtoId ||\r\n      !movementFormData.tipo ||\r\n      !movementFormData.quantidade\r\n    ) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"Preencha os campos obrigat├│rios\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Valida├º├úo de Lote Obrigat├│rio para Sa├¡das\r\n    if (\r\n      (movementFormData.tipo === \"SAIDA\" ||\r\n        movementFormData.tipo === \"PERDA\") &&\r\n      movementFormData.loteId === \"sem_lote\"\r\n    ) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"Selecione um Lote para registrar Sa├¡da ou Perda.\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    const qtd = Number(movementFormData.quantidade);\r\n    if (qtd <= 0) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"Quantidade deve ser maior que zero\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      let apiTipo = \"ENTRADA\";\r\n      let operacao = \"ADICIONAR\";\r\n\r\n      if (movementFormData.tipo === \"ENTRADA\") {\r\n        apiTipo = \"ENTRADA\";\r\n        operacao = \"ADICIONAR\";\r\n      } else if (movementFormData.tipo === \"SAIDA\") {\r\n        apiTipo = \"AJUSTE_INVENTARIO\";\r\n        operacao = \"REMOVER\";\r\n      } else if (movementFormData.tipo === \"PERDA\") {\r\n        apiTipo = \"AJUSTE_QUEBRA\";\r\n        operacao = \"REMOVER\";\r\n      } else if (movementFormData.tipo === \"AJUSTE\") {\r\n        apiTipo = \"AJUSTE_INVENTARIO\";\r\n        operacao = \"ADICIONAR\";\r\n      }\r\n\r\n      const body = {\r\n        produtoId: movementFormData.produtoId,\r\n        loteId:\r\n          movementFormData.loteId === \"sem_lote\"\r\n            ? undefined\r\n            : movementFormData.loteId,\r\n        tipo: apiTipo,\r\n        operacao,\r\n        quantidade: qtd,\r\n        motivo: movementFormData.motivo,\r\n      };\r\n\r\n      const response = await fetch(\"/api/admin/movimentacoes\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(body),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || \"Erro ao criar movimenta├º├úo\");\r\n      }\r\n\r\n      toast({\r\n        title: \"Sucesso\",\r\n        description: \"Movimenta├º├úo registrada com sucesso\",\r\n      });\r\n\r\n      setMovementDialogOpen(false);\r\n      fetchMovements(); // Atualizar lista\r\n    } catch (error) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description:\r\n          error instanceof Error\r\n            ? error.message\r\n            : \"Erro ao registrar movimenta├º├úo\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  };\r\n\r\n  const availableLotes = lotes.filter(\r\n    (l) => l.produtoId === movementFormData.produtoId\r\n  );\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <Card className=\"bg-white dark:bg-zinc-900 border-gray-200 dark:border-zinc-800\">\r\n        <CardHeader>\r\n          <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\r\n            <div>\r\n              <CardTitle className=\"text-gray-900 dark:text-gray-100\">\r\n                Central de Movimenta├º├Áes\r\n              </CardTitle>\r\n              <CardDescription className=\"text-gray-500 dark:text-gray-400\">\r\n                Visualize vendas, entradas e ajustes de estoque em uma linha do\r\n                tempo unificada.\r\n              </CardDescription>\r\n            </div>\r\n            <InteractiveHoverButton\r\n              onClick={handleOpenMovementDialog}\r\n              className=\"bg-cta-bg text-white border-cta-bg hover:bg-cta-bg/90\"\r\n            >\r\n              <span className=\"flex items-center gap-2\">\r\n                <ArrowRightLeft className=\"h-4 w-4\" />\r\n                Nova Movimenta├º├úo\r\n              </span>\r\n            </InteractiveHoverButton>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex flex-col md:flex-row gap-4\">\r\n            <div className=\"flex-1\">\r\n              <div className=\"relative\">\r\n                <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-gray-400\" />\r\n                <Input\r\n                  placeholder=\"Buscar por usu├írio ou produto...\"\r\n                  className=\"pl-8\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                />\r\n              </div>\r\n            </div>\r\n            <div className=\"w-full md:w-[200px]\">\r\n              <Select value={typeFilter} onValueChange={setTypeFilter}>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Tipo de Movimenta├º├úo\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"TODOS\">Todas</SelectItem>\r\n                  <SelectItem value=\"VENDA\">Vendas</SelectItem>\r\n                  <SelectItem value=\"ENTRADA\">Entradas</SelectItem>\r\n                  <SelectItem value=\"PERDA\">Perdas/Quebras</SelectItem>\r\n                  <SelectItem value=\"AJUSTE\">Ajustes</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n            <div className=\"flex gap-2\">\r\n              <Input\r\n                type=\"date\"\r\n                value={startDate}\r\n                onChange={(e) => setStartDate(e.target.value)}\r\n                className=\"w-[150px]\"\r\n              />\r\n              <Input\r\n                type=\"date\"\r\n                value={endDate}\r\n                onChange={(e) => setEndDate(e.target.value)}\r\n                className=\"w-[150px]\"\r\n              />\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      <div className=\"space-y-4\">\r\n        {loading ? (\r\n          <div className=\"py-4\">\r\n            <AnimatedLoadingSkeleton />\r\n          </div>\r\n        ) : filteredMovements.length === 0 ? (\r\n          <div className=\"text-center py-8 text-gray-500 dark:text-gray-400 border rounded-lg bg-gray-50 dark:bg-zinc-800 dark:border-zinc-700\">\r\n            Nenhuma movimenta├º├úo encontrada no per├¡odo.\r\n          </div>\r\n        ) : (\r\n          filteredMovements.map((mov) => (\r\n            <Card\r\n              key={mov.id}\r\n              className=\"overflow-hidden bg-white dark:bg-zinc-900 border-gray-200 dark:border-zinc-800\"\r\n            >\r\n              {mov.type === \"VENDA\" ? (\r\n                <Accordion type=\"single\" collapsible className=\"w-full\">\r\n                  <AccordionItem value=\"item-1\" className=\"border-none\">\r\n                    <div className=\"p-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-4\">\r\n                      <div className=\"flex items-center gap-4\">\r\n                        <div className=\"p-2 bg-blue-100 dark:bg-blue-900/30 rounded-full\">\r\n                          {getIcon(mov.type)}\r\n                        </div>\r\n                        <div>\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <h3 className=\"font-semibold text-lg text-gray-900 dark:text-gray-100\">\r\n                              Venda\r\n                            </h3>\r\n                            <Badge\r\n                              variant=\"outline\"\r\n                              className=\"font-mono text-xs\"\r\n                            >\r\n                              #{mov.id.slice(-6).toUpperCase()}\r\n                            </Badge>\r\n                          </div>\r\n                          <div className=\"text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2\">\r\n                            <span>\r\n                              {format(new Date(mov.date), \"dd/MM/yyyy HH:mm\", {\r\n                                locale: ptBR,\r\n                              })}\r\n                            </span>\r\n                            <span>ÔÇó</span>\r\n                            <span>{mov.user}</span>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n\r\n                      <div className=\"flex items-center gap-6\">\r\n                        <div className=\"text-right\">\r\n                          <p className=\"text-sm text-gray-500 dark:text-gray-400\">\r\n                            Total\r\n                          </p>\r\n                          <p className=\"font-bold text-green-600 dark:text-green-400 text-lg\">\r\n                            {formatCurrency(mov.totalValue || 0)}\r\n                          </p>\r\n                        </div>\r\n                        <AccordionTrigger className=\"hover:no-underline py-0\" />\r\n                      </div>\r\n                    </div>\r\n                    <AccordionContent>\r\n                      <div className=\"bg-gray-50 dark:bg-zinc-800 p-4 border-t dark:border-zinc-700\">\r\n                        <div className=\"grid gap-2\">\r\n                          <div className=\"font-medium text-sm text-gray-500 dark:text-gray-400 mb-2\">\r\n                            Itens da Venda\r\n                          </div>\r\n                          {mov.items?.map((item, idx) => (\r\n                            <div\r\n                              key={idx}\r\n                              className=\"flex justify-between text-sm items-center text-gray-700 dark:text-gray-300\"\r\n                            >\r\n                              <div className=\"flex flex-col\">\r\n                                <span>\r\n                                  {item.quantity}x {item.productName}\r\n                                </span>\r\n                                {item.discount && item.discount > 0 ? (\r\n                                  <span className=\"text-xs text-green-600 dark:text-green-400\">\r\n                                    Desconto: -{formatCurrency(item.discount)}\r\n                                  </span>\r\n                                ) : null}\r\n                              </div>\r\n                              <span className=\"font-mono\">\r\n                                {formatCurrency(item.subtotal)}\r\n                              </span>\r\n                            </div>\r\n                          ))}\r\n                          <div className=\"mt-2 pt-2 border-t dark:border-zinc-700 space-y-1\">\r\n                            <div className=\"flex justify-between text-sm font-medium text-gray-900 dark:text-gray-100\">\r\n                              <span>Forma de Pagamento</span>\r\n                              <span className=\"capitalize\">\r\n                                {mov.paymentMethod}\r\n                              </span>\r\n                            </div>\r\n                            {mov.amountPaid !== undefined && (\r\n                              <div className=\"flex justify-between text-sm text-gray-600 dark:text-gray-400\">\r\n                                <span>Valor Pago</span>\r\n                                <span>{formatCurrency(mov.amountPaid)}</span>\r\n                              </div>\r\n                            )}\r\n                            {mov.change !== undefined && (\r\n                              <div className=\"flex justify-between text-sm text-gray-600 dark:text-gray-400\">\r\n                                <span>Troco</span>\r\n                                <span>{formatCurrency(mov.change)}</span>\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </AccordionContent>\r\n                  </AccordionItem>\r\n                </Accordion>\r\n              ) : (\r\n                <div className=\"p-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-4\">\r\n                  <div className=\"flex items-center gap-4\">\r\n                    <div\r\n                      className={`p-2 rounded-full ${\r\n                        mov.type === \"ENTRADA\"\r\n                          ? \"bg-green-100 dark:bg-green-900/30\"\r\n                          : mov.type === \"AJUSTE_QUEBRA\"\r\n                          ? \"bg-red-100 dark:bg-red-900/30\"\r\n                          : \"bg-gray-100 dark:bg-zinc-800\"\r\n                      }`}\r\n                    >\r\n                      {getIcon(mov.type)}\r\n                    </div>\r\n                    <div>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <h3 className=\"font-semibold text-lg text-gray-900 dark:text-gray-100\">\r\n                          {getTypeLabel(mov.type, mov.paymentMethod)}\r\n                        </h3>\r\n                      </div>\r\n                      <div className=\"text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2\">\r\n                        <span>\r\n                          {format(new Date(mov.date), \"dd/MM/yyyy HH:mm\", {\r\n                            locale: ptBR,\r\n                          })}\r\n                        </span>\r\n                        <span>ÔÇó</span>\r\n                        <span>{mov.user}</span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"flex flex-col items-end gap-1\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <span className=\"font-medium text-gray-900 dark:text-gray-100\">\r\n                        {mov.productName}\r\n                      </span>\r\n                      {[\r\n                        \"ABERTURA\",\r\n                        \"SANGRIA\",\r\n                        \"SUPRIMENTO\",\r\n                        \"FECHAMENTO\",\r\n                      ].includes(mov.type) ? (\r\n                        <span\r\n                          className={`font-bold ${\r\n                            [\"ABERTURA\", \"SUPRIMENTO\"].includes(mov.type)\r\n                              ? \"text-green-600 dark:text-green-400\"\r\n                              : mov.type === \"SANGRIA\"\r\n                              ? \"text-red-600 dark:text-red-400\"\r\n                              : \"text-purple-600 dark:text-purple-400\"\r\n                          }`}\r\n                        >\r\n                          {formatCurrency(mov.totalValue || 0)}\r\n                        </span>\r\n                      ) : (\r\n                        <Badge\r\n                          variant={\r\n                            mov.type === \"ENTRADA\" ? \"default\" : \"destructive\"\r\n                          }\r\n                        >\r\n                          {mov.type === \"ENTRADA\" ? \"+\" : \"-\"}\r\n                          {Math.abs(mov.quantity || 0)}\r\n                        </Badge>\r\n                      )}\r\n                    </div>\r\n                    {mov.reason && (\r\n                      <p className=\"text-sm text-gray-500 dark:text-gray-400 italic max-w-md text-right\">\r\n                        &quot;{mov.reason}&quot;\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </Card>\r\n          ))\r\n        )}\r\n      </div>\r\n\r\n      <Dialog open={movementDialogOpen} onOpenChange={setMovementDialogOpen}>\r\n        <DialogContent className=\"sm:max-w-[500px]\">\r\n          <DialogHeader>\r\n            <DialogTitle>Nova Movimenta├º├úo</DialogTitle>\r\n            <DialogDescription>\r\n              Registre entradas, sa├¡das ou ajustes manuais no estoque.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <form onSubmit={handleMovementSubmit} className=\"space-y-4 py-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"movProduto\">Produto</Label>\r\n              <Select\r\n                value={movementFormData.produtoId}\r\n                onValueChange={(value) =>\r\n                  setMovementFormData({\r\n                    ...movementFormData,\r\n                    produtoId: value,\r\n                    loteId: \"sem_lote\",\r\n                  })\r\n                }\r\n              >\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Selecione um produto\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {products.map((product) => (\r\n                    <SelectItem key={product.id} value={product.id}>\r\n                      {product.nome} (SKU: {product.sku})\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            {movementFormData.produtoId && (\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"movLote\">\r\n                  Lote{\" \"}\r\n                  {movementFormData.tipo === \"SAIDA\" ||\r\n                  movementFormData.tipo === \"PERDA\"\r\n                    ? \"(Obrigat├│rio)\"\r\n                    : \"(Opcional)\"}\r\n                </Label>\r\n                <Select\r\n                  value={movementFormData.loteId}\r\n                  onValueChange={(value) =>\r\n                    setMovementFormData({ ...movementFormData, loteId: value })\r\n                  }\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Selecione um lote\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {movementFormData.tipo !== \"SAIDA\" &&\r\n                      movementFormData.tipo !== \"PERDA\" && (\r\n                        <SelectItem value=\"sem_lote\">\r\n                          Sem Lote (Ajuste Geral)\r\n                        </SelectItem>\r\n                      )}\r\n                    {availableLotes.map((lote) => (\r\n                      <SelectItem key={lote.id} value={lote.id}>\r\n                        {lote.numeroLote} (Qtd: {lote.quantidade}) - Val:{\" \"}\r\n                        {lote.dataValidade\r\n                          ? new Date(lote.dataValidade).toLocaleDateString(\r\n                              \"pt-BR\"\r\n                            )\r\n                          : \"N/A\"}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            )}\r\n\r\n            <div className=\"grid grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"movTipo\">Tipo</Label>\r\n                <Select\r\n                  value={movementFormData.tipo}\r\n                  onValueChange={(value) =>\r\n                    setMovementFormData({ ...movementFormData, tipo: value })\r\n                  }\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Tipo\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"ENTRADA\">Entrada (+)</SelectItem>\r\n                    <SelectItem value=\"SAIDA\">Sa├¡da (-)</SelectItem>\r\n                    <SelectItem value=\"PERDA\">Perda/Quebra (-)</SelectItem>\r\n                    <SelectItem value=\"AJUSTE\">Ajuste (+)</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"movQuantidade\">Quantidade</Label>\r\n                <Input\r\n                  id=\"movQuantidade\"\r\n                  type=\"number\"\r\n                  value={movementFormData.quantidade}\r\n                  onChange={(e) =>\r\n                    setMovementFormData({\r\n                      ...movementFormData,\r\n                      quantidade: e.target.value,\r\n                    })\r\n                  }\r\n                  placeholder=\"Qtd\"\r\n                  required\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"movMotivo\">Motivo (Opcional)</Label>\r\n              <Input\r\n                id=\"movMotivo\"\r\n                value={movementFormData.motivo}\r\n                onChange={(e) =>\r\n                  setMovementFormData({\r\n                    ...movementFormData,\r\n                    motivo: e.target.value,\r\n                  })\r\n                }\r\n                placeholder=\"Ex: Contagem de estoque, doa├º├úo, etc.\"\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex justify-end gap-2 pt-4\">\r\n              <InteractiveHoverButton\r\n                type=\"button\"\r\n                className=\"bg-white hover:bg-gray-50 dark:bg-zinc-800 dark:hover:bg-zinc-700 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-zinc-700\"\r\n                onClick={() => setMovementDialogOpen(false)}\r\n              >\r\n                Cancelar\r\n              </InteractiveHoverButton>\r\n              <InteractiveHoverButton\r\n                type=\"submit\"\r\n                className=\"bg-cta-bg text-white border-cta-bg hover:bg-cta-bg/90\"\r\n              >\r\n                Confirmar\r\n              </InteractiveHoverButton>\r\n            </div>\r\n          </form>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\relatorios\\_components\\relatorios-charts.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2464,2467],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2464,2467],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":152,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":152,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5669,5672],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5669,5672],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":194,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":194,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7267,7270],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7267,7270],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":210,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":210,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7878,7881],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7878,7881],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport {\r\n  BarChart,\r\n  Bar,\r\n  XAxis,\r\n  YAxis,\r\n  Tooltip,\r\n  PieChart,\r\n  Pie,\r\n  Cell,\r\n  ResponsiveContainer,\r\n  ComposedChart,\r\n  Line,\r\n  CartesianGrid,\r\n  Legend\r\n} from \"recharts\";\r\nimport { Analytics } from \"@/hooks/use-relatorios\";\r\n\r\ninterface RelatoriosChartsProps {\r\n  analytics: Analytics | null;\r\n}\r\n\r\nexport function RelatoriosCharts({ analytics }: RelatoriosChartsProps) {\r\n  const formatCurrency = (value: number) => `R$ ${value.toFixed(2)}`;\r\n\r\n  const methodColors = {\r\n    dinheiro: \"#60B5FF\",\r\n    debito: \"#FF9149\",\r\n    credito: \"#FF9898\",\r\n    pix: \"#80D8C3\",\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* NOVO: An├ílise Financeira (Timeline) */}\r\n      <Card className=\"bg-white dark:bg-zinc-900 border-gray-200 dark:border-zinc-800\">\r\n        <CardHeader>\r\n          <CardTitle className=\"text-gray-900 dark:text-gray-100\">\r\n            An├ílise Financeira (Faturamento x Custo x Lucro)\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {/* Scroll horizontal para mobile, com scrollbar escondida */}\r\n          <div className=\"w-full overflow-x-auto scrollbar-hide\">\r\n             <div className=\"min-w-[600px] h-[350px]\">\r\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                  <ComposedChart\r\n                    data={analytics?.financialTimeline || []}\r\n                    margin={{ top: 20, right: 20, bottom: 20, left: 20 }}\r\n                  >\r\n                    {/* Grid mais sutil */}\r\n                    <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"#E5E7EB\" />\r\n\r\n                    {/* Eixos mais limpos */}\r\n                    <XAxis\r\n                      dataKey=\"date\"\r\n                      scale=\"point\"\r\n                      padding={{ left: 10, right: 10 }}\r\n                      tick={{ fontSize: 12, fill: \"#6B7280\" }}\r\n                      axisLine={false}\r\n                      tickLine={false}\r\n                      dy={10}\r\n                    />\r\n                    <YAxis\r\n                      tick={{ fontSize: 12, fill: \"#6B7280\" }}\r\n                      tickFormatter={(val) => `R$${val}`}\r\n                      axisLine={false}\r\n                      tickLine={false}\r\n                    />\r\n\r\n                    {/* Tooltip melhorado */}\r\n                    <Tooltip\r\n                      formatter={(value: any) => formatCurrency(value)}\r\n                      wrapperStyle={{ outline: \"none\" }}\r\n                      contentStyle={{\r\n                        backgroundColor: \"#fff\",\r\n                        borderColor: \"#E5E7EB\",\r\n                        borderRadius: \"8px\",\r\n                        boxShadow: \"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)\",\r\n                        color: \"#111827\",\r\n                        fontSize: \"12px\",\r\n                        padding: \"8px 12px\"\r\n                      }}\r\n                      cursor={{ fill: \"#F3F4F6\" }}\r\n                    />\r\n                    <Legend\r\n                      wrapperStyle={{ paddingTop: \"20px\" }}\r\n                      iconType=\"circle\"\r\n                    />\r\n\r\n                    {/* Barra de Faturamento (Verde) com cantos arredondados */}\r\n                    <Bar\r\n                      dataKey=\"faturamento\"\r\n                      name=\"Faturamento\"\r\n                      barSize={20}\r\n                      fill=\"#22c55e\"\r\n                      radius={[4, 4, 0, 0]}\r\n                    />\r\n\r\n                    {/* Barra de Custo (Vermelho) com cantos arredondados */}\r\n                    <Bar\r\n                      dataKey=\"custo\"\r\n                      name=\"Custo\"\r\n                      barSize={20}\r\n                      fill=\"#ef4444\"\r\n                      radius={[4, 4, 0, 0]}\r\n                    />\r\n\r\n                    {/* Linha de Lucro (Dourado) mais suave */}\r\n                    <Line\r\n                      type=\"monotone\"\r\n                      dataKey=\"lucro\"\r\n                      name=\"Lucro L├¡quido\"\r\n                      stroke=\"#eab308\"\r\n                      strokeWidth={3}\r\n                      dot={{ r: 4, fill: \"#eab308\", strokeWidth: 2, stroke: \"#fff\" }}\r\n                      activeDot={{ r: 6, strokeWidth: 0 }}\r\n                    />\r\n                  </ComposedChart>\r\n                </ResponsiveContainer>\r\n             </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n        {/* Produtos Mais Vendidos */}\r\n        <Card className=\"bg-white dark:bg-zinc-900 border-gray-200 dark:border-zinc-800\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-gray-900 dark:text-gray-100\">\r\n              Produtos Mais Vendidos\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <ResponsiveContainer width=\"100%\" height={300}>\r\n              <BarChart data={analytics?.produtosMaisVendidos || []}>\r\n                <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"#E5E7EB\" />\r\n                <XAxis\r\n                  dataKey=\"nome\"\r\n                  tickLine={false}\r\n                  axisLine={false}\r\n                  tick={{ fontSize: 10, fill: \"#6B7280\" }}\r\n                  interval=\"preserveStartEnd\"\r\n                  dy={5}\r\n                />\r\n                <YAxis\r\n                  tickLine={false}\r\n                  axisLine={false}\r\n                  tick={{ fontSize: 10, fill: \"#6B7280\" }}\r\n                />\r\n                <Tooltip\r\n                  formatter={(value: any) => [value, \"Quantidade\"]}\r\n                  cursor={{ fill: \"#F3F4F6\" }}\r\n                  wrapperStyle={{ outline: \"none\" }}\r\n                  contentStyle={{\r\n                    backgroundColor: \"#fff\",\r\n                    borderColor: \"#E5E7EB\",\r\n                    borderRadius: \"8px\",\r\n                    boxShadow: \"0 4px 6px -1px rgba(0, 0, 0, 0.1)\",\r\n                    color: \"#000\",\r\n                    fontSize: \"12px\"\r\n                  }}\r\n                />\r\n                <Bar\r\n                  dataKey=\"totalVendido\"\r\n                  fill=\"#60B5FF\"\r\n                  name=\"Quantidade\"\r\n                  radius={[4, 4, 0, 0]}\r\n                />\r\n              </BarChart>\r\n            </ResponsiveContainer>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Vendas por M├®todo */}\r\n        <Card className=\"bg-white dark:bg-zinc-900 border-gray-200 dark:border-zinc-800\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-gray-900 dark:text-gray-100\">\r\n              Vendas por M├®todo de Pagamento\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <ResponsiveContainer width=\"100%\" height={300}>\r\n              <PieChart>\r\n                <Pie\r\n                  data={analytics?.vendasPorMetodo || []}\r\n                  cx=\"50%\"\r\n                  cy=\"50%\"\r\n                  outerRadius={80}\r\n                  innerRadius={50} // Donut chart looks cleaner\r\n                  paddingAngle={5}\r\n                  dataKey=\"valor\"\r\n                  nameKey=\"metodo\"\r\n                  label={(entry: any) =>\r\n                    `${entry.metodo}: ${formatCurrency(entry.valor)}`\r\n                  }\r\n                >\r\n                  {analytics?.vendasPorMetodo?.map((entry, index) => (\r\n                    <Cell\r\n                      key={`cell-${index}`}\r\n                      fill={\r\n                        methodColors[entry.metodo as keyof typeof methodColors] ||\r\n                        \"#8884d8\"\r\n                      }\r\n                      strokeWidth={0}\r\n                    />\r\n                  ))}\r\n                </Pie>\r\n                <Tooltip\r\n                  formatter={(value: any) => formatCurrency(value)}\r\n                  wrapperStyle={{ outline: \"none\" }}\r\n                  contentStyle={{\r\n                    backgroundColor: \"#fff\",\r\n                    borderColor: \"#E5E7EB\",\r\n                    borderRadius: \"8px\",\r\n                    boxShadow: \"0 4px 6px -1px rgba(0, 0, 0, 0.1)\",\r\n                    color: \"#000\",\r\n                    fontSize: \"12px\"\r\n                  }}\r\n                />\r\n              </PieChart>\r\n            </ResponsiveContainer>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\signup\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ThemeToggle' is defined but never used.","line":23,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Sparkles' is defined but never used.","line":25,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport Link from \"next/link\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  Building2,\r\n  User,\r\n  Mail,\r\n  Lock,\r\n  Eye,\r\n  EyeOff,\r\n  ArrowRight,\r\n  Loader2,\r\n  AlertTriangle,\r\n  CheckCircle2,\r\n  Phone,\r\n  FileText,\r\n  Ticket,\r\n  MapPin,\r\n} from \"lucide-react\";\r\nimport { ThemeToggle } from \"@/components/theme-toggle\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Sparkles } from \"@/components/Sparkles\";\r\nimport { AuthLayout } from \"@/components/auth/auth-layout\";\r\n\r\nexport default function SignupPage() {\r\n  const [email, setEmail] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\r\n  const [nome, setNome] = useState(\"\");\r\n  const [nomeEmpresa, setNomeEmpresa] = useState(\"\");\r\n  const [telefone, setTelefone] = useState(\"\");\r\n  const [cpfCnpj, setCpfCnpj] = useState(\"\");\r\n\r\n  // Endere├ºo\r\n  const [cep, setCep] = useState(\"\");\r\n  const [logradouro, setLogradouro] = useState(\"\");\r\n  const [numero, setNumero] = useState(\"\");\r\n  const [bairro, setBairro] = useState(\"\");\r\n  const [cidade, setCidade] = useState(\"\");\r\n  const [uf, setUf] = useState(\"\");\r\n  const [loadingCep, setLoadingCep] = useState(false);\r\n\r\n  // Cupom\r\n  const [cupom, setCupom] = useState(\"\");\r\n  const [cupomStatus, setCupomStatus] = useState<{\r\n    valid: boolean;\r\n    message: string;\r\n    color: string;\r\n  } | null>(null);\r\n  const [validatingCupom, setValidatingCupom] = useState(false);\r\n\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [success, setSuccess] = useState(\"\");\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const [termsAccepted, setTermsAccepted] = useState(false);\r\n  const router = useRouter();\r\n\r\n  // Formata├º├Áes\r\n  const formatTelefone = (value: string): string => {\r\n    const numbers = value.replace(/\\D/g, \"\").slice(0, 11);\r\n    if (numbers.length <= 2) return numbers;\r\n    if (numbers.length <= 6)\r\n      return `(${numbers.slice(0, 2)}) ${numbers.slice(2)}`;\r\n    if (numbers.length <= 10)\r\n      return `(${numbers.slice(0, 2)}) ${numbers.slice(2, 6)}-${numbers.slice(\r\n        6\r\n      )}`;\r\n    return `(${numbers.slice(0, 2)}) ${numbers.slice(2, 7)}-${numbers.slice(\r\n      7\r\n    )}`;\r\n  };\r\n\r\n  const formatCpfCnpj = (value: string): string => {\r\n    const numbers = value.replace(/\\D/g, \"\");\r\n    if (numbers.length <= 11) {\r\n      if (numbers.length <= 3) return numbers;\r\n      if (numbers.length <= 6)\r\n        return `${numbers.slice(0, 3)}.${numbers.slice(3)}`;\r\n      if (numbers.length <= 9)\r\n        return `${numbers.slice(0, 3)}.${numbers.slice(3, 6)}.${numbers.slice(\r\n          6\r\n        )}`;\r\n      return `${numbers.slice(0, 3)}.${numbers.slice(3, 6)}.${numbers.slice(\r\n        6,\r\n        9\r\n      )}-${numbers.slice(9, 11)}`;\r\n    } else {\r\n      const cnpj = numbers.slice(0, 14);\r\n      if (cnpj.length <= 2) return cnpj;\r\n      if (cnpj.length <= 5) return `${cnpj.slice(0, 2)}.${cnpj.slice(2)}`;\r\n      if (cnpj.length <= 8)\r\n        return `${cnpj.slice(0, 2)}.${cnpj.slice(2, 5)}.${cnpj.slice(5)}`;\r\n      if (cnpj.length <= 12)\r\n        return `${cnpj.slice(0, 2)}.${cnpj.slice(2, 5)}.${cnpj.slice(\r\n          5,\r\n          8\r\n        )}/${cnpj.slice(8)}`;\r\n      return `${cnpj.slice(0, 2)}.${cnpj.slice(2, 5)}.${cnpj.slice(\r\n        5,\r\n        8\r\n      )}/${cnpj.slice(8, 12)}-${cnpj.slice(12)}`;\r\n    }\r\n  };\r\n\r\n  const formatCep = (value: string) => {\r\n    return value\r\n      .replace(/\\D/g, \"\")\r\n      .replace(/^(\\d{5})(\\d)/, \"$1-$2\")\r\n      .slice(0, 9);\r\n  };\r\n\r\n  // Handlers\r\n  const handleCepBlur = async () => {\r\n    const cleanCep = cep.replace(/\\D/g, \"\");\r\n    if (cleanCep.length !== 8) return;\r\n\r\n    setLoadingCep(true);\r\n    try {\r\n      const res = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);\r\n      const data = await res.json();\r\n      if (!data.erro) {\r\n        setLogradouro(data.logradouro);\r\n        setBairro(data.bairro);\r\n        setCidade(data.localidade);\r\n        setUf(data.uf);\r\n        document.getElementById(\"numero\")?.focus();\r\n      }\r\n    } catch (e) {\r\n      console.error(\"Erro ao buscar CEP\", e);\r\n    } finally {\r\n      setLoadingCep(false);\r\n    }\r\n  };\r\n\r\n  const validateCupom = async () => {\r\n    if (!cupom) return;\r\n    setValidatingCupom(true);\r\n    setCupomStatus(null);\r\n    try {\r\n      const res = await fetch(\"/api/cupons/validate\", {\r\n        method: \"POST\",\r\n        body: JSON.stringify({ codigo: cupom }),\r\n      });\r\n      const data = await res.json();\r\n      if (res.ok) {\r\n        setCupomStatus({\r\n          valid: true,\r\n          message: data.mensagem,\r\n          color: \"text-green-600\",\r\n        });\r\n      } else {\r\n        setCupomStatus({\r\n          valid: false,\r\n          message: data.error,\r\n          color: \"text-red-500\",\r\n        });\r\n      }\r\n    } catch (e) {\r\n      setCupomStatus({\r\n        valid: false,\r\n        message: \"Erro ao validar cupom\",\r\n        color: \"text-red-500\",\r\n      });\r\n    } finally {\r\n      setValidatingCupom(false);\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n    setError(\"\");\r\n    setSuccess(\"\");\r\n\r\n    if (password !== confirmPassword) {\r\n      setError(\"As senhas n├úo coincidem\");\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const payload = {\r\n        email: email.toLowerCase(),\r\n        password,\r\n        nome,\r\n        nomeEmpresa,\r\n        telefone: telefone.replace(/\\D/g, \"\"),\r\n        cpfCnpj: cpfCnpj.replace(/\\D/g, \"\"),\r\n        // Endere├ºo\r\n        cep: cep.replace(/\\D/g, \"\"),\r\n        logradouro,\r\n        numero,\r\n        bairro,\r\n        cidade,\r\n        uf,\r\n        // Cupom (apenas se validado ou preenchido)\r\n        cupom: cupom && cupomStatus?.valid ? cupom : undefined,\r\n        // Termos\r\n        termsAccepted,\r\n      };\r\n\r\n      const signupResponse = await fetch(\"/api/signup\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(payload),\r\n      });\r\n\r\n      const signupData = await signupResponse.json();\r\n\r\n      if (!signupResponse.ok) {\r\n        setError(signupData.error || \"Erro ao criar conta\");\r\n        return;\r\n      }\r\n\r\n      setSuccess(signupData.message);\r\n\r\n      // Reset\r\n      setEmail(\"\");\r\n      setPassword(\"\");\r\n      setConfirmPassword(\"\");\r\n      setNome(\"\");\r\n      setNomeEmpresa(\"\");\r\n      setTelefone(\"\");\r\n      setCpfCnpj(\"\");\r\n      setLogradouro(\"\");\r\n      setNumero(\"\");\r\n      setBairro(\"\");\r\n      setCidade(\"\");\r\n      setUf(\"\");\r\n      setCep(\"\");\r\n      setCupom(\"\");\r\n\r\n      setTimeout(() => {\r\n        router.push(\"/login\");\r\n      }, 3000);\r\n    } catch (error) {\r\n      setError(\"Erro ao criar conta\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <AuthLayout\r\n      sideContent={\r\n        <>\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 40 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            transition={{ delay: 0.2, duration: 0.8 }}\r\n          >\r\n            <h2 className=\"text-5xl font-bold mb-6 text-gray-900 dark:text-white tracking-tight\">\r\n              Comece sua jornada <br />\r\n              <span className=\"text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600\">\r\n                rumo ao sucesso.\r\n              </span>\r\n            </h2>\r\n            <p className=\"text-xl text-gray-600 dark:text-gray-300 leading-relaxed\">\r\n              Ferramentas poderosas para quem quer ir al├®m do b├ísico.\r\n            </p>\r\n          </motion.div>\r\n        </>\r\n      }\r\n    >\r\n      <motion.div\r\n        initial={{ opacity: 0, y: 20 }}\r\n        animate={{ opacity: 1, y: 0 }}\r\n        transition={{ duration: 0.5 }}\r\n        className=\"w-full max-w-md mt-20 lg:mt-0 pb-12\"\r\n      >\r\n        <div className=\"mb-8\">\r\n          <h1 className=\"text-4xl font-bold tracking-tight mb-3\">\r\n            Crie sua conta\r\n          </h1>\r\n          <p className=\"text-gray-500 dark:text-gray-400 text-lg\">\r\n            Teste gr├ítis por 14 dias. Sem compromisso.\r\n          </p>\r\n        </div>\r\n\r\n        <form onSubmit={handleSubmit} className=\"space-y-5\">\r\n          {/* Nome da Empresa */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n              Nome da Empresa\r\n            </label>\r\n            <div className=\"relative\">\r\n              <Building2 className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n              <input\r\n                type=\"text\"\r\n                value={nomeEmpresa}\r\n                onChange={(e) => setNomeEmpresa(e.target.value)}\r\n                className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-12 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                placeholder=\"Minha Loja Inc.\"\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* CPF/CNPJ */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n              CPF ou CNPJ\r\n            </label>\r\n            <div className=\"relative\">\r\n              <FileText className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n              <input\r\n                type=\"text\"\r\n                value={cpfCnpj}\r\n                onChange={(e) => setCpfCnpj(formatCpfCnpj(e.target.value))}\r\n                className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-12 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                placeholder=\"000.000.000-00 ou 00.000.000/0000-00\"\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Telefone */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n              Telefone / WhatsApp\r\n            </label>\r\n            <div className=\"relative\">\r\n              <Phone className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n              <input\r\n                type=\"tel\"\r\n                value={telefone}\r\n                onChange={(e) => setTelefone(formatTelefone(e.target.value))}\r\n                className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-12 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                placeholder=\"(11) 99999-9999\"\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Endere├ºo - CEP */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n              CEP\r\n            </label>\r\n            <div className=\"relative\">\r\n              <MapPin className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n              <input\r\n                type=\"text\"\r\n                value={cep}\r\n                onChange={(e) => setCep(formatCep(e.target.value))}\r\n                onBlur={handleCepBlur}\r\n                className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-12 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                placeholder=\"00000-000\"\r\n                required\r\n              />\r\n              {loadingCep && (\r\n                <Loader2 className=\"absolute right-4 top-1/2 -translate-y-1/2 animate-spin w-4 h-4 text-blue-500\" />\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-3 gap-2\">\r\n            <div className=\"col-span-2 space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n                Logradouro\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={logradouro}\r\n                onChange={(e) => setLogradouro(e.target.value)}\r\n                className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-4 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all\"\r\n                placeholder=\"Rua...\"\r\n                required\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n                N├║mero\r\n              </label>\r\n              <input\r\n                id=\"numero\"\r\n                type=\"text\"\r\n                value={numero}\r\n                onChange={(e) => setNumero(e.target.value)}\r\n                className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-4 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all\"\r\n                placeholder=\"123\"\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-2 gap-2\">\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n                Bairro\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={bairro}\r\n                onChange={(e) => setBairro(e.target.value)}\r\n                className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-4 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all\"\r\n                placeholder=\"Centro\"\r\n                required\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n                Cidade - UF\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={cidade && uf ? `${cidade} - ${uf}` : \"\"}\r\n                readOnly\r\n                className=\"w-full bg-gray-100 dark:bg-zinc-800 border border-gray-200 dark:border-zinc-800 rounded-xl px-4 py-3.5 outline-none text-gray-500 cursor-not-allowed\"\r\n                placeholder=\"Cidade - UF\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Nome do Usu├írio */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n              Seu Nome\r\n            </label>\r\n            <div className=\"relative\">\r\n              <User className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n              <input\r\n                type=\"text\"\r\n                value={nome}\r\n                onChange={(e) => setNome(e.target.value)}\r\n                className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-12 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                placeholder=\"Jo├úo Silva\"\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Email */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n              Email\r\n            </label>\r\n            <div className=\"relative\">\r\n              <Mail className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n              <input\r\n                type=\"email\"\r\n                value={email}\r\n                onChange={(e) => setEmail(e.target.value)}\r\n                className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-12 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                placeholder=\"seu@email.com\"\r\n                required\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Senhas */}\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n                Senha\r\n              </label>\r\n              <div className=\"relative\">\r\n                <Lock className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n                <input\r\n                  type={showPassword ? \"text\" : \"password\"}\r\n                  value={password}\r\n                  onChange={(e) => setPassword(e.target.value)}\r\n                  className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-12 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                  placeholder=\"ÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇó\"\r\n                  required\r\n                  minLength={8}\r\n                />\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n                Confirmar\r\n              </label>\r\n              <div className=\"relative\">\r\n                <Lock className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n                <input\r\n                  type={showPassword ? \"text\" : \"password\"}\r\n                  value={confirmPassword}\r\n                  onChange={(e) => setConfirmPassword(e.target.value)}\r\n                  className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl px-12 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                  placeholder=\"ÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇóÔÇó\"\r\n                  required\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center justify-end\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setShowPassword(!showPassword)}\r\n              className=\"text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 flex items-center gap-1\"\r\n            >\r\n              {showPassword ? <EyeOff size={16} /> : <Eye size={16} />}\r\n              {showPassword ? \"Ocultar senha\" : \"Mostrar senha\"}\r\n            </button>\r\n          </div>\r\n\r\n          {/* Cupom */}\r\n          <div className=\"space-y-2\">\r\n            <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\r\n              Cupom de Desconto (Opcional)\r\n            </label>\r\n            <div className=\"relative flex gap-2\">\r\n              <div className=\"relative flex-1\">\r\n                <Ticket className=\"absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5\" />\r\n                <input\r\n                  type=\"text\"\r\n                  value={cupom}\r\n                  onChange={(e) => {\r\n                    setCupom(e.target.value.toUpperCase());\r\n                    setCupomStatus(null);\r\n                  }}\r\n                  className=\"w-full bg-gray-50 dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl pl-12 pr-4 py-3.5 outline-none focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600 transition-all placeholder:text-gray-400\"\r\n                  placeholder=\"CUPOM\"\r\n                />\r\n              </div>\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"outline\"\r\n                onClick={validateCupom}\r\n                disabled={!cupom || validatingCupom}\r\n                className=\"h-[50px] px-6\"\r\n              >\r\n                {validatingCupom ? (\r\n                  <Loader2 className=\"animate-spin w-4 h-4\" />\r\n                ) : (\r\n                  \"Aplicar\"\r\n                )}\r\n              </Button>\r\n            </div>\r\n            {cupomStatus && (\r\n              <p className={`text-sm ${cupomStatus.color} mt-1`}>\r\n                {cupomStatus.message}\r\n              </p>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"flex items-start gap-3 pt-2\">\r\n            <input\r\n              type=\"checkbox\"\r\n              id=\"terms\"\r\n              checked={termsAccepted}\r\n              onChange={(e) => setTermsAccepted(e.target.checked)}\r\n              required\r\n              className=\"mt-1 w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600\"\r\n            />\r\n            <label\r\n              htmlFor=\"terms\"\r\n              className=\"text-sm text-gray-500 dark:text-gray-400\"\r\n            >\r\n              Eu concordo com os{\" \"}\r\n              <Link\r\n                href=\"/termos\"\r\n                className=\"text-blue-600 hover:underline\"\r\n                target=\"_blank\"\r\n              >\r\n                Termos de Servi├ºo\r\n              </Link>{\" \"}\r\n              e{\" \"}\r\n              <Link\r\n                href=\"/privacidade\"\r\n                className=\"text-blue-600 hover:underline\"\r\n                target=\"_blank\"\r\n              >\r\n                Pol├¡tica de Privacidade\r\n              </Link>\r\n              .\r\n            </label>\r\n          </div>\r\n\r\n          {error && (\r\n            <motion.div\r\n              initial={{ opacity: 0, height: 0 }}\r\n              animate={{ opacity: 1, height: \"auto\" }}\r\n              className=\"flex items-center gap-2 text-red-600 bg-red-50 dark:bg-red-900/20 p-3 rounded-lg text-sm font-medium\"\r\n            >\r\n              <AlertTriangle size={16} />\r\n              {error}\r\n            </motion.div>\r\n          )}\r\n\r\n          {success && (\r\n            <motion.div\r\n              initial={{ opacity: 0, height: 0 }}\r\n              animate={{ opacity: 1, height: \"auto\" }}\r\n              className=\"flex items-center gap-2 text-green-600 bg-green-50 dark:bg-green-900/20 p-3 rounded-lg text-sm font-medium\"\r\n            >\r\n              <CheckCircle2 size={16} />\r\n              {success}\r\n            </motion.div>\r\n          )}\r\n\r\n          <Button\r\n            type=\"submit\"\r\n            disabled={loading}\r\n            className=\"w-full h-14 text-lg font-bold rounded-xl flex items-center justify-center gap-2\"\r\n          >\r\n            {loading ? (\r\n              <Loader2 className=\"animate-spin w-5 h-5\" />\r\n            ) : (\r\n              <>\r\n                Criar Conta\r\n                <ArrowRight size={20} />\r\n              </>\r\n            )}\r\n          </Button>\r\n        </form>\r\n        {/* ... Login Link ... */}\r\n        <div className=\"mt-8 text-center pb-8\">\r\n          <p className=\"text-gray-500 dark:text-gray-400\">\r\n            J├í tem uma conta?{\" \"}\r\n            <Link\r\n              href=\"/login\"\r\n              className=\"text-blue-600 font-bold hover:underline\"\r\n            >\r\n              Fazer login\r\n            </Link>\r\n          </p>\r\n        </div>\r\n      </motion.div>\r\n    </AuthLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\app\\suporte\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Phone' is defined but never used.","line":7,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Book' is defined but never used.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":7},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertCircle' is defined but never used.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":14}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Metadata } from \"next\";\r\nimport Link from \"next/link\";\r\nimport {\r\n  ArrowLeft,\r\n  Mail,\r\n  MessageCircle,\r\n  Phone,\r\n  Clock,\r\n  HelpCircle,\r\n  Book,\r\n  AlertCircle,\r\n  CheckCircle,\r\n} from \"lucide-react\";\r\n\r\nexport const metadata: Metadata = {\r\n  title: \"Suporte - FlowPDV\",\r\n  description: \"Central de Suporte do FlowPDV - Estamos aqui para ajudar\",\r\n};\r\n\r\nconst faqItems = [\r\n  {\r\n    question: \"Como fa├ºo para abrir o caixa?\",\r\n    answer:\r\n      \"No Dashboard, clique no bot├úo 'Abrir Caixa', informe o valor inicial em dinheiro e confirme. O caixa ficar├í aberto para voc├¬ realizar vendas.\",\r\n  },\r\n  {\r\n    question: \"Esqueci minha senha, como recupero?\",\r\n    answer:\r\n      \"Na tela de login, clique em 'Esqueci minha senha'. Informe seu e-mail cadastrado e voc├¬ receber├í uma senha tempor├íria para acessar o sistema.\",\r\n  },\r\n  {\r\n    question: \"Como adicionar um novo produto?\",\r\n    answer:\r\n      \"V├í em Estoque > Adicionar Produto. Preencha as informa├º├Áes como nome, SKU, pre├ºos e quantidade. Voc├¬ tamb├®m pode adicionar uma imagem do produto.\",\r\n  },\r\n  {\r\n    question: \"Como fa├ºo sangria ou suprimento de caixa?\",\r\n    answer:\r\n      \"No Dashboard, na se├º├úo 'Meu Caixa', clique em 'Suprimento' para adicionar dinheiro ou 'Sangria' para retirar. Informe o valor e o m├®todo de pagamento.\",\r\n  },\r\n  {\r\n    question: \"Como cadastrar um funcion├írio?\",\r\n    answer:\r\n      \"V├í em Equipe > Adicionar Funcion├írio. Informe o nome, e-mail e cargo do funcion├írio. Ele receber├í um e-mail com as credenciais de acesso.\",\r\n  },\r\n  {\r\n    question: \"Meu pagamento n├úo foi identificado, o que fazer?\",\r\n    answer:\r\n      \"Entre em contato com nosso suporte pelo WhatsApp ou e-mail informando seus dados. Verificaremos o pagamento e liberaremos seu acesso.\",\r\n  },\r\n];\r\n\r\nexport default function SuportePage() {\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50 dark:bg-zinc-950 py-12 px-4\">\r\n      <div className=\"max-w-4xl mx-auto\">\r\n        {/* Header */}\r\n        <div className=\"mb-8\">\r\n          <Link\r\n            href=\"/\"\r\n            className=\"inline-flex items-center text-sm text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 mb-6 transition-colors\"\r\n          >\r\n            <ArrowLeft size={16} className=\"mr-2\" />\r\n            Voltar para o in├¡cio\r\n          </Link>\r\n        </div>\r\n\r\n        {/* Hero */}\r\n        <div className=\"bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl p-8 md:p-12 text-white mb-8\">\r\n          <h1 className=\"text-3xl md:text-4xl font-bold mb-4\">\r\n            Como podemos ajudar?\r\n          </h1>\r\n          <p className=\"text-blue-100 text-lg\">\r\n            Nossa equipe est├í pronta para te atender e resolver qualquer d├║vida.\r\n          </p>\r\n        </div>\r\n\r\n        {/* Contact Cards */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-12\">\r\n          <div className=\"bg-white dark:bg-zinc-900 rounded-xl border border-gray-200 dark:border-zinc-800 p-6 text-center hover:shadow-lg transition-shadow\">\r\n            <div className=\"w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n              <MessageCircle className=\"w-6 h-6 text-green-600\" />\r\n            </div>\r\n            <h3 className=\"font-semibold text-gray-900 dark:text-white mb-2\">\r\n              WhatsApp\r\n            </h3>\r\n            <p className=\"text-gray-500 dark:text-gray-400 text-sm mb-4\">\r\n              Atendimento r├ípido e pr├ítico\r\n            </p>\r\n            <a\r\n              href=\"https://wa.me/5511999999999\"\r\n              target=\"_blank\"\r\n              rel=\"noopener noreferrer\"\r\n              className=\"inline-flex items-center text-green-600 hover:underline font-medium\"\r\n            >\r\n              Iniciar Conversa\r\n            </a>\r\n          </div>\r\n\r\n          <div className=\"bg-white dark:bg-zinc-900 rounded-xl border border-gray-200 dark:border-zinc-800 p-6 text-center hover:shadow-lg transition-shadow\">\r\n            <div className=\"w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n              <Mail className=\"w-6 h-6 text-blue-600\" />\r\n            </div>\r\n            <h3 className=\"font-semibold text-gray-900 dark:text-white mb-2\">\r\n              E-mail\r\n            </h3>\r\n            <p className=\"text-gray-500 dark:text-gray-400 text-sm mb-4\">\r\n              Para quest├Áes detalhadas\r\n            </p>\r\n            <a\r\n              href=\"mailto:suporte@flowpdv.com\"\r\n              className=\"inline-flex items-center text-blue-600 hover:underline font-medium\"\r\n            >\r\n              suporte@flowpdv.com\r\n            </a>\r\n          </div>\r\n\r\n          <div className=\"bg-white dark:bg-zinc-900 rounded-xl border border-gray-200 dark:border-zinc-800 p-6 text-center hover:shadow-lg transition-shadow\">\r\n            <div className=\"w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n              <Clock className=\"w-6 h-6 text-purple-600\" />\r\n            </div>\r\n            <h3 className=\"font-semibold text-gray-900 dark:text-white mb-2\">\r\n              Hor├írio\r\n            </h3>\r\n            <p className=\"text-gray-500 dark:text-gray-400 text-sm mb-4\">\r\n              Segunda a Sexta\r\n            </p>\r\n            <span className=\"text-purple-600 font-medium\">09:00 - 18:00</span>\r\n          </div>\r\n        </div>\r\n\r\n        {/* FAQ */}\r\n        <div className=\"bg-white dark:bg-zinc-900 rounded-2xl shadow-lg border border-gray-200 dark:border-zinc-800 p-8 md:p-12\">\r\n          <div className=\"flex items-center gap-3 mb-8\">\r\n            <div className=\"w-10 h-10 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg flex items-center justify-center\">\r\n              <HelpCircle className=\"w-5 h-5 text-yellow-600\" />\r\n            </div>\r\n            <h2 className=\"text-2xl font-bold text-gray-900 dark:text-white\">\r\n              Perguntas Frequentes\r\n            </h2>\r\n          </div>\r\n\r\n          <div className=\"space-y-6\">\r\n            {faqItems.map((item, index) => (\r\n              <div\r\n                key={index}\r\n                className=\"border-b border-gray-100 dark:border-zinc-800 pb-6 last:border-0\"\r\n              >\r\n                <h3 className=\"font-semibold text-gray-900 dark:text-white mb-2 flex items-start gap-2\">\r\n                  <CheckCircle className=\"w-5 h-5 text-green-500 mt-0.5 flex-shrink-0\" />\r\n                  {item.question}\r\n                </h3>\r\n                <p className=\"text-gray-600 dark:text-gray-400 pl-7\">\r\n                  {item.answer}\r\n                </p>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Status */}\r\n        <div className=\"mt-8 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800 p-6\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"w-3 h-3 bg-green-500 rounded-full animate-pulse\" />\r\n            <span className=\"font-medium text-green-700 dark:text-green-400\">\r\n              Todos os sistemas operacionais\r\n            </span>\r\n          </div>\r\n          <p className=\"text-green-600 dark:text-green-500 text-sm mt-2\">\r\n            FlowPDV est├í funcionando normalmente. Sem incidentes reportados.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\components\\PasswordChangeAlert.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[498,501],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[498,501],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useSession } from \"next-auth/react\";\r\nimport Link from \"next/link\";\r\nimport { AlertTriangle } from \"lucide-react\";\r\nimport { usePathname } from \"next/navigation\";\r\n\r\nexport function PasswordChangeAlert() {\r\n  const { data: session } = useSession();\r\n  const pathname = usePathname();\r\n\r\n  // Don't show on login or forgot-password pages\r\n  if (pathname === \"/login\" || pathname === \"/forgot-password\") {\r\n    return null;\r\n  }\r\n\r\n  if (!session?.user || !(session.user as any).mustChangePassword) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-amber-600 text-white px-4 py-3 text-center font-medium flex items-center justify-center gap-2 relative z-[100] shadow-md\">\r\n      <AlertTriangle className=\"w-5 h-5\" />\r\n      <span>\r\n        ­ƒöÉ Sua senha ├® tempor├íria! Por favor,{\" \"}\r\n        <Link\r\n          href=\"/configuracoes\"\r\n          className=\"underline hover:text-amber-100 font-bold\"\r\n        >\r\n          v├í em Configura├º├Áes &gt; Seguran├ºa\r\n        </Link>{\" \"}\r\n        e defina uma nova senha o quanto antes.\r\n      </span>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\components\\layout\\role-based-layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[520,523],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[520,523],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1279,1282],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1279,1282],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useSession } from \"next-auth/react\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  Sidebar,\r\n  SidebarBody,\r\n  SidebarLink,\r\n  SidebarBrand,\r\n  useSidebar,\r\n} from \"@/components/ui/sidebar\";\r\n\r\nimport {\r\n  LayoutDashboard,\r\n  ShoppingCart,\r\n  Package,\r\n  Calendar,\r\n  ArrowRightLeft,\r\n  Users,\r\n  BarChart3,\r\n  User,\r\n  LogOut,\r\n  Store,\r\n  Settings,\r\n  CreditCard,\r\n} from \"lucide-react\";\r\nimport { signOut } from \"next-auth/react\";\r\n\r\nconst SidebarUserInfo = ({ session }: { session: any }) => {\r\n  const { open } = useSidebar();\r\n\r\n  if (!session?.user) return null;\r\n\r\n  return (\r\n    <motion.div\r\n      animate={{\r\n        display: open ? \"block\" : \"none\",\r\n        opacity: open ? 1 : 0,\r\n      }}\r\n      className=\"px-2 py-1 mb-4 text-xs border-b border-white/20 pb-2 text-white\"\r\n    >\r\n      <p className=\"font-medium truncate\">\r\n        {session.user.empresaNome || \"Empresa\"}\r\n      </p>\r\n      <p className=\"truncate opacity-80\">\r\n        {session.user.role} | {session.user.name?.split(\" \")[0]}\r\n      </p>\r\n    </motion.div>\r\n  );\r\n};\r\n\r\nexport default function RoleBasedLayout({\r\n  children,\r\n}: {\r\n  children: React.ReactNode;\r\n}) {\r\n  const { data: session } = useSession();\r\n  const role = session?.user?.role;\r\n\r\n  let links: any[] = [];\r\n\r\n  if (role === \"master\") {\r\n    links = [\r\n      {\r\n        label: \"Dashboard\",\r\n        href: \"/master\",\r\n        icon: <LayoutDashboard className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n      {\r\n        label: \"Empresas\",\r\n        href: \"/master/empresas\",\r\n        icon: <Store className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n      {\r\n        label: \"Usu├írios\",\r\n        href: \"/master/usuarios\",\r\n        icon: <Users className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n      {\r\n        label: \"Configura├º├Áes\",\r\n        href: \"/configuracoes\",\r\n        icon: <Settings className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n    ];\r\n  } else if (role === \"gerente\") {\r\n    links = [\r\n      {\r\n        label: \"Dashboard\",\r\n        href: \"/gerente\",\r\n        icon: <LayoutDashboard className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n      {\r\n        label: \"Vender\",\r\n        href: \"/vender\",\r\n        icon: <ShoppingCart className=\"h-5 w-5 flex-shrink-0\" />,\r\n        id: \"menu-vender\",\r\n      },\r\n      {\r\n        label: \"Estoque\",\r\n        href: \"/estoque\",\r\n        icon: <Package className=\"h-5 w-5 flex-shrink-0\" />,\r\n        id: \"menu-estoque\",\r\n      },\r\n      {\r\n        label: \"Lotes\",\r\n        href: \"/lotes\",\r\n        icon: <Calendar className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n      {\r\n        label: \"Movimenta├º├Áes\",\r\n        href: \"/movimentacoes\",\r\n        icon: <ArrowRightLeft className=\"h-5 w-5 flex-shrink-0\" />,\r\n        id: \"menu-movimentacoes\",\r\n      },\r\n      {\r\n        label: \"Minha Conta\",\r\n        href: \"/minha-conta\",\r\n        icon: <User className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n      {\r\n        label: \"Configura├º├Áes\",\r\n        href: \"/configuracoes\",\r\n        icon: <Settings className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n    ];\r\n  } else if (role === \"admin\") {\r\n    links = [\r\n      {\r\n        label: \"Dashboard\",\r\n        href: \"/admin\",\r\n        icon: <LayoutDashboard className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n      {\r\n        label: \"Vender\",\r\n        href: \"/vender\",\r\n        icon: <ShoppingCart className=\"h-5 w-5 flex-shrink-0\" />,\r\n        id: \"menu-vender\",\r\n      },\r\n      {\r\n        label: \"Estoque\",\r\n        href: \"/estoque\",\r\n        icon: <Package className=\"h-5 w-5 flex-shrink-0\" />,\r\n        id: \"menu-estoque\",\r\n      },\r\n      {\r\n        label: \"Lotes\",\r\n        href: \"/lotes\",\r\n        icon: <Calendar className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n      {\r\n        label: \"Movimenta├º├Áes\",\r\n        href: \"/movimentacoes\",\r\n        icon: <ArrowRightLeft className=\"h-5 w-5 flex-shrink-0\" />,\r\n        id: \"menu-movimentacoes\",\r\n      },\r\n      {\r\n        label: \"Equipe\",\r\n        href: \"/equipe\",\r\n        icon: <Users className=\"h-5 w-5 flex-shrink-0\" />,\r\n        id: \"menu-equipe\",\r\n      },\r\n      {\r\n        label: \"Relat├│rios\",\r\n        href: \"/relatorios\",\r\n        icon: <BarChart3 className=\"h-5 w-5 flex-shrink-0\" />,\r\n        id: \"menu-relatorios\",\r\n      },\r\n      {\r\n        label: \"Minha Conta\",\r\n        href: \"/minha-conta\",\r\n        icon: <User className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n      {\r\n        label: \"Assinatura\",\r\n        href: \"/admin/assinatura\",\r\n        icon: <CreditCard className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n      {\r\n        label: \"Configura├º├Áes\",\r\n        href: \"/configuracoes\",\r\n        icon: <Settings className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n    ];\r\n  } else {\r\n    // Caixa / Funcion├írio\r\n    links = [\r\n      {\r\n        label: \"Dashboard\",\r\n        href: \"/dashboard\",\r\n        icon: <LayoutDashboard className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n      {\r\n        label: \"Vender\",\r\n        href: \"/vender\",\r\n        icon: <ShoppingCart className=\"h-5 w-5 flex-shrink-0\" />,\r\n        id: \"menu-vender\",\r\n      },\r\n      {\r\n        label: \"Minha Conta\",\r\n        href: \"/minha-conta\",\r\n        icon: <User className=\"h-5 w-5 flex-shrink-0\" />,\r\n        id: \"menu-minha-conta\",\r\n      },\r\n      {\r\n        label: \"Configura├º├Áes\",\r\n        href: \"/configuracoes\",\r\n        icon: <Settings className=\"h-5 w-5 flex-shrink-0\" />,\r\n      },\r\n    ];\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col lg:flex-row h-[100dvh] overflow-hidden bg-gray-100 dark:bg-zinc-900 font-body\">\r\n      <Sidebar>\r\n        <SidebarBody className=\"justify-between gap-10\">\r\n          <div className=\"flex flex-col flex-1 overflow-y-auto overflow-x-hidden\">\r\n            <SidebarBrand />\r\n            <SidebarUserInfo session={session} />\r\n            {/* Links */}\r\n            <div className=\"flex flex-col gap-2\">\r\n              {links.map((link, idx) => (\r\n                <SidebarLink key={idx} link={link} />\r\n              ))}\r\n            </div>\r\n          </div>\r\n          {/* Footer: Perfil e Sair */}\r\n          <div onClick={() => signOut({ callbackUrl: \"/login\" })}>\r\n            <SidebarLink\r\n              link={{\r\n                label: \"Sair\",\r\n                href: \"#\",\r\n                icon: <LogOut className=\"h-5 w-5 text-red-500\" />,\r\n              }}\r\n            />\r\n          </div>\r\n        </SidebarBody>\r\n      </Sidebar>\r\n      {/* Conte├║do com Scroll Independente */}\r\n      <main className=\"flex-1 overflow-y-auto p-4 lg:p-8 bg-white dark:bg-zinc-950 lg:rounded-tl-2xl border-t lg:border-l border-gray-200 dark:border-zinc-800 lg:m-2 lg:ml-0 shadow-sm\">\r\n        {children}\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\components\\onboarding-tour.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isReady' is assigned a value but never used.","line":14,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState, useRef, useCallback } from \"react\";\r\nimport Joyride, { CallBackProps, STATUS, Step } from \"react-joyride\";\r\nimport { useSession } from \"next-auth/react\";\r\nimport { usePathname } from \"next/navigation\";\r\nimport { TOUR_RESET_EVENT } from \"@/lib/events\";\r\n\r\nconst TOUR_COMPLETED_KEY = \"flowpdv_tour_completed\";\r\nconst TOUR_SHOWN_THIS_SESSION_KEY = \"flowpdv_tour_shown_session\";\r\n\r\nexport function OnboardingTour() {\r\n  const [run, setRun] = useState(false);\r\n  const [isReady, setIsReady] = useState(false);\r\n  const { data: session, update, status: sessionStatus } = useSession();\r\n  const pathname = usePathname();\r\n\r\n  // Use ref para controlar se o tour j├í foi iniciado nesta sess├úo de componente\r\n  const hasInitialized = useRef(false);\r\n\r\n  // Obter valores diretamente da sess├úo cliente\r\n  const role = session?.user?.role || \"funcionario\";\r\n  const userId = session?.user?.id;\r\n\r\n  // tourCompleted da sess├úo - undefined enquanto carrega, true/false quando carregado\r\n  const tourCompletedFromSession = session?.user?.tourCompleted;\r\n\r\n  // Bloqueio imediato de renderiza├º├úo em p├íginas p├║blicas\r\n  const publicPages = [\r\n    \"/login\",\r\n    \"/forgot-password\",\r\n    \"/register\",\r\n    \"/signup\",\r\n    \"/bloqueado\",\r\n  ];\r\n  const isPublicPage = publicPages.some((page) => pathname?.startsWith(page));\r\n\r\n  // Fun├º├úo para verificar se o tour foi mostrado nesta sess├úo do navegador (sessionStorage)\r\n  const wasShownThisSession = useCallback(() => {\r\n    if (typeof window === \"undefined\") return false;\r\n    return sessionStorage.getItem(TOUR_SHOWN_THIS_SESSION_KEY) === \"true\";\r\n  }, []);\r\n\r\n  // Fun├º├úo para marcar que o tour foi mostrado nesta sess├úo\r\n  const markShownThisSession = useCallback(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    sessionStorage.setItem(TOUR_SHOWN_THIS_SESSION_KEY, \"true\");\r\n  }, []);\r\n\r\n  // Fun├º├úo para limpar o flag de sess├úo (usado no reset)\r\n  const clearShownThisSession = useCallback(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    sessionStorage.removeItem(TOUR_SHOWN_THIS_SESSION_KEY);\r\n  }, []);\r\n\r\n  // Fun├º├úo para marcar tour como completado no localStorage (por userId)\r\n  const markTourCompletedInStorage = useCallback(() => {\r\n    if (typeof window === \"undefined\" || !userId) return;\r\n    localStorage.setItem(`${TOUR_COMPLETED_KEY}_${userId}`, \"true\");\r\n  }, [userId]);\r\n\r\n  // Fun├º├úo para verificar se est├í completado no localStorage\r\n  const isTourCompletedInStorage = useCallback(() => {\r\n    if (typeof window === \"undefined\" || !userId) return false;\r\n    return localStorage.getItem(`${TOUR_COMPLETED_KEY}_${userId}`) === \"true\";\r\n  }, [userId]);\r\n\r\n  // Fun├º├úo para resetar tour no localStorage\r\n  const resetTourInStorage = useCallback(() => {\r\n    if (typeof window === \"undefined\" || !userId) return;\r\n    localStorage.removeItem(`${TOUR_COMPLETED_KEY}_${userId}`);\r\n  }, [userId]);\r\n\r\n  // Fun├º├úo para iniciar o tour\r\n  const startTour = useCallback(() => {\r\n    if (\r\n      role !== \"master\" &&\r\n      sessionStatus === \"authenticated\" &&\r\n      session?.user\r\n    ) {\r\n      console.log(\"­ƒÜÇ Iniciando tour...\");\r\n      markShownThisSession();\r\n      setRun(true);\r\n    }\r\n  }, [role, sessionStatus, session?.user, markShownThisSession]);\r\n\r\n  // Listener para o evento de reset do tour (vindo do bot├úo)\r\n  useEffect(() => {\r\n    const handleTourReset = () => {\r\n      console.log(\"­ƒöä Tour reset event received\");\r\n      hasInitialized.current = false;\r\n      resetTourInStorage();\r\n      clearShownThisSession();\r\n      // Pequeno delay para garantir que a sess├úo foi atualizada\r\n      setTimeout(() => {\r\n        startTour();\r\n      }, 500);\r\n    };\r\n\r\n    window.addEventListener(TOUR_RESET_EVENT, handleTourReset);\r\n    return () => window.removeEventListener(TOUR_RESET_EVENT, handleTourReset);\r\n  }, [startTour, resetTourInStorage, clearShownThisSession]);\r\n\r\n  // L├│gica principal para decidir quando iniciar o tour\r\n  useEffect(() => {\r\n    // NUNCA rodar em p├íginas p├║blicas\r\n    if (isPublicPage) {\r\n      setRun(false);\r\n      setIsReady(false);\r\n      return;\r\n    }\r\n\r\n    // Aguardar sess├úo carregar completamente\r\n    if (sessionStatus === \"loading\") {\r\n      setIsReady(false);\r\n      return;\r\n    }\r\n\r\n    // S├│ executa se o usu├írio estiver autenticado\r\n    if (sessionStatus !== \"authenticated\" || !session?.user) {\r\n      setRun(false);\r\n      setIsReady(false);\r\n      return;\r\n    }\r\n\r\n    // Agora a sess├úo est├í pronta\r\n    setIsReady(true);\r\n\r\n    // Se ├® master, NUNCA mostrar tour\r\n    if (role === \"master\") {\r\n      setRun(false);\r\n      return;\r\n    }\r\n\r\n    // Se o tour j├í foi mostrado NESTA SESS├âO do navegador, n├úo mostrar de novo\r\n    // Isso evita o problema de aparecer no F5\r\n    if (wasShownThisSession()) {\r\n      console.log(\"ÔÅ¡´©Å Tour j├í foi mostrado nesta sess├úo do navegador\");\r\n      setRun(false);\r\n      return;\r\n    }\r\n\r\n    // Se o tour est├í marcado como completado na SESS├âO (do servidor), n├úo mostrar\r\n    if (tourCompletedFromSession === true) {\r\n      console.log(\"Ô£à Tour j├í completado (sess├úo)\");\r\n      setRun(false);\r\n      return;\r\n    }\r\n\r\n    // Se o tour est├í marcado como completado no localStorage, n├úo mostrar\r\n    if (isTourCompletedInStorage()) {\r\n      console.log(\"Ô£à Tour j├í completado (localStorage)\");\r\n      setRun(false);\r\n      return;\r\n    }\r\n\r\n    // Se tourCompleted ├® explicitamente FALSE (ou seja, nunca fez o tour), mostrar\r\n    if (tourCompletedFromSession === false && !hasInitialized.current) {\r\n      hasInitialized.current = true;\r\n\r\n      // Delay para garantir que o DOM est├í pronto\r\n      const timer = setTimeout(() => {\r\n        console.log(\"­ƒÄ» Iniciando tour pela primeira vez...\", {\r\n          role,\r\n          tourCompletedFromSession,\r\n        });\r\n        markShownThisSession();\r\n        setRun(true);\r\n      }, 1500);\r\n\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [\r\n    tourCompletedFromSession,\r\n    role,\r\n    sessionStatus,\r\n    session?.user,\r\n    isPublicPage,\r\n    wasShownThisSession,\r\n    isTourCompletedInStorage,\r\n    markShownThisSession,\r\n  ]);\r\n\r\n  // N├úo renderizar em p├íginas p├║blicas ou enquanto carregando sess├úo\r\n  if (isPublicPage || sessionStatus !== \"authenticated\" || !session?.user) {\r\n    return null;\r\n  }\r\n\r\n  const handleJoyrideCallback = async (data: CallBackProps) => {\r\n    const { status } = data;\r\n    const finishedStatuses: string[] = [STATUS.FINISHED, STATUS.SKIPPED];\r\n\r\n    if (finishedStatuses.includes(status)) {\r\n      setRun(false);\r\n      hasInitialized.current = true; // Marcar como inicializado para evitar re-trigger\r\n\r\n      // Salvar no localStorage IMEDIATAMENTE para evitar re-apari├º├úo no F5\r\n      markTourCompletedInStorage();\r\n\r\n      try {\r\n        await fetch(\"/api/user/complete-tour\", {\r\n          method: \"POST\",\r\n        });\r\n        await update({ tourCompleted: true });\r\n      } catch (error) {\r\n        console.error(\"Failed to complete tour\", error);\r\n      }\r\n    }\r\n  };\r\n\r\n  const adminSteps: Step[] = [\r\n    {\r\n      target: \"body\",\r\n      content: (\r\n        <div className=\"text-center\">\r\n          <h3 className=\"font-bold text-lg mb-2\">Bem-vindo ao FlowPDV!</h3>\r\n          <p>Vamos fazer um tour r├ípido pelas funcionalidades do sistema.</p>\r\n        </div>\r\n      ),\r\n      placement: \"center\",\r\n      disableBeacon: true,\r\n    },\r\n    {\r\n      target: \"#menu-vender\",\r\n      content: \"Aqui voc├¬ realiza as vendas no PDV (Ponto de Venda).\",\r\n    },\r\n    {\r\n      target: \"#menu-estoque\",\r\n      content: \"Gerencie seus produtos e estoque nesta ├írea.\",\r\n    },\r\n    {\r\n      target: \"#menu-movimentacoes\",\r\n      content: \"Acompanhe todas as movimenta├º├Áes de estoque e financeiras.\",\r\n    },\r\n    {\r\n      target: \"#menu-equipe\",\r\n      content: \"Gerencie os membros da sua equipe e permiss├Áes.\",\r\n    },\r\n    {\r\n      target: \"#menu-relatorios\",\r\n      content: \"Visualize relat├│rios detalhados de vendas e financeiro.\",\r\n    },\r\n    {\r\n      target: \"#card-faturamento\",\r\n      content: \"Acompanhe seu faturamento di├írio aqui.\",\r\n    },\r\n  ];\r\n\r\n  const gerenteSteps: Step[] = [\r\n    {\r\n      target: \"body\",\r\n      content: (\r\n        <div className=\"text-center\">\r\n          <h3 className=\"font-bold text-lg mb-2\">Bem-vindo ao FlowPDV!</h3>\r\n          <p>Vamos fazer um tour r├ípido pelas funcionalidades do sistema.</p>\r\n        </div>\r\n      ),\r\n      placement: \"center\",\r\n      disableBeacon: true,\r\n    },\r\n    {\r\n      target: \"#menu-vender\",\r\n      content: \"Aqui voc├¬ realiza as vendas no PDV (Ponto de Venda).\",\r\n    },\r\n    {\r\n      target: \"#menu-estoque\",\r\n      content: \"Gerencie seus produtos e estoque nesta ├írea.\",\r\n    },\r\n    {\r\n      target: \"#menu-movimentacoes\",\r\n      content: \"Acompanhe as movimenta├º├Áes de estoque e financeiras.\",\r\n    },\r\n    {\r\n      target: \"#card-faturamento\",\r\n      content: \"Acompanhe seu faturamento di├írio aqui.\",\r\n    },\r\n  ];\r\n\r\n  const funcionarioSteps: Step[] = [\r\n    {\r\n      target: \"body\",\r\n      content: (\r\n        <div className=\"text-center\">\r\n          <h3 className=\"font-bold text-lg mb-2\">Bem-vindo ao FlowPDV!</h3>\r\n          <p>Vamos conhecer seu ambiente de trabalho.</p>\r\n        </div>\r\n      ),\r\n      placement: \"center\",\r\n      disableBeacon: true,\r\n    },\r\n    {\r\n      target: \"#menu-vender\",\r\n      content: \"Acesse o caixa para realizar vendas.\",\r\n    },\r\n    {\r\n      target: \"#mural-avisos\",\r\n      content: \"Fique atento aos avisos e comunicados da empresa aqui.\",\r\n    },\r\n    {\r\n      target: \"#menu-minha-conta\",\r\n      content: \"Gerencie seus dados e veja suas vendas.\",\r\n    },\r\n  ];\r\n\r\n  let steps: Step[] = [];\r\n\r\n  if (role === \"admin\") {\r\n    steps = adminSteps;\r\n  } else if (role === \"gerente\") {\r\n    steps = gerenteSteps;\r\n  } else if (role === \"caixa\" || role === \"funcionario\") {\r\n    steps = funcionarioSteps;\r\n  }\r\n\r\n  if (!steps.length) return null;\r\n\r\n  return (\r\n    <Joyride\r\n      steps={steps}\r\n      run={run}\r\n      continuous\r\n      showSkipButton\r\n      showProgress\r\n      scrollToFirstStep={false}\r\n      disableScrollParentFix={true}\r\n      spotlightClicks={true}\r\n      callback={handleJoyrideCallback}\r\n      styles={{\r\n        options: {\r\n          primaryColor: \"#137fec\",\r\n          zIndex: 1000,\r\n          arrowColor: \"#fff\",\r\n          backgroundColor: \"#fff\",\r\n          overlayColor: \"rgba(0, 0, 0, 0.6)\",\r\n          textColor: \"#333\",\r\n        },\r\n        tooltip: {\r\n          borderRadius: \"12px\",\r\n          boxShadow:\r\n            \"0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)\",\r\n          padding: \"20px\",\r\n        },\r\n        tooltipContainer: {\r\n          textAlign: \"left\",\r\n        },\r\n        buttonNext: {\r\n          backgroundColor: \"#137fec\",\r\n          borderRadius: \"8px\",\r\n          padding: \"10px 20px\",\r\n          fontWeight: 600,\r\n          fontSize: \"14px\",\r\n        },\r\n        buttonBack: {\r\n          color: \"#666\",\r\n          marginRight: \"10px\",\r\n          fontWeight: 500,\r\n        },\r\n        buttonSkip: {\r\n          color: \"#999\",\r\n          fontSize: \"14px\",\r\n        },\r\n      }}\r\n      locale={{\r\n        back: \"Voltar\",\r\n        close: \"Fechar\",\r\n        last: \"Concluir\",\r\n        next: \"Pr├│ximo\",\r\n        skip: \"Pular tour\",\r\n      }}\r\n    />\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\components\\pwa\\install-prompt.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[311,314],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[311,314],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[609,612],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[609,612],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1095,1098],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1095,1098],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":152,"column":11,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[5008,5135],"text":"\r\n          Para instalar no iOS, toque no bot├úo de compartilhar e selecione\r\n          &quot;Adicionar ├á Tela de In├¡cio\".\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[5008,5135],"text":"\r\n          Para instalar no iOS, toque no bot├úo de compartilhar e selecione\r\n          &ldquo;Adicionar ├á Tela de In├¡cio\".\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[5008,5135],"text":"\r\n          Para instalar no iOS, toque no bot├úo de compartilhar e selecione\r\n          &#34;Adicionar ├á Tela de In├¡cio\".\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[5008,5135],"text":"\r\n          Para instalar no iOS, toque no bot├úo de compartilhar e selecione\r\n          &rdquo;Adicionar ├á Tela de In├¡cio\".\r\n        "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":152,"column":38,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[5008,5135],"text":"\r\n          Para instalar no iOS, toque no bot├úo de compartilhar e selecione\r\n          \"Adicionar ├á Tela de In├¡cio&quot;.\r\n        "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[5008,5135],"text":"\r\n          Para instalar no iOS, toque no bot├úo de compartilhar e selecione\r\n          \"Adicionar ├á Tela de In├¡cio&ldquo;.\r\n        "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[5008,5135],"text":"\r\n          Para instalar no iOS, toque no bot├úo de compartilhar e selecione\r\n          \"Adicionar ├á Tela de In├¡cio&#34;.\r\n        "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[5008,5135],"text":"\r\n          Para instalar no iOS, toque no bot├úo de compartilhar e selecione\r\n          \"Adicionar ├á Tela de In├¡cio&rdquo;.\r\n        "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Download } from \"lucide-react\";\r\nimport { useSession } from \"next-auth/react\";\r\nimport { usePathname } from \"next/navigation\";\r\nimport { toast } from \"sonner\";\r\n\r\nlet globalDeferredPrompt: any = null;\r\n\r\ninterface InstallPromptProps {\r\n  variant?: \"floating\" | \"inline\";\r\n}\r\n\r\nexport function InstallPrompt({ variant = \"floating\" }: InstallPromptProps) {\r\n  const { status } = useSession();\r\n  const pathname = usePathname();\r\n  const [deferredPrompt, setDeferredPrompt] =\r\n    useState<any>(globalDeferredPrompt);\r\n  const [isIOS, setIsIOS] = useState(false);\r\n  const [isStandalone, setIsStandalone] = useState(false);\r\n  const [mounted, setMounted] = useState(false);\r\n\r\n  useEffect(() => {\r\n    setMounted(true);\r\n    // Check if already in standalone mode\r\n    if (window.matchMedia(\"(display-mode: standalone)\").matches) {\r\n      setIsStandalone(true);\r\n    }\r\n\r\n    // Check if iOS\r\n    const ios =\r\n      /iPad|iPhone|iPod/.test(navigator.userAgent) && !(window as any).MSStream;\r\n    setIsIOS(ios);\r\n\r\n    const handleBeforeInstallPrompt = (e: Event) => {\r\n      e.preventDefault();\r\n      globalDeferredPrompt = e;\r\n      setDeferredPrompt(e);\r\n      console.log(\"Captured beforeinstallprompt event\");\r\n    };\r\n\r\n    window.addEventListener(\"beforeinstallprompt\", handleBeforeInstallPrompt);\r\n\r\n    return () => {\r\n      window.removeEventListener(\r\n        \"beforeinstallprompt\",\r\n        handleBeforeInstallPrompt\r\n      );\r\n    };\r\n  }, []);\r\n\r\n  const handleInstallClick = async () => {\r\n    if (!deferredPrompt) {\r\n      if (isIOS) {\r\n        toast(\"Instala├º├úo no iOS\", {\r\n          description:\r\n            \"Toque no bot├úo de compartilhar e selecione 'Adicionar ├á Tela de In├¡cio'.\",\r\n        });\r\n      }\r\n      return;\r\n    }\r\n\r\n    deferredPrompt.prompt();\r\n    const { outcome } = await deferredPrompt.userChoice;\r\n    console.log(`User response to the install prompt: ${outcome}`);\r\n    globalDeferredPrompt = null;\r\n    setDeferredPrompt(null);\r\n  };\r\n\r\n  if (!mounted) return null;\r\n\r\n  // Logic for INLINE variant (Settings page)\r\n  if (variant === \"inline\") {\r\n    // If installed, show nothing or specific message? User asked to put button in settings.\r\n    // If installed, maybe we show \"App Instalado\" disabled button.\r\n\r\n    // Condition: Only show if authenticated (safety)\r\n    // if (status !== \"authenticated\") return null; // Logic handled by parent usually, but good to keep.\r\n\r\n    return (\r\n      <div className=\"bg-white dark:bg-zinc-900 rounded-xl border border-gray-200 dark:border-zinc-800 p-6 shadow-sm\">\r\n        <h2 className=\"text-lg font-semibold mb-2 text-gray-900 dark:text-white flex items-center gap-2\">\r\n          <Download className=\"w-5 h-5 text-blue-600\" />\r\n          Aplicativo\r\n        </h2>\r\n        <div className=\"flex flex-col sm:flex-row items-center justify-between gap-4\">\r\n          <div className=\"text-sm text-gray-500 dark:text-gray-400\">\r\n            {isStandalone\r\n              ? \"O aplicativo j├í est├í instalado e ativo neste dispositivo.\"\r\n              : \"Instale o FlowPDV no seu dispositivo para acessar offline e ter uma melhor experi├¬ncia.\"}\r\n          </div>\r\n\r\n          {!isStandalone && (\r\n            <Button\r\n              onClick={handleInstallClick}\r\n              className=\"w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white gap-2\"\r\n              disabled={!deferredPrompt && !isIOS}\r\n            >\r\n              <Download className=\"h-4 w-4\" />\r\n              {isIOS ? \"Como Instalar (iOS)\" : \"Instalar Agora\"}\r\n            </Button>\r\n          )}\r\n\r\n          {isStandalone && (\r\n            <Button\r\n              variant=\"outline\"\r\n              disabled\r\n              className=\"w-full sm:w-auto gap-2 opacity-70\"\r\n            >\r\n              <Download className=\"h-4 w-4\" />\r\n              Instalado\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Logic for FLOATING variant (Legacy/Corner)\r\n  // ... existing logic for public checks ...\r\n  const publicPaths = [\r\n    \"/\",\r\n    \"/login\",\r\n    \"/signup\",\r\n    \"/register\",\r\n    \"/forgot-password\",\r\n    \"/termos\",\r\n    \"/privacidade\",\r\n  ];\r\n\r\n  const isPublicPath =\r\n    publicPaths.includes(pathname) ||\r\n    pathname?.startsWith(\"/login\") ||\r\n    pathname?.startsWith(\"/signup\");\r\n\r\n  if (status !== \"authenticated\" || isStandalone || isPublicPath) return null;\r\n  if (!deferredPrompt && !isIOS) return null;\r\n\r\n  if (isIOS) {\r\n    // iOS floating logic\r\n    return (\r\n      <div className=\"fixed bottom-4 right-4 z-50 bg-background/90 backdrop-blur-sm border p-4 rounded-lg shadow-lg flex flex-col gap-2 max-w-sm animate-in slide-in-from-bottom-5\">\r\n        {/* ... ios content ... */}\r\n        <div className=\"flex items-center gap-2 font-semibold\">\r\n          <Download className=\"h-4 w-4\" />\r\n          Instalar App\r\n        </div>\r\n        <p className=\"text-sm text-muted-foreground\">\r\n          Para instalar no iOS, toque no bot├úo de compartilhar e selecione\r\n          \"Adicionar ├á Tela de In├¡cio\".\r\n        </p>\r\n        <Button variant=\"ghost\" size=\"sm\" onClick={() => setIsIOS(false)}>\r\n          Entendi\r\n        </Button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"fixed bottom-4 right-4 md:bottom-6 md:right-6 z-50 animate-in slide-in-from-bottom-10 fade-in duration-700\">\r\n      <Button\r\n        onClick={handleInstallClick}\r\n        variant=\"outline\"\r\n        className=\"rounded-full shadow-2xl bg-background/80 backdrop-blur-md border-muted-foreground/20 hover:bg-muted/50 transition-all font-medium gap-2 h-10 pr-4 pl-3\"\r\n      >\r\n        <div className=\"bg-primary/10 p-1.5 rounded-full\">\r\n          <Download className=\"h-4 w-4 text-primary\" />\r\n        </div>\r\n        <span className=\"text-sm font-medium\">Instalar App</span>\r\n      </Button>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\components\\shared\\user-card.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Shield' is defined but never used.","line":8,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'id' is defined but never used.","line":27,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":5}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport { Mail, Calendar, Users, Shield } from \"lucide-react\";\r\nimport { ReactNode } from \"react\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\ninterface UserCardProps {\r\n  id: string;\r\n  name: string;\r\n  email: string;\r\n  createdAt: string;\r\n  role?: string;\r\n  isCurrentUser?: boolean;\r\n  currentUserLabel?: string;\r\n  icon?: ReactNode;\r\n  footer?: ReactNode;\r\n  className?: string; // Allow overrides\r\n  onClick?: () => void;\r\n}\r\n\r\nexport function UserCard({\r\n  id,\r\n  name,\r\n  email,\r\n  createdAt,\r\n  role,\r\n  isCurrentUser,\r\n  currentUserLabel = \"Voc├¬\",\r\n  icon,\r\n  footer,\r\n  className,\r\n  onClick,\r\n}: UserCardProps) {\r\n  const Icon = icon || (\r\n    <Users className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\r\n  );\r\n\r\n  const getRoleBadgeColor = (role: string) => {\r\n    switch (role) {\r\n      case \"admin\":\r\n        return \"bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300\";\r\n      case \"master\":\r\n        return \"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300\";\r\n      case \"gerente\":\r\n        return \"bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300\";\r\n      default:\r\n        return \"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300\";\r\n    }\r\n  };\r\n\r\n  const getRoleLabel = (role: string) => {\r\n    switch (role) {\r\n      case \"admin\":\r\n        return \"Admin\";\r\n      case \"master\":\r\n        return \"Master\";\r\n      case \"gerente\":\r\n        return \"Gerente\";\r\n      default:\r\n        return \"Caixa\";\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Card\r\n      onClick={onClick}\r\n      className={cn(\r\n        \"transition-all duration-200 border-2 bg-white dark:bg-zinc-900 h-full\",\r\n        isCurrentUser\r\n          ? \"border-blue-200 dark:border-blue-800 bg-blue-50/50 dark:bg-blue-900/20\"\r\n          : \"border-gray-200 dark:border-zinc-800 hover:shadow-md\",\r\n        onClick && \"cursor-pointer\",\r\n        className\r\n      )}\r\n    >\r\n      <CardHeader className=\"pb-3\">\r\n        <div className=\"flex items-start justify-between\">\r\n          <div className=\"flex items-center space-x-3 w-full\">\r\n            <div className=\"flex-1\">\r\n              <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                  <CardTitle className=\"text-lg font-bold text-gray-900 dark:text-gray-100\">\r\n                    {name}\r\n                  </CardTitle>\r\n                  {isCurrentUser && (\r\n                    <div className=\"absolute top-2 right-2\">\r\n                      <span className=\"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 text-xs px-2 py-1 rounded-full font-medium\">\r\n                        {currentUserLabel}\r\n                      </span>\r\n                    </div>\r\n                  )}\r\n                  {role && (\r\n                    <CardDescription className=\"flex items-center space-x-1 mt-1\">\r\n                      <span\r\n                        className={`inline-block px-2 py-1 text-xs rounded ${getRoleBadgeColor(\r\n                          role\r\n                        )}`}\r\n                      >\r\n                        {getRoleLabel(role)}\r\n                      </span>\r\n                    </CardDescription>\r\n                  )}\r\n                </div>\r\n                {!isCurrentUser && (\r\n                  <div className=\"p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg opacity-80\">\r\n                    {Icon}\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent>\r\n        <div className=\"space-y-3\">\r\n          <div className=\"flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400\">\r\n            <Mail className=\"h-4 w-4\" />\r\n            <span className=\"truncate\">{email}</span>\r\n          </div>\r\n          <div className=\"flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400\">\r\n            <Calendar className=\"h-4 w-4\" />\r\n            <span>Desde {new Date(createdAt).toLocaleDateString(\"pt-BR\")}</span>\r\n          </div>\r\n          {footer && <div className=\"pt-2\">{footer}</div>}\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\hooks\\use-pos.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useCallback' is defined but never used.","line":1,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":50},{"ruleId":"prefer-const","severity":2,"message":"'sorted' is never reassigned. Use 'const' instead.","line":22,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":22,"endColumn":15,"fix":{"range":[722,754],"text":"const sorted = [...searchResults];"}}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef, useCallback, useMemo } from \"react\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { db, ProductLocal } from \"@/lib/local-db\";\r\nimport { PRODUCTS_SYNCED_EVENT } from \"@/lib/events\";\r\n\r\nexport interface Product extends ProductLocal {}\r\n\r\nexport interface CartItem {\r\n  product: Product;\r\n  quantidade: number;\r\n  descontoAplicado: number;\r\n  subtotal: number;\r\n}\r\n\r\nexport function usePOS() {\r\n  const [products, setProducts] = useState<Product[]>([]);\r\n  const [searchResults, setSearchResults] = useState<Product[]>([]);\r\n  const [sortOption, setSortOption] = useState<string>(\"name_asc\");\r\n\r\n  // Ordena├º├úo Reativa com useMemo\r\n  const filteredProducts = useMemo(() => {\r\n    let sorted = [...searchResults];\r\n\r\n    switch (sortOption) {\r\n      case \"name_asc\":\r\n        sorted.sort((a, b) => a.nome.localeCompare(b.nome));\r\n        break;\r\n      case \"name_desc\":\r\n        sorted.sort((a, b) => b.nome.localeCompare(a.nome));\r\n        break;\r\n      case \"stock_asc\":\r\n        sorted.sort((a, b) => a.estoqueAtual - b.estoqueAtual);\r\n        break;\r\n      case \"stock_desc\":\r\n        sorted.sort((a, b) => b.estoqueAtual - a.estoqueAtual);\r\n        break;\r\n      case \"price_asc\":\r\n        sorted.sort((a, b) => a.precoVenda - b.precoVenda);\r\n        break;\r\n      case \"price_desc\":\r\n        sorted.sort((a, b) => b.precoVenda - a.precoVenda);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n    return sorted;\r\n  }, [searchResults, sortOption]);\r\n\r\n  const [cart, setCart] = useState<CartItem[]>([]);\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [metodoPagamento, setMetodoPagamento] = useState(\"\");\r\n  const [valorRecebido, setValorRecebido] = useState<string>(\"\");\r\n  const [initialLoading, setInitialLoading] = useState(true);\r\n  const [finalizing, setFinalizing] = useState(false);\r\n  const [paymentError, setPaymentError] = useState(false);\r\n  const [showSuccessScreen, setShowSuccessScreen] = useState(false);\r\n  const [lastSaleTotal, setLastSaleTotal] = useState(0);\r\n  const [lastPaymentMethod, setLastPaymentMethod] = useState(\"\");\r\n  const [lastValorRecebido, setLastValorRecebido] = useState<number | null>(\r\n    null\r\n  );\r\n  const [lastTroco, setLastTroco] = useState<number | null>(null);\r\n  const [isOffline, setIsOffline] = useState(false);\r\n\r\n  const searchInputRef = useRef<HTMLInputElement>(null);\r\n  const hasLoadedProducts = useRef(false);\r\n\r\n  // Fun├º├úo para garantir que o banco est├í pronto\r\n  const ensureDbReady = async (): Promise<boolean> => {\r\n    try {\r\n      await db.open();\r\n      return true;\r\n    } catch (error) {\r\n      console.error(\"Erro ao abrir banco local:\", error);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Carregar dados iniciais e configurar listeners\r\n  useEffect(() => {\r\n    const savedCart = localStorage.getItem(\"pdv_cart\");\r\n    if (savedCart) {\r\n      try {\r\n        setCart(JSON.parse(savedCart));\r\n      } catch (e) {\r\n        console.error(\"Erro ao carregar carrinho salvo:\", e);\r\n      }\r\n    }\r\n\r\n    const savedPayment = localStorage.getItem(\"pdv_payment_method\");\r\n    if (savedPayment) {\r\n      setMetodoPagamento(savedPayment);\r\n    }\r\n\r\n    const handleOnline = () => setIsOffline(false);\r\n    const handleOffline = () => setIsOffline(true);\r\n\r\n    window.addEventListener(\"online\", handleOnline);\r\n    window.addEventListener(\"offline\", handleOffline);\r\n    setIsOffline(!navigator.onLine);\r\n\r\n    // Listener para quando os produtos forem sincronizados\r\n    const handleProductsSynced = (event: Event) => {\r\n      const customEvent = event as CustomEvent;\r\n      console.log(\"Products synced event received:\", customEvent.detail);\r\n      // Recarregar produtos do banco local\r\n      loadProductsFromDb();\r\n    };\r\n\r\n    window.addEventListener(PRODUCTS_SYNCED_EVENT, handleProductsSynced);\r\n\r\n    // Tentar carregar produtos iniciais\r\n    loadProductsFromDb();\r\n\r\n    return () => {\r\n      window.removeEventListener(\"online\", handleOnline);\r\n      window.removeEventListener(\"offline\", handleOffline);\r\n      window.removeEventListener(PRODUCTS_SYNCED_EVENT, handleProductsSynced);\r\n    };\r\n  }, []);\r\n\r\n  // Fun├º├úo principal para carregar produtos do banco local\r\n  const loadProductsFromDb = async () => {\r\n    try {\r\n      const dbReady = await ensureDbReady();\r\n      if (!dbReady) {\r\n        console.log(\"Banco n├úo est├í pronto, aguardando...\");\r\n        // Aguardar um pouco e tentar novamente\r\n        setTimeout(loadProductsFromDb, 500);\r\n        return;\r\n      }\r\n\r\n      // Aguardar com retry para dar tempo do sync popular o banco\r\n      const results = await waitForProducts(8, 300);\r\n\r\n      setSearchResults(results);\r\n      setProducts(results);\r\n      hasLoadedProducts.current = true;\r\n\r\n      if (results.length === 0) {\r\n        console.log(\"Nenhum produto encontrado no banco local\");\r\n      } else {\r\n        console.log(`${results.length} produtos carregados do banco local`);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Erro ao carregar produtos:\", error);\r\n      // N├úo exibir toast de erro aqui pois pode ser race condition normal\r\n    } finally {\r\n      setInitialLoading(false);\r\n    }\r\n  };\r\n\r\n  // Persist├¬ncia\r\n  useEffect(() => {\r\n    localStorage.setItem(\"pdv_cart\", JSON.stringify(cart));\r\n  }, [cart]);\r\n\r\n  const total = useMemo(\r\n    () => cart.reduce((acc, item) => acc + item.subtotal, 0),\r\n    [cart]\r\n  );\r\n\r\n  useEffect(() => {\r\n    localStorage.setItem(\"pdv_payment_method\", metodoPagamento);\r\n    // Se mudar para dinheiro ou o total mudar, preenche automaticamente com o total\r\n    if (metodoPagamento === \"dinheiro\") {\r\n      setValorRecebido(total.toFixed(2).replace(\".\", \",\"));\r\n    } else {\r\n      setValorRecebido(\"\");\r\n    }\r\n  }, [metodoPagamento, total]);\r\n\r\n  // Busca com Debounce usando Dexie (150ms para ser mais responsivo)\r\n  useEffect(() => {\r\n    const delayDebounceFn = setTimeout(() => {\r\n      searchProducts(searchTerm, false);\r\n    }, 150);\r\n\r\n    return () => clearTimeout(delayDebounceFn);\r\n  }, [searchTerm]);\r\n\r\n  // Fun├º├úo para remover acentos (normaliza├º├úo)\r\n  const removeAccents = (str: string): string => {\r\n    return str.normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\");\r\n  };\r\n\r\n  // Fun├º├úo auxiliar para aguardar com retry\r\n  const waitForProducts = async (\r\n    maxRetries: number = 8,\r\n    initialDelay: number = 300\r\n  ): Promise<Product[]> => {\r\n    let delay = initialDelay;\r\n\r\n    for (let i = 0; i < maxRetries; i++) {\r\n      try {\r\n        const dbReady = await ensureDbReady();\r\n        if (!dbReady) {\r\n          await new Promise((resolve) => setTimeout(resolve, delay));\r\n          delay = Math.min(delay * 1.5, 2000); // Cap at 2 seconds\r\n          continue;\r\n        }\r\n\r\n        const results = await db.products.limit(50).toArray();\r\n        if (results.length > 0) {\r\n          return results;\r\n        }\r\n\r\n        // Se n├úo encontrou produtos, aguarda antes de tentar novamente\r\n        // (provavelmente o sync ainda est├í em andamento)\r\n        console.log(`Tentativa ${i + 1}/${maxRetries}: aguardando produtos...`);\r\n        await new Promise((resolve) => setTimeout(resolve, delay));\r\n        delay = Math.min(delay * 1.5, 2000); // Backoff exponencial com cap\r\n      } catch (error) {\r\n        console.error(`Tentativa ${i + 1}/${maxRetries} falhou:`, error);\r\n        await new Promise((resolve) => setTimeout(resolve, delay));\r\n        delay = Math.min(delay * 1.5, 2000);\r\n      }\r\n    }\r\n\r\n    // Ap├│s todas as tentativas, retorna vazio (pode ser que realmente n├úo haja produtos)\r\n    return [];\r\n  };\r\n\r\n  const searchProducts = async (term: string, isInitial: boolean = false) => {\r\n    try {\r\n      const dbReady = await ensureDbReady();\r\n      if (!dbReady) {\r\n        console.log(\"Banco n├úo est├í pronto para busca\");\r\n        return;\r\n      }\r\n\r\n      let results: Product[];\r\n      const normalizedTerm = removeAccents(term.trim().toLowerCase());\r\n\r\n      if (normalizedTerm === \"\") {\r\n        if (isInitial) {\r\n          // No carregamento inicial, aguarda o sync popular o banco\r\n          results = await waitForProducts(8, 300);\r\n        } else {\r\n          // Limit to 50 items for initial view to avoid performance issues\r\n          results = await db.products.limit(50).toArray();\r\n        }\r\n      } else {\r\n        // Improved search: \"Contains\" instead of \"StartsWith\"\r\n        // Also accent-insensitive: \"cafe\" finds \"Caf├®\", \"acucar\" finds \"A├º├║car\"\r\n        results = await db.products\r\n          .filter((product) => {\r\n            const normalizedName = product.nome\r\n              ? removeAccents(product.nome.toLowerCase())\r\n              : \"\";\r\n            const normalizedSku = product.sku\r\n              ? removeAccents(product.sku.toString().toLowerCase())\r\n              : \"\";\r\n\r\n            const nameMatch = normalizedName.includes(normalizedTerm);\r\n            const skuMatch = normalizedSku.includes(normalizedTerm);\r\n            return nameMatch || skuMatch;\r\n          })\r\n          .limit(50)\r\n          .toArray();\r\n      }\r\n\r\n      setSearchResults(results);\r\n      // We don't necessarily update 'products' state anymore as we rely on search results.\r\n      if (normalizedTerm === \"\") setProducts(results);\r\n    } catch (error) {\r\n      console.error(\"Erro ao buscar produtos localmente:\", error);\r\n      // S├│ exibe toast de erro se j├í temos produtos carregados (n├úo ├® race condition)\r\n      if (hasLoadedProducts.current && !isInitial) {\r\n        toast({\r\n          title: \"Erro na busca\",\r\n          description: \"Falha ao buscar produtos no banco local.\",\r\n          variant: \"destructive\",\r\n        });\r\n      }\r\n    } finally {\r\n      // S├│ desliga o loading inicial\r\n      if (isInitial) {\r\n        setInitialLoading(false);\r\n      }\r\n    }\r\n  };\r\n\r\n  const addToCart = (product: Product) => {\r\n    // 1. Verifica se o produto tem estoque > 0\r\n    if (product.estoqueAtual <= 0) {\r\n      toast({\r\n        title: \"Estoque Indispon├¡vel\",\r\n        description: `O produto \"${product.nome}\" est├í sem estoque.`,\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    // 2. Verifica se a quantidade no carrinho + 1 ultrapassa o estoque\r\n    const existingItem = cart.find((item) => item.product.id === product.id);\r\n    if (existingItem && existingItem.quantidade >= product.estoqueAtual) {\r\n      toast({\r\n        title: \"Limite de Estoque\",\r\n        description: `Voc├¬ j├í atingiu a quantidade m├íxima em estoque para este produto.`,\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    setCart((prevCart) => {\r\n      const existingItemIndex = prevCart.findIndex(\r\n        (item) => item.product.id === product.id\r\n      );\r\n\r\n      if (existingItemIndex >= 0) {\r\n        const newCart = [...prevCart];\r\n        const newQuantity = newCart[existingItemIndex].quantidade + 1;\r\n        const desconto = newCart[existingItemIndex].descontoAplicado;\r\n        newCart[existingItemIndex] = {\r\n          ...newCart[existingItemIndex],\r\n          quantidade: newQuantity,\r\n          subtotal: newQuantity * product.precoVenda - desconto,\r\n        };\r\n        return newCart;\r\n      } else {\r\n        return [\r\n          ...prevCart,\r\n          {\r\n            product,\r\n            quantidade: 1,\r\n            descontoAplicado: 0,\r\n            subtotal: product.precoVenda,\r\n          },\r\n        ];\r\n      }\r\n    });\r\n  };\r\n\r\n  const updateCartItemQuantity = (productId: string, newQuantity: number) => {\r\n    if (newQuantity <= 0) {\r\n      removeFromCart(productId);\r\n      return;\r\n    }\r\n\r\n    const itemInCart = cart.find((item) => item.product.id === productId);\r\n    if (itemInCart) {\r\n      if (newQuantity > itemInCart.product.estoqueAtual) {\r\n        toast({\r\n          title: \"Estoque Insuficiente\",\r\n          description: `A quantidade m├íxima dispon├¡vel ├® ${itemInCart.product.estoqueAtual}.`,\r\n          variant: \"destructive\",\r\n        });\r\n        // Atualiza para o m├íximo poss├¡vel ao inv├®s de ignorar, melhor UX\r\n        newQuantity = itemInCart.product.estoqueAtual;\r\n      }\r\n    }\r\n\r\n    setCart((prevCart) =>\r\n      prevCart.map((item) =>\r\n        item.product.id === productId\r\n          ? {\r\n              ...item,\r\n              quantidade: newQuantity,\r\n              subtotal:\r\n                newQuantity * item.product.precoVenda - item.descontoAplicado,\r\n            }\r\n          : item\r\n      )\r\n    );\r\n  };\r\n\r\n  const updateCartItemDesconto = (productId: string, desconto: number) => {\r\n    setCart((prevCart) =>\r\n      prevCart.map((item) => {\r\n        if (item.product.id === productId) {\r\n          const maxDesconto = item.quantidade * item.product.precoVenda;\r\n          const descontoValido = Math.max(0, Math.min(desconto, maxDesconto));\r\n          return {\r\n            ...item,\r\n            descontoAplicado: descontoValido,\r\n            subtotal:\r\n              item.quantidade * item.product.precoVenda - descontoValido,\r\n          };\r\n        }\r\n        return item;\r\n      })\r\n    );\r\n  };\r\n\r\n  const removeFromCart = (productId: string) => {\r\n    setCart((prevCart) =>\r\n      prevCart.filter((item) => item.product.id !== productId)\r\n    );\r\n  };\r\n\r\n  const clearCart = () => {\r\n    setCart([]);\r\n    setMetodoPagamento(\"\");\r\n    setValorRecebido(\"\");\r\n    localStorage.removeItem(\"pdv_cart\");\r\n    localStorage.removeItem(\"pdv_payment_method\");\r\n  };\r\n\r\n  const finalizarVenda = async () => {\r\n    if (cart.length === 0) {\r\n      toast({\r\n        title: \"Carrinho vazio\",\r\n        description: \"Adicione produtos ao carrinho antes de finalizar\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (!metodoPagamento) {\r\n      setPaymentError(true);\r\n      toast({\r\n        title: \"Forma de Pagamento Obrigat├│ria\",\r\n        description: \"Selecione a Forma de Pagamento antes de finalizar!\",\r\n        variant: \"destructive\",\r\n      });\r\n      setTimeout(() => setPaymentError(false), 3000);\r\n      return;\r\n    }\r\n\r\n    const total = cart.reduce((acc, item) => acc + item.subtotal, 0);\r\n    let trocoCalculado: number | null = null;\r\n    let valorRecebidoNum: number | null = null;\r\n\r\n    if (metodoPagamento === \"dinheiro\") {\r\n      valorRecebidoNum = parseFloat(valorRecebido.replace(\",\", \".\"));\r\n\r\n      if (isNaN(valorRecebidoNum) || valorRecebidoNum < total) {\r\n        toast({\r\n          title: \"Valor recebido insuficiente\",\r\n          description:\r\n            \"O valor recebido deve ser maior ou igual ao total da venda.\",\r\n          variant: \"destructive\",\r\n        });\r\n        return;\r\n      }\r\n      trocoCalculado = valorRecebidoNum - total;\r\n    }\r\n\r\n    setFinalizing(true);\r\n    setPaymentError(false);\r\n\r\n    const salePayload = {\r\n      items: cart.map((item) => ({\r\n        productId: item.product.id,\r\n        quantidade: item.quantidade,\r\n        precoUnitario: item.product.precoVenda,\r\n        descontoAplicado: item.descontoAplicado,\r\n      })),\r\n      metodoPagamento,\r\n      valorRecebido: metodoPagamento === \"dinheiro\" ? valorRecebidoNum : null,\r\n      troco: trocoCalculado,\r\n    };\r\n\r\n    try {\r\n      // Try to send to API first\r\n      if (navigator.onLine) {\r\n        const response = await fetch(\"/api/sales\", {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify(salePayload),\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (!response.ok)\r\n          throw new Error(data.error || \"Erro ao finalizar venda\");\r\n\r\n        toast({\r\n          title: \"Venda realizada\",\r\n          description: \"Venda registrada com sucesso!\",\r\n          variant: \"default\",\r\n        });\r\n      } else {\r\n        throw new Error(\"Offline\"); // Force offline handling\r\n      }\r\n    } catch (error) {\r\n      console.log(\"Saving offline:\", error);\r\n\r\n      // Save locally\r\n      try {\r\n        await db.offlineSales.add({\r\n          payload: salePayload,\r\n          timestamp: Date.now(),\r\n        });\r\n\r\n        toast({\r\n          title: \"Venda Salva Localmente\",\r\n          description: \"Ser├í enviada quando houver internet.\",\r\n          className: \"bg-yellow-500 text-white\", // Visual feedback\r\n        });\r\n\r\n        // Atualizar estoque local imediatamente para refletir na UI\r\n        try {\r\n          for (const item of cart) {\r\n            const product = await db.products.get(item.product.id);\r\n            if (product) {\r\n              await db.products.update(item.product.id, {\r\n                estoqueAtual: product.estoqueAtual - item.quantidade,\r\n              });\r\n            }\r\n          }\r\n        } catch (localUpdateError) {\r\n          console.error(\"Erro ao atualizar estoque local\", localUpdateError);\r\n        }\r\n      } catch (dbError) {\r\n        console.error(\"Critical: Failed to save locally\", dbError);\r\n        toast({\r\n          title: \"Erro Cr├¡tico\",\r\n          description: \"N├úo foi poss├¡vel salvar a venda. Tente novamente.\",\r\n          variant: \"destructive\",\r\n        });\r\n        setFinalizing(false);\r\n        return; // Do not clear cart\r\n      }\r\n    }\r\n\r\n    // Success (either online or offline saved)\r\n    setLastSaleTotal(total);\r\n    setLastPaymentMethod(metodoPagamento);\r\n    setLastValorRecebido(valorRecebidoNum);\r\n    setLastTroco(trocoCalculado);\r\n\r\n    setShowSuccessScreen(true);\r\n    clearCart();\r\n    setFinalizing(false);\r\n\r\n    // Refresh local stock if needed (optional, logic might be complex locally without full sync)\r\n  };\r\n\r\n  const handleNewSale = () => {\r\n    setShowSuccessScreen(false);\r\n    clearCart();\r\n  };\r\n\r\n  return {\r\n    products,\r\n    filteredProducts,\r\n    cart,\r\n    searchTerm,\r\n    setSearchTerm,\r\n    metodoPagamento,\r\n    setMetodoPagamento,\r\n    loading: initialLoading,\r\n    finalizing,\r\n    paymentError,\r\n    setPaymentError,\r\n    showSuccessScreen,\r\n    lastSaleTotal,\r\n    isOffline,\r\n    searchInputRef,\r\n    addToCart,\r\n    updateCartItemQuantity,\r\n    updateCartItemDesconto,\r\n    removeFromCart,\r\n    clearCart,\r\n    finalizarVenda,\r\n    handleNewSale,\r\n    lastPaymentMethod,\r\n    valorRecebido,\r\n    setValorRecebido,\r\n    lastValorRecebido,\r\n    lastTroco,\r\n    sortOption,\r\n    setSortOption,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\hooks\\use-products.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":96,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2676,2679],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2676,2679],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from \"react\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\n\r\nexport interface Product {\r\n  id: string;\r\n  nome: string;\r\n  sku: string;\r\n  precoVenda: number;\r\n  precoCompra: number;\r\n  estoqueAtual: number;\r\n  estoqueMinimo: number;\r\n  imagemUrl?: string | null;\r\n  categoryId?: string | null;\r\n  category?: {\r\n    nome: string;\r\n  } | null;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\nexport interface Category {\r\n  id: string;\r\n  nome: string;\r\n}\r\n\r\ninterface UseProductsProps {\r\n  companyId?: string;\r\n}\r\n\r\nexport function useProducts({ companyId }: UseProductsProps = {}) {\r\n  const [products, setProducts] = useState<Product[]>([]);\r\n  const [categories, setCategories] = useState<Category[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const fetchCategories = useCallback(async () => {\r\n    try {\r\n      const response = await fetch(\"/api/admin/categories\");\r\n      const data = await response.json();\r\n      if (response.ok) {\r\n        setCategories(Array.isArray(data) ? data : []);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Erro ao carregar categorias:\", error);\r\n    }\r\n  }, []);\r\n\r\n  const fetchProducts = useCallback(async () => {\r\n    try {\r\n      const url = companyId\r\n        ? `/api/admin/products?companyId=${companyId}`\r\n        : \"/api/admin/products\";\r\n\r\n      const response = await fetch(url);\r\n      const data = await response.json();\r\n\r\n      if (!response.ok)\r\n        throw new Error(data.error || \"Erro ao carregar produtos\");\r\n\r\n      setProducts(Array.isArray(data) ? data : []);\r\n    } catch (error) {\r\n      console.error(\"Erro ao carregar produtos:\", error);\r\n      setProducts([]);\r\n      toast({\r\n        title: \"Erro\",\r\n        description: \"N├úo foi poss├¡vel carregar os produtos.\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [companyId]);\r\n\r\n  useEffect(() => {\r\n    fetchProducts();\r\n    fetchCategories();\r\n  }, [fetchProducts, fetchCategories]);\r\n\r\n  const deleteProduct = async (productId: string) => {\r\n    try {\r\n      let url = `/api/admin/products/${productId}`;\r\n      if (companyId) url += `?companyId=${companyId}`;\r\n      const response = await fetch(url, { method: \"DELETE\" });\r\n\r\n      if (!response.ok) {\r\n        const data = await response.json();\r\n        throw new Error(data.error || \"Erro ao excluir\");\r\n      }\r\n\r\n      // Optimistic update\r\n      setProducts((prev) => prev.filter((p) => p.id !== productId));\r\n\r\n      toast({ title: \"Sucesso\", description: \"Produto exclu├¡do\" });\r\n\r\n      // Background re-fetch to ensure consistency\r\n      fetchProducts();\r\n    } catch (error: any) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description: error.message || \"Erro ao excluir produto\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  };\r\n\r\n  const createCategory = async (name: string) => {\r\n    try {\r\n      const response = await fetch(\"/api/admin/categories\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ nome: name }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.error || \"Erro ao criar categoria\");\r\n      }\r\n\r\n      toast({\r\n        title: \"Sucesso\",\r\n        description: \"Categoria criada com sucesso!\",\r\n      });\r\n\r\n      // Atualizar lista\r\n      setCategories((prev) =>\r\n        [...prev, data].sort((a, b) => a.nome.localeCompare(b.nome))\r\n      );\r\n      return true;\r\n    } catch (error) {\r\n      toast({\r\n        title: \"Erro\",\r\n        description:\r\n          error instanceof Error ? error.message : \"Erro ao criar categoria\",\r\n        variant: \"destructive\",\r\n      });\r\n      return false;\r\n    }\r\n  };\r\n\r\n  return {\r\n    products,\r\n    categories,\r\n    loading,\r\n    fetchProducts,\r\n    deleteProduct,\r\n    createCategory,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\lib\\asaas.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":208,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":208,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5462,5465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5462,5465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Define environment variables with fallbacks for type safety\r\nconst ASAAS_API_URL = process.env.ASAAS_API_URL || \"https://api.asaas.com/v3\"; // Produ├º├úo por padr├úo\r\n\r\n// API Key DEVE vir do ambiente - sem fallback por seguran├ºa\r\nconst ASAAS_API_KEY = process.env.ASAAS_API_KEY || \"\";\r\n\r\nconst PLAN_PRICE = parseFloat(process.env.NEXT_PUBLIC_PLAN_PRICE || \"49.90\");\r\nconst TRIAL_DAYS = parseInt(process.env.NEXT_PUBLIC_TRIAL_DAYS || \"14\", 10);\r\n\r\n// Multa e Juros configur├íveis\r\nconst FINE_PERCENT = parseFloat(process.env.ASAAS_FINE_PERCENT || \"2\"); // 2%\r\nconst INTEREST_PERCENT = parseFloat(process.env.ASAAS_INTEREST_PERCENT || \"1\"); // 1% a.m.\r\n\r\n// Valida├º├úo na inicializa├º├úo (apenas log, n├úo quebra o build)\r\nif (!ASAAS_API_KEY) {\r\n  console.warn(\r\n    \"ÔÜá´©Å ASAAS_API_KEY n├úo est├í definida. As chamadas de integra├º├úo ir├úo falhar.\"\r\n  );\r\n}\r\n\r\ninterface AsaasCustomer {\r\n  id: string;\r\n  name: string;\r\n  email: string;\r\n  cpfCnpj: string;\r\n  address?: string;\r\n  addressNumber?: string;\r\n  complement?: string;\r\n  province?: string;\r\n  postalCode?: string;\r\n}\r\n\r\ninterface AsaasSubscription {\r\n  id: string;\r\n  customerId: string;\r\n  value: number;\r\n  nextDueDate: string;\r\n  cycle: string;\r\n  status: string;\r\n}\r\n\r\ninterface BillingInfo {\r\n  value: number;\r\n  dueDate: string;\r\n  invoiceUrl: string;\r\n  bankSlipUrl?: string;\r\n  pixQrCodeUrl?: string;\r\n  status?: string;\r\n}\r\n\r\ninterface PaymentHistoryItem {\r\n  id: string;\r\n  status: string;\r\n  value: number;\r\n  dueDate: string;\r\n  invoiceUrl: string;\r\n  bankSlipUrl?: string;\r\n}\r\n\r\ninterface AsaasError {\r\n  errors?: { description: string; code: string }[];\r\n}\r\n\r\n/**\r\n * Helper function for consistent error logging\r\n */\r\nfunction logError(\r\n  method: string,\r\n  error: unknown,\r\n  context?: Record<string, unknown>\r\n) {\r\n  console.error(`ÔØî [Asaas.${method}] Error:`, {\r\n    message: error instanceof Error ? error.message : String(error),\r\n    context,\r\n    timestamp: new Date().toISOString(),\r\n  });\r\n}\r\n\r\n/**\r\n * Helper function for API requests\r\n */\r\nasync function asaasRequest<T>(\r\n  endpoint: string,\r\n  options: RequestInit = {}\r\n): Promise<{ ok: boolean; data: T; status: number }> {\r\n  const url = `${ASAAS_API_URL}${endpoint}`;\r\n\r\n  const response = await fetch(url, {\r\n    ...options,\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      access_token: ASAAS_API_KEY,\r\n      ...options.headers,\r\n    },\r\n  });\r\n\r\n  // Handle 204 No Content\r\n  if (response.status === 204) {\r\n    return { ok: true, data: {} as T, status: 204 };\r\n  }\r\n\r\n  const text = await response.text();\r\n  let data: T;\r\n\r\n  try {\r\n    data = JSON.parse(text);\r\n  } catch {\r\n    console.error(\"[Asaas] Invalid JSON response:\", text);\r\n    throw new Error(`Resposta inv├ílida do Asaas (status ${response.status})`);\r\n  }\r\n\r\n  return { ok: response.ok, data, status: response.status };\r\n}\r\n\r\nexport const asaas = {\r\n  /**\r\n   * Searches for existing customer by CPF/CNPJ\r\n   */\r\n  async findCustomerByCpfCnpj(cpfCnpj: string): Promise<AsaasCustomer | null> {\r\n    try {\r\n      const { ok, data } = await asaasRequest<{ data: AsaasCustomer[] }>(\r\n        `/customers?cpfCnpj=${encodeURIComponent(cpfCnpj)}`\r\n      );\r\n\r\n      if (ok && data.data && data.data.length > 0) {\r\n        console.log(\r\n          \"Ô£à [Asaas.findCustomerByCpfCnpj] Customer found:\",\r\n          data.data[0].id\r\n        );\r\n        return data.data[0];\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      logError(\"findCustomerByCpfCnpj\", error, { cpfCnpj });\r\n      return null;\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Updates an existing customer in Asaas\r\n   */\r\n  async updateCustomer(\r\n    customerId: string,\r\n    updates: { name?: string; email?: string; mobilePhone?: string }\r\n  ): Promise<AsaasCustomer> {\r\n    console.log(\"­ƒôØ [Asaas.updateCustomer] Updating:\", customerId);\r\n\r\n    const { ok, data } = await asaasRequest<AsaasCustomer & AsaasError>(\r\n      `/customers/${customerId}`,\r\n      {\r\n        method: \"POST\",\r\n        body: JSON.stringify(updates),\r\n      }\r\n    );\r\n\r\n    if (!ok) {\r\n      const errorMsg =\r\n        data.errors?.[0]?.description || \"Erro ao atualizar cliente no Asaas\";\r\n      logError(\"updateCustomer\", errorMsg, { customerId, updates });\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    console.log(\"Ô£à [Asaas.updateCustomer] Customer updated:\", data.id);\r\n    return data;\r\n  },\r\n\r\n  /**\r\n   * Creates a new customer in Asaas.\r\n   * If CPF/CNPJ already exists, updates and returns existing customer.\r\n   */\r\n  async createCustomer(\r\n    name: string,\r\n    cpfCnpj: string,\r\n    email: string,\r\n    mobilePhone?: string,\r\n    addressData?: {\r\n      logradouro: string;\r\n      numero: string;\r\n      bairro: string;\r\n      cep: string;\r\n      complemento?: string;\r\n    }\r\n  ): Promise<AsaasCustomer> {\r\n    if (!cpfCnpj) throw new Error(\"CPF/CNPJ ├® obrigat├│rio\");\r\n\r\n    console.log(\"­ƒöä [Asaas.createCustomer] Checking if customer exists...\");\r\n\r\n    // Verificar se cliente j├í existe\r\n    const existingCustomer = await this.findCustomerByCpfCnpj(cpfCnpj);\r\n\r\n    if (existingCustomer) {\r\n      console.log(\"Ôä╣´©Å [Asaas.createCustomer] Customer exists, updating...\");\r\n      // Opcional: Atualizar endere├ºo tamb├®m se fornecido\r\n      return this.updateCustomer(existingCustomer.id, {\r\n        name,\r\n        email,\r\n        mobilePhone,\r\n      });\r\n    }\r\n\r\n    console.log(\"­ƒåò [Asaas.createCustomer] Creating new customer:\", {\r\n      name,\r\n      cpfCnpj,\r\n      email,\r\n    });\r\n\r\n    const payload: any = {\r\n      name,\r\n      cpfCnpj,\r\n      email,\r\n      mobilePhone,\r\n      notificationDisabled: false,\r\n    };\r\n\r\n    if (addressData) {\r\n      payload.address = addressData.logradouro;\r\n      payload.addressNumber = addressData.numero;\r\n      payload.complement = addressData.complemento;\r\n      payload.province = addressData.bairro;\r\n      payload.postalCode = addressData.cep;\r\n    }\r\n\r\n    const { ok, data } = await asaasRequest<AsaasCustomer & AsaasError>(\r\n      \"/customers\",\r\n      {\r\n        method: \"POST\",\r\n        body: JSON.stringify(payload),\r\n      }\r\n    );\r\n\r\n    if (!ok) {\r\n      const errorMsg =\r\n        data.errors?.[0]?.description || \"Erro ao criar cliente no Asaas\";\r\n      logError(\"createCustomer\", errorMsg, { name, cpfCnpj, email });\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    console.log(\"Ô£à [Asaas.createCustomer] Customer created:\", data.id);\r\n    return {\r\n      id: data.id,\r\n      name: data.name,\r\n      email: data.email,\r\n      cpfCnpj: data.cpfCnpj,\r\n    };\r\n  },\r\n\r\n  /**\r\n   * Gets customer details from Asaas.\r\n   */\r\n  async getCustomer(customerId: string): Promise<AsaasCustomer> {\r\n    console.log(\"­ƒöì [Asaas.getCustomer]\", customerId);\r\n\r\n    const { ok, data } = await asaasRequest<AsaasCustomer & AsaasError>(\r\n      `/customers/${customerId}`\r\n    );\r\n\r\n    if (!ok) {\r\n      const errorMsg =\r\n        data.errors?.[0]?.description || \"Erro ao buscar cliente\";\r\n      logError(\"getCustomer\", errorMsg, { customerId });\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    return data;\r\n  },\r\n\r\n  /**\r\n   * Creates a subscription with fine and interest rules.\r\n   * Starts after the trial period.\r\n   */\r\n  async createSubscription(\r\n    customerId: string,\r\n    customValue?: number\r\n  ): Promise<AsaasSubscription> {\r\n    const nextDueDate = new Date();\r\n    nextDueDate.setDate(nextDueDate.getDate() + TRIAL_DAYS);\r\n    const nextDueDateStr = nextDueDate.toISOString().split(\"T\")[0];\r\n\r\n    const value = customValue !== undefined ? customValue : PLAN_PRICE;\r\n\r\n    console.log(\"­ƒöä [Asaas.createSubscription] Creating subscription:\", {\r\n      customerId,\r\n      value,\r\n      nextDueDate: nextDueDateStr,\r\n      fine: `${FINE_PERCENT}%`,\r\n      interest: `${INTEREST_PERCENT}% a.m.`,\r\n    });\r\n\r\n    const { ok, data } = await asaasRequest<AsaasSubscription & AsaasError>(\r\n      \"/subscriptions\",\r\n      {\r\n        method: \"POST\",\r\n        body: JSON.stringify({\r\n          customer: customerId,\r\n          billingType: \"UNDEFINED\", // Permite Pix/Boleto\r\n          value: value,\r\n          nextDueDate: nextDueDateStr,\r\n          cycle: \"MONTHLY\",\r\n          description: \"Assinatura Flow PDV - Plano Mensal\",\r\n          // Multa por atraso\r\n          fine: {\r\n            value: FINE_PERCENT,\r\n            type: \"PERCENTAGE\",\r\n          },\r\n          // Juros por m├¬s de atraso\r\n          interest: {\r\n            value: INTEREST_PERCENT,\r\n            type: \"PERCENTAGE\",\r\n          },\r\n        }),\r\n      }\r\n    );\r\n\r\n    if (!ok) {\r\n      const errorMsg =\r\n        data.errors?.[0]?.description || \"Erro ao criar assinatura no Asaas\";\r\n      logError(\"createSubscription\", errorMsg, { customerId });\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    console.log(\"Ô£à [Asaas.createSubscription] Subscription created:\", data.id);\r\n    return {\r\n      id: data.id,\r\n      customerId: data.customerId || customerId,\r\n      value: data.value,\r\n      nextDueDate: data.nextDueDate,\r\n      cycle: data.cycle,\r\n      status: data.status,\r\n    };\r\n  },\r\n\r\n  /**\r\n   * Fetches the current billing information (next invoice).\r\n   */\r\n  async getSubscriptionBillingInfo(\r\n    subscriptionId: string\r\n  ): Promise<BillingInfo | null> {\r\n    try {\r\n      const { ok, data } = await asaasRequest<{ data: BillingInfo[] }>(\r\n        `/payments?subscription=${subscriptionId}&status=PENDING&limit=1`\r\n      );\r\n\r\n      if (!ok) {\r\n        logError(\"getSubscriptionBillingInfo\", \"Failed to fetch\", {\r\n          subscriptionId,\r\n        });\r\n        return null;\r\n      }\r\n\r\n      if (data.data && data.data.length > 0) {\r\n        const payment = data.data[0];\r\n        return {\r\n          value: payment.value,\r\n          dueDate: payment.dueDate,\r\n          invoiceUrl: payment.invoiceUrl,\r\n          bankSlipUrl: payment.bankSlipUrl,\r\n          status: payment.status,\r\n        };\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      logError(\"getSubscriptionBillingInfo\", error, { subscriptionId });\r\n      return null;\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Fetches payment history for the subscription.\r\n   */\r\n  async listPaymentHistory(\r\n    subscriptionId: string\r\n  ): Promise<PaymentHistoryItem[]> {\r\n    try {\r\n      const { ok, data } = await asaasRequest<{ data: PaymentHistoryItem[] }>(\r\n        `/payments?subscription=${subscriptionId}&limit=10`\r\n      );\r\n\r\n      if (!ok) {\r\n        throw new Error(\"Failed to fetch history\");\r\n      }\r\n\r\n      return data.data || [];\r\n    } catch (error) {\r\n      logError(\"listPaymentHistory\", error, { subscriptionId });\r\n      return [];\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Pauses (inactivates) a subscription in Asaas.\r\n   */\r\n  async pauseSubscription(subscriptionId: string): Promise<boolean> {\r\n    console.log(\"ÔÅ©´©Å [Asaas.pauseSubscription]\", subscriptionId);\r\n\r\n    const { ok, data } = await asaasRequest<AsaasSubscription & AsaasError>(\r\n      `/subscriptions/${subscriptionId}`,\r\n      {\r\n        method: \"POST\",\r\n        body: JSON.stringify({ status: \"INACTIVE\" }),\r\n      }\r\n    );\r\n\r\n    if (!ok) {\r\n      const errorMsg =\r\n        data.errors?.[0]?.description || \"Erro ao pausar assinatura\";\r\n      logError(\"pauseSubscription\", errorMsg, { subscriptionId });\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    console.log(\"Ô£à [Asaas.pauseSubscription] Subscription paused\");\r\n    return true;\r\n  },\r\n\r\n  /**\r\n   * Reactivates a paused subscription in Asaas.\r\n   */\r\n  async reactivateSubscription(subscriptionId: string): Promise<boolean> {\r\n    console.log(\"ÔûÂ´©Å [Asaas.reactivateSubscription]\", subscriptionId);\r\n\r\n    const { ok, data } = await asaasRequest<AsaasSubscription & AsaasError>(\r\n      `/subscriptions/${subscriptionId}`,\r\n      {\r\n        method: \"POST\",\r\n        body: JSON.stringify({ status: \"ACTIVE\" }),\r\n      }\r\n    );\r\n\r\n    if (!ok) {\r\n      const errorMsg =\r\n        data.errors?.[0]?.description || \"Erro ao reativar assinatura\";\r\n      logError(\"reactivateSubscription\", errorMsg, { subscriptionId });\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    console.log(\"Ô£à [Asaas.reactivateSubscription] Subscription reactivated\");\r\n    return true;\r\n  },\r\n\r\n  /**\r\n   * Cancels (deletes) a subscription in Asaas permanently.\r\n   */\r\n  async cancelSubscription(subscriptionId: string): Promise<boolean> {\r\n    console.log(\"­ƒùæ´©Å [Asaas.cancelSubscription]\", subscriptionId);\r\n\r\n    const { ok, status, data } = await asaasRequest<AsaasError>(\r\n      `/subscriptions/${subscriptionId}`,\r\n      { method: \"DELETE\" }\r\n    );\r\n\r\n    if (status === 204 || ok) {\r\n      console.log(\"Ô£à [Asaas.cancelSubscription] Subscription cancelled\");\r\n      return true;\r\n    }\r\n\r\n    const errorMsg =\r\n      data.errors?.[0]?.description || \"Erro ao cancelar assinatura\";\r\n    logError(\"cancelSubscription\", errorMsg, { subscriptionId });\r\n    throw new Error(errorMsg);\r\n  },\r\n\r\n  /**\r\n   * Updates the next due date of a subscription.\r\n   */\r\n  async updateSubscriptionDueDate(\r\n    subscriptionId: string,\r\n    newDueDate: Date\r\n  ): Promise<boolean> {\r\n    const dueDateStr = newDueDate.toISOString().split(\"T\")[0];\r\n    console.log(\r\n      \"­ƒôà [Asaas.updateSubscriptionDueDate]\",\r\n      subscriptionId,\r\n      dueDateStr\r\n    );\r\n\r\n    const { ok, data } = await asaasRequest<AsaasSubscription & AsaasError>(\r\n      `/subscriptions/${subscriptionId}`,\r\n      {\r\n        method: \"POST\",\r\n        body: JSON.stringify({ nextDueDate: dueDateStr }),\r\n      }\r\n    );\r\n\r\n    if (!ok) {\r\n      const errorMsg =\r\n        data.errors?.[0]?.description || \"Erro ao atualizar vencimento\";\r\n      logError(\"updateSubscriptionDueDate\", errorMsg, {\r\n        subscriptionId,\r\n        dueDateStr,\r\n      });\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    console.log(\"Ô£à [Asaas.updateSubscriptionDueDate] Due date updated\");\r\n    return true;\r\n  },\r\n\r\n  /**\r\n   * Updates subscription value (price).\r\n   */\r\n  async updateSubscriptionValue(\r\n    subscriptionId: string,\r\n    newValue: number\r\n  ): Promise<boolean> {\r\n    console.log(\"­ƒÆ░ [Asaas.updateSubscriptionValue]\", subscriptionId, newValue);\r\n\r\n    const { ok, data } = await asaasRequest<AsaasSubscription & AsaasError>(\r\n      `/subscriptions/${subscriptionId}`,\r\n      {\r\n        method: \"POST\",\r\n        body: JSON.stringify({ value: newValue }),\r\n      }\r\n    );\r\n\r\n    if (!ok) {\r\n      const errorMsg =\r\n        data.errors?.[0]?.description || \"Erro ao atualizar valor\";\r\n      logError(\"updateSubscriptionValue\", errorMsg, {\r\n        subscriptionId,\r\n        newValue,\r\n      });\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    console.log(\"Ô£à [Asaas.updateSubscriptionValue] Value updated\");\r\n    return true;\r\n  },\r\n\r\n  /**\r\n   * Gets subscription details from Asaas.\r\n   */\r\n  async getSubscription(subscriptionId: string): Promise<AsaasSubscription> {\r\n    console.log(\"­ƒöì [Asaas.getSubscription]\", subscriptionId);\r\n\r\n    const { ok, data } = await asaasRequest<AsaasSubscription & AsaasError>(\r\n      `/subscriptions/${subscriptionId}`\r\n    );\r\n\r\n    if (!ok) {\r\n      const errorMsg =\r\n        data.errors?.[0]?.description || \"Erro ao buscar assinatura\";\r\n      logError(\"getSubscription\", errorMsg, { subscriptionId });\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    return data;\r\n  },\r\n\r\n  /**\r\n   * Deletes a customer from Asaas.\r\n   * Does not throw on failure - logs and returns false.\r\n   */\r\n  async deleteCustomer(customerId: string): Promise<boolean> {\r\n    console.log(\"­ƒùæ´©Å [Asaas.deleteCustomer]\", customerId);\r\n\r\n    try {\r\n      const { ok, status } = await asaasRequest<AsaasError>(\r\n        `/customers/${customerId}`,\r\n        { method: \"DELETE\" }\r\n      );\r\n\r\n      if (status === 204 || ok) {\r\n        console.log(\"Ô£à [Asaas.deleteCustomer] Customer deleted\");\r\n        return true;\r\n      }\r\n\r\n      console.warn(\"ÔÜá´©Å [Asaas.deleteCustomer] Failed to delete customer\");\r\n      return false;\r\n    } catch (error) {\r\n      logError(\"deleteCustomer\", error, { customerId });\r\n      return false;\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Gets the billing URL (checkout page) for a subscription\r\n   */\r\n  async getBillingInfo(subscriptionId: string): Promise<BillingInfo | null> {\r\n    // Alias for getSubscriptionBillingInfo for API consistency\r\n    return this.getSubscriptionBillingInfo(subscriptionId);\r\n  },\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\lib\\auth.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":48,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1361,1364],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1361,1364],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":99,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3519,3522],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3519,3522],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import NextAuth, { AuthOptions } from \"next-auth\";\r\nimport CredentialsProvider from \"next-auth/providers/credentials\";\r\nimport bcrypt from \"bcryptjs\";\r\nimport { PrismaAdapter } from \"@next-auth/prisma-adapter\";\r\nimport { prisma } from \"@/lib/db\";\r\n\r\nexport const authOptions: AuthOptions = {\r\n  adapter: PrismaAdapter(prisma),\r\n  providers: [\r\n    CredentialsProvider({\r\n      name: \"credentials\",\r\n      credentials: {\r\n        email: { label: \"Email\", type: \"email\" },\r\n        password: { label: \"Password\", type: \"password\" },\r\n      },\r\n      async authorize(credentials) {\r\n        if (!credentials?.email || !credentials?.password) {\r\n          return null;\r\n        }\r\n\r\n        const user = await prisma.user.findFirst({\r\n          where: {\r\n            email: {\r\n              equals: credentials.email,\r\n              mode: \"insensitive\",\r\n            },\r\n          },\r\n          include: {\r\n            empresa: true,\r\n          },\r\n        });\r\n\r\n        if (!user?.password) {\r\n          return null;\r\n        }\r\n\r\n        const isPasswordValid = await bcrypt.compare(\r\n          credentials.password,\r\n          user.password\r\n        );\r\n\r\n        if (!isPasswordValid) {\r\n          return null;\r\n        }\r\n\r\n        // Ô£à BLOQUEIOS SaaS (apenas para n├úo-masters)\r\n        if (user.role !== \"master\" && user.empresa) {\r\n          const empresa: any = user.empresa;\r\n          const status = empresa.status as string;\r\n          const now = new Date();\r\n\r\n          // 1. Empresa pendente de aprova├º├úo\r\n          if (status === \"PENDENTE\") {\r\n            throw new Error(\r\n              \"Sua empresa est├í aguardando aprova├º├úo do administrador. Tente novamente mais tarde.\"\r\n            );\r\n          }\r\n\r\n          // 2. Empresa pausada/suspensa\r\n          if (status === \"PAUSADO\") {\r\n            const liberacaoAte = empresa.liberacaoTemporariaAte;\r\n            // Se tiver libera├º├úo tempor├íria v├ílida, permite o acesso\r\n            if (liberacaoAte && new Date(liberacaoAte) > now) {\r\n              // Acesso liberado temporariamente\r\n            } else {\r\n              throw new Error(\"Pagamento Pendente. Regularize para acessar.\");\r\n            }\r\n          }\r\n\r\n          // 3. Mensalidade vencida (apenas para empresas ativas ou em teste)\r\n          if (\r\n            (status === \"ATIVO\" || status === \"EM_TESTE\") &&\r\n            empresa.vencimentoPlano\r\n          ) {\r\n            const toleranceDate = new Date(empresa.vencimentoPlano);\r\n            // Toler├óncia de 10 dias apenas para ATIVO. EM_TESTE bloqueia imediatamente?\r\n            // User disse: \"O bloqueio s├│ acontece se ele n├úo pagar ap├│s 14 dias\" (referindo-se ao trial)\r\n            // Vou dar 1 dia de toler├óncia para o trial para evitar bloqueio no minuto exato\r\n            const toleranceDays = status === \"EM_TESTE\" ? 1 : 10;\r\n            toleranceDate.setDate(toleranceDate.getDate() + toleranceDays);\r\n\r\n            if (now > toleranceDate) {\r\n              throw new Error(\r\n                \"Acesso bloqueado. O pagamento da sua mensalidade n├úo foi realizado. Entre em contato com o suporte.\"\r\n              );\r\n            }\r\n          }\r\n        }\r\n\r\n        return {\r\n          id: user.id,\r\n          email: user.email,\r\n          name: user.name || user.nome || \"\",\r\n          role: user.role,\r\n          empresaId: user.empresaId,\r\n          empresaNome: user.empresa?.nome,\r\n          vencimentoPlano: user.empresa?.vencimentoPlano?.toISOString(),\r\n          liberacaoTemporariaAte: (\r\n            user.empresa as any\r\n          )?.liberacaoTemporariaAte?.toISOString(),\r\n          tourCompleted: user.tourCompleted,\r\n        };\r\n      },\r\n    }),\r\n  ],\r\n  session: {\r\n    strategy: \"jwt\",\r\n    maxAge: 8 * 60 * 60, // 8 horas (sess├úo expira ap├│s 8h)\r\n  },\r\n  callbacks: {\r\n    async signIn() {\r\n      // Permitir o login\r\n      return true;\r\n    },\r\n    async jwt({ token, user, trigger, session }) {\r\n      // Se ├® um novo login, adiciona os dados do usu├írio\r\n      if (user) {\r\n        token.role = user.role;\r\n        token.empresaId = user.empresaId;\r\n        token.empresaNome = user.empresaNome;\r\n        token.vencimentoPlano = user.vencimentoPlano;\r\n        token.liberacaoTemporariaAte = user.liberacaoTemporariaAte;\r\n        token.tourCompleted = user.tourCompleted;\r\n        token.lastActivity = Date.now();\r\n      }\r\n\r\n      // Atualizar ├║ltima atividade se for um update manual\r\n      if (trigger === \"update\") {\r\n        token.lastActivity = Date.now();\r\n        if (session?.tourCompleted !== undefined) {\r\n          token.tourCompleted = session.tourCompleted;\r\n        }\r\n      }\r\n\r\n      return token;\r\n    },\r\n    async session({ session, token }) {\r\n      if (token && Object.keys(token).length > 0) {\r\n        session.user.id = token.sub as string;\r\n        session.user.role = token.role as string;\r\n        session.user.empresaId = token.empresaId as string;\r\n        session.user.empresaNome = token.empresaNome as string;\r\n        session.user.vencimentoPlano = token.vencimentoPlano as string;\r\n        session.user.liberacaoTemporariaAte = token.liberacaoTemporariaAte as\r\n          | string\r\n          | undefined;\r\n        session.user.tourCompleted = token.tourCompleted as boolean;\r\n        session.lastActivity = token.lastActivity as number;\r\n      }\r\n      return session;\r\n    },\r\n  },\r\n  pages: {\r\n    signIn: \"/login\",\r\n  },\r\n};\r\n\r\nexport default NextAuth(authOptions);\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\lib\\local-db.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[264,267],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[264,267],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Dexie, { Table } from 'dexie';\r\n\r\nexport interface ProductLocal {\r\n  id: string;\r\n  nome: string;\r\n  sku: string;\r\n  precoVenda: number;\r\n  estoqueAtual: number;\r\n  imagemUrl?: string | null;\r\n}\r\n\r\nexport interface OfflineSale {\r\n  id?: number;\r\n  payload: any;\r\n  timestamp: number;\r\n}\r\n\r\nexport class FlowPDVDatabase extends Dexie {\r\n  products!: Table<ProductLocal, string>;\r\n  offlineSales!: Table<OfflineSale, number>;\r\n\r\n  constructor() {\r\n    super('FlowPDVDB');\r\n    this.version(1).stores({\r\n      products: 'id, nome, sku', // id is primary key\r\n      offlineSales: '++id, timestamp'\r\n    });\r\n  }\r\n}\r\n\r\nexport const db = new FlowPDVDatabase();\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\IMPORTANTE\\Google Antigravity\\Site 4\\pdv_system\\nextjs_space\\lib\\validation\\product.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[89,92],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[89,92],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\r\n\r\nexport function validateProductData(body: any) {\r\n  const { nome, precoVenda, precoCompra, estoqueAtual, estoqueMinimo } = body;\r\n\r\n  if (\r\n    !nome ||\r\n    precoVenda === undefined ||\r\n    precoCompra === undefined ||\r\n    estoqueAtual === undefined\r\n  ) {\r\n    return {\r\n      isValid: false,\r\n      response: NextResponse.json(\r\n        { error: \"Todos os campos obrigat├│rios devem ser preenchidos\" },\r\n        { status: 400 }\r\n      ),\r\n    };\r\n  }\r\n\r\n  if (precoVenda <= 0 || precoCompra < 0) {\r\n    return {\r\n      isValid: false,\r\n      response: NextResponse.json(\r\n        {\r\n          error:\r\n            \"Pre├ºos devem ser v├ílidos (pre├ºo de venda > 0, pre├ºo de compra >= 0)\",\r\n        },\r\n        { status: 400 }\r\n      ),\r\n    };\r\n  }\r\n\r\n  if (estoqueAtual < 0) {\r\n    return {\r\n      isValid: false,\r\n      response: NextResponse.json(\r\n        { error: \"Estoque n├úo pode ser negativo\" },\r\n        { status: 400 }\r\n      ),\r\n    };\r\n  }\r\n\r\n  if (estoqueMinimo !== undefined && estoqueMinimo < 0) {\r\n    return {\r\n      isValid: false,\r\n      response: NextResponse.json(\r\n        { error: \"Estoque m├¡nimo n├úo pode ser negativo\" },\r\n        { status: 400 }\r\n      ),\r\n    };\r\n  }\r\n\r\n  return { isValid: true };\r\n}\r\n","usedDeprecatedRules":[]}]
